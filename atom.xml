<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Yan Jiankang&#39;s Blog</title>
  <subtitle>博学之,审问之,慎思之,明辨之,笃行之</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yanjiankang.cn/"/>
  <updated>2016-04-25T06:43:28.122Z</updated>
  <id>http://yanjiankang.cn/</id>
  
  <author>
    <name>Jiankang Yan</name>
    <email>yanhealth@163.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>一起消消毒 网易互娱2017实习生招聘游戏研发工程师在线笔试第二场</title>
    <link href="http://yanjiankang.cn/wygame-onlinetest-2-2/"/>
    <id>http://yanjiankang.cn/wygame-onlinetest-2-2/</id>
    <published>2016-04-25T06:40:58.411Z</published>
    <updated>2016-04-25T06:43:28.122Z</updated>
    
    <content type="html">&lt;p&gt;##题目&lt;br&gt;时间限制:10000ms&lt;br&gt;单点时限:1000ms&lt;br&gt;内存限制:256MB&lt;/p&gt;
&lt;p&gt;###描述&lt;br&gt;《一起消消毒》是网易推出的一款创新的消除类游戏。游戏的基本规则很简单，玩家每次操作可以选择把游戏中相邻的两个图形（垂直相邻或者水平相邻）进行交换，如果交换后，出现三个或三个以上的连续相同图形在一条线上，则视这次操作为一次有效的操作，并且这些相同图形会消失。图形消失后，在同一条垂直线上的图形会往下掉。然后继续把同一直线上大于等于三个的相同图形消除，直到已无可消除的图形，则这次操作结束。&lt;/p&gt;
&lt;p&gt;如下图所示，假设左上角坐标为(0,0)，右下角坐标为(8,6)，则交换坐标为（2,0）和(3,0)的操作是一个有效的操作，该操作将使得(0,1),(1,1)和(2,1)的红色图形在同一条线上。同理，交换坐标为(7,5)和(8,5)的操作也是一个有效的操作，在同一线上的三个蓝色图形将消失。&lt;/p&gt;
&lt;p&gt;一次操作的完整流程是：&lt;/p&gt;
&lt;p&gt;（1）玩家进行交换操作；&lt;/p&gt;
&lt;p&gt;（2）得到交换图形的后的局面；&lt;/p&gt;
&lt;p&gt;（3）计算在当前局面下所有可以进行消除的图形，注意一次操作有可能使得不止一组图形在同一条线上；&lt;/p&gt;
&lt;p&gt;（4）在（3）中计算得到的所有图形同时消失，然后有图形消失了的列，其余剩下的图形往下掉，得到新的局面；&lt;/p&gt;
&lt;p&gt;（5）重复执行（3），直到已无图形可以消除。&lt;/p&gt;
&lt;p&gt;给出一个局面，同时给出玩家的一次有效的交换操作，请计算出这次操作总共能消除多少个图形。&lt;/p&gt;
&lt;p&gt;###输入&lt;br&gt;每个输入数据包含多个测试点。&lt;/p&gt;
&lt;p&gt;第一行为测试点的个数S &amp;lt;= 50。之后是S个测试点的数据。&lt;/p&gt;
&lt;p&gt;每个测试点的第一行为N, M (1 &amp;lt;= N, M &amp;lt;= 20)，之后N行，每行包含M个字符，每个字符代表一个图形，’.’表示该位置为空，’A’…’Z’分别表示一种图案。除此以外局面中无其他字符。之后一行是4个整数x0, y0, x1, y1，表示玩家希望交换的两个相邻图形的坐标位置(x0, y0)以及(x1, y1)。&lt;/p&gt;
&lt;p&gt;保证初始的局面为合法局面，无三个或以上连续相同图形在同一线上。并且无悬空的空格，即’.’只会出现在每一列的顶部。&lt;/p&gt;
&lt;p&gt;###输出&lt;br&gt;对于每个测试点，对应的结果输出一行，表示进行交换操作后能消除多少个图形。&lt;/p&gt;
&lt;p&gt;###样例输入&lt;br&gt;&lt;figure class=&quot;highlight c++&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.D.M.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.DCAE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;.AABA&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;MDDAM&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;F.Z.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ZZAZ&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;###样例输出&lt;br&gt;&lt;figure class=&quot;highlight c++&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;##我的解答&lt;/p&gt;
&lt;p&gt;考试的时候因为时间不够没做出来；&lt;br&gt;后来想了想大概的思路如下：&lt;br&gt;1）存储一个整个局面的flag数组，标志是否需要消除；&lt;br&gt;2）对于每个点，可以横向和纵向查找是否存在3个以上的可以消除，存在则更新flag数组&lt;br&gt;3）对于第一次交换，只需要考虑交换发生的两个点，因为题目保证初始局面合法；&lt;br&gt;4）找到所有需要消除的点之后，逐列遍历局面，消除该点，并且将上方的点下降；&lt;br&gt;5）循环以上过程直到找不到可消除的点；&lt;/p&gt;
&lt;p&gt;代码如下：&lt;br&gt;&lt;figure class=&quot;highlight c++&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;126&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;127&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;129&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;130&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;131&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;132&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;133&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;meta-string&quot;&gt;&amp;lt;iostream&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;meta-string&quot;&gt;&amp;lt;vector&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;meta-string&quot;&gt;&amp;lt;string&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;meta-string&quot;&gt;&amp;lt;fstream&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;meta-string&quot;&gt;&amp;lt;algorithm&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;using&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;std&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//对于i所在的行和j所在的列进行遍历，标记可以消除的点&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;markBoards&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;built_in&quot;&gt;vector&lt;/span&gt;&amp;lt;&lt;span class=&quot;built_in&quot;&gt;string&lt;/span&gt;&amp;gt;&amp;amp; board, &lt;span class=&quot;built_in&quot;&gt;vector&lt;/span&gt;&amp;lt;&lt;span class=&quot;built_in&quot;&gt;vector&lt;/span&gt;&amp;lt;&lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;&amp;gt;&amp;gt;&amp;amp; flag, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; j)&lt;/span&gt; &lt;/span&gt;&amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; n = board.size();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; m = board[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;].size();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; a1 = i, a2 = i;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; temp = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;//纵向扩展&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; ((--a1) &amp;gt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; board[a1][j] == board[i][j]) temp++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; ((++a2) &amp;lt; n &amp;amp;&amp;amp; board[a2][j] == board[i][j]) temp++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (temp &amp;gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; k = a1+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; k &amp;lt; a2; ++k) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      flag[k][j] = &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  a1 = j; a2 = j;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  temp = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;//横向扩展&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; ((--a1) &amp;gt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; board[i][a1] == board[i][j]) temp++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; ((++a2) &amp;lt; m &amp;amp;&amp;amp; board[i][a2] == board[i][j]) temp++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (temp &amp;gt; &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; k = a1+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; k &amp;lt; a2; ++k) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      flag[i][k] = &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//遍历整个局面，计算消除个数，并消除方块，垂直下降，返回消除个数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//逐列遍历，先考虑连续的消除以避免重复的下降&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//记得将flag重置&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;EliminateAndCount&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;built_in&quot;&gt;vector&lt;/span&gt;&amp;lt;&lt;span class=&quot;built_in&quot;&gt;string&lt;/span&gt;&amp;gt;&amp;amp; board, &lt;span class=&quot;built_in&quot;&gt;vector&lt;/span&gt;&amp;lt;&lt;span class=&quot;built_in&quot;&gt;vector&lt;/span&gt;&amp;lt;&lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;&amp;gt;&amp;gt;&amp;amp; flag)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; n = board.size();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; m = board[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;].size();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; a, b;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; count = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; j = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; j &amp;lt; m; ++j) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; n; ++i) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (board[i][j] != &lt;span class=&quot;string&quot;&gt;&#39;.&#39;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (flag[i][j] == &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          count++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          a = i; b = i;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; ((++b) &amp;lt; n &amp;amp;&amp;amp; flag[b][j]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            count++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;comment&quot;&gt;//下降过程&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; k = a&lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;; k &amp;gt;= &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; --k) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            board[k+b-a][j] = board[k][j];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            flag[k+b-a][j] = &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; k = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; k &amp;lt; b-a; ++k) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            board[k][j] = &lt;span class=&quot;string&quot;&gt;&#39;.&#39;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;comment&quot;&gt;//flag[k][j] = false;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          i = b+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  return count;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//简单粗暴的方法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;iterEliminateGame&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;built_in&quot;&gt;vector&lt;/span&gt;&amp;lt;&lt;span class=&quot;built_in&quot;&gt;string&lt;/span&gt;&amp;gt;&amp;amp; board, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; x0, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; y0, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; x1, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; y1)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; n = board.size();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; m = board[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;].size();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;vector&lt;/span&gt;&amp;lt;&lt;span class=&quot;built_in&quot;&gt;vector&lt;/span&gt;&amp;lt;&lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;&amp;gt;&amp;gt; flag(n, &lt;span class=&quot;built_in&quot;&gt;vector&lt;/span&gt;&amp;lt;&lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt;&amp;gt;(m, false));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;//因此初始局面是合法的，因此第一次只需要考虑交换的两个位置；&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  markBoards(board, flag, x0, y0);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  markBoards(board, flag, x1, y1);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; count = INT_MAX;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; result = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;//没有可消除的跳出循环&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (count &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//遍历整个局面，计算消除个数，并消除方块，垂直下降，返回消除个数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    count = EliminateAndCount(board, flag);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    result += count;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//对下降后的新的局面重新标记&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; n; ++i) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; j = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; j &amp;lt; m; ++j) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (board[i][j] != &lt;span class=&quot;string&quot;&gt;&#39;.&#39;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          markBoards(board, flag, i, j);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  return result;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; s, n, m;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;built_in&quot;&gt;cin&lt;/span&gt; &amp;gt;&amp;gt; s;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (s--) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;cin&lt;/span&gt; &amp;gt;&amp;gt; n &amp;gt;&amp;gt; m;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;vector&lt;/span&gt;&amp;lt;&lt;span class=&quot;built_in&quot;&gt;string&lt;/span&gt;&amp;gt; board(n);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; n; ++i) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;built_in&quot;&gt;cin&lt;/span&gt; &amp;gt;&amp;gt; board[i];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; x0, y0, x1, y1;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;cin&lt;/span&gt; &amp;gt;&amp;gt; x0 &amp;gt;&amp;gt; y0 &amp;gt;&amp;gt; x1 &amp;gt;&amp;gt; y1;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//检查输入输出是否越界&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (x0 &amp;lt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; || x0 &amp;gt;= n || y0 &amp;lt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; || y0 &amp;gt;= m &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      || x1 &amp;lt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; || x1 &amp;gt;= n || y1 &amp;lt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; || y1 &amp;gt;= m &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      || (x0 != x1 &amp;amp;&amp;amp; y0 != y1)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      || (x0 == x1 &amp;amp;&amp;amp; y0 == y1)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;built_in&quot;&gt;cout&lt;/span&gt; &amp;lt;&amp;lt; &lt;span class=&quot;string&quot;&gt;&quot;0&quot;&lt;/span&gt; &amp;lt;&amp;lt; &lt;span class=&quot;built_in&quot;&gt;endl&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//交换两个点&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt; c = board[x0][y0];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    board[x0][y0] = board[x1][y1];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    board[x1][y1] = c;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; result = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    result = iterEliminateGame(board, x0, y0, x1, y1);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;cout&lt;/span&gt; &amp;lt;&amp;lt; result &amp;lt;&amp;lt; &lt;span class=&quot;built_in&quot;&gt;endl&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  return &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;br&gt; &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com&lt;/strong&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;##题目&lt;br&gt;时间限制:10000ms&lt;br&gt;单点时限:1000ms&lt;br&gt;内存限制:256MB&lt;/p&gt;
&lt;p&gt;###描述&lt;br&gt;《一起消消毒》是网易推出的一款创新的消除类游戏。游戏的基本规则很简单，玩家每次操作可以选择把游戏中相邻的两个图形（垂直相邻或者水平相邻）进行交
    
    </summary>
    
      <category term="算法" scheme="http://yanjiankang.cn/categories/%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="网易游戏" scheme="http://yanjiankang.cn/tags/%E7%BD%91%E6%98%93%E6%B8%B8%E6%88%8F/"/>
    
  </entry>
  
  <entry>
    <title>Storm 源码分析——UI界面显示代码分析（上）</title>
    <link href="http://yanjiankang.cn/Storm-sourcecode-uicode-1/"/>
    <id>http://yanjiankang.cn/Storm-sourcecode-uicode-1/</id>
    <published>2016-04-07T08:12:59.865Z</published>
    <updated>2016-04-07T08:49:05.829Z</updated>
    
    <content type="html">&lt;p&gt;#Storm源码分析——UI界面显示代码分析&lt;/p&gt;
&lt;p&gt;storm开发环境的配置请参考：&lt;a href=&quot;http://yanjiankang.cn/Storm-sourcecode-analize-tools/&quot;&gt;storm源码分析——工具篇&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;storm的UI界面的参数解释可以参考&lt;a href=&quot;http://lbxc.iteye.com/blog/1522318&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://lbxc.iteye.com/blog/1522318&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;storm提供了ui界面的Restful API，主要API如下，详细的API的参数和返回值请参考&lt;a href=&quot;https://www.zybuluo.com/yanhealth/note/142919：&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.zybuluo.com/yanhealth/note/142919：&lt;/a&gt;&lt;br&gt;&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;/api/v1/cluster/configuration (GET) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/api/v1/cluster/summary (GET)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/api/v1/supervisor/summary (GET)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/api/v1/topology/summary (GET)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/api/v1/topology/:id (GET)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/api/v1/topology/:id/component/:component (GET)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/api/v1/topology/:id/activate (POST)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/api/v1/topology/:id/deactivate (POST)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/api/v1/topology/:id/rebalance/:wait-time (POST)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/api/v1/topology/:id/kill/:wait-time (POST)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这些接口函数的定义主要是在ui/core.clj文件中。下面主要分析UI进程的启动过程和以上接口数据的产生。 &lt;/p&gt;
&lt;h2 id=&quot;UI进程的启动&quot;&gt;&lt;a href=&quot;#UI进程的启动&quot; class=&quot;headerlink&quot; title=&quot;UI进程的启动&quot;&gt;&lt;/a&gt;UI进程的启动&lt;/h2&gt;&lt;p&gt;我们知道，UI进程是通过以下命令启动的：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;bin/storm ui&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中storm实际上是一个bash的脚本文件，storm 会通过以下命令调用bin/storm.py的python文件来执行：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;exec&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&lt;span class=&quot;variable&quot;&gt;$PYTHON&lt;/span&gt;&quot;&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&lt;span class=&quot;variable&quot;&gt;$&amp;#123;STORM_BIN_DIR&amp;#125;&lt;/span&gt;/storm.py&quot;&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&lt;span class=&quot;variable&quot;&gt;$@&lt;/span&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;storm.py中，接收到ui参数后，执行的函数代码如下：&lt;br&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;ui&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;:&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;string&quot;&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Syntax: [storm ui]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Launches the UI daemon. &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &quot;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    cppaths = [CLUSTER_CONF_DIR]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    jvmopts = parse_args(confvalue(&lt;span class=&quot;string&quot;&gt;&quot;ui.childopts&quot;&lt;/span&gt;, cppaths)) + [ &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;-Dlogfile.name=ui.log&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;-Dlog4j.configurationFile=&quot;&lt;/span&gt; + os.path.join(get_log4j_conf_dir(), &lt;span class=&quot;string&quot;&gt;&quot;cluster.xml&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ]   &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    exec_storm_class(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;backtype.storm.ui.core&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        jvmtype=&lt;span class=&quot;string&quot;&gt;&quot;-server&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        daemonName=&lt;span class=&quot;string&quot;&gt;&quot;ui&quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        jvmopts=jvmopts,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        extrajars=[STORM_DIR, CLUSTER_CONF_DIR])&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中首先会调用confvalue函数来获取UI进程执行的参数项，confvalue代码如下：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;def confvalue(name, extrapaths, daemon=True):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    global CONFFILE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;command&lt;/span&gt; = [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        JAVA_CMD, &lt;span class=&quot;string&quot;&gt;&quot;-client&quot;&lt;/span&gt;, get_config_opts(), &lt;span class=&quot;string&quot;&gt;&quot;-Dstorm.conf.file=&quot;&lt;/span&gt; + CONFFILE,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;string&quot;&gt;&quot;-cp&quot;&lt;/span&gt;, get_classpath(extrapaths, daemon), &lt;span class=&quot;string&quot;&gt;&quot;backtype.storm.command.config_value&quot;&lt;/span&gt;, name&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    p = sub.Popen(&lt;span class=&quot;built_in&quot;&gt;command&lt;/span&gt;, stdout=sub.PIPE)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    output, errors = p.communicate()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;# python 3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; not isinstance(output, str):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        output = output.decode(&lt;span class=&quot;string&quot;&gt;&#39;utf-8&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    lines = output.split(os.linesep)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; line &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; lines:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        tokens = line.split(&lt;span class=&quot;string&quot;&gt;&quot; &quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; tokens[0] == &lt;span class=&quot;string&quot;&gt;&quot;VALUE:&quot;&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;built_in&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot; &quot;&lt;/span&gt;.join(tokens[1:])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中sub.Popen是启动一个子进程，执行command命令，而command数组实际上是执行backtype.storm.command.config_value这个类，并将传入的ui.childopts作为参数。&lt;br&gt;config_value类的路径为：src/clj/backtype/storm/command/config_value.clj&lt;br&gt;config_value.clj的代码如下：&lt;br&gt;&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defn&lt;/span&gt;&lt;/span&gt; -main [&lt;span class=&quot;comment&quot;&gt;^String&lt;/span&gt; name]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [conf (&lt;span class=&quot;name&quot;&gt;read-storm-config&lt;/span&gt;)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;println&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;VALUE:&quot;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;conf&lt;/span&gt; name))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;因此，实际上就是读取storm的配置文件storm.conf，并得到ui.childopts参数。默认的ui.childopts参数是”-Xmx768m”，设置虚拟机内存堆的最大可用大小为768M.&lt;/p&gt;
&lt;p&gt;因此&lt;strong&gt;UI进程启动的顺序&lt;/strong&gt;为：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;先调用&lt;strong&gt;backtype.storm.command.config_value&lt;/strong&gt;获取读取到的配置文件中的ui启动项；&lt;/li&gt;
&lt;li&gt;然后执行java命令行参数后调用&lt;strong&gt;backtype.storm.ui.core&lt;/strong&gt;启动UI进程。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;其中配置文件中可以配置的UI参数如下（定义在src/jvm/backtype/storm/Config.java）：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Childopts for Storm UI Java process.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; String	UI_CHILDOPTS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//A class implementing javax.servlet.Filter for authenticating/filtering UI requests&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; String	UI_FILTER&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Initialization parameters for the javax.servlet.Filter&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; String	UI_FILTER_PARAMS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//The size of the header buffer for the UI in bytes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; String	UI_HEADER_BUFFER_BYTES&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Storm UI binds to this host/interface.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; String	UI_HOST&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Class name of the HTTP credentials plugin for the UI.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; String	UI_HTTP_CREDS_PLUGIN&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//Storm UI binds to this port.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; String	UI_PORT&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;backtype-storm-ui-core&quot;&gt;&lt;a href=&quot;#backtype-storm-ui-core&quot; class=&quot;headerlink&quot; title=&quot;backtype.storm.ui.core&quot;&gt;&lt;/a&gt;&lt;strong&gt;backtype.storm.ui.core&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;这一节看一下src/backtype/storm/ui/core.clj这个文件的主要功能（其中部分关于jetty服务器配置的函数定义在ui/helper.clj文件中）：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;backtype.storm.ui.core的主要功能是定义并启动一个jetty服务器，用于实现所有API的响应并返回json数据。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;首先看main函数， 就是调用start-server! 函数（clojure中！表示函数是突变函数，表示方法或宏不能在STM中安全使用）：&lt;br&gt;&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defn&lt;/span&gt;&lt;/span&gt; -main [] (&lt;span class=&quot;name&quot;&gt;start-server!&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;start-server！函数定义如下：&lt;br&gt;&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defn&lt;/span&gt;&lt;/span&gt; start-server!&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  []&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;try&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [conf *STORM-CONF*&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          header-buffer-size (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;int&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;.get&lt;/span&gt; conf UI-HEADER-BUFFER-BYTES))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          filters-confs [&amp;#123;&lt;span class=&quot;symbol&quot;&gt;:filter-class&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;conf&lt;/span&gt; UI-FILTER)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                          &lt;span class=&quot;symbol&quot;&gt;:filter-params&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;conf&lt;/span&gt; UI-FILTER-PARAMS)&amp;#125;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          https-port (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;if&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;not-nil?&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;conf&lt;/span&gt; UI-HTTPS-PORT)) (&lt;span class=&quot;name&quot;&gt;conf&lt;/span&gt; UI-HTTPS-PORT) &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          https-ks-path (&lt;span class=&quot;name&quot;&gt;conf&lt;/span&gt; UI-HTTPS-KEYSTORE-PATH)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          https-ks-password (&lt;span class=&quot;name&quot;&gt;conf&lt;/span&gt; UI-HTTPS-KEYSTORE-PASSWORD)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          https-ks-type (&lt;span class=&quot;name&quot;&gt;conf&lt;/span&gt; UI-HTTPS-KEYSTORE-TYPE)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          https-key-password (&lt;span class=&quot;name&quot;&gt;conf&lt;/span&gt; UI-HTTPS-KEY-PASSWORD)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          https-ts-path (&lt;span class=&quot;name&quot;&gt;conf&lt;/span&gt; UI-HTTPS-TRUSTSTORE-PATH)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          https-ts-password (&lt;span class=&quot;name&quot;&gt;conf&lt;/span&gt; UI-HTTPS-TRUSTSTORE-PASSWORD)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          https-ts-type (&lt;span class=&quot;name&quot;&gt;conf&lt;/span&gt; UI-HTTPS-TRUSTSTORE-TYPE)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          https-want-client-auth (&lt;span class=&quot;name&quot;&gt;conf&lt;/span&gt; UI-HTTPS-WANT-CLIENT-AUTH)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          https-need-client-auth (&lt;span class=&quot;name&quot;&gt;conf&lt;/span&gt; UI-HTTPS-NEED-CLIENT-AUTH)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (&lt;span class=&quot;name&quot;&gt;storm-run-jetty&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:port&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;conf&lt;/span&gt; UI-PORT)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &lt;span class=&quot;symbol&quot;&gt;:host&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;conf&lt;/span&gt; UI-HOST)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &lt;span class=&quot;symbol&quot;&gt;:https-port&lt;/span&gt; https-port&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &lt;span class=&quot;symbol&quot;&gt;:configurator&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;fn&lt;/span&gt;&lt;/span&gt; [server]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                        (&lt;span class=&quot;name&quot;&gt;config-ssl&lt;/span&gt; server&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                    https-port&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                    https-ks-path&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                    https-ks-password&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                    https-ks-type&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                    https-key-password&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                    https-ts-path&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                    https-ts-password&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                    https-ts-type&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                    https-need-client-auth&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                    https-want-client-auth)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                        (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;doseq&lt;/span&gt;&lt;/span&gt; [connector (&lt;span class=&quot;name&quot;&gt;.getConnectors&lt;/span&gt; server)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                          (&lt;span class=&quot;name&quot;&gt;.setRequestHeaderSize&lt;/span&gt; connector header-buffer-size))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                        (&lt;span class=&quot;name&quot;&gt;config-filter&lt;/span&gt; server app filters-confs))&amp;#125;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   (&lt;span class=&quot;name&quot;&gt;catch&lt;/span&gt; Exception ex&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     (&lt;span class=&quot;name&quot;&gt;log-error&lt;/span&gt; ex))))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;首先从conf配置项中取出http的相应参数，然后将这些配置项封装为map作为参数去调用&lt;strong&gt;storm-run-jetty&lt;/strong&gt;函数(helper.clj)，参数有:port，:host，:https-port，:configurator。storm-run-jetty函数定义如下：&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;;; Modified from ring.adapter.jetty 1.3.0&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(defn- jetty-create-server&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &quot;Construct a Jetty Server instance.&quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [options]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (let [connector (doto (SelectChannelConnector.)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    (.setPort (options :port 80))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    (.setHost (options :host))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    (.setMaxIdleTime (options :max-idle-time 200000)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        server    (doto (Server.)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    (.addConnector connector)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    (.setSendDateHeader true))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        https-port (options :https-port)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (if (and (not-nil? https-port) (&amp;gt; https-port 0)) (remove-non-ssl-connectors server))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    server))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(defn storm-run-jetty&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &quot;Modified version of run-jetty&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Assumes configurator sets handler.&quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [config]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#123;:pre [(:configurator config)]&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (let [#^Server s (jetty-create-server (dissoc config :configurator))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        configurator (:configurator config)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (configurator s)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (.start s)))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;storm-run-jetty的运行流程&lt;/strong&gt;：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;传入参数为：:port，:host，:https-port，:configurator。 其中:configurator是在start-server!中定义的参数，返回的是如下的函数，该函数首先利用https的传入参数初始化一个ssl connector，并将其添加到server中。然后对server中的每一个connector，设置HTTP请求头的buffer size，设置server的过滤器，再设置server的handle为app，主要通过config-filter函数(helper.clj)实现。。&lt;/p&gt;
 &lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;fn&lt;/span&gt;&lt;/span&gt; [server]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           (&lt;span class=&quot;name&quot;&gt;config-ssl&lt;/span&gt; server&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       https-port&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       https-ks-path&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       https-ks-password&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       https-ks-type&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       https-key-password&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       https-ts-path&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       https-ts-password&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       https-ts-type&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       https-need-client-auth&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       https-want-client-auth)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;doseq&lt;/span&gt;&lt;/span&gt; [connector (&lt;span class=&quot;name&quot;&gt;.getConnectors&lt;/span&gt; server)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             (&lt;span class=&quot;name&quot;&gt;.setRequestHeaderSize&lt;/span&gt; connector header-buffer-size))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           (&lt;span class=&quot;name&quot;&gt;config-filter&lt;/span&gt; server app filters-confs))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;在storm-run-jetty函数中首先调用jetty-create-server函数来创建一个jetty服务器对象：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;传入的参数为:port，:host，:https-port 。&lt;/li&gt;
&lt;li&gt;首先初始化一个SelectChannelConnector，设置端口（默认为80），设置host， 设置最大空闲时间（默认为200000ms），然后初始化一个Server， 添加连接器Connector，设置Http Header中发送日期。然后判断参数中是否存在https端口，如果存在的话，将Server中的所有不是SslSocketConnector实例的连接器删除。&lt;/li&gt;
&lt;li&gt;返回server&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;然后从storm-run-jetty函数参数中取出configurator函数，配置server对象，添加https连接器和过滤器，设置handle；&lt;/li&gt;
&lt;li&gt;最后启动服务器server.start()。 &lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;storm中的jetty服务器的&lt;strong&gt;handle的实现&lt;/strong&gt;是借助于Clojure中的web开发框架ring及其routing库Compojure来实现的，主要通过以下app代码来实现。即首先对&lt;strong&gt;main-routes路由函数&lt;/strong&gt;（后面介绍）添加中间件：包括request参数json化，parse multipart， 在发送request前重载namespace；捕捉错误并json化，然后作为参数调用handler/site函数；&lt;/p&gt;
&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;def&lt;/span&gt;&lt;/span&gt; app&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;handler/site&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt; main-routes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    (&lt;span class=&quot;name&quot;&gt;wrap-json-params&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    (&lt;span class=&quot;name&quot;&gt;wrap-multipart-params&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    (&lt;span class=&quot;name&quot;&gt;wrap-reload&lt;/span&gt; &#39;[backtype.storm.ui.core])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    catch-errors)))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;compojure.handler.site函数&lt;/strong&gt;的功能为：传入route函数，添加中间件，返回handle。&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Create a handler suitable &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; a standard website. This adds the&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;following middleware to your routes:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - wrap-session&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - wrap-flash&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - wrap-cookies&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - wrap-multipart-params&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - wrap-params&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - wrap-nested-params&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  - wrap-keyword-params&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;因此最后得到的app是一个handle。将app作为config-filter的参数执行以下代码：&lt;br&gt;&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defn&lt;/span&gt;&lt;/span&gt; config-filter [server handler filters-confs]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;if&lt;/span&gt;&lt;/span&gt; filters-confs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [servlet-holder (&lt;span class=&quot;name&quot;&gt;ServletHolder.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                           (&lt;span class=&quot;name&quot;&gt;ring.util.servlet/servlet&lt;/span&gt; handler))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          context (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;doto&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;org.eclipse.jetty.servlet.ServletContextHandler.&lt;/span&gt; server &lt;span class=&quot;string&quot;&gt;&quot;/&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    (&lt;span class=&quot;name&quot;&gt;.addServlet&lt;/span&gt; servlet-holder &lt;span class=&quot;string&quot;&gt;&quot;/&quot;&lt;/span&gt;))]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (&lt;span class=&quot;name&quot;&gt;.addFilter&lt;/span&gt; context (&lt;span class=&quot;name&quot;&gt;cors-filter-handler&lt;/span&gt;) &lt;span class=&quot;string&quot;&gt;&quot;/*&quot;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;EnumSet/allOf&lt;/span&gt; DispatcherType))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;doseq&lt;/span&gt;&lt;/span&gt; [&amp;#123;&lt;span class=&quot;symbol&quot;&gt;:keys&lt;/span&gt; [filter-name filter-class filter-params]&amp;#125; filters-confs]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;if&lt;/span&gt;&lt;/span&gt; filter-class&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [filter-holder (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;doto&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;org.eclipse.jetty.servlet.FilterHolder.&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                (&lt;span class=&quot;name&quot;&gt;.setClassName&lt;/span&gt; filter-class)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                (&lt;span class=&quot;name&quot;&gt;.setName&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;or&lt;/span&gt;&lt;/span&gt; filter-name filter-class))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                (&lt;span class=&quot;name&quot;&gt;.setInitParameters&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;or&lt;/span&gt;&lt;/span&gt; filter-params &amp;#123;&amp;#125;)))]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            (&lt;span class=&quot;name&quot;&gt;.addFilter&lt;/span&gt; context filter-holder &lt;span class=&quot;string&quot;&gt;&quot;/*&quot;&lt;/span&gt; FilterMapping/ALL))))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (&lt;span class=&quot;name&quot;&gt;.setHandler&lt;/span&gt; server context))))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这段代码的前面主要是添加filter。关键的最后一句server.setHandler(context) 函数会将前面得到的app作为jetty服务器的handle。这里注意：虽然默认的filters-confs参数是 &lt;strong&gt;{:filter-class  nil, :filter-params nil}&lt;/strong&gt;，但其并不是nil，所以&lt;strong&gt;if filters-confs&lt;/strong&gt;为true。&lt;/p&gt;
&lt;p&gt;最后再来看一下main-routes函数，其定义如下。这是ring框架提供的macro定义，主要定义了&lt;strong&gt;不同API路径的请求处理和响应返回&lt;/strong&gt;。&lt;/p&gt;
&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;defroutes&lt;/span&gt; main-routes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;GET&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;/api/v1/cluster/configuration&quot;&lt;/span&gt; [&amp;amp; m]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;json-response&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;cluster-configuration&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                   (&lt;span class=&quot;symbol&quot;&gt;:callback&lt;/span&gt; m) &lt;span class=&quot;symbol&quot;&gt;:serialize-fn&lt;/span&gt; identity))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;GET&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;/api/v1/cluster/summary&quot;&lt;/span&gt; [&lt;span class=&quot;symbol&quot;&gt;:as&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:keys&lt;/span&gt; [cookies servlet-request]&amp;#125; &amp;amp; m]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;populate-context!&lt;/span&gt; servlet-request)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;assert-authorized-user&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;getClusterInfo&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [user (&lt;span class=&quot;name&quot;&gt;get-user-name&lt;/span&gt; servlet-request)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (&lt;span class=&quot;name&quot;&gt;json-response&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;cluster-summary&lt;/span&gt; user) (&lt;span class=&quot;symbol&quot;&gt;:callback&lt;/span&gt; m))))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;GET&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;/api/v1/supervisor/summary&quot;&lt;/span&gt; [&lt;span class=&quot;symbol&quot;&gt;:as&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:keys&lt;/span&gt; [cookies servlet-request]&amp;#125; &amp;amp; m]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;populate-context!&lt;/span&gt; servlet-request)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;assert-authorized-user&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;getClusterInfo&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;json-response&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;supervisor-summary&lt;/span&gt;) (&lt;span class=&quot;symbol&quot;&gt;:callback&lt;/span&gt; m)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;GET&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;/api/v1/topology/summary&quot;&lt;/span&gt; [&lt;span class=&quot;symbol&quot;&gt;:as&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:keys&lt;/span&gt; [cookies servlet-request]&amp;#125; &amp;amp; m]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;populate-context!&lt;/span&gt; servlet-request)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;assert-authorized-user&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;getClusterInfo&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;json-response&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;all-topologies-summary&lt;/span&gt;) (&lt;span class=&quot;symbol&quot;&gt;:callback&lt;/span&gt; m)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;GET&lt;/span&gt;  &lt;span class=&quot;string&quot;&gt;&quot;/api/v1/topology/:id&quot;&lt;/span&gt; [&lt;span class=&quot;symbol&quot;&gt;:as&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:keys&lt;/span&gt; [cookies servlet-request scheme params]&amp;#125; id &amp;amp; m]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;populate-context!&lt;/span&gt; servlet-request)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;assert-authorized-user&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;getTopology&quot;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;topology-config&lt;/span&gt; id))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [user (&lt;span class=&quot;name&quot;&gt;.getUserName&lt;/span&gt; http-creds-handler servlet-request)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (&lt;span class=&quot;name&quot;&gt;json-response&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;topology-page&lt;/span&gt; id (&lt;span class=&quot;symbol&quot;&gt;:window&lt;/span&gt; m) (&lt;span class=&quot;name&quot;&gt;check-include-sys?&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:sys&lt;/span&gt; m)) user (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;=&lt;/span&gt;&lt;/span&gt; scheme &lt;span class=&quot;symbol&quot;&gt;:https&lt;/span&gt;)) (&lt;span class=&quot;symbol&quot;&gt;:callback&lt;/span&gt; m))))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;GET&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;/api/v1/topology/:id/visualization&quot;&lt;/span&gt; [&lt;span class=&quot;symbol&quot;&gt;:as&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:keys&lt;/span&gt; [cookies servlet-request]&amp;#125; id &amp;amp; m]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;populate-context!&lt;/span&gt; servlet-request)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;assert-authorized-user&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;getTopology&quot;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;topology-config&lt;/span&gt; id))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;json-response&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;mk-visualization-data&lt;/span&gt; id (&lt;span class=&quot;symbol&quot;&gt;:window&lt;/span&gt; m) (&lt;span class=&quot;name&quot;&gt;check-include-sys?&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:sys&lt;/span&gt; m))) (&lt;span class=&quot;symbol&quot;&gt;:callback&lt;/span&gt; m)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;GET&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;/api/v1/topology/:id/component/:component&quot;&lt;/span&gt; [&lt;span class=&quot;symbol&quot;&gt;:as&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:keys&lt;/span&gt; [cookies servlet-request scheme]&amp;#125; id component &amp;amp; m]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;populate-context!&lt;/span&gt; servlet-request)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;assert-authorized-user&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;getTopology&quot;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;topology-config&lt;/span&gt; id))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [user (&lt;span class=&quot;name&quot;&gt;.getUserName&lt;/span&gt; http-creds-handler servlet-request)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (&lt;span class=&quot;name&quot;&gt;json-response&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;component-page&lt;/span&gt; id component (&lt;span class=&quot;symbol&quot;&gt;:window&lt;/span&gt; m) (&lt;span class=&quot;name&quot;&gt;check-include-sys?&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:sys&lt;/span&gt; m)) user (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;=&lt;/span&gt;&lt;/span&gt; scheme &lt;span class=&quot;symbol&quot;&gt;:https&lt;/span&gt;)) (&lt;span class=&quot;symbol&quot;&gt;:callback&lt;/span&gt; m))))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;POST&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;/api/v1/topology/:id/activate&quot;&lt;/span&gt; [&lt;span class=&quot;symbol&quot;&gt;:as&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:keys&lt;/span&gt; [cookies servlet-request]&amp;#125; id &amp;amp; m]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;populate-context!&lt;/span&gt; servlet-request)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;assert-authorized-user&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;activate&quot;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;topology-config&lt;/span&gt; id))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;with-nimbus&lt;/span&gt; nimbus&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [tplg (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&amp;gt;&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;doto&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        (&lt;span class=&quot;name&quot;&gt;GetInfoOptions.&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        (&lt;span class=&quot;name&quot;&gt;.set_num_err_choice&lt;/span&gt; NumErrorsChoice/NONE))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      (&lt;span class=&quot;name&quot;&gt;.getTopologyInfoWithOpts&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;^Nimbus&lt;/span&gt;$Client nimbus id))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            name (&lt;span class=&quot;name&quot;&gt;.get_name&lt;/span&gt; tplg)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;.activate&lt;/span&gt; nimbus name)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;log-message&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Activating topology &#39;&quot;&lt;/span&gt; name &lt;span class=&quot;string&quot;&gt;&quot;&#39;&quot;&lt;/span&gt;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;json-response&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;topology-op-response&lt;/span&gt; id &lt;span class=&quot;string&quot;&gt;&quot;activate&quot;&lt;/span&gt;) (&lt;span class=&quot;name&quot;&gt;m&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;callback&quot;&lt;/span&gt;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;POST&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;/api/v1/topology/:id/deactivate&quot;&lt;/span&gt; [&lt;span class=&quot;symbol&quot;&gt;:as&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:keys&lt;/span&gt; [cookies servlet-request]&amp;#125; id &amp;amp; m]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;populate-context!&lt;/span&gt; servlet-request)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;assert-authorized-user&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;deactivate&quot;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;topology-config&lt;/span&gt; id))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;with-nimbus&lt;/span&gt; nimbus&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [tplg (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&amp;gt;&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;doto&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        (&lt;span class=&quot;name&quot;&gt;GetInfoOptions.&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        (&lt;span class=&quot;name&quot;&gt;.set_num_err_choice&lt;/span&gt; NumErrorsChoice/NONE))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      (&lt;span class=&quot;name&quot;&gt;.getTopologyInfoWithOpts&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;^Nimbus&lt;/span&gt;$Client nimbus id))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            name (&lt;span class=&quot;name&quot;&gt;.get_name&lt;/span&gt; tplg)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;.deactivate&lt;/span&gt; nimbus name)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;log-message&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Deactivating topology &#39;&quot;&lt;/span&gt; name &lt;span class=&quot;string&quot;&gt;&quot;&#39;&quot;&lt;/span&gt;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;json-response&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;topology-op-response&lt;/span&gt; id &lt;span class=&quot;string&quot;&gt;&quot;deactivate&quot;&lt;/span&gt;) (&lt;span class=&quot;name&quot;&gt;m&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;callback&quot;&lt;/span&gt;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;POST&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;/api/v1/topology/:id/rebalance/:wait-time&quot;&lt;/span&gt; [&lt;span class=&quot;symbol&quot;&gt;:as&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:keys&lt;/span&gt; [cookies servlet-request]&amp;#125; id wait-time &amp;amp; m]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;populate-context!&lt;/span&gt; servlet-request)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;assert-authorized-user&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;rebalance&quot;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;topology-config&lt;/span&gt; id))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;with-nimbus&lt;/span&gt; nimbus&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [tplg (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&amp;gt;&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;doto&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        (&lt;span class=&quot;name&quot;&gt;GetInfoOptions.&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        (&lt;span class=&quot;name&quot;&gt;.set_num_err_choice&lt;/span&gt; NumErrorsChoice/NONE))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      (&lt;span class=&quot;name&quot;&gt;.getTopologyInfoWithOpts&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;^Nimbus&lt;/span&gt;$Client nimbus id))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            name (&lt;span class=&quot;name&quot;&gt;.get_name&lt;/span&gt; tplg)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            rebalance-options (&lt;span class=&quot;name&quot;&gt;m&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;rebalanceOptions&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            options (&lt;span class=&quot;name&quot;&gt;RebalanceOptions.&lt;/span&gt;)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;.set_wait_secs&lt;/span&gt; options (&lt;span class=&quot;name&quot;&gt;Integer/parseInt&lt;/span&gt; wait-time))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;if&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;and&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;not-nil?&lt;/span&gt; rebalance-options) (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;contains?&lt;/span&gt;&lt;/span&gt; rebalance-options &lt;span class=&quot;string&quot;&gt;&quot;numWorkers&quot;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          (&lt;span class=&quot;name&quot;&gt;.set_num_workers&lt;/span&gt; options (&lt;span class=&quot;name&quot;&gt;Integer/parseInt&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;.toString&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;rebalance-options&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;numWorkers&quot;&lt;/span&gt;)))))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;if&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;and&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;not-nil?&lt;/span&gt; rebalance-options) (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;contains?&lt;/span&gt;&lt;/span&gt; rebalance-options &lt;span class=&quot;string&quot;&gt;&quot;executors&quot;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;doseq&lt;/span&gt;&lt;/span&gt; [keyval (&lt;span class=&quot;name&quot;&gt;rebalance-options&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;executors&quot;&lt;/span&gt;)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            (&lt;span class=&quot;name&quot;&gt;.put_to_num_executors&lt;/span&gt; options (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;key&lt;/span&gt;&lt;/span&gt; keyval) (&lt;span class=&quot;name&quot;&gt;Integer/parseInt&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;.toString&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;val&lt;/span&gt;&lt;/span&gt; keyval))))))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;.rebalance&lt;/span&gt; nimbus name options)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;log-message&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Rebalancing topology &#39;&quot;&lt;/span&gt; name &lt;span class=&quot;string&quot;&gt;&quot;&#39; with wait time: &quot;&lt;/span&gt; wait-time &lt;span class=&quot;string&quot;&gt;&quot; secs&quot;&lt;/span&gt;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;json-response&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;topology-op-response&lt;/span&gt; id &lt;span class=&quot;string&quot;&gt;&quot;rebalance&quot;&lt;/span&gt;) (&lt;span class=&quot;name&quot;&gt;m&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;callback&quot;&lt;/span&gt;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;POST&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;/api/v1/topology/:id/kill/:wait-time&quot;&lt;/span&gt; [&lt;span class=&quot;symbol&quot;&gt;:as&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:keys&lt;/span&gt; [cookies servlet-request]&amp;#125; id wait-time &amp;amp; m]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;populate-context!&lt;/span&gt; servlet-request)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;assert-authorized-user&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;killTopology&quot;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;topology-config&lt;/span&gt; id))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;with-nimbus&lt;/span&gt; nimbus&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [tplg (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&amp;gt;&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;doto&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        (&lt;span class=&quot;name&quot;&gt;GetInfoOptions.&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        (&lt;span class=&quot;name&quot;&gt;.set_num_err_choice&lt;/span&gt; NumErrorsChoice/NONE))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      (&lt;span class=&quot;name&quot;&gt;.getTopologyInfoWithOpts&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;^Nimbus&lt;/span&gt;$Client nimbus id))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            name (&lt;span class=&quot;name&quot;&gt;.get_name&lt;/span&gt; tplg)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            options (&lt;span class=&quot;name&quot;&gt;KillOptions.&lt;/span&gt;)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;.set_wait_secs&lt;/span&gt; options (&lt;span class=&quot;name&quot;&gt;Integer/parseInt&lt;/span&gt; wait-time))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;.killTopologyWithOpts&lt;/span&gt; nimbus name options)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;log-message&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Killing topology &#39;&quot;&lt;/span&gt; name &lt;span class=&quot;string&quot;&gt;&quot;&#39; with wait time: &quot;&lt;/span&gt; wait-time &lt;span class=&quot;string&quot;&gt;&quot; secs&quot;&lt;/span&gt;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;json-response&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;topology-op-response&lt;/span&gt; id &lt;span class=&quot;string&quot;&gt;&quot;kill&quot;&lt;/span&gt;) (&lt;span class=&quot;name&quot;&gt;m&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;callback&quot;&lt;/span&gt;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;GET&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;/&quot;&lt;/span&gt; [&lt;span class=&quot;symbol&quot;&gt;:as&lt;/span&gt; &amp;#123;cookies &lt;span class=&quot;symbol&quot;&gt;:cookies&lt;/span&gt;&amp;#125;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;resp/redirect&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;/index.html&quot;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;route/resources&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;/&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;route/not-found&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Page not found&quot;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;其中：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;json-response函数用于将得到的response转换为json格式；&lt;/li&gt;
&lt;li&gt;populate-context!函数用于将servlet-request对象转换为storm的RequestContext对象，即backtype.storm.security.auth.ReqContext （src/jvm/backtype/storm/security/auth/ReqContext.java），主要是用于添加用户认证的插件，插件只需要实现IHttpCredentialsPlugin接口即可。没有做详细了解。&lt;/li&gt;
&lt;li&gt;assert-authorized-user也是验证用户操作权限的；&lt;/li&gt;
&lt;li&gt;&lt;p&gt;with-nimbus是一个宏，用于建立一个与thrift server的客户端连接，代码如下, 首先初始化一个ReqContext上下文对象，获取用户名，然后与storm thirift server建立连接，执行body所代表的操作。&lt;strong&gt;其中nimbus-sym是一个符号参数，其会在with-nimbus-connection-as-user中被赋值为NimbusClient对象，用于在执行body代码是作为参数；&lt;/strong&gt;&lt;/p&gt;
  &lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; src/clj/backtype/storm/ui/core.clj&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defmacro&lt;/span&gt;&lt;/span&gt; with-nimbus&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [nimbus-sym &amp;amp; body]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  `(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [context# (&lt;span class=&quot;name&quot;&gt;ReqContext/context&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         user# (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;if&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;.principal&lt;/span&gt; context#) (&lt;span class=&quot;name&quot;&gt;.getName&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;.principal&lt;/span&gt; context#)))]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;thrift/with-nimbus-connection-as-user&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       [~nimbus-sym (&lt;span class=&quot;name&quot;&gt;*STORM-CONF*&lt;/span&gt; NIMBUS-HOST) (&lt;span class=&quot;name&quot;&gt;*STORM-CONF*&lt;/span&gt; NIMBUS-THRIFT-PORT) user#]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       ~@body)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; src/clj/backtype/storm/thrift.clj&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defmacro&lt;/span&gt;&lt;/span&gt; with-nimbus-connection-as-user&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [[client-sym host port as-user] &amp;amp; body]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  `(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [[&lt;span class=&quot;comment&quot;&gt;^Nimbus&lt;/span&gt;$Client ~client-sym &lt;span class=&quot;comment&quot;&gt;^TTransport&lt;/span&gt; conn#] (&lt;span class=&quot;name&quot;&gt;nimbus-client-and-conn&lt;/span&gt; ~host ~port ~as-user)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;try&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       ~@body&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       (&lt;span class=&quot;name&quot;&gt;finally&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;.close&lt;/span&gt; conn#)))))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;  比如&lt;strong&gt;active API&lt;/strong&gt;的代码如下：在建立与服务器的连接后得到了&lt;strong&gt;NimbusCilent对象nimbus&lt;/strong&gt;，调用其.getTopologyInfoWithOpts函数，得到TopologyInfo 对象，进而得到topology name，然后调用active方法激活topology；&lt;/p&gt;
&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;with-nimbus&lt;/span&gt; nimbus&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [tplg (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&amp;gt;&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;doto&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        (&lt;span class=&quot;name&quot;&gt;GetInfoOptions.&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        (&lt;span class=&quot;name&quot;&gt;.set_num_err_choice&lt;/span&gt; NumErrorsChoice/NONE))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      (&lt;span class=&quot;name&quot;&gt;.getTopologyInfoWithOpts&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;^Nimbus&lt;/span&gt;$Client nimbus id))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            name (&lt;span class=&quot;name&quot;&gt;.get_name&lt;/span&gt; tplg)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;.activate&lt;/span&gt; nimbus name)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;log-message&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Activating topology &#39;&quot;&lt;/span&gt; name &lt;span class=&quot;string&quot;&gt;&quot;&#39;&quot;&lt;/span&gt;)))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;note：jetty服务器API是org.eclipse.jetty.server这个包提供的。&lt;/p&gt;
&lt;p&gt;至此整个UI进程的启动和运行过程已经解析完毕。下一步是解析UI界面上的数据来源。 请参考下一篇博客。&lt;/p&gt;
&lt;p&gt;&lt;br&gt; &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com&lt;/strong&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;#Storm源码分析——UI界面显示代码分析&lt;/p&gt;
&lt;p&gt;storm开发环境的配置请参考：&lt;a href=&quot;http://yanjiankang.cn/Storm-sourcecode-analize-tools/&quot;&gt;storm源码分析——工具篇&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;s
    
    </summary>
    
      <category term="集群技术" scheme="http://yanjiankang.cn/categories/%E9%9B%86%E7%BE%A4%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="storm" scheme="http://yanjiankang.cn/tags/storm/"/>
    
      <category term="UI" scheme="http://yanjiankang.cn/tags/UI/"/>
    
  </entry>
  
  <entry>
    <title>Storm 源码分析——工具篇</title>
    <link href="http://yanjiankang.cn/Storm-sourcecode-analize-tools/"/>
    <id>http://yanjiankang.cn/Storm-sourcecode-analize-tools/</id>
    <published>2016-04-07T08:12:59.864Z</published>
    <updated>2016-02-02T12:24:13.000Z</updated>
    
    <content type="html">&lt;p&gt;&lt;strong&gt;工欲善其事，必先利其器。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;在开始分析storm源码之前，一个好的阅读代码的环境是非常有帮助的。&lt;br&gt;storm的代码包括：核心功能的Clojure代码，对外接口的java 代码，RPC通信的thrift代码，bin中客户端命令的python代码等。&lt;/p&gt;
&lt;p&gt;虽然可以在命令行使用vim直接阅读，但是对于对storm还不熟悉的像我这样的小白，我的建议是使用IDE效率会更高。&lt;/p&gt;
&lt;h2 id=&quot;Intellij-idea-Cursive&quot;&gt;&lt;a href=&quot;#Intellij-idea-Cursive&quot; class=&quot;headerlink&quot; title=&quot;Intellij idea + Cursive&quot;&gt;&lt;/a&gt;Intellij idea + Cursive&lt;/h2&gt;&lt;p&gt;我的推荐是：&lt;strong&gt;Intellij idea + Cursive&lt;/strong&gt; （一开始我是用的是Eclipse，但是对于Clojure的支持并不是很好，直到我发现了Cursive）&lt;/p&gt;
&lt;p&gt;Intellij idea的安装可以直接从其官网下载：&lt;a href=&quot;https://www.jetbrains.com/idea/download/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.jetbrains.com/idea/download/&lt;/a&gt;&lt;br&gt;免费的Community版本功能就足够使用；&lt;/p&gt;
&lt;p&gt;我是CentOS系统，下载的linux版本，下载后解压运行即可：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#Unpack the idea idea-15.0.3.tar.gz file using the following command: &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;tar xfz idea-15.0.3.tar.gz&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#Run idea.sh from the bin subdirectory.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后&lt;strong&gt;安装Cursive 插件&lt;/strong&gt;：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/idea-install-cursive-1.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;运行idea，点击configure，再点击setting。&lt;/p&gt;
&lt;p&gt;然后点击plugins：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/idea-install-cursive-2.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;再点击底下的Browse repositories， &lt;/p&gt;
&lt;p&gt;然后搜索cursive，点击Install ，我这边因为已经安装过了，所以没有install的按钮：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/idea-install-cursive-3.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;安装后重启idea，进入Cursive会提示需要license， 去他的官网&lt;a href=&quot;https://cursive-ide.com/申请一个免费的即可：&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://cursive-ide.com/申请一个免费的即可：&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;点击首页的Get a License按钮，如下填写后：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/idea-install-cursive-4.png&quot; alt=&quot;enter image description here&quot;&gt;&lt;/p&gt;
&lt;p&gt;会将License发送到你的邮箱。&lt;/p&gt;
&lt;p&gt;至此安装完成。&lt;/p&gt;
&lt;h2 id=&quot;安装storm编译依赖&quot;&gt;&lt;a href=&quot;#安装storm编译依赖&quot; class=&quot;headerlink&quot; title=&quot;安装storm编译依赖&quot;&gt;&lt;/a&gt;安装storm编译依赖&lt;/h2&gt;&lt;p&gt;按照storm的开发文档&lt;a href=&quot;https://www.zybuluo.com/yanhealth/note/281972的说明，storm的编译依赖python&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.zybuluo.com/yanhealth/note/281972的说明，storm的编译依赖python&lt;/a&gt;, ruby 和nodejs，需要预先安装：&lt;/p&gt;
&lt;p&gt;The ruby package manager rvm and nodejs package manager nvm are for convenience and are used in the tests which run on travis. (ruby的包管理器rvm和nodejs的包管理器nvm是用于在 travis (&lt;a href=&quot;https://en.wikipedia.org/wiki/Travis_CI&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://en.wikipedia.org/wiki/Travis_CI&lt;/a&gt;) 上的测试的) 。可以用如下命令安装：&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;curl -L https://get.rvm.io | bash &lt;span class=&quot;_&quot;&gt;-s&lt;/span&gt; stable --autolibs=enabled &amp;amp;&amp;amp; &lt;span class=&quot;built_in&quot;&gt;source&lt;/span&gt; ~/.profile&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;wget -qO- https://raw.githubusercontent.com/creationix/nvm/v0.26.1/install.sh | bash &amp;amp;&amp;amp; &lt;span class=&quot;built_in&quot;&gt;source&lt;/span&gt; ~/.bashrc&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;安装好以后运行如下命令：&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;rvm use 2.1.5 --install&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nvm install 0.12.2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nvm use 0.12.2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;导入Storm-core项目&quot;&gt;&lt;a href=&quot;#导入Storm-core项目&quot; class=&quot;headerlink&quot; title=&quot;导入Storm-core项目&quot;&gt;&lt;/a&gt;导入Storm-core项目&lt;/h2&gt;&lt;p&gt;在官网下载storm的源代码并解压后，在idea点击import，然后选择storm源码目录下的storm-core：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-1.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;然后下一步，选择Maven：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-2.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;next，默认就可以：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-3.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-4.png&quot; alt=&quot;enter image description here&quot;&gt;&lt;/p&gt;
&lt;p&gt;然后选择安装的jdk的位置，我选的版本1.7，没有安装需要先安装jdk；&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-5.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;导入后会开始解决依赖问题：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-6.png&quot; alt=&quot;enter image description here&quot;&gt;&lt;/p&gt;
&lt;p&gt;然后添加一个maven的打包操作：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-7.png&quot; alt=&quot;enter image description here&quot;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-8.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;此处-DskipTests=true ，是指跳过打包时的测试阶段，因为我的版本中测试会失败。同时也可以节省时间。&lt;/p&gt;
&lt;p&gt;最后运行打包命令，会在storm-core项目根目录下的target中生成jar包文件：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-9.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;h2 id=&quot;如何编译storm生成可以发布的binary版本&quot;&gt;&lt;a href=&quot;#如何编译storm生成可以发布的binary版本&quot; class=&quot;headerlink&quot; title=&quot;如何编译storm生成可以发布的binary版本&quot;&gt;&lt;/a&gt;如何编译storm生成可以发布的binary版本&lt;/h2&gt;&lt;p&gt;以下命令可以将storm编译后安装到本地的.m2库中&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;mvn clean install  &lt;span class=&quot;comment&quot;&gt;# 可加上-DskipTests=true 跳过测试&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果你需要对storm源代码进行改动，并且希望生成binary版本的话，可以按照storm的Develper教程&lt;a href=&quot;https://www.zybuluo.com/yanhealth/note/281972来操作：&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://www.zybuluo.com/yanhealth/note/281972来操作：&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# First, build the code. 首先在storm根目录下install&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ mvn clean install &lt;span class=&quot;comment&quot;&gt;# you may skip tests with `-DskipTests=true` to save time&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Create the binary distribution. &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ &lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; storm-dist/binary &amp;amp;&amp;amp; mvn package&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;至此，基本上storm的整个环境配置完成。可以开始storm源代码的阅读和二次开发。&lt;/p&gt;
&lt;h2 id=&quot;storm的代码结构&quot;&gt;&lt;a href=&quot;#storm的代码结构&quot; class=&quot;headerlink&quot; title=&quot;storm的代码结构&quot;&gt;&lt;/a&gt;storm的代码结构&lt;/h2&gt;&lt;h3 id=&quot;Java-storm-core-src-jvm&quot;&gt;&lt;a href=&quot;#Java-storm-core-src-jvm&quot; class=&quot;headerlink&quot; title=&quot;Java   (storm-core/src/jvm/)&quot;&gt;&lt;/a&gt;Java   (storm-core/src/jvm/)&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;backtype.storm.coordination&lt;/strong&gt;: 实现了DRPC和事务性topology里用到的基于Storm的批处理功能。这个包里最重要得类是CoordinatedBolt&lt;br&gt;&lt;strong&gt;backtype.storm.drpc&lt;/strong&gt;: DRPC的更高层次抽象的具体实现&lt;br&gt;&lt;strong&gt;backtype.storm.generated&lt;/strong&gt;: 自动生成的Thrift代码（利用这里folk出来的Thrift版本生成的，主要是把org.apache.thrift包重命名成org.apache.thrift7来避免与其他Thrift版本的冲突）&lt;br&gt;&lt;strong&gt;backtype.storm.grouping&lt;/strong&gt;: 包含了用户实现自定义stream分组类时需要用到的接口&lt;br&gt;&lt;strong&gt;backtype.storm.hooks&lt;/strong&gt;: 定义了处理storm各种事件的钩子接口，例如当task发射tuple时、当tuple被ack时。关于钩子的手册详见这里&lt;br&gt;&lt;strong&gt;backtype.storm.serialization&lt;/strong&gt;: storm序列化/反序列化tuple的实现。在Kryo之上构建。&lt;br&gt;&lt;strong&gt;backtype.storm.spout&lt;/strong&gt;: spout及相关接口的定义（例如”SpoutOutputCollector”）。也包括了”ShellSpout”来实现非JVM语言定义spout的协议。&lt;br&gt;&lt;strong&gt;backtype.storm.task:&lt;/strong&gt; bolt及相关接口的定义（例如”OutputCollector”）。也包括了”ShellBolt”来实现非JVM语言定义bolt的协议。最后，”TopologyContext”也是在这里定义的，用来在运行时供spout和bolt使用以获取topology的执行信息。&lt;br&gt;&lt;strong&gt;backtype.storm.testing&lt;/strong&gt;: 包括了storm单元测试中用到的各种测试bolt及工具。&lt;br&gt;&lt;strong&gt;backtype.storm.topology&lt;/strong&gt;: 在Thrift结构之上的Java层，用以提供一个纯Java API来使用Storm（用户不需要了解Thrift的细节）。”TopologyBuilder”及不同spout和bolt的基类们也在这里定义。稍高一层次的接口”IBasicBolt”也在这里定义，它会使得创建某些特定类型的bolt会更加简洁。&lt;br&gt;&lt;strong&gt;backtype.storm.transactional&lt;/strong&gt;: 包括了事务性topology的实现。&lt;br&gt;&lt;strong&gt;backtype.storm.tuple&lt;/strong&gt;: 包括Storm中tuple数据模型的实现。&lt;br&gt;&lt;strong&gt;backtype.storm.utils&lt;/strong&gt;: 包含了Storm源码中用到的数据结构及各种工具类。&lt;/p&gt;
&lt;h3 id=&quot;Clojure-storm-core-src-clj&quot;&gt;&lt;a href=&quot;#Clojure-storm-core-src-clj&quot; class=&quot;headerlink&quot; title=&quot;Clojure  (storm-core/src/clj/)&quot;&gt;&lt;/a&gt;Clojure  (storm-core/src/clj/)&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;backtype.storm.bootstrap&lt;/strong&gt;: 包括了1个有用的宏来引入源码中用到的所有类及命名空间。&lt;br&gt;&lt;strong&gt;backtype.storm.clojure&lt;/strong&gt;: 包括了利用Clojure为Storm定义的特定领域语言(DSL)。&lt;br&gt;&lt;strong&gt;backtype.storm.cluster&lt;/strong&gt;: Storm守护进程中用到的Zookeeper逻辑都封装在这个文件中。这部分代码提供了API来将整个集群的运行状态映射到Zookeeper的”文件系统”上（例如哪里运行着怎样的task，每个task运行的是哪个spout/bolt）。&lt;br&gt;&lt;strong&gt;backtype.storm.command&lt;/strong&gt;.&lt;em&gt;: 这些命名空间包括了各种”storm xxx”开头的客户端命令行的命令实现。这些实现都很简短。&lt;br&gt;&lt;strong&gt;backtype.storm.config&lt;/strong&gt;: Clojure中config的读取/解析实现。同时也包括了工具函数来告诉nimbus、supervisor等守护进程在各种情况下应该使用哪些本地目录。例如：”master-inbox”函数会返回本地目录告诉Nimbus应该将上传给它的jar包保存到哪里。&lt;br&gt;&lt;strong&gt;backtype.storm.daemon.acker&lt;/strong&gt;: “acker” bolt的实现。这是Storm确保数据被完全处理的关键组成部分。&lt;br&gt;&lt;strong&gt;backtype.storm.daemon.common&lt;/strong&gt;: Storm守护进程用到的公共函数，例如根据topology的名字获取其id，将1个用户定义的topology映射到真正运行的topology（真正运行的topology是在用户定义的topology基础上添加了ack stream及acker bolt，参见system-topology!函数），同时包括了各种心跳及Storm中其他数据结构的定义。&lt;br&gt;&lt;strong&gt;backtype.storm.daemon.drpc&lt;/strong&gt;: 包括了DRPC服务器的实现，用来与DRPC topology一起使用。&lt;br&gt;&lt;strong&gt;backtype.storm.daemon.nimbus&lt;/strong&gt;: 包括了Nimbus的实现。&lt;br&gt;&lt;strong&gt;backtype.storm.daemon.supervisor&lt;/strong&gt;: 包括了Supervisor的实现。&lt;br&gt;&lt;strong&gt;backtype.storm.daemon.task&lt;/strong&gt;: 包括了spout或bolt的task实例实现。包括了处理消息路由、序列化、为UI提供的统计集合及spout、bolt执行动作的实现。&lt;br&gt;&lt;strong&gt;backtype.storm.daemon.worker&lt;/strong&gt;: 包括了worker进程（1个worker包含很多的task）的实现。包括了消息传输和task启动的实现。&lt;br&gt;&lt;strong&gt;backtype.storm.event&lt;/strong&gt;: 包括了1个简单的异步函数的执行器。Nimbus和Supervisor很多场合都用到了异步函数执行器来避免资源竞争。&lt;br&gt;&lt;strong&gt;backtype.storm.log&lt;/strong&gt;: 定义了用来输出log信息给log4j的函数。&lt;br&gt;&lt;strong&gt;backtype.storm.messaging&lt;/strong&gt;.&lt;/em&gt;: 定义了1个高一层次的接口来实现点对点的消息通讯。工作在本地模式时Storm会使用内存中的Java队列来模拟消息传递。工作在集群模式时，消息传递使用的是ZeroMQ。通用的接口在protocol.clj中定义。&lt;br&gt;&lt;strong&gt;backtype.storm.stats&lt;/strong&gt;: 实现了向Zookeeper中写入UI使用的统计信息时如何进行汇总。实现了不同粒度的聚合。&lt;br&gt;&lt;strong&gt;backtype.storm.testing&lt;/strong&gt;: 包括了测试Storm topology的工具。包括时间仿真，运行一组固定数量的tuple然后获得输出快照的”complete-topology”，”tracker topology”可以在集群”空闲”时做更细粒度的控制操作，以及其他工具。&lt;br&gt;&lt;strong&gt;backtype.storm.thrift&lt;/strong&gt;: 包括了自动生成的Thrift API的Clojure封装以使得使用Thrift结构更加便利。&lt;br&gt;&lt;strong&gt;backtype.storm.timer&lt;/strong&gt;: 实现了1个后台定时器来延迟执行函数或者定时轮询执行。Storm不能使用Java里的Timer类，因为为了单测Nimbus和Supervisor，必须要与时间仿真集成起来使用。&lt;br&gt;&lt;strong&gt;backtype.storm.ui.*&lt;/strong&gt;: Storm UI的实现。完全独立于其他的代码，通过Nimbus的Thrift API来获取需要的数据。&lt;br&gt;&lt;strong&gt;backtype.storm.util&lt;/strong&gt;: 包括了Storm代码中用到的通用工具函数。&lt;br&gt;&lt;strong&gt;backtype.storm.zookeeper&lt;/strong&gt;: 包括了Clojure对Zookeeper API的封装，同时也提供了一些高一层次的操作例如：”mkdirs”、”delete-recursive”&lt;/p&gt;
&lt;h3 id=&quot;Thrift-（storm-core-src-storm-thrift）&quot;&gt;&lt;a href=&quot;#Thrift-（storm-core-src-storm-thrift）&quot; class=&quot;headerlink&quot; title=&quot;Thrift （storm-core/src/storm.thrift）&quot;&gt;&lt;/a&gt;Thrift （storm-core/src/storm.thrift）&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;storm.thrift&lt;/strong&gt;: RPC服务的通信接口定义&lt;br&gt;&lt;strong&gt;genthrift.sh&lt;/strong&gt;: 将storm.thrift文件中定义的结构编译转换为java代码(backtype.storm.generated)的脚本文件&lt;/p&gt;
&lt;h3 id=&quot;Web-UI-storm-core-src-ui&quot;&gt;&lt;a href=&quot;#Web-UI-storm-core-src-ui&quot; class=&quot;headerlink&quot; title=&quot;Web UI (storm-core/src/ui)&quot;&gt;&lt;/a&gt;Web UI (storm-core/src/ui)&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;src/ui&lt;/strong&gt; : 定义storm UI界面的网页文件资源&lt;/p&gt;
&lt;p&gt;&lt;br&gt; &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h2&gt;&lt;p&gt;[1] &lt;a href=&quot;https://github.com/apache/storm&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/apache/storm&lt;/a&gt;&lt;br&gt;[2]  &lt;a href=&quot;http://blog.csdn.net/pelick/article/details/17682477&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Storm源码结构 (来源Storm Github Wiki)&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;工欲善其事，必先利其器。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;在开始分析storm源码之前，一个好的阅读代码的环境是非常有帮助的。&lt;br&gt;storm的代码包括：核心功能的Clojure代码，对外接口的java 代码，RPC通信的thrift代码，bin中客户端命
    
    </summary>
    
      <category term="集群技术" scheme="http://yanjiankang.cn/categories/%E9%9B%86%E7%BE%A4%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="storm" scheme="http://yanjiankang.cn/tags/storm/"/>
    
      <category term="idea" scheme="http://yanjiankang.cn/tags/idea/"/>
    
      <category term="Clojure" scheme="http://yanjiankang.cn/tags/Clojure/"/>
    
      <category term="cursive" scheme="http://yanjiankang.cn/tags/cursive/"/>
    
  </entry>
  
  <entry>
    <title>Storm源码阅读学习笔记之一(待整理)</title>
    <link href="http://yanjiankang.cn/storm-source-study-note-01/"/>
    <id>http://yanjiankang.cn/storm-source-study-note-01/</id>
    <published>2016-04-07T08:12:59.862Z</published>
    <updated>2015-12-28T08:56:42.000Z</updated>
    
    <content type="html">&lt;ol&gt;
&lt;li&gt;&lt;p&gt;宏 for 和 doseq 可以用来做 list comprehension. 它们支持遍历多个集合 ( 最右边的最快 ) ,同时还可以做一些过滤用 :when 和 :while 。 宏 for 只接受一个表达式 ,它返回一个懒惰集合作为结果 . 宏 doseq 接受任意数量的表达式 , 以有副作用的方式执行它们 , 并且返回 nil;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;$符号用于取代java包之间的点;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;定义zookeeper的连接状态&lt;/p&gt;
 &lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;def&lt;/span&gt;&lt;/span&gt; zk-keeper-states&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;Watcher$Event$KeeperState/Disconnected &lt;span class=&quot;symbol&quot;&gt;:disconnected&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Watcher$Event$KeeperState/SyncConnected &lt;span class=&quot;symbol&quot;&gt;:connected&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Watcher$Event$KeeperState/AuthFailed &lt;span class=&quot;symbol&quot;&gt;:auth-failed&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Watcher$Event$KeeperState/Expired &lt;span class=&quot;symbol&quot;&gt;:expired&lt;/span&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;定义zookeeper监听事件类型&lt;/p&gt;
 &lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;def&lt;/span&gt;&lt;/span&gt; zk-event-types&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#123;Watcher$Event$EventType/None &lt;span class=&quot;symbol&quot;&gt;:none&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Watcher$Event$EventType/NodeCreated &lt;span class=&quot;symbol&quot;&gt;:node-created&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Watcher$Event$EventType/NodeDeleted &lt;span class=&quot;symbol&quot;&gt;:node-deleted&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Watcher$Event$EventType/NodeDataChanged &lt;span class=&quot;symbol&quot;&gt;:node-data-changed&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Watcher$Event$EventType/NodeChildrenChanged &lt;span class=&quot;symbol&quot;&gt;:node-children-changed&lt;/span&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;defn-定义私有函数&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;storm中广泛使用defnk: 和普通defn的不同是, 可以在参数里面使用k,v, 并且可以在函数体中直接使用k来得到value, 也可以在指定参数时给定k的默认值, 其实它的实现就是增加一个hashmap来存放这些k,v&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;storm中zookeeper.clj中采用Curator作为zookeeper的客户端连接, Curator是Netflix公司开源的一个Zookeeper客户端，与Zookeeper提供的原生客户端相比，Curator的抽象层次更高，简化了Zookeeper客户端的开发量。&lt;br&gt;backtype.storm.utils 中用java代码定义了newCurator的构造方法; &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;今天的工作主要是导入storm到eclipse中去,遇到很多问题;&lt;br&gt;When building a WAR with “lein ring uberwar” and if ring-servlet is only in the lib/dev directory but not in the lib directory, ring-servlet is not added to the WAR.When deploying the WAR, for instance on Jetty, one get the following error:&lt;br&gt;“Could not locate ring/util/servlet__init.class or ring/util/servlet.clj on classpath”.&lt;br&gt;A temporary work around is to explicitly adds [ring/ring-servlet “1.0.1”] to the list of dependencies in the project.clj.  我添加了ring-servlet到pom中,错误消失; &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;reify 用来 实现java的接口, 如下例所示:&lt;/p&gt;
 &lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;myJButton.addActionListener(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ActionListener() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;actionPerformed&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(ActionEvent e)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;span class=&quot;comment&quot;&gt;// do something here&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125; &amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
 &lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;.addActionListener&lt;/span&gt; my-jbutton&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;proxy&lt;/span&gt;&lt;/span&gt; [ActionListener] []&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         (&lt;span class=&quot;name&quot;&gt;actionPerformed&lt;/span&gt; [evt]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             &lt;span class=&quot;comment&quot;&gt;;; (do something here)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          ))) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;.addActionListener&lt;/span&gt; my-jbutton&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;reify&lt;/span&gt;&lt;/span&gt; ActionListener&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         (&lt;span class=&quot;name&quot;&gt;actionPerformed&lt;/span&gt; [this evt]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 &lt;span class=&quot;comment&quot;&gt;;; (do something here)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         )))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;“..” 是同时调用两个函数的简写: 即 方法调用可以用 .. 宏串起来; &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Curator 框架事件类型&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Enum CuratorEventType : &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CHILDREN&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Corresponds to CuratorFramework.getChildren()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CLOSING&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Event sent when client is being closed&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CREATE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Corresponds to CuratorFramework.create()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;DELETE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Corresponds to CuratorFramework.delete()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;EXISTS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Corresponds to CuratorFramework.checkExists()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;GET_ACL&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Corresponds to CuratorFramework.getACL()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;GET_DATA&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Corresponds to CuratorFramework.getData()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SET_ACL&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Corresponds to CuratorFramework.setACL()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SET_DATA&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Corresponds to CuratorFramework.setData()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SYNC&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Corresponds to CuratorFramework.sync(String, Object)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;WATCHED&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Corresponds to Watchable.usingWatcher(Watcher) or Watchable.watched()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Clojure 函数参数中可以使用^符号+参数类型来限定参数类型; &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Clojure方法调用可以用 .. 宏串起来 并不是有几个串联调用的方法就需要几个点, 而是都是两个点； &lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(.getLocation (.getCodeSource (.getProtectionDomain (.getClass &#39;(1 2)))))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;可以缩写为&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(.. &#39;(1 2) getClass getProtectionDomain getCodeSource getLocation)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Tips: Eclipse 中可以使用ctrl+H 进行整个项目的搜索,非常实用的功能；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Twitter Storm源代码分析之TimeCacheMap – 见另一篇笔记；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;inimbus是一个接口, 主要实现方法为:查询调用可用slot, 分配slots, 获取supervisor的节点id, 获取调度器；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;clojure cond宏: 接受一系列 test/expression 对， 它每次对一个 test 进行求值， 如果某个 test 返回 true ， 那么 cond 求值并返回与这个 test 相对应的expression ， 并且不再对其他 test 进行求值。如:&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;    (defn type-of-number [n]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;               (cond (&amp;gt; n 0) &quot;positive number&quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                     (&amp;lt; n 0) &quot;negative number&quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                     :else &quot;zero&quot;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ``` &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18. storm中使用到的语法符号-&amp;gt;: &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-&amp;gt;, (-&amp;gt; x form &amp;amp; more)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;线性化嵌套, 使其更具有可读性,  Inserts x as the second item in the first form ； 从下面的例子可以看出, 就是把第一个参数(x)作为最初的输入, 调用第二个参数(代表的fn), 然后拿返回值调用后续函数；和..用处差不多, 但..只能用于java调用；&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ```clojure&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (first (.split (.replace (.toUpperCase &quot;a b c d&quot;) &quot;A&quot; &quot;X&quot;) &quot; &quot;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    可以改写为:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (-&amp;gt; &quot;a b c d&quot; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    .toUpperCase &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (.replace &quot;A&quot; &quot;X&quot;) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (.split &quot; &quot;) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    first)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;nimbus data 数据结构: 见nimbus.clj文件, 主要包括&lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;    (defn nimbus-data [conf inimbus]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (let [forced-scheduler (.getForcedScheduler inimbus)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;:conf conf &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :nimbus-host-port-info (NimbusInfo/fromConf conf)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :inimbus inimbus&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :authorization-handler (mk-authorization-handler (conf NIMBUS-AUTHORIZER) conf)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :impersonation-authorization-handler (mk-authorization-handler (conf NIMBUS-IMPERSONATION-AUTHORIZER) conf)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :submitted-count (atom 0)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :storm-cluster-state (cluster/mk-storm-cluster-state conf :acls (when (Utils/isZkAuthenticationConfiguredStormServer conf) NIMBUS-ZK-ACLS))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :submit-lock (Object.)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :cred-update-lock (Object.)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :log-update-lock (Object.)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :heartbeats-cache (atom &amp;#123;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :downloaders (file-cache-map conf)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :uploaders (file-cache-map conf)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :uptime (uptime-computer)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :validator (new-instance (conf NIMBUS-TOPOLOGY-VALIDATOR))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :timer (mk-timer :kill-fn (fn [t]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                     (log-error t &quot;Error when processing event&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                     (exit-process! 20 &quot;Error when processing an event&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                     ))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :scheduler (mk-scheduler conf inimbus)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :leader-elector (zk-leader-elector conf)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :code-distributor (mk-code-distributor conf)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :id-&amp;gt;sched-status (atom &amp;#123;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :cred-renewers (AuthUtils/GetCredentialRenewers conf)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         :nimbus-autocred-plugins (AuthUtils/getNimbusAutoCredPlugins conf)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &amp;#125;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ``` &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20. **org.apache.commons.io.FileUtils** : forceMkdir方法: &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    public static void forceMkdir(File directory)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                           throws IOException&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Makes a directory, including any necessary but nonexistent parent directories. If a file already exists with specified name but it is not a directory then an IOException is thrown. If the directory cannot be created (or does not already exist) then an IOException is thrown.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21. **doseq** :  Repeatedly executes body (presumably for side-effects) with bindings and filtering as provided by &quot;for&quot;. Does not retain the head of the sequence. Returns nil.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22. clojure 中**symbol** :  Returns a Symbol with the given namespace and name. &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23. 宏 **defmulti** 和 **defmethod** 经常被用在一起来定义 multimethod. 宏 defmulti 的参数包括一个方法名以及一个 dispatch 函数,这个 dispatch 函数的返回值会被用来到底调用哪个重载的函数。宏 defmethod 的参数则包括方法名, dispatch 的值, 参数列表以及方法体。一个特殊的 dispatch 值 :default 是用来表示默认情况的 — 即如果其它的 dispatch 值都不匹配的话,那么就调用这个方法。 defmethod 多定义的名字一样的方法,它们的参数个数必须一样。传给multimethod 的参数会传给 dipatch 函数的。&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24. **-&amp;gt;&amp;gt; , (-&amp;gt;&amp;gt; x form &amp;amp; more)**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Inserts x as the last item in the first form 和-&amp;gt;的差别在于x插入的位置不同, -&amp;gt;是插入在第二个item, 即紧跟在函数名后面, 而-&amp;gt;&amp;gt;是插在最后一个item; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ```clojure&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    user=&amp;gt; (-&amp;gt;&amp;gt; (range)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                (map #(* % %))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                (filter even?)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                (take 10)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                (reduce +))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    等价于:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    user=&amp;gt; (reduce +&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           (take 10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           (filter even?&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           (map #(* % %)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           (range)))))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;backtype.storm.&lt;strong&gt;config&lt;/strong&gt;.clj 文件中主要实现功能:  对conf参数内容进行提取,  backtype.storm.Config.java文件中定义了所有的storm可配置参数,同时定义serilization register；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Clojure 语法 : &lt;strong&gt;with-meta&lt;/strong&gt;  (with-meta obj m)    Returns an object of the same type and value as obj, with  map m as its metadata.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;into, (into to from)&lt;/strong&gt;&lt;br&gt;把from join到to, 可以看到底下对于list, vector, set, 加完的顺序是不同的, 刚开始有些疑惑, 其实Into, 只是依次从from中把item读出, 并append到to里面, 最终的顺序不同因为数据结构对append的处理不同；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;‘() 是List, 类似于java里面的LinkedList, [] 是vector, #{} 可以定义set, {} 里面可以定义set；&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;merge&lt;/strong&gt;, (merge &amp;amp; maps) : 把多个map merge在一起, 如果有一样的key则latter优先原则, 后出现的优先;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;LocalState&lt;/strong&gt; 定义了一个轻量级, 可持久化的KV 数据库, 它的效率不高,每次读写都要进行磁盘操作, 所以他一般只能用于读写次数不多的场景;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;fn 定义匿名函数;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;cluster.clj 文件中 &lt;strong&gt;ClusterState&lt;/strong&gt;协议 定义了一系列用于对Zookeeper进行操作的方法; &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;defprotocol&lt;/strong&gt;: protocol是clojure中的接口; 需要注意的是，protocol里所有方法的第一个参数都是self/this参数（类似python），从第二个开始才是调用时传入的参数。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;cluster.clj 文件中 &lt;strong&gt;mk-distributed-cluster-state&lt;/strong&gt; 函数返回一个实现了ClusterState协议的对象, 该对象的基本方法都是使用zookeeper.clj文件中定义的方法实现的; &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;cluster.clj 文件中 &lt;strong&gt;StormClusterState&lt;/strong&gt;协议, 主要定义了与storm相关的zookeeper操作, 包括读取topology中的任务分配, 向zookeeper中发送心跳信息等;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;cluster.clj 文件中 &lt;strong&gt;mk-storm-cluster-state&lt;/strong&gt; 函数返回一个实现了StormClusterState协议的对象;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;cluster.clj&lt;/strong&gt;文件中主要定义了两个协议,并定义两个函数分别返回实现了该协议的对象;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;register&lt;/strong&gt; : &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;defrecord&lt;/strong&gt; : &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;SupervisorInfo&lt;/strong&gt; 在common.clj文件中定义； converter.clj 文件中定义了SupevisorInfo的使用, 即在Thrift中的传输;&lt;/p&gt;
&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defrecord&lt;/span&gt;&lt;/span&gt; SupervisorInfo [time-secs hostname assignment-id used-ports meta scheduler-meta uptime-secs version])&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;common.clj文件中定义了StormBase, 其中定义了Topology的基本信息; &lt;/p&gt;
&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defrecord&lt;/span&gt;&lt;/span&gt; StormBase [storm-name launch-time-secs status num-workers component-&amp;gt;executors owner topology-action-options prev-status])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;;component-&amp;gt;executors 保存了&amp;lt;component-id , parallelism&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;common.clj文件中定义了Assignment, 其中定义当前topology的任务分配情况; &lt;/p&gt;
&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defrecord&lt;/span&gt;&lt;/span&gt; Assignment [master-code-dir node-&amp;gt;host executor-&amp;gt;node+port executor-&amp;gt;start-time-secs])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; master-code-dir 为nimbus在本地保存该topology信息的路径, 包括stormjar  stormcode   stormconf&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; node-&amp;gt;host 定义了该Topology被分配到的&amp;lt;supervisor-id, hostname&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; executor-&amp;gt;node+port 定义了该topology中executor的分配情况, node对应于supervisor-id, port是supervisor的一个端口;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Clojure的函数后面加个&lt;strong&gt;感叹号&lt;/strong&gt;的意思: 跟下划线一样是普通的组词字符，定义的时候想加就加, 在coding风格上提倡用这个形式来表示函数有明显&lt;strong&gt;副作用&lt;/strong&gt;， 但是这只是风格上的提倡，在语义层面没有强制; 参考: &lt;a href=&quot;http://dev.clojure.org/display/community/Library+Coding+Standards&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://dev.clojure.org/display/community/Library+Coding+Standards&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;storm.&lt;strong&gt;thrift&lt;/strong&gt; 是按照Thrift语法编写的RPC  接口文件, 其中定义了service Nimbus的所有注册服务; 由于storm运行在jvm上, 前面定义的结构需要使用thrift转换为对应的java代码； 即 backtype.storm.generated.Nimbus.&lt;strong&gt;Iface&lt;/strong&gt;接口;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;nimbus中定义的数据结构主要有两大类: &lt;strong&gt;java&lt;/strong&gt;定义的数据结构和&lt;strong&gt;Clojure&lt;/strong&gt;定义的数据结构; java定义的数据结构主要用于&lt;strong&gt;任务分配&lt;/strong&gt;, 而Clojure定义的数据结构主要来充当一些&lt;strong&gt;Storm的元数据&lt;/strong&gt;; java定义的数据结构主要封装在backtype.storm.&lt;strong&gt;scheduler&lt;/strong&gt;包中；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;nimbus文件中定义mk-assignments函数, 主要功能为负责对当前集群中的所有topology进行新一轮的任务调度, 一方面会检查已运行的topology所占用的资源, 是否需要重新分配; 另一方面会根据当前系统中的可用资源, 为新提交的topology分配任务;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;log.clj 文件中定义了所有级别的log message 宏; &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Clojure apply:  Applies fn f to the argument list formed by prepending intervening arguments to args. &lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(apply f args)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(apply f x args)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(apply f x y args)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(apply f x y z args)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(apply f a b c d &amp;amp; args) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;示例 : (apply str [&quot;str1&quot; &quot;str2&quot; &quot;str3&quot;]) ;;=&amp;gt; &quot;str1str2str3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;do-cleanup函数功能&lt;/p&gt;
&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; cleanup-storm-ids 函数判断出哪些topology需要清理, &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 然后对需要清理的topology进行相应的操作;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 操作包括: 删除zookeeper中心跳和错误信息, &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 然后尝试清除nimbus本地目录中的相关文件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 并从nimbus心跳缓存中移除对应的信息&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defn&lt;/span&gt;&lt;/span&gt; do-cleanup [nimbus]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [storm-cluster-state (&lt;span class=&quot;symbol&quot;&gt;:storm-cluster-state&lt;/span&gt; nimbus)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;conf (&lt;span class=&quot;symbol&quot;&gt;:conf&lt;/span&gt; nimbus)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;submit-lock (&lt;span class=&quot;symbol&quot;&gt;:submit-lock&lt;/span&gt; nimbus)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [to-cleanup-ids (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;locking&lt;/span&gt;&lt;/span&gt; submit-lock&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;cleanup-storm-ids&lt;/span&gt; conf storm-cluster-state))]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;when-not&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;empty?&lt;/span&gt;&lt;/span&gt; to-cleanup-ids)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;doseq&lt;/span&gt;&lt;/span&gt; [id to-cleanup-ids]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;log-message&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Cleaning up &quot;&lt;/span&gt; id)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;.teardown-heartbeats!&lt;/span&gt; storm-cluster-state id)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;.teardown-topology-errors!&lt;/span&gt; storm-cluster-state id)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;rmr&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;master-stormdist-root&lt;/span&gt; conf id))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;swap!&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:heartbeats-cache&lt;/span&gt; nimbus) dissoc id))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;))))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;clean-inbox函数功能&lt;/p&gt;
&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 该方法负责清理nimbus的inbox文件夹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 清理的条件是文件夹中的jar包从最后一次被修改到当前时间间隔超过了seconds&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defn&lt;/span&gt;&lt;/span&gt; clean-inbox [dir-location seconds]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&quot;Deletes jar files in dir older than seconds.&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [now (&lt;span class=&quot;name&quot;&gt;current-time-secs&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;pred #(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;and&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;.isFile&lt;/span&gt; %) (&lt;span class=&quot;name&quot;&gt;file-older-than?&lt;/span&gt; now seconds %))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;files (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;filter&lt;/span&gt;&lt;/span&gt; pred (&lt;span class=&quot;name&quot;&gt;file-seq&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;File.&lt;/span&gt; dir-location)))]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;doseq&lt;/span&gt;&lt;/span&gt; [f files]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;if&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;.delete&lt;/span&gt; f)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;log-message&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Cleaning inbox ... deleted: &quot;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;.getName&lt;/span&gt; f))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; This should never happen&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;log-error&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Cleaning inbox ... error deleting: &quot;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;.getName&lt;/span&gt; f))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;))))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;nimbus.clj文件中 &lt;strong&gt;transition-name!&lt;/strong&gt;函数&lt;/p&gt;
&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 该方法根据topology-name对应的转移事件,完成topology的状态转换,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 将基于storm-name的状态转换为基于storm-id的状态&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defn&lt;/span&gt;&lt;/span&gt; transition-name! [nimbus storm-name event &amp;amp; args]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [storm-id (&lt;span class=&quot;name&quot;&gt;get-storm-id&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:storm-cluster-state&lt;/span&gt; nimbus) storm-name)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;when-not&lt;/span&gt;&lt;/span&gt; storm-id&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;throw&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;NotAliveException.&lt;/span&gt; storm-name)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;apply&lt;/span&gt;&lt;/span&gt; transition! nimbus storm-id event args)))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;nimbus.clj文件中&lt;strong&gt;transition!&lt;/strong&gt; 方法&lt;/p&gt;
&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; transition! 方法会根据传入的转移事件, &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 获取与当前的Topology状态对应的状态转移函数,并执行该函数获取转换后的新状态&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defn&lt;/span&gt;&lt;/span&gt; transition!&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ([nimbus storm-id event]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     (&lt;span class=&quot;name&quot;&gt;transition!&lt;/span&gt; nimbus storm-id event &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ([nimbus storm-id event error-on-no-transition?]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;locking&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:submit-lock&lt;/span&gt; nimbus)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [system-events #&amp;#123;&lt;span class=&quot;symbol&quot;&gt;:startup&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             [event &amp;amp; event-args] (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;if&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;keyword?&lt;/span&gt;&lt;/span&gt; event) [event] event)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             storm-base (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt; nimbus &lt;span class=&quot;symbol&quot;&gt;:storm-cluster-state&lt;/span&gt;  (&lt;span class=&quot;name&quot;&gt;.storm-base&lt;/span&gt; storm-id &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             status (&lt;span class=&quot;symbol&quot;&gt;:status&lt;/span&gt; storm-base)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;span class=&quot;comment&quot;&gt;;; handles the case where event was scheduled but topology has been removed&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;if-not&lt;/span&gt;&lt;/span&gt; status&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           (&lt;span class=&quot;name&quot;&gt;log-message&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Cannot apply event &quot;&lt;/span&gt; event &lt;span class=&quot;string&quot;&gt;&quot; to &quot;&lt;/span&gt; storm-id &lt;span class=&quot;string&quot;&gt;&quot; because topology no longer exists&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [get-event (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;fn&lt;/span&gt;&lt;/span&gt; [m e]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                             (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;if&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;contains?&lt;/span&gt;&lt;/span&gt; m e)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                               (&lt;span class=&quot;name&quot;&gt;m&lt;/span&gt; e)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                               (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [msg (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;str&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;No transition for event: &quot;&lt;/span&gt; event&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                              &lt;span class=&quot;string&quot;&gt;&quot;, status: &quot;&lt;/span&gt; status,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                              &lt;span class=&quot;string&quot;&gt;&quot; storm-id: &quot;&lt;/span&gt; storm-id)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                 (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;if&lt;/span&gt;&lt;/span&gt; error-on-no-transition?&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                   (&lt;span class=&quot;name&quot;&gt;throw-runtime&lt;/span&gt; msg)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                   (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;do&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;when-not&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;contains?&lt;/span&gt;&lt;/span&gt; system-events event)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                         (&lt;span class=&quot;name&quot;&gt;log-message&lt;/span&gt; msg))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                       &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                 )))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 transition (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;state-transitions&lt;/span&gt; nimbus storm-id status storm-base)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;get&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:type&lt;/span&gt; status))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                (&lt;span class=&quot;name&quot;&gt;get-event&lt;/span&gt; event))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 transition (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;if&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;or&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;nil?&lt;/span&gt;&lt;/span&gt; transition)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                    (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;keyword?&lt;/span&gt;&lt;/span&gt; transition))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                              (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;fn&lt;/span&gt;&lt;/span&gt; [] transition)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                              transition)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 storm-base-updates (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;apply&lt;/span&gt;&lt;/span&gt; transition event-args)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 storm-base-updates (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;if&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;keyword?&lt;/span&gt;&lt;/span&gt; storm-base-updates) &lt;span class=&quot;comment&quot;&gt;;if it&#39;s just a symbol, that just indicates new status.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                      &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:status&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:type&lt;/span&gt; storm-base-updates&amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                      storm-base-updates)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;when&lt;/span&gt;&lt;/span&gt; storm-base-updates&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;               (&lt;span class=&quot;name&quot;&gt;.update-storm!&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:storm-cluster-state&lt;/span&gt; nimbus) storm-id storm-base-updates)))))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       )))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;nimbus.clj文件中&lt;strong&gt;kill-transition&lt;/strong&gt; 方法&lt;/p&gt;
&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 函数功能: delay kill-time后 kill 掉topology&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 在kill状态下执行remove转移事件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defn&lt;/span&gt;&lt;/span&gt; kill-transition [nimbus storm-id]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;fn&lt;/span&gt;&lt;/span&gt; [kill-time]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [delay (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;if&lt;/span&gt;&lt;/span&gt; kill-time&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  kill-time&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;get&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;read-storm-conf&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:conf&lt;/span&gt; nimbus) storm-id)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       TOPOLOGY-MESSAGE-TIMEOUT-SECS))]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (&lt;span class=&quot;name&quot;&gt;delay-event&lt;/span&gt; nimbus&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                   storm-id&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                   delay&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                   &lt;span class=&quot;symbol&quot;&gt;:remove&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;symbol&quot;&gt;:status&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:type&lt;/span&gt; &lt;span class=&quot;symbol&quot;&gt;:killed&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;symbol&quot;&gt;:topology-action-options&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:delay-secs&lt;/span&gt; delay &lt;span class=&quot;symbol&quot;&gt;:action&lt;/span&gt; &lt;span class=&quot;symbol&quot;&gt;:kill&lt;/span&gt;&amp;#125;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;nimbus.clj文件中&lt;strong&gt;rebalance-transition&lt;/strong&gt; 方法&lt;/p&gt;
&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 函数功能: delay time后 rebalance topology&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 返回的执行结果中topology状态被更新为rebalancing&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 等到计时器线程中do-rebalance转移事件执行完毕, 真正的rebalance才完成&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defn&lt;/span&gt;&lt;/span&gt; rebalance-transition [nimbus storm-id status]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;fn&lt;/span&gt;&lt;/span&gt; [time num-workers executor-overrides]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [delay (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;if&lt;/span&gt;&lt;/span&gt; time&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  time&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;get&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;read-storm-conf&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:conf&lt;/span&gt; nimbus) storm-id)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       TOPOLOGY-MESSAGE-TIMEOUT-SECS))]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (&lt;span class=&quot;name&quot;&gt;delay-event&lt;/span&gt; nimbus&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                   storm-id&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                   delay&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                   &lt;span class=&quot;symbol&quot;&gt;:do-rebalance&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:status&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:type&lt;/span&gt; &lt;span class=&quot;symbol&quot;&gt;:rebalancing&lt;/span&gt;&amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &lt;span class=&quot;symbol&quot;&gt;:prev-status&lt;/span&gt; status&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &lt;span class=&quot;symbol&quot;&gt;:topology-action-options&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:delay-secs&lt;/span&gt; delay &lt;span class=&quot;symbol&quot;&gt;:action&lt;/span&gt; &lt;span class=&quot;symbol&quot;&gt;:rebalance&lt;/span&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                  (&lt;span class=&quot;name&quot;&gt;assoc-non-nil&lt;/span&gt; &lt;span class=&quot;symbol&quot;&gt;:num-workers&lt;/span&gt; num-workers)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                  (&lt;span class=&quot;name&quot;&gt;assoc-non-nil&lt;/span&gt; &lt;span class=&quot;symbol&quot;&gt;:component-&amp;gt;executors&lt;/span&gt; executor-overrides))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &amp;#125;)))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;nimbus.clj文件中&lt;strong&gt;state-transitions&lt;/strong&gt; 方法&lt;/p&gt;
&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 该函数定义了一个状态转移矩阵, key的集合包括active, inactive, killed, rebalancing&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 对应的value表示了处于由key指定的状态时, &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 其状态变化需要遵循的从转移事件到对应状态的转移函数的集合&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defn&lt;/span&gt;&lt;/span&gt; state-transitions [nimbus storm-id status storm-base]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:active&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:inactivate&lt;/span&gt; &lt;span class=&quot;symbol&quot;&gt;:inactive&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;symbol&quot;&gt;:activate&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;symbol&quot;&gt;:rebalance&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;rebalance-transition&lt;/span&gt; nimbus storm-id status)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;symbol&quot;&gt;:kill&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;kill-transition&lt;/span&gt; nimbus storm-id)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;symbol&quot;&gt;:inactive&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:activate&lt;/span&gt; &lt;span class=&quot;symbol&quot;&gt;:active&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &lt;span class=&quot;symbol&quot;&gt;:inactivate&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &lt;span class=&quot;symbol&quot;&gt;:rebalance&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;rebalance-transition&lt;/span&gt; nimbus storm-id status)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &lt;span class=&quot;symbol&quot;&gt;:kill&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;kill-transition&lt;/span&gt; nimbus storm-id)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;symbol&quot;&gt;:killed&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:startup&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;fn&lt;/span&gt;&lt;/span&gt; [] (&lt;span class=&quot;name&quot;&gt;delay-event&lt;/span&gt; nimbus&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                         storm-id&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                         (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt; storm-base&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                             &lt;span class=&quot;symbol&quot;&gt;:topology-action-options&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                             &lt;span class=&quot;symbol&quot;&gt;:delay-secs&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                         &lt;span class=&quot;symbol&quot;&gt;:remove&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                             &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;symbol&quot;&gt;:kill&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;kill-transition&lt;/span&gt; nimbus storm-id)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;symbol&quot;&gt;:remove&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;fn&lt;/span&gt;&lt;/span&gt; []&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      (&lt;span class=&quot;name&quot;&gt;log-message&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Killing topology: &quot;&lt;/span&gt; storm-id)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      (&lt;span class=&quot;name&quot;&gt;.remove-storm!&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:storm-cluster-state&lt;/span&gt; nimbus)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                      storm-id)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                      &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;symbol&quot;&gt;:rebalancing&lt;/span&gt; &amp;#123;&lt;span class=&quot;symbol&quot;&gt;:startup&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;fn&lt;/span&gt;&lt;/span&gt; [] (&lt;span class=&quot;name&quot;&gt;delay-event&lt;/span&gt; nimbus&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                              storm-id&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                              (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt; storm-base&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                  &lt;span class=&quot;symbol&quot;&gt;:topology-action-options&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                  &lt;span class=&quot;symbol&quot;&gt;:delay-secs&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                              &lt;span class=&quot;symbol&quot;&gt;:do-rebalance&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                 &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 &lt;span class=&quot;symbol&quot;&gt;:kill&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;kill-transition&lt;/span&gt; nimbus storm-id)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 &lt;span class=&quot;symbol&quot;&gt;:do-rebalance&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;fn&lt;/span&gt;&lt;/span&gt; []&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                 (&lt;span class=&quot;name&quot;&gt;do-rebalance&lt;/span&gt; nimbus storm-id status storm-base)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                 (&lt;span class=&quot;symbol&quot;&gt;:type&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:prev-status&lt;/span&gt; storm-base)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 &amp;#125;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;nimbus.clj文件中&lt;strong&gt;compute-new-topology-&amp;gt;executor-&amp;gt;node+port&lt;/strong&gt;方法&lt;/p&gt;
&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;; public so it can be mocked out&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 该方法根据当前已经存在的分配情况, 结合系统当前的运行情况找出需要进行任务分配的Topology 集合&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 并为他们分配任务, 计算出这一轮分配完之后的每个Topology对应的任务分配情况&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;;  scratch-topology-id 是需要重新进行分配操作的topology id&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defn&lt;/span&gt;&lt;/span&gt; compute-new-topology-&amp;gt;executor-&amp;gt;node+port [nimbus existing-assignments topologies scratch-topology-id]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [conf (&lt;span class=&quot;symbol&quot;&gt;:conf&lt;/span&gt; nimbus)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        storm-cluster-state (&lt;span class=&quot;symbol&quot;&gt;:storm-cluster-state&lt;/span&gt; nimbus)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        topology-&amp;gt;executors (&lt;span class=&quot;name&quot;&gt;compute-topology-&amp;gt;executors&lt;/span&gt; nimbus (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;keys&lt;/span&gt;&lt;/span&gt; existing-assignments))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;;; update the executors heartbeats first.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _ (&lt;span class=&quot;name&quot;&gt;update-all-heartbeats!&lt;/span&gt; nimbus existing-assignments topology-&amp;gt;executors)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        topology-&amp;gt;alive-executors (&lt;span class=&quot;name&quot;&gt;compute-topology-&amp;gt;alive-executors&lt;/span&gt; nimbus&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                     existing-assignments&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                     topologies&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                     topology-&amp;gt;executors&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                     scratch-topology-id)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        supervisor-&amp;gt;dead-ports (&lt;span class=&quot;name&quot;&gt;compute-supervisor-&amp;gt;dead-ports&lt;/span&gt; nimbus&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                               existing-assignments&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                               topology-&amp;gt;executors&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                               topology-&amp;gt;alive-executors)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        topology-&amp;gt;scheduler-assignment (&lt;span class=&quot;name&quot;&gt;compute-topology-&amp;gt;scheduler-assignment&lt;/span&gt; nimbus&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                               existing-assignments&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                               topology-&amp;gt;alive-executors)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;;; 过滤条件: 该Topology的所有Executor为空, 或者该Topology的所有Executors不等于该Topolgy&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &lt;span class=&quot;comment&quot;&gt;;; 的alive executors, 或者该Topology的num-used-worker 数目小雨指定的num workers&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        missing-assignment-topologies (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&amp;gt;&lt;/span&gt;&lt;/span&gt; topologies&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                           .getTopologies    &lt;span class=&quot;comment&quot;&gt;;; Collection&amp;lt;TopologyDetails&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                           (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;map&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;memfn&lt;/span&gt;&lt;/span&gt; getId))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                           (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;filter&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;fn&lt;/span&gt;&lt;/span&gt; [t]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                      (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [alle (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;get&lt;/span&gt;&lt;/span&gt; topology-&amp;gt;executors t)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                            alivee (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;get&lt;/span&gt;&lt;/span&gt; topology-&amp;gt;alive-executors t)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                            (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;or&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;empty?&lt;/span&gt;&lt;/span&gt; alle)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;not=&lt;/span&gt;&lt;/span&gt; alle alivee)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;&amp;lt;&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt; topology-&amp;gt;scheduler-assignment&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                       (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;get&lt;/span&gt;&lt;/span&gt; t)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                       num-used-workers )&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                   (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt; topologies (&lt;span class=&quot;name&quot;&gt;.getById&lt;/span&gt; t) .getNumWorkers)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                   ))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                            ))))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        all-scheduling-slots (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&amp;gt;&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;all-scheduling-slots&lt;/span&gt; nimbus topologies missing-assignment-topologies)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                  (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;map&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;fn&lt;/span&gt;&lt;/span&gt; [[node-id port]] &amp;#123;node-id #&amp;#123;port&amp;#125;&amp;#125;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                  (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;apply&lt;/span&gt;&lt;/span&gt; merge-with set/union))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        supervisors (&lt;span class=&quot;name&quot;&gt;read-all-supervisor-details&lt;/span&gt; nimbus all-scheduling-slots supervisor-&amp;gt;dead-ports)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        cluster (&lt;span class=&quot;name&quot;&gt;Cluster.&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:inimbus&lt;/span&gt; nimbus) supervisors topology-&amp;gt;scheduler-assignment)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;;; call scheduler.schedule to schedule all the topologies&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;;; the new assignments for all the topologies are in the cluster object.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _ (&lt;span class=&quot;name&quot;&gt;.schedule&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:scheduler&lt;/span&gt; nimbus) topologies cluster)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        new-scheduler-assignments (&lt;span class=&quot;name&quot;&gt;.getAssignments&lt;/span&gt; cluster)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;;; add more information to convert SchedulerAssignment to Assignment&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        new-topology-&amp;gt;executor-&amp;gt;node+port (&lt;span class=&quot;name&quot;&gt;compute-topology-&amp;gt;executor-&amp;gt;node+port&lt;/span&gt; new-scheduler-assignments)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;reset!&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:id-&amp;gt;sched-status&lt;/span&gt; nimbus) (&lt;span class=&quot;name&quot;&gt;.getStatusMap&lt;/span&gt; cluster))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;;; print some useful information.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;doseq&lt;/span&gt;&lt;/span&gt; [[topology-id executor-&amp;gt;node+port] new-topology-&amp;gt;executor-&amp;gt;node+port&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;symbol&quot;&gt;:let&lt;/span&gt; [old-executor-&amp;gt;node+port (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;/span&gt; topology-id&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                          existing-assignments&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                          &lt;span class=&quot;symbol&quot;&gt;:executor-&amp;gt;node+port&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  reassignment (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;filter&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;fn&lt;/span&gt;&lt;/span&gt; [[executor node+port]]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                         (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;and&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;contains?&lt;/span&gt;&lt;/span&gt; old-executor-&amp;gt;node+port executor)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                              (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;not&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;=&lt;/span&gt;&lt;/span&gt; node+port (&lt;span class=&quot;name&quot;&gt;old-executor-&amp;gt;node+port&lt;/span&gt; executor)))))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                       executor-&amp;gt;node+port)]]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;when-not&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;empty?&lt;/span&gt;&lt;/span&gt; reassignment)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [new-slots-cnt (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;count&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;set&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;vals&lt;/span&gt;&lt;/span&gt; executor-&amp;gt;node+port)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              reassign-executors (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;keys&lt;/span&gt;&lt;/span&gt; reassignment)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          (&lt;span class=&quot;name&quot;&gt;log-message&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Reassigning &quot;&lt;/span&gt; topology-id &lt;span class=&quot;string&quot;&gt;&quot; to &quot;&lt;/span&gt; new-slots-cnt &lt;span class=&quot;string&quot;&gt;&quot; slots&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          (&lt;span class=&quot;name&quot;&gt;log-message&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Reassign executors: &quot;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;vec&lt;/span&gt;&lt;/span&gt; reassign-executors)))))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    new-topology-&amp;gt;executor-&amp;gt;node+port))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Clojure 中 &lt;strong&gt;mapcat&lt;/strong&gt;方法:  Returns the result of applying concat to the result of applying map to f and colls.  Thus function f should return a collection. Returns a transducer when no collections are provided. &lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;user=&amp;gt; (mapcat (fn [[k v]] &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 (for [[k2 v2] v] &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                   (concat [k k2] v2)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &#39;&amp;#123;:a &amp;#123;:x (1 2) :y (3 4)&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           :b &amp;#123;:x (1 2) :z (5 6)&amp;#125;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;((:a :x 1 2) (:a :y 3 4) (:b :x 1 2) (:b :z 5 6))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;if-let&lt;/strong&gt; :  对let添加if判断, 如下面的例子, 如果nums非false或nil, 则执行累加, 否则表示list中没有偶数打印”No even numbers found.” 适用于对于不同的let结果的不同处理. &lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;user=&amp;gt; (defn sum-even-numbers [nums]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         (if-let [nums (seq (filter even? nums))]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           (reduce + nums)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           &quot;No even numbers found.&quot;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;user=&amp;gt; (sum-even-numbers [1 3 5 7 9])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&quot;No even numbers found.&quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;user=&amp;gt; (sum-even-numbers [1 3 5 7 9 10 12])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;when-let&lt;/strong&gt; :  when-let, 一样的理论, 当let赋值非false或nil时, 执行相应逻辑, 否则返回nil &lt;/p&gt;
&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(defn drop-one&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [coll]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (when-let [s (seq coll)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (rest s)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;user=&amp;gt; (drop-one [1 2 3])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(2 3)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;user=&amp;gt; (drop-one [])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nil&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;nimbus 本地工作目录结构&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;- workdir&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	- nimbus&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		- inbox&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		- stormdist&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			- topology id命名的文件夹&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				- **stormcode.ser** ( backtype.storm.generated包中StormTopology对象序列化)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				- **stormconf.ser**  (topology conf 代码序列化)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				- **stormjar.jar**     (用户提交的jar包)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	- supervisor&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		- isupervisor&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		- localstate&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		- tmp&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;TopologyDetails 对象中的数据结构&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;TopologyDetails&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    String topologyId;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Map topologyConf;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    StormTopology topology;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Map&amp;lt;ExecutorDetails, String&amp;gt; executorToComponent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; numWorkers;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; ......&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;ExcutorDetails&lt;/strong&gt; 对象记录了每个Executor所对应的startTask和endTask, 这样定义是为了保证Storm在计算Executor时, 每个Executor都是一个连续的任务集合；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Clojure 中 &lt;strong&gt;swap!&lt;/strong&gt; 宏的作用:&lt;br&gt;&lt;strong&gt;(swap! atom f)    (swap! atom f x)    (swap! atom f x y)     (swap! atom f x y &amp;amp; args)&lt;/strong&gt;&lt;br&gt;Atomically swaps the value of atom to be:&lt;br&gt;(apply f current-value-of-atom args). Note that f may be called&lt;br&gt;multiple times, and thus should be free of side effects.  Returns&lt;br&gt;the value that was swapped in.&lt;br&gt;swap! 将函数f作用于当前状态值和额外的参数args之上，形成新的状态值&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;SchedulerAssignment&lt;/strong&gt; 是一个接口, &lt;strong&gt;SchedulerAssignmentImpl&lt;/strong&gt;是对这个接口的实现；&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;SchedulerAssignment&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Does this slot occupied by this assignment?&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;isSlotOccupied&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(WorkerSlot slot)&lt;/span&gt;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//is the executor assigned?&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;isExecutorAssigned&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(ExecutorDetails executor)&lt;/span&gt;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// get the topology-id this assignment is for.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; String &lt;span class=&quot;title&quot;&gt;getTopologyId&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//get the executor -&amp;gt; slot map.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; Map&amp;lt;ExecutorDetails, WorkerSlot&amp;gt; &lt;span class=&quot;title&quot;&gt;getExecutorToSlot&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Return the executors covered by this assignments&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; Set&amp;lt;ExecutorDetails&amp;gt; &lt;span class=&quot;title&quot;&gt;getExecutors&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; Set&amp;lt;WorkerSlot&amp;gt; &lt;span class=&quot;title&quot;&gt;getSlots&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; backtype.storm.scheduler;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.ArrayList;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.Collection;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.HashMap;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.HashSet;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.List;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.Map;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.Set;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//&lt;span class=&quot;doctag&quot;&gt;TODO:&lt;/span&gt; improve this by maintaining slot -&amp;gt; executors as well for more efficient operations&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;SchedulerAssignmentImpl&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;SchedulerAssignment&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//topology-id this assignment is for.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    String topologyId;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// assignment detail, a mapping from executor to WorkerSlot&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Map&amp;lt;ExecutorDetails, WorkerSlot&amp;gt; executorToSlot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;SchedulerAssignmentImpl&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String topologyId, Map&amp;lt;ExecutorDetails, WorkerSlot&amp;gt; executorToSlots)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.topologyId = topologyId;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.executorToSlot = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;ExecutorDetails, WorkerSlot&amp;gt;(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (executorToSlots != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.executorToSlot.putAll(executorToSlots);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; Set&amp;lt;WorkerSlot&amp;gt; &lt;span class=&quot;title&quot;&gt;getSlots&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; HashSet(executorToSlot.values());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//Assign the slot to executors.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;assign&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(WorkerSlot slot, Collection&amp;lt;ExecutorDetails&amp;gt; executors)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (ExecutorDetails executor : executors) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.executorToSlot.put(executor, slot);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//Release the slot occupied by this assignment.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;unassignBySlot&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(WorkerSlot slot)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        List&amp;lt;ExecutorDetails&amp;gt; executors = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;ExecutorDetails&amp;gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (ExecutorDetails executor : &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.executorToSlot.keySet()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            WorkerSlot ws = &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.executorToSlot.get(executor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (ws.equals(slot)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                executors.add(executor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// remove&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (ExecutorDetails executor : executors) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.executorToSlot.remove(executor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//Does this slot occupied by this assignment?&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;isSlotOccupied&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(WorkerSlot slot)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.executorToSlot.containsValue(slot);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;isExecutorAssigned&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(ExecutorDetails executor)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.executorToSlot.containsKey(executor);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; String &lt;span class=&quot;title&quot;&gt;getTopologyId&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.topologyId;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; Map&amp;lt;ExecutorDetails, WorkerSlot&amp;gt; &lt;span class=&quot;title&quot;&gt;getExecutorToSlot&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.executorToSlot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// Return the executors covered by this assignments&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; Set&amp;lt;ExecutorDetails&amp;gt; &lt;span class=&quot;title&quot;&gt;getExecutors&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.executorToSlot.keySet();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;nimbus.clj&lt;/strong&gt;文件中&lt;strong&gt;mk-assignments&lt;/strong&gt;方法&lt;/p&gt;
&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; get existing assignment (just the executor-&amp;gt;node+port map) -&amp;gt; default to &amp;#123;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; filter out ones which have a executor timeout&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; figure out available slots on cluster. add to that the used valid slots to get total slots. figure out how many executors should be in each slot (e.g., 4, 4, 4, 5)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; only keep existing slots that satisfy one of those slots. for rest, reassign them across remaining slots&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; edge case for slots with no executor timeout but with supervisor timeout... just treat these as valid slots that can be reassigned to. worst comes to worse the executor will timeout and won&#39;t assign here next time around&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; mk-assignments主要负责对当前集群中的所有Topology进行新一轮的任务调度, 它一方面会检查已运行的Topology&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 所占用的资源,判断他们是否有问题, 是否需要重新分配, 另一方面也会根据当前的可用资源, 为新提交的Topology分配任务&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;;; 然后会将所有的分配信息保存或者更新到Zookeeper中,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;defnk&lt;/span&gt; mk-assignments [nimbus &lt;span class=&quot;symbol&quot;&gt;:scratch-topology-id&lt;/span&gt; &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [conf (&lt;span class=&quot;symbol&quot;&gt;:conf&lt;/span&gt; nimbus)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        storm-cluster-state (&lt;span class=&quot;symbol&quot;&gt;:storm-cluster-state&lt;/span&gt; nimbus)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;^INimbus&lt;/span&gt; inimbus (&lt;span class=&quot;symbol&quot;&gt;:inimbus&lt;/span&gt; nimbus)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;;; read all the topologies&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        topology-ids (&lt;span class=&quot;name&quot;&gt;.active-storms&lt;/span&gt; storm-cluster-state)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        topologies (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;into&lt;/span&gt;&lt;/span&gt; &amp;#123;&amp;#125; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;for&lt;/span&gt;&lt;/span&gt; [tid topology-ids]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                              &amp;#123;tid (&lt;span class=&quot;name&quot;&gt;read-topology-details&lt;/span&gt; nimbus tid)&amp;#125;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        topologies (&lt;span class=&quot;name&quot;&gt;Topologies.&lt;/span&gt; topologies)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;;; read all the assignments&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        assigned-topology-ids (&lt;span class=&quot;name&quot;&gt;.assignments&lt;/span&gt; storm-cluster-state &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        existing-assignments (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;into&lt;/span&gt;&lt;/span&gt; &amp;#123;&amp;#125; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;for&lt;/span&gt;&lt;/span&gt; [tid assigned-topology-ids]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                        &lt;span class=&quot;comment&quot;&gt;;; for the topology which wants rebalance (specified by the scratch-topology-id)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                        &lt;span class=&quot;comment&quot;&gt;;; we exclude its assignment, meaning that all the slots occupied by its assignment&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                        &lt;span class=&quot;comment&quot;&gt;;; will be treated as free slot in the scheduler code.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                        (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;when&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;or&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;nil?&lt;/span&gt;&lt;/span&gt; scratch-topology-id) (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;not=&lt;/span&gt;&lt;/span&gt; tid scratch-topology-id))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                          &amp;#123;tid (&lt;span class=&quot;name&quot;&gt;.assignment-info&lt;/span&gt; storm-cluster-state tid &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;)&amp;#125;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;;; make the new assignments for topologies&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        topology-&amp;gt;executor-&amp;gt;node+port (&lt;span class=&quot;name&quot;&gt;compute-new-topology-&amp;gt;executor-&amp;gt;node+port&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                       nimbus&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                       existing-assignments&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                       topologies&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                       scratch-topology-id)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        topology-&amp;gt;executor-&amp;gt;node+port (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;merge&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;into&lt;/span&gt;&lt;/span&gt; &amp;#123;&amp;#125; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;for&lt;/span&gt;&lt;/span&gt; [id assigned-topology-ids] &amp;#123;id &lt;span class=&quot;literal&quot;&gt;nil&lt;/span&gt;&amp;#125;)) topology-&amp;gt;executor-&amp;gt;node+port)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        now-secs (&lt;span class=&quot;name&quot;&gt;current-time-secs&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        basic-supervisor-details-map (&lt;span class=&quot;name&quot;&gt;basic-supervisor-details-map&lt;/span&gt; storm-cluster-state)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;;; construct the final Assignments by adding start-times etc into it&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        new-assignments (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;into&lt;/span&gt;&lt;/span&gt; &amp;#123;&amp;#125; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;for&lt;/span&gt;&lt;/span&gt; [[topology-id executor-&amp;gt;node+port] topology-&amp;gt;executor-&amp;gt;node+port&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                        &lt;span class=&quot;symbol&quot;&gt;:let&lt;/span&gt; [existing-assignment (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;get&lt;/span&gt;&lt;/span&gt; existing-assignments topology-id)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                              all-nodes (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&amp;gt;&lt;/span&gt;&lt;/span&gt; executor-&amp;gt;node+port vals (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;map&lt;/span&gt;&lt;/span&gt; first) set)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                              node-&amp;gt;host (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&amp;gt;&lt;/span&gt;&lt;/span&gt; all-nodes&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                              (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;mapcat&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;fn&lt;/span&gt;&lt;/span&gt; [node]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                        (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;if-let&lt;/span&gt;&lt;/span&gt; [host (&lt;span class=&quot;name&quot;&gt;.getHostName&lt;/span&gt; inimbus basic-supervisor-details-map node)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                          [[node host]]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                          )))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                              (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;into&lt;/span&gt;&lt;/span&gt; &amp;#123;&amp;#125;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                              all-node-&amp;gt;host (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;merge&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:node-&amp;gt;host&lt;/span&gt; existing-assignment) node-&amp;gt;host)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                              reassign-executors (&lt;span class=&quot;name&quot;&gt;changed-executors&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:executor-&amp;gt;node+port&lt;/span&gt; existing-assignment) executor-&amp;gt;node+port)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                              start-times (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;merge&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;symbol&quot;&gt;:executor-&amp;gt;start-time-secs&lt;/span&gt; existing-assignment)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;into&lt;/span&gt;&lt;/span&gt; &amp;#123;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                      (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;for&lt;/span&gt;&lt;/span&gt; [id reassign-executors]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                        [id now-secs]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                                        )))]]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                   &amp;#123;topology-id (&lt;span class=&quot;name&quot;&gt;Assignment.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                 (&lt;span class=&quot;name&quot;&gt;master-stormdist-root&lt;/span&gt; conf topology-id)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                 (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;select-keys&lt;/span&gt;&lt;/span&gt; all-node-&amp;gt;host all-nodes)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                 executor-&amp;gt;node+port&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                                                 start-times)&amp;#125;))]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;;; tasks figure out what tasks to talk to by looking at topology at runtime&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;;; only log/set when there&#39;s been a change to the assignment&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;doseq&lt;/span&gt;&lt;/span&gt; [[topology-id assignment] new-assignments&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;symbol&quot;&gt;:let&lt;/span&gt; [existing-assignment (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;get&lt;/span&gt;&lt;/span&gt; existing-assignments topology-id)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                  topology-details (&lt;span class=&quot;name&quot;&gt;.getById&lt;/span&gt; topologies topology-id)]]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;if&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;=&lt;/span&gt;&lt;/span&gt; existing-assignment assignment)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;log-debug&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Assignment for &quot;&lt;/span&gt; topology-id &lt;span class=&quot;string&quot;&gt;&quot; hasn&#39;t changed&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;do&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          (&lt;span class=&quot;name&quot;&gt;log-message&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;Setting new assignment for topology id &quot;&lt;/span&gt; topology-id &lt;span class=&quot;string&quot;&gt;&quot;: &quot;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;pr-str&lt;/span&gt; assignment))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          (&lt;span class=&quot;name&quot;&gt;.set-assignment!&lt;/span&gt; storm-cluster-state topology-id assignment)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          )))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;-&amp;gt;&amp;gt;&lt;/span&gt;&lt;/span&gt; new-assignments&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;map&lt;/span&gt;&lt;/span&gt; (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;fn&lt;/span&gt;&lt;/span&gt; [[topology-id assignment]]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;let&lt;/span&gt;&lt;/span&gt; [existing-assignment (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;get&lt;/span&gt;&lt;/span&gt; existing-assignments topology-id)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              [topology-id (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;map&lt;/span&gt;&lt;/span&gt; to-worker-slot (&lt;span class=&quot;name&quot;&gt;newly-added-slots&lt;/span&gt; existing-assignment assignment))]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;              )))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          (&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;into&lt;/span&gt;&lt;/span&gt; &amp;#123;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          (&lt;span class=&quot;name&quot;&gt;.assignSlots&lt;/span&gt; inimbus topologies))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;WorkerTopologyContext 上下文对象&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;WorkerTopologyContext&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;GeneralTopologyContext&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; String SHARED_EXECUTOR = &lt;span class=&quot;string&quot;&gt;&quot;executor&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; Integer _workerPort;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; List&amp;lt;Integer&amp;gt; _workerTasks;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; String _codeDir;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; String _pidDir;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Map&amp;lt;String, Object&amp;gt; _userResources;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Map&amp;lt;String, Object&amp;gt; _defaultResources;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;WorkerTopologyContext&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            StormTopology topology,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            Map stormConf,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            Map&amp;lt;Integer, String&amp;gt; taskToComponent,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            Map&amp;lt;String, List&amp;lt;Integer&amp;gt;&amp;gt; componentToSortedTasks,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            Map&amp;lt;String, Map&amp;lt;String, Fields&amp;gt;&amp;gt; componentToStreamToFields,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            String stormId,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            String codeDir,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            String pidDir,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            Integer workerPort,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            List&amp;lt;Integer&amp;gt; workerTasks,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            Map&amp;lt;String, Object&amp;gt; defaultResources,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            Map&amp;lt;String, Object&amp;gt; userResources&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            )&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;super&lt;/span&gt;(topology, stormConf, taskToComponent, componentToSortedTasks, componentToStreamToFields, stormId);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _codeDir = codeDir;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _defaultResources = defaultResources;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _userResources = userResources;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(pidDir!=&lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                _pidDir = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; File(pidDir).getCanonicalPath();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                _pidDir = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (IOException e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;string&quot;&gt;&quot;Could not get canonical path for &quot;&lt;/span&gt; + _pidDir, e);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _workerPort = workerPort;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        _workerTasks = workerTasks;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;common.clj&lt;/strong&gt; 文件定义了对Topology的检验函数, 为Topoloy添加acker, metric, system bolt的方法;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Clojure中&lt;strong&gt;-functionname&lt;/strong&gt; 表示该函数是public的，调用该函数时，不需要加-， 直接functionname即可；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;nimbus读取storm的配置文件函数&lt;strong&gt;read-storm-config&lt;/strong&gt; 是在config.clj中定义的； 而nimbus中定义的read-storm-conf是读取指定Topology的配置信息；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;read-storm-config 函数中真正读取&lt;strong&gt;storm.yaml&lt;/strong&gt;函数是由java代码来实现的， &lt;strong&gt;readStormConfig&lt;/strong&gt;定义在Utils.java中，该文件中解析yaml文件， 其中的Yaml类是由&lt;strong&gt;org.yaml.snakeyaml.Yaml&lt;/strong&gt; 提供的；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Apache thrift的使用步骤： &lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;编写后缀名为thrift的文件，使用工具生成对应语言的源代码，thrift支持的语言很多，包括C/C++/java/python等；&lt;/li&gt;
&lt;li&gt;实现thrift client；&lt;/li&gt;
&lt;li&gt;实现thrift server；thfirt server需要实现thrift文件中定义的service接口；&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;supervisor 启动时先设置了线程的未捕捉异常的Handler.  &lt;strong&gt;Thread.UncaughtExceptionHandler&lt;/strong&gt;解释:&lt;br&gt;一个处理接口，当一个线程因为没有捕捉的异常导致的突然终止时，该接口被唤醒。 当一个线程因为不能捕捉的异常将要终止的时候，JVM会调用getUncaughtExceptionHandler方法查找扎个线程对应的指定UncaughtExceptionHandler对象，并且回调这个对象的uncaughtException方法。如果这个线程没有指定的UncaughtExceptionHandler对象，那么将ThreadGroup对象作为UncaughtExceptionHandler对象，因为ThreadGroup类实现了Thread.UncaughtExceptionHandler接口；会调用顶层ThreadGroup的那个默认的UncaughtExceptionHandler对象的uncaughtException方法.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;standalone-supervisor&lt;/strong&gt; 方法实例化一个实现了ISupervisor 接口的对象;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;storm事件管理器&lt;/strong&gt;定义在event.clj中，主要功能就是通过独立线程执行”事件处理函数”。我们可以将”事件处理函数”添加到EventManager的阻塞队列中，EventManager的事件处理线程不断地从阻塞队列中获取”事件处理函数”并执行。&lt;br&gt;&lt;strong&gt;EventManager协议:&lt;/strong&gt;   协议就是一组函数定义的集合，协议中函数的第一个参数必须为实现该协议的实例本身，类似于java中实例方法的第一个参数为this；协议类似于java中的接口。&lt;/p&gt;
&lt;figure class=&quot;highlight clojure&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(&lt;span class=&quot;name&quot;&gt;&lt;span class=&quot;builtin-name&quot;&gt;defprotocol&lt;/span&gt;&lt;/span&gt; EventManager&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;add&lt;/span&gt; [this event-fn])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;waiting?&lt;/span&gt; [this])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (&lt;span class=&quot;name&quot;&gt;shutdown&lt;/span&gt; [this]))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;event-manager&lt;/strong&gt;函数定义如下:&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;(defn event-manager&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;quot;Creates a thread to respond to events. Any error will cause process to halt&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ;; daemon?表示是否将事件处理线程设置成守护线程&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  [daemon?]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ;; added表示已添加的&amp;quot;事件处理函数&amp;quot;的个数&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  (let [added (atom 0)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ;; processed表示已处理的&amp;quot;事件处理函数&amp;quot;的个数&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        processed (atom 0)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ;; queue绑定事件管理器的阻塞队列LinkedBlockingQueue&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ^LinkedBlockingQueue queue (LinkedBlockingQueue.)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ;; 设置事件管理器的状态为&amp;quot;running&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        running (atom true)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ;; 创建事件处理线程。Clojure函数实现了Runnable和Callable接口，所以可以将Clojure函数作为参数传递给java.lang.Thread类的构造函数&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        runner (Thread.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             ;; 事件处理线程循环检查事件处理器的状态是否是&amp;quot;running&amp;quot;，如果是，就从阻塞队列中获取&amp;quot;事件处理函数&amp;quot;，并执行；然后将processed加1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 (fn []&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                   (try-cause&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                     (while @running&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       (let [r (.take queue)]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                         (r)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                         (swap! processed inc)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                     (catch InterruptedException t&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       (log-message &amp;quot;Event manager interrupted&amp;quot;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                     (catch Throwable t&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       (log-error t &amp;quot;Error when processing event&amp;quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                       (exit-process! 20 &amp;quot;Error when processing an event&amp;quot;)))))]:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (.setDaemon runner daemon?)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ;; 启动事件处理线程&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (.start runner)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ;; 返回一个实现了EventManager协议的实例&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    (reify&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      EventManager&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      ;; add函数将&amp;quot;事件处理函数&amp;quot;添加到事件处理器的阻塞队列中&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (add&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        [this event-fn]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ;; should keep track of total added and processed to know if this is finished yet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (when-not @running&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          (throw (RuntimeException. &amp;quot;Cannot add events to a shutdown event manager&amp;quot;)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (swap! added inc)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (.put queue event-fn))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      ;; waiting?判断事件处理线程是否处于等待状态&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (waiting?&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        [this]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (or (Time/isThreadWaiting runner)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            (= @processed @added)))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      ;; 关闭事件管理器&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      (shutdown&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        [this]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (reset! running false)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (.interrupt runner)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        (.join runner)))))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;UI界面上的信息获取是在ui.core.clj 文件中实现的,里面实现了所有的UI  API 函数, 可以获取UI 界面信息;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;storm 0.11.0 版本中使用的thrift 是0.9.2 版本的,我用0.9.3 版本编辑结果后用以下命令比较:&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; `ls ./` ; &lt;span class=&quot;keyword&quot;&gt;do&lt;/span&gt; diff &lt;span class=&quot;variable&quot;&gt;$i&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;/home/yjk/storm-master-copy/storm-core/src/jvm/backtype/storm/generated/&lt;span class=&quot;variable&quot;&gt;$i&lt;/span&gt;&quot;&lt;/span&gt;; &lt;span class=&quot;keyword&quot;&gt;done&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;结果基本上是相等的, 但有细微差别. 存在许多以下转换&lt;/p&gt;
&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;       return get_num_tasks();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;---&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;gt;       return Integer.valueOf(get_num_tasks());&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;未完待续. &lt;/p&gt;
&lt;p&gt;&lt;br&gt; &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com&lt;/strong&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;ol&gt;
&lt;li&gt;&lt;p&gt;宏 for 和 doseq 可以用来做 list comprehension. 它们支持遍历多个集合 ( 最右边的最快 ) ,同时还可以做一些过滤用 :when 和 :while 。 宏 for 只接受一个表达式 ,它返回一个懒惰集合作为结果 . 宏 do
    
    </summary>
    
      <category term="集群技术" scheme="http://yanjiankang.cn/categories/%E9%9B%86%E7%BE%A4%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="storm" scheme="http://yanjiankang.cn/tags/storm/"/>
    
      <category term="zookeeper" scheme="http://yanjiankang.cn/tags/zookeeper/"/>
    
      <category term="clojure" scheme="http://yanjiankang.cn/tags/clojure/"/>
    
  </entry>
  
  <entry>
    <title>Storm并行度详解</title>
    <link href="http://yanjiankang.cn/Storm-introduce-parallism/"/>
    <id>http://yanjiankang.cn/Storm-introduce-parallism/</id>
    <published>2016-04-07T08:12:59.861Z</published>
    <updated>2015-08-06T03:44:38.000Z</updated>
    
    <content type="html">&lt;p&gt;##基本概念##&lt;br&gt;Spout是数据源；&lt;br&gt;Bolt封装了数据处理逻辑；&lt;br&gt;Worker是工作进程，一个工作进程中可以含有一个或者多个Executor线程；&lt;br&gt;Executor是运行Spout或者Bolt处理逻辑的线程；&lt;br&gt;Task是Storm中的最小处理单元，一个Executor中可以包含一个或者多个Task，消息的分发都是从一个task到另一个task进行的；&lt;br&gt;Stream Grouping定义了消息分发策略，定义了Bolt节点以何种方式接收数据；&lt;br&gt;Topology就是由消息分组方式连接起来的Spout和Bolt节点网络；&lt;/p&gt;
&lt;p&gt;##关系##&lt;br&gt;Worker由Supervisor负责启动，一个Worker中可以含有一个或者多个Executor线程，每个Executor线程都会启动一个消息循环线程，用于接收、处理和发送消息，当Executor收到其下某一task的消息后，就会调用该Task对应的处理逻辑对消息进行处理。&lt;/p&gt;
&lt;p&gt;每个executor只会运行1个topology的1个component(spout或bolt)的task（注：task可以是1个或多个，storm默认是1个component只生成1个task，executor线程里会在每次循环里&lt;strong&gt;顺序调用&lt;/strong&gt;所有task实例）。&lt;/p&gt;
&lt;p&gt;supervisor和node是一一对应的关系，而worker就是process（进程），executor就是thread（线程），task就是在spout或bolt中定义的函数。&lt;/p&gt;
&lt;p&gt;##storm的并行度解释##&lt;br&gt;下图为上述概念的关系图&lt;br&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/Storm_worker-processes_executors_tasks.png&quot; alt=&quot;storm并行度示意图1&quot;&gt;&lt;/p&gt;
&lt;p&gt;下面是storm并发度的一个计算方式。&lt;br&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/example-of-a-running-topology.png&quot; alt=&quot;storm并发度计算方式&quot;&gt;&lt;br&gt;其中是一个包含有两个 worker 进程的拓扑。其中，蓝色的 BlueSpout 有两个 executor，每个 executor 中有一个 task，并行度为 2；绿色的 GreenBolt 有两个 executor，每个 executor 有两个 task，并行度也为2；而黄色的 YellowBolt 有 6 个 executor，每个 executor 中有一个 task，并行度为 6，因此，这个拓扑的总并行度就是 2 + 2 + 6 = 10。具体分配到每个 worker 就有 10 / 2 = 5 个 executor。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;并行度是基于线程数量来确定的，线程数被平均分配到Worker进程中。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;提高storm并行度的方法&lt;/strong&gt;：增加work进程，增加executor线程，增加task实例&lt;/p&gt;
&lt;p&gt;##storm的并行度设置##&lt;/p&gt;
&lt;p&gt;###配置worker数量###&lt;br&gt;增加额外的worker 是增加topology 计算能力的简单方法。为此Storm 提供了API 和修改配置项两种修改方法。无论采取哪种方法，spout 和bolt 组件都不需要做变更，可以直接复用。&lt;br&gt;&lt;strong&gt;1 配置文件storm.yaml&lt;/strong&gt;&lt;br&gt;storm.yaml中，如下指定了worker进程的端口，以及当前机器下能运行的work数量,每个端口用于对应进程对外通讯的。&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;supervisor.slots.ports:    // 指定storm通讯端口    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - 6701  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - 6702  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - 6703  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      - 6704&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;默认的worker是4个，同时需要注意一个Slot的概念，Slots的数目默认是跟worker的允许端口数相同，但是如果机器是超线程的，那么Slots数目也会翻倍；&lt;/p&gt;
&lt;p&gt;2 代码中配置&lt;br&gt;worker进程数量也可以通过代码设置。(优先级更高)&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Config stormConf = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Config();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;config.setNumWorkers(workers);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;###配置executor数量###&lt;br&gt;如何每个组件需要的执行线程数？&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;代码中设置&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;builder.setSpout(id, spout, parallelism_hint)  &lt;span class=&quot;comment&quot;&gt;// parallelism_hint设置spout的线程数量&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setBolt(id, bolt, parallelism_hint)   &lt;span class=&quot;comment&quot;&gt;// parallelism_hint设置bolt的线程数量&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;注意，不设置的话，storm中默认是每个组件(spout或bolt)一个executor；&lt;br&gt;例如：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;TopologyBuilder builder = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; TopologyBuilder();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setSpout(&lt;span class=&quot;string&quot;&gt;&quot;spout&quot;&lt;/span&gt;, &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; RandomSentenceSpout(), &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setBolt(&lt;span class=&quot;string&quot;&gt;&quot;split&quot;&lt;/span&gt;, &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; SplitSentence(),&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                .shuffleGrouping(&lt;span class=&quot;string&quot;&gt;&quot;spout&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setBolt(&lt;span class=&quot;string&quot;&gt;&quot;count&quot;&lt;/span&gt;, &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; WordCount(),&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                .shuffleGrouping(&lt;span class=&quot;string&quot;&gt;&quot;split&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setBolt(&lt;span class=&quot;string&quot;&gt;&quot;report&quot;&lt;/span&gt;, &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ReportBolt())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                .globalGrouping(&lt;span class=&quot;string&quot;&gt;&quot;count&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中spout为2，split为2， count为4，report为1&lt;/p&gt;
&lt;p&gt;###配置task数量###&lt;br&gt;task是通过 spout/bolt的声明中setNumTasks(num)设置对应spout/bolt的task个数。&lt;br&gt;&lt;strong&gt;代码中设置&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;TopologyBuilder builder = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; TopologyBuilder();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setSpout(&lt;span class=&quot;string&quot;&gt;&quot;spout&quot;&lt;/span&gt;, &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; RandomSentenceSpout()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                .setNumTasks(&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;), &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setBolt(&lt;span class=&quot;string&quot;&gt;&quot;split&quot;&lt;/span&gt;, &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; SplitSentence()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                .setNumTasks(&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;),&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                .shuffleGrouping(&lt;span class=&quot;string&quot;&gt;&quot;spout&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setBolt(&lt;span class=&quot;string&quot;&gt;&quot;count&quot;&lt;/span&gt;, &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; WordCount()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                .setNumTasks(&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;),&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                .shuffleGrouping(&lt;span class=&quot;string&quot;&gt;&quot;split&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setBolt(&lt;span class=&quot;string&quot;&gt;&quot;report&quot;&lt;/span&gt;, &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ReportBolt())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                .globalGrouping(&lt;span class=&quot;string&quot;&gt;&quot;count&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;如果你在设置 bolt 的时候不指定 task 的数量，那么每个 executor 的 task 数会默认设置为 1。&lt;/p&gt;
&lt;p&gt;##其他知识##&lt;/p&gt;
&lt;p&gt;###worker调优###&lt;br&gt; Config类对象可设置如下参数，来调整worker进入数据，处理数据的容量大小：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;conf.put(Config.TOPOLOGY_RECEIVER_BUFFER_SIZE, &lt;span class=&quot;number&quot;&gt;8&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;conf.put(Config.TOPOLOGY_TRANSFER_BUFFER_SIZE, &lt;span class=&quot;number&quot;&gt;32&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;conf.put(Config.TOPOLOGY_EXECUTOR_RECEIVE_BUFFER_SIZE, &lt;span class=&quot;number&quot;&gt;16384&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;conf.put(Config.TOPOLOGY_EXECUTOR_SEND_BUFFER_SIZE, &lt;span class=&quot;number&quot;&gt;16384&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;###rebalance调整topology并行度&lt;br&gt;Storm 的一个很有意思的特点是你可以随时增加或者减少 worker 或者 executor 的数量，而不需要重启集群或者拓扑。这个方法就叫做再平衡（rebalance）。&lt;/p&gt;
&lt;p&gt;有两种方法可以对一个拓扑执行再平衡操作：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;使用 Storm UI&lt;/li&gt;
&lt;li&gt;使用命令行如下&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;## 重新配置拓扑 &quot;mytopology&quot;，使得该拓扑拥有 5 个 worker processes&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;##另外，配置名为 &quot;blue-spout&quot; 的 spout 使用 3 个 executor，配置名为 &quot;yellow-bolt&quot; 的 bolt 使用 10 个 executor。&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ storm rebalance mytopology -n 5 &lt;span class=&quot;_&quot;&gt;-e&lt;/span&gt; blue-spout=3 &lt;span class=&quot;_&quot;&gt;-e&lt;/span&gt; yellow-bolt=10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;##参考##&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;http://chengjianxiaoxue.iteye.com/blog/2188864&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://chengjianxiaoxue.iteye.com/blog/2188864&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.superwu.cn/2015/05/22/2316/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.superwu.cn/2015/05/22/2316/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://weyo.me/pages/techs/storm-translations-understanding-the-parallelism-of-a-storm-topology/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://weyo.me/pages/techs/storm-translations-understanding-the-parallelism-of-a-storm-topology/&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;br&gt; &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com&lt;/strong&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;##基本概念##&lt;br&gt;Spout是数据源；&lt;br&gt;Bolt封装了数据处理逻辑；&lt;br&gt;Worker是工作进程，一个工作进程中可以含有一个或者多个Executor线程；&lt;br&gt;Executor是运行Spout或者Bolt处理逻辑的线程；&lt;br&gt;Task是Storm中的最小处
    
    </summary>
    
      <category term="集群技术" scheme="http://yanjiankang.cn/categories/%E9%9B%86%E7%BE%A4%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="storm" scheme="http://yanjiankang.cn/tags/storm/"/>
    
      <category term="并行度" scheme="http://yanjiankang.cn/tags/%E5%B9%B6%E8%A1%8C%E5%BA%A6/"/>
    
      <category term="worker" scheme="http://yanjiankang.cn/tags/worker/"/>
    
      <category term="executor" scheme="http://yanjiankang.cn/tags/executor/"/>
    
  </entry>
  
  <entry>
    <title>采集rtsp流摄像头到浏览器实时播放方案</title>
    <link href="http://yanjiankang.cn/rtsp_camera_to_web_browser/"/>
    <id>http://yanjiankang.cn/rtsp_camera_to_web_browser/</id>
    <published>2016-04-07T08:12:59.859Z</published>
    <updated>2015-05-15T09:03:20.000Z</updated>
    
    <content type="html">&lt;p&gt;最近在做一个流媒体的项目，项目中需要采集摄像头的视频流到网页界面实时播放，一般ip摄像头的流格式都是rtsp的，虽然可以通过vlc实时播放，但是不如浏览器观看给用户的体验简单。&lt;/p&gt;
&lt;p&gt;根据查找的资料和实际的实践，目前发现的切实可行的方案有以下几种（因为项目是采用java开发，因此下面的代码也主要使用java实现）：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;使用xuggle库直接解码rtsp流，将解码的一帧帧图片发送给浏览器，使用html5的video播放mjpeg格式，即图片的不断刷新；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;使用xuggle库直接解码rtsp流，解码结果直接发送给rtmp服务器，然后浏览器使用flash直接播放rtmp的视频流；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;ffmpeg直接解码rtsp流，将解码结果使用http发送到nodejs服务器，nodejs服务器使用websocket发送给客户端，客户端使用canvas实时绘制图像；&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;下面详细介绍这几种方案。&lt;/p&gt;
&lt;h2 id=&quot;FFmpeg和Xuggle的简介&quot;&gt;&lt;a href=&quot;#FFmpeg和Xuggle的简介&quot; class=&quot;headerlink&quot; title=&quot;FFmpeg和Xuggle的简介&quot;&gt;&lt;/a&gt;FFmpeg和Xuggle的简介&lt;/h2&gt;&lt;p&gt;FFmpeg是一个自由软件，可以运行音频和视频多种格式的录影、转换、流功能，包含了libavcodec——这是一个用于多个项目中音频和视频的解码器库，以及libavformat——一个音频与视频格式转换库。&lt;br&gt;FFmpeg的安装请参考：&lt;a href=&quot;http://www.linuxidc.com/Linux/2014-05/101322.htm&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ubuntu上安装ffmpeg&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.xuggle.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;xuggle官网&lt;/a&gt;是一个开源的资源库，能够让开发者更好的去对视频和音频文件进行解码、编码、以及录制等功能。xuggle是对ffmepg的封装，是一套基于ffmpeg的开发库。 使用非常方便。 在java中使用时，请在eclipse中导入其jar包。 &lt;a href=&quot;http://pan.baidu.com/s/1pJj0GVD&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;xuggle-5.4-jar包下载&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;方案一的具体实现&quot;&gt;&lt;a href=&quot;#方案一的具体实现&quot; class=&quot;headerlink&quot; title=&quot;方案一的具体实现&quot;&gt;&lt;/a&gt;方案一的具体实现&lt;/h2&gt;&lt;p&gt;xuggle读取rtsp摄像头的代码如下：&lt;br&gt;import包如下：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.mediatool.IMediaReader;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.mediatool.MediaListenerAdapter;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.mediatool.ToolFactory;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.mediatool.event.IVideoPictureEvent;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中：streamLocation是需要读取的rtsp地址&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;mediaReader = ToolFactory.makeReader(streamLocation);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mediaReader.setBufferedImageTypeToGenerate(BufferedImage.TYPE_3BYTE_BGR）;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mediaReader.addListener(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (mediaReader.readPacket() == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; running ) ;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mediaReader.close();&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;上面这段代码实现了rtsp的持续读取，那么读取到的数据怎么获取，很简单，实现以下的帧回调函数onVideoPicture即可。&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * Gets called when FFMPEG transcoded a frame&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onVideoPicture&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(IVideoPictureEvent event)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	BufferedImage frame = event.getImage();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;//stream是用户自定义的rtsp视频流的id，例如;streamId = this.hashcode()即可&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	images.put(streamId ,frame);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	frameNr++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;以上的images是使用guava库的Cache建立的代码如下：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.google.common.cache.Cache;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.google.common.cache.CacheBuilder;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; Cache&amp;lt;String, BufferedImage&amp;gt; images = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;使用html5 video标签+javax.ws.rs实现的网页显示代码如下：&lt;br&gt;&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;126&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;127&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;128&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;129&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;130&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;131&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;132&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;133&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;134&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;135&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;136&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;137&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;138&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;139&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;140&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;141&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;142&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;143&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;144&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;145&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;146&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;147&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;148&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;149&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;150&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;151&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;152&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;153&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;154&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;155&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;156&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;157&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;158&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;159&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;160&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;161&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;162&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;163&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;164&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;165&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;166&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;167&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;168&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;169&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;170&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;171&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;172&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;173&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;174&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;175&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;176&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;177&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;178&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;179&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;180&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;181&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;182&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;183&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;184&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;185&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;186&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;187&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;188&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;189&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;190&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;191&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;192&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;193&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;194&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;195&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;196&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;197&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;198&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;199&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;200&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;201&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;202&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;203&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;204&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;205&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;206&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;207&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;208&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;209&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;210&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;211&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;212&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;213&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;214&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;215&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;216&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;217&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;218&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;219&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;220&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;221&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;222&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;223&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;224&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;225&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;226&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;227&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;228&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;229&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;230&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;231&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;232&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;233&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;234&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;235&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;236&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;237&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;238&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;239&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;240&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;241&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;242&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;243&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;244&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;245&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;246&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;247&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;248&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;249&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;250&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;251&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;252&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;253&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;import java.awt.image.BufferedImage;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import java.io.ByteArrayOutputStream;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import java.io.IOException;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import java.io.OutputStream;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import java.util.HashSet;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import java.util.Set;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import javax.imageio.ImageIO;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import javax.ws.rs.DefaultValue;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import javax.ws.rs.GET;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import javax.ws.rs.Path;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import javax.ws.rs.PathParam;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import javax.ws.rs.Produces;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import javax.ws.rs.QueryParam;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import javax.ws.rs.WebApplicationException;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import javax.ws.rs.core.Application;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import javax.ws.rs.core.Response;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import javax.ws.rs.core.StreamingOutput;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import org.slf4j.Logger;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import org.slf4j.LoggerFactory;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import com.google.common.cache.Cache;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import com.sun.jersey.api.container.httpserver.HttpServerFactory;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import com.sun.jersey.api.core.ApplicationAdapter;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;import com.sun.net.httpserver.HttpServer;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * A simple webservice used to view results MJPEG streams. &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * The webservice supports a number of calls different calls:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * &amp;lt;ol&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * &amp;lt;li&amp;gt;http://IP:PORT/streaming/streams : lists the available JPG and MJPEG urls&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * &amp;lt;/li&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * &amp;lt;li&amp;gt;http://IP:PORT/streaming/picture/&amp;#123;streamid&amp;#125;.jpg : url to grab jpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * pictures&amp;lt;/li&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * &amp;lt;li&amp;gt;http://IP:PORT/streaming/tiles : provides a visual overview of all the&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * streams available at this service. Clicking an image will open the mjpeg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * stream&amp;lt;/li&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * &amp;lt;li&amp;gt;http://IP:PORT/streaming/mjpeg/&amp;#123;streamid&amp;#125;.mjpeg : provides a possibly&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * never ending mjpeg formatted stream&amp;lt;/li&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * &amp;lt;/ol&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * The service runs on port 8558 by default but this can be changed by using the&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * port(int) method.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * @author Corne Versloot&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; *&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;@Path(&quot;/streaming&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;public class MjpegStreamingOp extends Application &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	private static Cache&amp;lt;String, BufferedImage&amp;gt; images = null;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	private Logger logger = LoggerFactory.getLogger(getClass());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	private HttpServer server;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	private int port = 8558;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	private int frameRate = 20;  // this parameter decide the sleep time&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	public MjpegStreamingOp port(int nr) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		this.port = nr;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		return this;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	public MjpegStreamingOp framerate(int nr) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		this.frameRate = nr;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		return this;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	public void prepare() throws IllegalArgumentException, IOException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	    //此处需要修改为从rtsp读进来的images存放的类&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		images = TCPClient.getImages();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		ApplicationAdapter connector = new ApplicationAdapter(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				new MjpegStreamingOp());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		server = HttpServerFactory.create(&quot;http://localhost:&quot; + port + &quot;/&quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				connector);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		server.start();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	/**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	 * Sets the classes to be used as resources for this application&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	 */&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	public Set&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt; getClasses() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		Set&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt; s = new HashSet&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		s.add(MjpegStreamingOp.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		return s;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	public void deactivate() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		server.stop(0);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		images.invalidateAll();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		images.cleanUp();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@GET&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@Path(&quot;/streams&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@Produces(&quot;text/plain&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	public String getStreamIds() throws IOException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		String result = new String();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		for (String id : images.asMap().keySet()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			result += &quot;/streaming/picture/&quot; + id + &quot;.jpeg\r\n&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		System.out.println(&quot;\r\n&quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		for (String id : images.asMap().keySet()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			result += &quot;/streaming/mjpeg/&quot; + id + &quot;.mjpeg\r\n&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		return result;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@GET&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@Path(&quot;/picture/&amp;#123;streamid&amp;#125;.jpeg&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@Produces(&quot;image/jpg&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	public Response jpeg(@PathParam(&quot;streamid&quot;) final String streamId) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		BufferedImage image = null;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		if ((image = images.getIfPresent(streamId)) != null) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			ByteArrayOutputStream baos = new ByteArrayOutputStream();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				ImageIO.write(image, &quot;jpg&quot;, baos);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				byte[] imageData = baos.toByteArray();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				return Response.ok(imageData).build(); // non streaming&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				// return Response.ok(new&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				// ByteArrayInputStream(imageDAta)).build(); // streaming&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&amp;#125; catch (IOException ioe) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				logger.warn(&quot;Unable to write image to output&quot;, ioe);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				return Response.serverError().build();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125; else &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			return Response.noContent().build();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@GET&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@Path(&quot;/playmultiple&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@Produces(&quot;text/html&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	public String showPlayers(@DefaultValue(&quot;3&quot;) @QueryParam(&quot;cols&quot;) int cols,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			@DefaultValue(&quot;0&quot;) @QueryParam(&quot;offset&quot;) int offset,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			@DefaultValue(&quot;6&quot;) @QueryParam(&quot;number&quot;) int number)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			throws IOException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		// number = Math.min(6, number);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		String result = &quot;&amp;lt;html&amp;gt;&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;Mjpeg stream players&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		                &amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body bgcolor=\&quot;#3C3C3C\&quot;&amp;gt;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		result += &quot;&amp;lt;font style=\&quot;color:#CCC;\&quot;&amp;gt;Streams: &quot; + images.size()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				+ &quot; (showing &quot; + offset + &quot; - &quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				+ Math.min(images.size(), offset + number) + &quot;)&amp;lt;/font&amp;gt;&amp;lt;br/&amp;gt;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		result += &quot;&amp;lt;table style=\&quot;border-spacing:0; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		           border-collapse: collapse;\&quot;&amp;gt;&amp;lt;tr&amp;gt;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		int videoNr = 0;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		for (String id : images.asMap().keySet()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			if (videoNr &amp;lt; offset) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				videoNr++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				continue;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			if (videoNr - offset &amp;gt; 0 &amp;amp;&amp;amp; (videoNr - offset) % cols == 0) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				result += &quot;&amp;lt;/tr&amp;gt;&amp;lt;tr&amp;gt;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			result += &quot;&amp;lt;td&amp;gt;&amp;lt;video poster=\&quot;mjpeg/&quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					+ id&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					+ &quot;.mjpeg\&quot;&amp;gt;&quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					+ &quot;Your browser does not support the video tag.&amp;lt;/video&amp;gt;&amp;lt;/td&amp;gt;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			// result +=&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			// &quot;&amp;lt;td&amp;gt;&amp;lt;img src=\&quot;http://&quot;+InetAddress.getLocalHost().getHostAddress()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			                 +&quot;:&quot;+port+&quot;/streaming/mjpeg/&quot;+id+&quot;.mjpeg\&quot;&amp;gt;&amp;lt;/td&amp;gt;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			if (videoNr &amp;gt; offset + number)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				break;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			videoNr++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		result += &quot;&amp;lt;/tr&amp;gt;&amp;lt;/table&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		return result;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@GET&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@Path(&quot;/play&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@Produces(&quot;text/html&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	public String showPlayers(@QueryParam(&quot;streamid&quot;) String streamId)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			throws IOException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		String result = &quot;&amp;lt;html&amp;gt;&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;Mjpeg stream: &quot; + streamId&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				+ &quot;&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body bgcolor=\&quot;#3C3C3C\&quot;&amp;gt;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		result += &quot;&amp;lt;font style=\&quot;color:#CCC;\&quot;&amp;gt;&amp;lt;a href=\&quot;tiles\&quot;&amp;gt;Back&amp;lt;/a&amp;gt;&amp;lt;/font&amp;gt;&amp;lt;br/&amp;gt;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		result += &quot;&amp;lt;table style=\&quot;border-spacing:0; border-collapse: collapse;\&quot;&amp;gt;&amp;lt;tr&amp;gt;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		result += &quot;&amp;lt;video poster=\&quot;mjpeg/&quot; + streamId + &quot;.mjpeg\&quot;&amp;gt;&quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				+ &quot;Your browser does not support the video tag.&amp;lt;/video&amp;gt;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		return result;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@GET&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@Path(&quot;/tiles&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@Produces(&quot;text/html&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	public String showTiles(@DefaultValue(&quot;3&quot;) @QueryParam(&quot;cols&quot;) int cols,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			@DefaultValue(&quot;-1&quot;) @QueryParam(&quot;width&quot;) float width)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			throws IOException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		String result = &quot;&amp;lt;html&amp;gt;&amp;lt;head&amp;gt;&amp;lt;title&amp;gt;Mjpeg stream players&amp;lt;/title&amp;gt;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		result += &quot;&amp;lt;/head&amp;gt;&amp;lt;body bgcolor=\&quot;#3C3C3C\&quot;&amp;gt;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		result += &quot;&amp;lt;table style=\&quot;border-spacing:0; border-collapse: collapse;\&quot;&amp;gt;&amp;lt;tr&amp;gt;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		int videoNr = 0;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		for (String id : images.asMap().keySet()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			if (videoNr &amp;gt; 0 &amp;amp;&amp;amp; videoNr % cols == 0) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				result += &quot;&amp;lt;/tr&amp;gt;&amp;lt;tr&amp;gt;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			result += &quot;&amp;lt;td&amp;gt;&amp;lt;a href=\&quot;play?streamid=&quot; + id&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					+ &quot;\&quot;&amp;gt;&amp;lt;img src=\&quot;picture/&quot; + id + &quot;.jpeg\&quot; &quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					+ (width &amp;gt; 0 ? &quot;width=\&quot;&quot; + width + &quot;\&quot;&quot; : &quot;&quot;) + &quot;/&amp;gt;&amp;lt;/a&amp;gt;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			videoNr++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		result += &quot;&amp;lt;/tr&amp;gt;&amp;lt;/table&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		return result;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@GET&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@Path(&quot;/mjpeg/&amp;#123;streamid&amp;#125;.mjpeg&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	@Produces(&quot;multipart/x-mixed-replace; boundary=--BoundaryString\r\n&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	public Response mjpeg(@PathParam(&quot;streamid&quot;) final String streamId) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		StreamingOutput output = new StreamingOutput() &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			private BufferedImage prevImage = null;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			private int sleep = 1000 / frameRate;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			@Override&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			public void write(OutputStream outputStream) throws IOException,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					WebApplicationException &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				BufferedImage image = null;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				try &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					while ((image = images.getIfPresent(streamId)) != null) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;						if (prevImage == null || !image.equals(prevImage)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;							ByteArrayOutputStream baos = new ByteArrayOutputStream();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;							ImageIO.write(image, &quot;jpg&quot;, baos);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;							byte[] imageData = baos.toByteArray();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;							outputStream&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;									.write((&quot;--BoundaryString\r\n&quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;											+ &quot;Content-type: image/jpeg\r\n&quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;											+ &quot;Content-Length: &quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;											+ imageData.length + &quot;\r\n\r\n&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;											.getBytes());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;							outputStream.write(imageData);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;							outputStream.write(&quot;\r\n\r\n&quot;.getBytes());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;							outputStream.flush();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;						&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;						Thread.sleep(sleep);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					outputStream.flush();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					outputStream.close();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				&amp;#125; catch (IOException ioe) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					logger.info(&quot;Steam for [&quot; + streamId&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;							+ &quot;] closed by client!&quot;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				&amp;#125; catch (InterruptedException e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					e.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		return Response.ok(output).header(&quot;Connection&quot;, &quot;close&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				.header(&quot;Max-Age&quot;, &quot;0&quot;).header(&quot;Expires&quot;, &quot;0&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				.header(&quot;Cache-Control&quot;, &quot;no-cache, private&quot;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				.header(&quot;Pragma&quot;, &quot;no-cache&quot;).build();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;以上代码参考自github上stormcv项目，项目地址为：&lt;a href=&quot;https://github.com/sensorstorm/StormCV&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;https://github.com/sensorstorm/StormCV&lt;/a&gt;, 感谢原作者。&lt;/p&gt;
&lt;p&gt;至此，打开网页 &lt;a href=&quot;http://localhost:8558/streaming/tiles&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://localhost:8558/streaming/tiles&lt;/a&gt; 即可查看到实时视频。&lt;/p&gt;
&lt;h2 id=&quot;方案二的具体实现&quot;&gt;&lt;a href=&quot;#方案二的具体实现&quot; class=&quot;headerlink&quot; title=&quot;方案二的具体实现&quot;&gt;&lt;/a&gt;方案二的具体实现&lt;/h2&gt;&lt;h3 id=&quot;xuggle库转rtsp为rtmp&quot;&gt;&lt;a href=&quot;#xuggle库转rtsp为rtmp&quot; class=&quot;headerlink&quot; title=&quot;xuggle库转rtsp为rtmp&quot;&gt;&lt;/a&gt;xuggle库转rtsp为rtmp&lt;/h3&gt;&lt;p&gt;rtsp的reader：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;120&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.slf4j.Logger;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.slf4j.LoggerFactory;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.mediatool.IMediaReader;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.mediatool.MediaListenerAdapter;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.mediatool.ToolFactory;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.mediatool.event.IVideoPictureEvent;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.xuggler.ICodec;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.xuggler.IContainer;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.xuggler.IVideoPicture;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * This class reads a video stream or file, decodes frames and transcode to rtmp stream&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * &lt;span class=&quot;doctag&quot;&gt;@author&lt;/span&gt; jkyan&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;RTSPReader&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;MediaListenerAdapter&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Runnable&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; Logger logger = LoggerFactory.getLogger(RTSPReader.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; IMediaReader mediaReader;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; frameSkip;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; groupSize;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; frameNr; &lt;span class=&quot;comment&quot;&gt;// number of the frame read so far&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; running = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// used to determine if the EOF was reached if Xuggler does not detect it&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; lastRead = -&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; sleepTime = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; String streamName; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; String streamLocation = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; RTMPWriter rtmpWriter = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	Double frameRate = &lt;span class=&quot;number&quot;&gt;0.0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// frameskip和groupsize决定了需要读取的帧的数目，即采样率，&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 例如，1,1时代表每一帧都需要读取，10,5时代表只需要[0 1 2 3 4] [10 11 12 13 14] ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;RTSPReader&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String streamName, String streamLocation, &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; frameSkip, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; groupSize, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; sleepTime)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.streamLocation = streamLocation;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.frameSkip = Math.max(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, frameSkip);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.groupSize = Math.max(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, groupSize);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.sleepTime = sleepTime;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.streamName = streamName;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		lastRead = System.currentTimeMillis() + &lt;span class=&quot;number&quot;&gt;10000&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	 * Start reading the provided URL&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	 */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		running = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (running) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				&lt;span class=&quot;comment&quot;&gt;// if a url was provided read it&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (streamLocation != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					logger.info(&lt;span class=&quot;string&quot;&gt;&quot;Start reading stream: &quot;&lt;/span&gt; + streamLocation);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					mediaReader = ToolFactory.makeReader(streamLocation);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					lastRead = System.currentTimeMillis() + &lt;span class=&quot;number&quot;&gt;10000&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					frameNr = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					rtmpWriter = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; RTMPWriter(&lt;span class=&quot;number&quot;&gt;576&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;704&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;30.0&lt;/span&gt;,streamName);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					mediaReader.addListener(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					&lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (mediaReader.readPacket() == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; running);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					&lt;span class=&quot;comment&quot;&gt;// reset internal state&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					rtmpWriter.setFinish();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					mediaReader.close();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					logger.error(&lt;span class=&quot;string&quot;&gt;&quot;No stream provided, nothing to read&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;					&lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (Exception e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				logger.warn(&lt;span class=&quot;string&quot;&gt;&quot;Stream closed unexpectatly: &quot;&lt;/span&gt; + e.getMessage(), e);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				&lt;span class=&quot;comment&quot;&gt;// sleep a minute and try to read the stream again&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				sleep(&lt;span class=&quot;number&quot;&gt;60&lt;/span&gt; * &lt;span class=&quot;number&quot;&gt;1000&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		running = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;sleep&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; ms)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			Thread.sleep(ms);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			e.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	 * Gets called when FFMPEG transcoded a frame&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	 */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onVideoPicture&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(IVideoPictureEvent event)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		lastRead = System.currentTimeMillis();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (frameNr % frameSkip &amp;lt; groupSize) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			IVideoPicture picture = event.getPicture();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			rtmpWriter.write(frameNr, picture);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;comment&quot;&gt;// enforced throttling&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (sleepTime &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				sleep(sleepTime);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		frameNr++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	 * Tells the StreamReader to stop reading frames&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	 */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;stop&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		running = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	 * Returns whether the StreamReader is still active or not&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	 * &lt;span class=&quot;doctag&quot;&gt;@return&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	 */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;isRunning&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;comment&quot;&gt;// kill this thread if the last frame read is to long ago&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;comment&quot;&gt;// (means Xuggler missed the EoF) and clear resources&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (lastRead &amp;gt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; &amp;amp;&amp;amp; System.currentTimeMillis() - lastRead &amp;gt; &lt;span class=&quot;number&quot;&gt;3000&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			running = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (mediaReader != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; mediaReader.getContainer() != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				mediaReader.getContainer().close();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.running;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://itony.me/619.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;rtmp服务器的搭建方法&lt;/a&gt;请参考这里。&lt;/p&gt;
&lt;p&gt;rtmp的writer：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;107&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.xuggler.ICodec;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.xuggler.IContainer;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.xuggler.IContainerFormat;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.xuggler.IPacket;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.xuggler.IPixelFormat;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.xuggler.IRational;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.xuggler.IStream;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.xuggler.IStreamCoder;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; com.xuggle.xuggler.IVideoPicture;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.Collection;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.Iterator;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; javax.management.RuntimeErrorException;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.slf4j.Logger;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.slf4j.LoggerFactory;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;RTMPWriter&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; Logger logger = LoggerFactory.getLogger(RTMPWriter.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;// private static String url = &quot;&quot;;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; String url = &lt;span class=&quot;string&quot;&gt;&quot;rtmp://localhost:1935/live1/&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; String appName = &lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; height = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; width = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; IStreamCoder coder = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; IContainer container = &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; Boolean isfinish = &lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//rtmp writer中需要获取rtsp流图像的宽和高，帧频作为编码参数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;//rtmp服务器的地址格式一般为：ip+端口+地址+应用名称&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;meta&quot;&gt;@SuppressWarnings&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;deprecation&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;RTMPWriter&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; height, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; width, &lt;span class=&quot;keyword&quot;&gt;double&lt;/span&gt; frameRate, String appName)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		container = IContainer.make();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		IContainerFormat containerFormat = IContainerFormat.make();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		containerFormat.setOutputFormat(&lt;span class=&quot;string&quot;&gt;&quot;flv&quot;&lt;/span&gt;, url + appName, &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;comment&quot;&gt;// set the buffer length xuggle will suggest to ffmpeg for reading inputs&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		container.setInputBufferLength(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; retVal = container.open(url + appName, IContainer.Type.WRITE,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				containerFormat);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (retVal &amp;lt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			logger.error(&lt;span class=&quot;string&quot;&gt;&quot;Could not open output container for live stream&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			logger.info(&lt;span class=&quot;string&quot;&gt;&quot;hava opened server &quot;&lt;/span&gt; + url + appName + &lt;span class=&quot;string&quot;&gt;&quot; for write!&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		IStream stream = container.addNewStream(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		coder = stream.getStreamCoder();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		ICodec codec = ICodec.findEncodingCodec(ICodec.ID.CODEC_ID_H264);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (codec == &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			logger.warn(&lt;span class=&quot;string&quot;&gt;&quot;cannot find h264 encoding codec!&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			Collection&amp;lt;ICodec&amp;gt; icodec_collections = ICodec.getInstalledCodecs();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			Iterator&amp;lt;ICodec&amp;gt; iterator = icodec_collections.iterator();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (iterator.hasNext()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				ICodec icodec = iterator.next();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				logger.info(&lt;span class=&quot;string&quot;&gt;&quot;Your system supports codec:&quot;&lt;/span&gt; + icodec.getName());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			coder.setCodec(codec);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		coder.setNumPicturesInGroupOfPictures(&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		coder.setBitRate(&lt;span class=&quot;number&quot;&gt;256000&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		coder.setPixelType(IPixelFormat.Type.YUV420P);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (width == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; || height == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			logger.error(&lt;span class=&quot;string&quot;&gt;&quot;cannot get the real size of the stream needed to read&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		coder.setHeight(height);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		coder.setWidth(width);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		coder.setFlag(IStreamCoder.Flags.FLAG_QSCALE, &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		coder.setGlobalQuality(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		IRational rationalFrameRate = IRational.make(frameRate);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		coder.setFrameRate(rationalFrameRate);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		coder.setTimeBase(IRational.make(rationalFrameRate.getDenominator(),&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				rationalFrameRate.getNumerator()));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		coder.open();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		logger.info(&lt;span class=&quot;string&quot;&gt;&quot;[ENCODER] address: &quot;&lt;/span&gt; + url + appName + &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				&lt;span class=&quot;string&quot;&gt;&quot;\n video size is &quot;&lt;/span&gt; + width + &lt;span class=&quot;string&quot;&gt;&quot;x&quot;&lt;/span&gt; + height &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				+ &lt;span class=&quot;string&quot;&gt;&quot; and framerate is &quot;&lt;/span&gt; + frameRate);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (container.writeHeader() &amp;lt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		  &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;string&quot;&gt;&quot;cannot write header&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;setFinish&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.isfinish = &lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; frameNr, IVideoPicture picture)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		IPacket packet = IPacket.make();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (frameNr == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;comment&quot;&gt;// make first frame keyframe&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			picture.setKeyFrame(&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		picture.setQuality(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		coder.encodeVideo(packet, picture, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		picture.delete();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (packet.isComplete()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (container.writePacket(packet) &amp;lt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				&lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;string&quot;&gt;&quot;cannot write packet&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				logger.info(&lt;span class=&quot;string&quot;&gt;&quot;[ENCODER] writing packet of size &quot;&lt;/span&gt; + packet.getSize());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&amp;#125;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isfinish) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (container.writeTrailer() &amp;lt; &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;				&lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;string&quot;&gt;&quot;cannot write Trailer&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			coder.close();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			container.close();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;到这里已经实现了rtsp流推送到rtsp的服务器。下一步即为rtmp流的显示。使用的是&lt;a href=&quot;https://flowplayer.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;flowplayer&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;FlowPlayer 是一个用Flash开发的在Web上的视频播放器，可以很容易将它集成在任何的网页上。支持HTTP以及流媒体传输。&lt;/p&gt;
&lt;p&gt;FlowPlayer的示例程序可以&lt;a href=&quot;http://pan.baidu.com/s/1sjJU1zR&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;点击此处&lt;/a&gt;下载。(FlowPlayer是商业软件，此处仅作测试，请支持正版)&lt;/p&gt;
&lt;p&gt;下载flowplay并实现以下的html，即可。&lt;br&gt;&lt;figure class=&quot;highlight html&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;&amp;lt;!DOCTYPE html&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;html&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;head&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;script&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;type&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;text/javascript&quot;&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;src&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;flowplayer-3.2.13.min.js&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;undefined&quot;&gt;&lt;/span&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;title&lt;/span&gt;&amp;gt;&lt;/span&gt;RTSP Camera to RTMP Player&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;title&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;head&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;body&lt;/span&gt;&amp;gt;&lt;/span&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;h1&lt;/span&gt;&amp;gt;&lt;/span&gt;RTSP Camera to RTMP Player&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;h1&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;&amp;lt;!-- this A tag is where your Flowplayer will be placed. it can be anywhere --&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;a&lt;/span&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		 &lt;span class=&quot;attr&quot;&gt;href&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;#&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		 &lt;span class=&quot;attr&quot;&gt;style&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;display:block;width:520px;height:330px&quot;&lt;/span&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		 &lt;span class=&quot;attr&quot;&gt;id&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;player&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;a&lt;/span&gt;&amp;gt;&lt;/span&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;&amp;lt;!-- this will install flowplayer inside previous A- tag. --&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;comment&quot;&gt;&amp;lt;!-- 修改url为rtmp的应用名称，netConnectionUrl为rtmp服务器的地址 --&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;undefined&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	flowplayer(&quot;player&quot;, &quot;flowplayer-3.2.18.swf&quot;,&amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		clip: &amp;#123; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		  url: &#39;app&#39;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		  provider: &#39;rtmp&#39;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		  live: true, &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;,  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		plugins: &amp;#123;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		   rtmp: &amp;#123;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			 url: &#39;flowplayer.rtmp-3.2.13.swf&#39;,  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			 netConnectionUrl: &#39;rtmp://localhost:1935/live1&#39;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		   &amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	   &amp;#125; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;/span&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;p&lt;/span&gt;&amp;gt;&lt;/span&gt;		&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		Sample RTMP URL (Live) is &quot;rtmp://live.hkstv.hk.lxdns.com/live/hks&quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;p&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;body&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;html&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;启动rtmp服务器，实例化上面的RTSPReader类并传入相应的rtsp摄像头地址，再打开这个网页即可看到摄像头直播。可以使用VLC打开rtsp流对比观看。&lt;br&gt;rtsp示例地址:  rtsp://streaming3.webcam.nl:1935/n224/n224.stream&lt;/p&gt;
&lt;p&gt;另外推荐一个世界各地的摄像头直播网站，很有趣: &lt;a href=&quot;http://geocam.tv/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;世界各地的摄像头&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;ffmpeg-命令直接-转rtsp为rtmp&quot;&gt;&lt;a href=&quot;#ffmpeg-命令直接-转rtsp为rtmp&quot; class=&quot;headerlink&quot; title=&quot;ffmpeg 命令直接 转rtsp为rtmp&quot;&gt;&lt;/a&gt;ffmpeg 命令直接 转rtsp为rtmp&lt;/h3&gt;&lt;p&gt; 上面是使用java库转rtsp为rtmp。&lt;br&gt; ffmpeg直接就可以通过命令将rtsp转rtmp&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ffmpeg -i rtsp://地址  &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; flv  rtmp://localhost:1935/live1/app&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;方案三的具体实现&quot;&gt;&lt;a href=&quot;#方案三的具体实现&quot; class=&quot;headerlink&quot; title=&quot;方案三的具体实现&quot;&gt;&lt;/a&gt;方案三的具体实现&lt;/h2&gt;&lt;p&gt;这套方案参考地址为：&lt;a href=&quot;http://segmentfault.com/a/1190000000392586&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;使用 WebSockets 进行 HTML5 视频直播 - SegmentFault&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;具体实现如下：&lt;br&gt;来自rtsp摄像头的视频被 ffmpeg 编码，然后通过 HTTP 传递给一个 Node.js 写的小脚本；脚本会将这条 MPEG 视频流通过 WebSockets 分发给所有链接的浏览器；浏览器使用 JavaScript 解码 MPEG 视频流并将解码后的画面渲染到 Canvas 元素上。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;安装nodejs&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;sudo apt-get install nodejs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo apt-get install npm&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo apt-get install node-legacy&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;下载 &lt;a href=&quot;https://github.com/phoboslab/jsmpeg&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;phoboslab/jsmpeg 项目&lt;/a&gt;的 &lt;a href=&quot;https://github.com/phoboslab/jsmpeg/blob/master/stream-server.js&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;stream-server.js&lt;/a&gt; 脚本。安装 WebSocket包ws并启动服务器： &lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;npm install ws
node stream-server.js 你的密码
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;这里的密码是用来确视频流不被劫持用的。如果服务器运行正常，你应该会看到这样的输出： &lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;Listening &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; MPEG Stream on http://127.0.0.1:8082/&amp;lt;secret&amp;gt;/&amp;lt;width&amp;gt;/&amp;lt;height&amp;gt;
Awaiting WebSocket connections on ws://127.0.0.1:8084/
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;服务器启动后，你就可以启动 ffmpeg 并将它指向到正在运行的这个域名和端口了： &lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;ffmpeg -i rtsp://admin:12345@10.124.142.15:554/h264/ch1/main/av_stream  &lt;span class=&quot;_&quot;&gt;-f&lt;/span&gt; mpeg1video  -r 25  &lt;span class=&quot;_&quot;&gt;-s&lt;/span&gt; 640x480  http://localhost:8082/123456/640/480/
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;这条命令会开始从rtsp流捕捉 640x480 的视频，并编码成 25fps 码率的 MPEG 视频。编码后的视频会通过 HTTP 被发送到所指定的服务器和端口。确保密码正确，URL 中的长和宽也需要正确指定，否则服务器无法正确判断当前的分辨率。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;要观看直播，需要从前文提到的 &lt;a href=&quot;https://github.com/phoboslab/jsmpeg&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;jsmpeg 项目&lt;/a&gt;中下载 stream-example.html 和 jsmpg.js 文件，更改 stream-example.html 中的 WebSocket URL 为你的服务器地址，并使用你喜欢的浏览器打开。 &lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;如果一切正常，你就能看到摄像头画面。&lt;/p&gt;
&lt;h2 id=&quot;总结&quot;&gt;&lt;a href=&quot;#总结&quot; class=&quot;headerlink&quot; title=&quot;总结&quot;&gt;&lt;/a&gt;总结&lt;/h2&gt;&lt;p&gt;以上三种方案得到的结果都会有延时，具体的分析未完待续。&lt;/p&gt;
&lt;p&gt;&lt;br&gt; &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com&lt;/strong&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;最近在做一个流媒体的项目，项目中需要采集摄像头的视频流到网页界面实时播放，一般ip摄像头的流格式都是rtsp的，虽然可以通过vlc实时播放，但是不如浏览器观看给用户的体验简单。&lt;/p&gt;
&lt;p&gt;根据查找的资料和实际的实践，目前发现的切实可行的方案有以下几种（因为项目是采用ja
    
    </summary>
    
      <category term="流媒体技术" scheme="http://yanjiankang.cn/categories/%E6%B5%81%E5%AA%92%E4%BD%93%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="rtsp" scheme="http://yanjiankang.cn/tags/rtsp/"/>
    
      <category term="web" scheme="http://yanjiankang.cn/tags/web/"/>
    
      <category term="摄像头" scheme="http://yanjiankang.cn/tags/%E6%91%84%E5%83%8F%E5%A4%B4/"/>
    
      <category term="rtmp" scheme="http://yanjiankang.cn/tags/rtmp/"/>
    
      <category term="html5" scheme="http://yanjiankang.cn/tags/html5/"/>
    
      <category term="nodejs" scheme="http://yanjiankang.cn/tags/nodejs/"/>
    
      <category term="xuggle" scheme="http://yanjiankang.cn/tags/xuggle/"/>
    
  </entry>
  
  <entry>
    <title>python中列表删除满足条件元素的方法</title>
    <link href="http://yanjiankang.cn/python_list_delete_element/"/>
    <id>http://yanjiankang.cn/python_list_delete_element/</id>
    <published>2016-04-07T08:12:59.858Z</published>
    <updated>2015-08-05T07:58:54.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;问题的产生&quot;&gt;&lt;a href=&quot;#问题的产生&quot; class=&quot;headerlink&quot; title=&quot;问题的产生&quot;&gt;&lt;/a&gt;问题的产生&lt;/h2&gt;&lt;p&gt;最近的开发中遇到的问题为：需要删除python中list中满足条件的元素，例如，删除【1,2,3,4,5】中不是4的元素：&lt;br&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#!/usr/bin/env python&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;l = [&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; l :&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; i != &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt; :&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        l.remove(i)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;print&lt;/span&gt; l&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后运行的结果是【2,4】，明显出错了，我们详细分析一下为什么：&lt;br&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#!/usr/bin/env python&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;l = [&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; l :&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;print&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&quot;i:%d&quot;&lt;/span&gt; % i&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; i != &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt; :&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        l.remove(i)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;print&lt;/span&gt; l&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;运行结果为：&lt;br&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;i:&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;i:&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;i:&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;遍历完1后直接到3，然后到5，2和4被跳过了；&lt;br&gt;&lt;strong&gt;推导原因如下&lt;/strong&gt;：&lt;br&gt;list.remove(i)方法用于删除列表中等于i的第一个元素，这个方法不返回任何值，第一次删除后l变成[2,3,4,5],此时for循环的index增加为1；&lt;br&gt;第二次遍历时，直接遍历到3，删除3后，index变为2，l变为[3,4,5],然后删除3，依此类推；&lt;/p&gt;
&lt;p&gt;##正确的方法##&lt;br&gt;&lt;strong&gt;1 使用Lambada表达式&lt;/strong&gt;：&lt;br&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;l = [&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;l = filter(&lt;span class=&quot;keyword&quot;&gt;lambda&lt;/span&gt; x:x !=&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;,l)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中filter要求两个参数，第一个是规则函数，第二个参数要求输入序列，而lambda这个函数的作用就是产生一个函数，是一种紧凑小函数的写法&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2 使用列表解析&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;l = [&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;l = [ i &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; l &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; i !=&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;3 建立新的list存放要删除的元素&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;l = [&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;dellist = []&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; l:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; i != &lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        dellist.append(i)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; dellist:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    l.remove(i)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;##参考##&lt;br&gt;&lt;a href=&quot;http://gmingzhe.blog.51cto.com/810664/165905&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://gmingzhe.blog.51cto.com/810664/165905&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;br&gt; &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com&lt;/strong&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;问题的产生&quot;&gt;&lt;a href=&quot;#问题的产生&quot; class=&quot;headerlink&quot; title=&quot;问题的产生&quot;&gt;&lt;/a&gt;问题的产生&lt;/h2&gt;&lt;p&gt;最近的开发中遇到的问题为：需要删除python中list中满足条件的元素，例如，删除【1,2,3,4,5】中不是4的
    
    </summary>
    
      <category term="python" scheme="http://yanjiankang.cn/categories/python/"/>
    
    
      <category term="python" scheme="http://yanjiankang.cn/tags/python/"/>
    
      <category term="list" scheme="http://yanjiankang.cn/tags/list/"/>
    
      <category term="delete" scheme="http://yanjiankang.cn/tags/delete/"/>
    
  </entry>
  
  <entry>
    <title>OpenCV  Java API 读取 RTSP 摄像头</title>
    <link href="http://yanjiankang.cn/OpenCV%20-Java-API-%20Read-RTSP-Camera/"/>
    <id>http://yanjiankang.cn/OpenCV -Java-API- Read-RTSP-Camera/</id>
    <published>2016-04-07T08:12:59.856Z</published>
    <updated>2016-01-27T01:29:38.000Z</updated>
    
    <content type="html">&lt;p&gt;我的配置：Centos 6.4 + opencv 2.4.8 + ffmpeg  2.8.5&lt;/p&gt;
&lt;p&gt;最近在用opencv的VideoCapture读取rtsp摄像头，首先找到以下代码，想测试一下：&lt;/p&gt;
&lt;h2 id=&quot;测试代码&quot;&gt;&lt;a href=&quot;#测试代码&quot; class=&quot;headerlink&quot; title=&quot;测试代码&quot;&gt;&lt;/a&gt;&lt;strong&gt;测试代码&lt;/strong&gt;&lt;/h2&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.opencv.core.Mat;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.opencv.highgui.Highgui;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.opencv.highgui.VideoCapture;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; * Created by jkyan on 1/26/16.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;OpenCVRTSPReader&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String[] args)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         System.load(&lt;span class=&quot;string&quot;&gt;&quot;/lib/linux64_opencv_java248.so&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         VideoCapture capture = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; VideoCapture(&lt;span class=&quot;string&quot;&gt;&quot;rtsp://218.204.223.237:554/live/1/66251FC11353191F/e7ooqwcfbqjoo80j.sdp&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         Mat image=&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Mat();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;span class=&quot;keyword&quot;&gt;double&lt;/span&gt; propid=&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         capture.open(&lt;span class=&quot;string&quot;&gt;&quot;rtsp://218.204.223.237:554/live/1/66251FC11353191F/e7ooqwcfbqjoo80j.sdp&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (capture.isOpened()) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             System.out.println(&lt;span class=&quot;string&quot;&gt;&quot;Video is captured&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; x=&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (x&amp;lt;&lt;span class=&quot;number&quot;&gt;18&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 x=x+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 propid=capture.get(x);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 System.out.println(&lt;span class=&quot;string&quot;&gt;&quot;Property Id is &quot;&lt;/span&gt; + x + &lt;span class=&quot;string&quot;&gt;&quot; value =&quot;&lt;/span&gt;+ propid);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             &lt;span class=&quot;comment&quot;&gt;// grab 10 frames as a test&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (i &amp;lt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                     &lt;span class=&quot;comment&quot;&gt;//capture.retrieve(image); //same results as .read()&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                     capture.read(image);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                     &lt;span class=&quot;comment&quot;&gt;//Highgui.imwrite(&quot;camera&quot;+i+&quot;.jpg&quot;, image);&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                     System.out.println(&lt;span class=&quot;string&quot;&gt;&quot;read a frame at &quot;&lt;/span&gt;+ i);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (Exception e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                     e.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                 i=i+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;             System.out.println(&lt;span class=&quot;string&quot;&gt;&quot;Camera can not be opened!&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         capture.release();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         System.out.println(&lt;span class=&quot;string&quot;&gt;&quot;VideoCapture is released&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         System.exit(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;报错及解决办法&quot;&gt;&lt;a href=&quot;#报错及解决办法&quot; class=&quot;headerlink&quot; title=&quot;报错及解决办法&quot;&gt;&lt;/a&gt;&lt;strong&gt;报错及解决办法&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;但是运行时直接报错（在已经安装了OpenCV的情况下，Opencv的安装教程参考，同时安装了ffmpeg, ffmpeg的安装教程参考）, Your GStreamer installation is missing a plug-in, 报错内容如下：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;GStreamer Plugin: Embedded video playback halted; module decodebin20 reported: Your GStreamer installation is missing a plug-in.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;说是缺少插件，找到的解决办法基本上都是安装以下包：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install gstreamer-&amp;#123;ffmpeg,plugins-&amp;#123;bad,good,ugly&amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但是&lt;strong&gt;直接使用yum安装会提示这些包找不到&lt;/strong&gt;，因为他们并不在官方源中，因此&lt;strong&gt;需要添加第三方源&lt;/strong&gt;。&lt;/p&gt;
&lt;h2 id=&quot;添加第三方源&quot;&gt;&lt;a href=&quot;#添加第三方源&quot; class=&quot;headerlink&quot; title=&quot;添加第三方源&quot;&gt;&lt;/a&gt;&lt;strong&gt;添加第三方源&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;我找到的解决办法是添加rpmfusion源，参考教程为：&lt;a href=&quot;http://rpmfusion.org/Configuration&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://rpmfusion.org/Configuration&lt;/a&gt;&lt;br&gt;直接直接以下命令即可安装：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;su -c &lt;span class=&quot;string&quot;&gt;&#39;yum localinstall --nogpgcheck http://download1.rpmfusion.org/free/el/updates/6/i386/rpmfusion-free-release-6-1.noarch.rpm http://download1.rpmfusion.org/nonfree/el/updates/6/i386/rpmfusion-nonfree-release-6-1.noarch.rpm&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后更新yum：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum clean all&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;yum makecache&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;但是我添加了之后，&lt;strong&gt;gstreamer-ffmpeg仍然装不上，会报缺少liborc.so.0.4这个库&lt;/strong&gt;。&lt;br&gt;最后找到这个网站：&lt;a href=&quot;http://pkgs.org/centos-6/linuxtech/liborc-devel-0.4.14-1.el6.x86_64.rpm.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://pkgs.org/centos-6/linuxtech/liborc-devel-0.4.14-1.el6.x86_64.rpm.html&lt;/a&gt;&lt;br&gt;里面有liborc的包，因此按照其教程，&lt;strong&gt;在/etc/yum.repos.d/目录中新建linuxtech.repo&lt;/strong&gt;，文件内容如下：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[linuxtech]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;name=LinuxTECH&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;baseurl=http://pkgrepo.linuxtech.net/el6/release/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;enabled=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgcheck=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;gpgkey=http://pkgrepo.linuxtech.net/el6/release/RPM-GPG-KEY-LinuxTECH.NET&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;同样更新一下：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum makecache&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后安装liborc：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install liborc-devel&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;再接着安装gstreamer-ffmpeg和其他的gstreamer-plugins-{bad,good,ugly} 可顺利装上：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install gstreamer-&amp;#123;ffmpeg,plugins-&amp;#123;bad,good,ugly&amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后再去运行上述代码，可以完美运行。&lt;br&gt;结束。&lt;/p&gt;
&lt;p&gt;&lt;br&gt; &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;参考：&lt;br&gt;[1] &lt;a href=&quot;http://ubuntuforums.org/archive/index.php/t-1730395.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://ubuntuforums.org/archive/index.php/t-1730395.html&lt;/a&gt;&lt;br&gt;[2] &lt;a href=&quot;http://answers.opencv.org/question/44767/rtsp-link-can-not-open-camera-java-h264-stream/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://answers.opencv.org/question/44767/rtsp-link-can-not-open-camera-java-h264-stream/&lt;/a&gt;&lt;br&gt;[3] &lt;a href=&quot;http://pkgs.org/centos-6/linuxtech/liborc-devel-0.4.14-1.el6.x86_64.rpm.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://pkgs.org/centos-6/linuxtech/liborc-devel-0.4.14-1.el6.x86_64.rpm.html&lt;/a&gt;&lt;br&gt;[4] &lt;a href=&quot;http://www.cnblogs.com/foohack/p/4153173.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://www.cnblogs.com/foohack/p/4153173.html&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;我的配置：Centos 6.4 + opencv 2.4.8 + ffmpeg  2.8.5&lt;/p&gt;
&lt;p&gt;最近在用opencv的VideoCapture读取rtsp摄像头，首先找到以下代码，想测试一下：&lt;/p&gt;
&lt;h2 id=&quot;测试代码&quot;&gt;&lt;a href=&quot;#测试代码&quot; 
    
    </summary>
    
      <category term="Linux配置" scheme="http://yanjiankang.cn/categories/Linux%E9%85%8D%E7%BD%AE/"/>
    
    
      <category term="opencv" scheme="http://yanjiankang.cn/tags/opencv/"/>
    
      <category term="rtsp" scheme="http://yanjiankang.cn/tags/rtsp/"/>
    
      <category term="centos" scheme="http://yanjiankang.cn/tags/centos/"/>
    
      <category term="ffmpeg" scheme="http://yanjiankang.cn/tags/ffmpeg/"/>
    
      <category term="gstream" scheme="http://yanjiankang.cn/tags/gstream/"/>
    
  </entry>
  
  <entry>
    <title>Linux 编译安装 OpenCV (Ubuntu, Redhat)</title>
    <link href="http://yanjiankang.cn/Linux-install-OpenCV-on-Ubuntu-or-Redhat/"/>
    <id>http://yanjiankang.cn/Linux-install-OpenCV-on-Ubuntu-or-Redhat/</id>
    <published>2016-04-07T08:12:59.854Z</published>
    <updated>2016-01-27T01:28:10.000Z</updated>
    
    <content type="html">&lt;p&gt;今天在编译安装opencv时遇到的一些问题，记录下来。&lt;/p&gt;
&lt;h2 id=&quot;我的系统配置和安装版本&quot;&gt;&lt;a href=&quot;#我的系统配置和安装版本&quot; class=&quot;headerlink&quot; title=&quot;我的系统配置和安装版本&quot;&gt;&lt;/a&gt;&lt;strong&gt;我的系统配置和安装版本&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;ubuntu server 12.04 和 redhat 6.4 两台机器&lt;br&gt;安装opencv 2.4.8&lt;/p&gt;
&lt;h2 id=&quot;编译环境准备&quot;&gt;&lt;a href=&quot;#编译环境准备&quot; class=&quot;headerlink&quot; title=&quot;编译环境准备&quot;&gt;&lt;/a&gt;&lt;strong&gt;编译环境准备&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;对于ubuntu的机器，首先安装以下软件：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 安装基本编程环境&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo apt-get install build-essential  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 安装编解码支持库&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo apt-get install  libgtk2.0-dev libavcodec-dev libavformat-dev  libtiff4-dev  libswscale-dev libjasper-dev  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 安装cmake&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo apt-get install cmake &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 安装pkg-config&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo apt-get install pkg-config&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;对于redhat的机器，使用yum安装以下包：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;yum install cmake gcc gcc-c++ gtk+-devel gimp-devel gimp-devel-tools gimp-help-browser zlib-devel libtiff-devel libjpeg-devel libpng-devel gstreamer-devel libavc1394-devel libraw1394-devel libdc1394-devel jasper-devel jasper-utils swig python libtool nasm&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;下载OpenCV安装包&quot;&gt;&lt;a href=&quot;#下载OpenCV安装包&quot; class=&quot;headerlink&quot; title=&quot;下载OpenCV安装包&quot;&gt;&lt;/a&gt;&lt;strong&gt;下载OpenCV安装包&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;到&lt;a href=&quot;http://opencv.org/downloads.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;官网&lt;/a&gt;下载OpenCV的安装包，我下载的是2.4.8的版本，但这个版本我安装的时候有bug，后面会介绍。（建议下载2.4.11及以上版本，安装步骤基本类似）&lt;/p&gt;
&lt;p&gt;下载后解压，进入目录&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;unzip -v opencv-2.4.8.zip&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#进入解压后的目录&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; opencv-2.4.8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;编译安装&quot;&gt;&lt;a href=&quot;#编译安装&quot; class=&quot;headerlink&quot; title=&quot;编译安装&quot;&gt;&lt;/a&gt;&lt;strong&gt;编译安装&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;直接在当前目录下编译即可，并不一定要建立子目录&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cmake -D CMAKE_BUILD_TYPE=RELEASE -D CMAKE_INSTALL_PREFIX=/usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt; .&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;make&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;make -j8    &lt;span class=&quot;comment&quot;&gt;#（-j8表示使用8个线程编译，可以大大加快编译速度）&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo make install&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;我主要在此处遇到了问题，因为我的电脑&lt;strong&gt;安装了GPU卡&lt;/strong&gt;，因此OpenCV会自动编译CUDA相关的代码，可以直接关掉( 在cmake时加上-D WITH_CUDA=OFF )，但我需要编译。因此默认是打开的，因此在make时遇到以下错误：a storage class is not allowed in an explicit specialization&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(51): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(52): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(53): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(54): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(55): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(56): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(57): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(58): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(61): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(62): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(63): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(64): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(65): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(66): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(67): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(68): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(119): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(120): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(121): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(122): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(123): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(124): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(125): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(126): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(127): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(128): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(129): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(130): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(131): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(132): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(133): error: a storage class is not allowed &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; an explicit specialization&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31 errors detected &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; the compilation of &lt;span class=&quot;string&quot;&gt;&quot;/tmp/tmpxft_00006af4_00000000-9_NCVPyramid.compute_35.cpp1.ii&quot;&lt;/span&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CMake Error at cuda_compile_generated_NCVPyramid.cu.o.cmake:266 (message):&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Error generating file&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  /root/opencv-2.4.8/modules/gpu/CMakeFiles/cuda_compile.dir/src/nvidia/core/./cuda_compile_generated_NCVPyramid.cu.o&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;make[2]: *** [modules/gpu/CMakeFiles/cuda_compile.dir/src/nvidia/core/./cuda_compile_generated_NCVPyramid.cu.o] Error 1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;make[2]: *** Waiting &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; unfinished jobs....&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;make[1]: *** [modules/gpu/CMakeFiles/opencv_gpu.dir/all] Error 2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;make: *** [all] Error 2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;我安装的CUDA是6.5版本，计算能力是3.5，针对以上错误，我找到的说在cmake时加上以上参数的方法都是没用：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;-D CUDA_GENERATION=Auto&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;或&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;-D CUDA_GENERATION=&lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt; -D CUDA_ARCH_BIN=2.0（或3.5，5.0）&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;最后找的解决办法是：&lt;br&gt;打开错误的文件：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 注意修改为你的编译路径&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vim /root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;将其中template声明中的所有static全部删除。可以使用vim的全局替换，或者其他编辑工具全局替换即可(template&amp;lt;&amp;gt; static inline 替换为template&amp;lt;&amp;gt; inline )：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;:%s/template&amp;lt;&amp;gt; static inline/template&amp;lt;&amp;gt; inline/g&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;这个问题的原因是OpenCV 2.4.8 与CUDA 6.5不兼容的一个bug（好像2.4系列都有问题），已在后续版本中修复，参考&lt;a href=&quot;http://code.opencv.org/issues/3814&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://code.opencv.org/issues/3814&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;修改过后重新执行以下，切记有多核的一定使用多线程，编译CUDA慢的要哭：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;cmake -D CMAKE_BUILD_TYPE=RELEASE -D CMAKE_INSTALL_PREFIX=/usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt; .&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;make -j8    &lt;span class=&quot;comment&quot;&gt;#（-j8表示使用8个线程编译，可以大大加快编译速度）&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo make install&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;环境变量修改&quot;&gt;&lt;a href=&quot;#环境变量修改&quot; class=&quot;headerlink&quot; title=&quot;环境变量修改&quot;&gt;&lt;/a&gt;&lt;strong&gt;环境变量修改&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;在/etc/ld.so.conf 文件中添加 /usr/local/lib  ， 然后执行&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;sudo ldconfig -v&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;为程序指定openvc的头文件位置, 使用pkg-config命令来完成。首先在 /etc/profile 中添加&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;export&lt;/span&gt;  PKG_CONFIG_PATH=&lt;span class=&quot;variable&quot;&gt;$PKG_CONFIG_PATH&lt;/span&gt;:/usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/pkgconfig&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后source生效&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;source&lt;/span&gt; /etc/profile&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;再执行以下命令可以打印opencv的配置信息&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;pkg-config --libs opencv&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;root@ubuntu:~&lt;span class=&quot;comment&quot;&gt;# pkg-config  --libs opencv&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;/usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_calib3d.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_contrib.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_core.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_features2d.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_flann.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_gpu.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_highgui.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_imgproc.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_legacy.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_ml.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_nonfree.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_objdetect.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_ocl.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_photo.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_stitching.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_superres.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_ts.a /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_video.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/lib/libopencv_videostab.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/cuda/lib64/libcufft.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/cuda/lib64/libnpps.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/cuda/lib64/libnppi.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/cuda/lib64/libnppc.so /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/cuda/lib64/libcudart.so -lrt -lpthread -lm -ldl&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;测试&quot;&gt;&lt;a href=&quot;#测试&quot; class=&quot;headerlink&quot; title=&quot;测试&quot;&gt;&lt;/a&gt;&lt;strong&gt;测试&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;在解压的opencv目录下找到 samples/c/build_all.sh，运行该文件&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; /root/opencv-2.4.8/samples/c/&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;chmod a+x build_all.sh&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;./build_all.sh&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;选取生成的可执行文件进行测试，比如find_obg：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;root@ubuntu:~/opencv-2.4.8/samples/c&lt;span class=&quot;comment&quot;&gt;# ls&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;adaptiveskindetector      delaunay               mser_sample&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;adaptiveskindetector.cpp  delaunay.c             mser_sample.cpp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;agaricus-lepiota.data     example_cmake          mushroom&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;airplane.jpg              facedetect             mushroom.cpp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;baboon200.jpg             facedetect.cmd         one_way_sample&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;baboon200_rotated.jpg     facedetect.cpp         one_way_sample.cpp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;baboon.jpg                fback_c                one_way_train_0000.jpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;bgfg_codebook             fback_c.c              one_way_train_0001.jpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;bgfg_codebook.cpp         find_obj               one_way_train_images.txt&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;blobtrack_sample          find_obj_calonder      polar_transforms&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;blobtrack_sample.cpp      find_obj_calonder.cpp  polar_transforms.c&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;box_&lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt;_scene.png          find_obj.cpp           puzzle.png&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;box.png                   find_obj_ferns         pyramid_segmentation&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;build_all.sh              find_obj_ferns.cpp     pyramid_segmentation.c&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;calonder_params.xml       fruits.jpg             scene_l.bmp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat.jpg                   intrinsics.yml         scene_r.bmp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cat.xml                   JCB.png                smiledetect&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;CMakeLists.txt            latentsvmdetect        smiledetect.cpp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;contours                  latentsvmdetect.cpp    stuff.jpg&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;contours.c                lena.jpg               tree.avi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;convert_cascade           morphology             tree_engine&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;convert_cascade.c         morphology.c           tree_engine.cpp&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cvsample.dsp              motempl                waveform.data&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;cvsample.vs2005.vcproj    motempl.c&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;./find_obj&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;安装结束。&lt;/p&gt;
&lt;p&gt;&lt;br&gt; &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;参考资料：&lt;br&gt;[1] &lt;a href=&quot;http://docs.opencv.org/2.4/doc/tutorials/introduction/linux_install/linux_install.html#linux-installation&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://docs.opencv.org/2.4/doc/tutorials/introduction/linux_install/linux_install.html#linux-installation&lt;/a&gt;&lt;br&gt;[2] &lt;a href=&quot;http://blog.csdn.net/surgewong/article/details/39078251&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://blog.csdn.net/surgewong/article/details/39078251&lt;/a&gt;&lt;br&gt;[3] &lt;a href=&quot;http://blog.csdn.net/xuejiren/article/details/24347555&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;http://blog.csdn.net/xuejiren/article/details/24347555&lt;/a&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;今天在编译安装opencv时遇到的一些问题，记录下来。&lt;/p&gt;
&lt;h2 id=&quot;我的系统配置和安装版本&quot;&gt;&lt;a href=&quot;#我的系统配置和安装版本&quot; class=&quot;headerlink&quot; title=&quot;我的系统配置和安装版本&quot;&gt;&lt;/a&gt;&lt;strong&gt;我的系统配置和安装版
    
    </summary>
    
      <category term="Linux配置" scheme="http://yanjiankang.cn/categories/Linux%E9%85%8D%E7%BD%AE/"/>
    
    
      <category term="opencv" scheme="http://yanjiankang.cn/tags/opencv/"/>
    
      <category term="Linux" scheme="http://yanjiankang.cn/tags/Linux/"/>
    
      <category term="ubuntu" scheme="http://yanjiankang.cn/tags/ubuntu/"/>
    
      <category term="redhat" scheme="http://yanjiankang.cn/tags/redhat/"/>
    
  </entry>
  
  <entry>
    <title>Kafka集群配置以及与Storm的spout集成</title>
    <link href="http://yanjiankang.cn/Kafka-install-config-storm-spout/"/>
    <id>http://yanjiankang.cn/Kafka-install-config-storm-spout/</id>
    <published>2016-04-07T08:12:59.852Z</published>
    <updated>2015-10-21T05:16:06.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;kafka介绍&quot;&gt;&lt;a href=&quot;#kafka介绍&quot; class=&quot;headerlink&quot; title=&quot;kafka介绍&quot;&gt;&lt;/a&gt;&lt;strong&gt;kafka介绍&lt;/strong&gt;&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;Kafka是分布式发布-订阅消息系统。它最初由LinkedIn公司开发，之后成为Apache项目的一部分。Kafka是一个分布式的，可划分的，冗余备份的持久性的日志服务。它主要用于处理活跃的流式数据。
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;Kafka主要特点：&quot;&gt;&lt;a href=&quot;#Kafka主要特点：&quot; class=&quot;headerlink&quot; title=&quot;Kafka主要特点：&quot;&gt;&lt;/a&gt;&lt;strong&gt;Kafka主要特点&lt;/strong&gt;：&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;同时为发布和订阅提供高吞吐量。据了解，Kafka每秒可以生产约25万消息（50 MB），每秒处理55万消息（110 MB）。&lt;/li&gt;
&lt;li&gt;可进行持久化操作。将消息持久化到磁盘，因此可用于批量消费，例如ETL，以及实时应用程序。通过将数据持久化到硬盘以及replication防止数据丢失。&lt;/li&gt;
&lt;li&gt;分布式系统，易于向外扩展。所有的producer、broker和consumer都会有多个，均为分布式的。无需停机即可扩展机器。&lt;/li&gt;
&lt;li&gt;消息被处理的状态是在consumer端维护，而不是由server端维护。当失败时能自动平衡。&lt;/li&gt;
&lt;li&gt;支持online和offline的场景。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;kafka架构：&quot;&gt;&lt;a href=&quot;#kafka架构：&quot; class=&quot;headerlink&quot; title=&quot;kafka架构：&quot;&gt;&lt;/a&gt;&lt;strong&gt;kafka架构&lt;/strong&gt;：&lt;/h3&gt;&lt;p&gt;  &lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/kafka.png&quot; alt=&quot;kafka架构图&quot;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Topic：&lt;/strong&gt;特指Kafka处理的消息源（feeds of messages）的不同分类。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Partition：&lt;/strong&gt;Topic物理上的分组，一个topic可以分为多个partition，每个partition是一个有序的队列。partition中的每条消息都会被分配一个有序的id（offset）。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Message：&lt;/strong&gt;消息，是通信的基本单位，每个producer可以向一个topic（主题）发布一些消息。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Producers：&lt;/strong&gt;消息和数据生产者，向Kafka的一个topic发布消息的过程叫做producers。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Consumers：&lt;/strong&gt;消息和数据消费者，订阅topics并处理其发布的消息的过程叫做consumers。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Broker：&lt;/strong&gt;缓存代理，Kafa集群中的一台或多台服务器统称为broker。&lt;/li&gt;
&lt;li&gt;kafka以topic来进行消息管理，每个topic包含多个partition，每个partition对应一个逻辑log，有多个segment组成。&lt;/li&gt;
&lt;li&gt;每个segment中存储多条消息，消息id由其逻辑位置决定，即从消息id可直接定位到消息的存储位置，避免id到位置的额外映射。&lt;/li&gt;
&lt;li&gt;每个partition在内存中对应一个index，记录每个segment中的第一条消息偏移。&lt;/li&gt;
&lt;li&gt;发布者发到某个topic的消息会被均匀的分布到多个partition上（随机或根据用户指定的回调函数进行分布），broker收到发布消息往对应partition的最后一个segment上添加该消息，当某个segment上的消息条数达到配置值或消息发布时间超过阈值时，segment上的消息会被flush到磁盘，只有flush到磁盘上的消息订阅者才能订阅到，segment达到一定的大小后将不会再往该segment写数据，broker会创建新的segment；&lt;/li&gt;
&lt;li&gt;在Kafka文件存储中，同一个topic下有多个不同partition，在单机模式上每个partition为一个目录，partiton命名规则为topic名称+有序序号，第一个partiton序号从0开始，序号最大值为partitions数量减1；&lt;/li&gt;
&lt;li&gt;&lt;p&gt;在&lt;strong&gt;多机的分布式kafka&lt;/strong&gt;中，&lt;strong&gt;kafka的partition分配规则&lt;/strong&gt;如下图所示：&lt;br&gt;一个Kafka集群中4个Broker举例，创建1个topic包含4个Partition，2 Replication， brokers上分区分配如下图：&lt;br&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/kafka-partition1.png&quot; alt=&quot;kafka分布式partition分配规则1&quot;&gt;&lt;br&gt;当当集群中新增2节点，Partition增加到6个时分布情况如下：&lt;br&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/kafka-partition2.png&quot; alt=&quot;kafka分布式partition分配规则2&quot;&gt;&lt;br&gt;具体可以参考&lt;a href=&quot;http://blog.csdn.net/lizhitao/article/details/41778193&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Kafka集群partition replication自动分配分析&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;partion中segment file组成和物理结构：segment file由2大部分组成，分别为index file和data file，此2个文件一一对应，成对出现，后缀”.index”和“.log”分别表示为segment索引文件、数据文件；segment文件命名规则–partion全局的第一个segment从0开始，后续每个segment文件名为上一个segment文件最后一条消息的offset值。数值最大为64位long大小，19位数字字符长度，没有数字用0填充。&lt;/p&gt;
&lt;p&gt;kafka的运行流程美团团队分析的比较好，可以参考：&lt;a href=&quot;http://tech.meituan.com/kafka-fs-design-theory.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Kafka文件存储机制那些事–美团技术团队&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;kafka-单机模式的配置&quot;&gt;&lt;a href=&quot;#kafka-单机模式的配置&quot; class=&quot;headerlink&quot; title=&quot;kafka 单机模式的配置&quot;&gt;&lt;/a&gt;&lt;strong&gt;kafka 单机模式的配置&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;1) 去kafka官网下载kafka,记得下载bin包，就不用再自己编译：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;wget http://www.webhostingjams.com/mirror/apache/kafka/0.8.2.1/kafka_2.9.1-0.8.2.1.tgz&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;2) 解压&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;tar -xvf kafka_2.9.1-0.8.2.1.tgz&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;3) 配置zookeeper配置文件和kafka配置文件&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;built_in&quot;&gt;cd&lt;/span&gt; kafka_2.9.1-0.8.2.1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vim config/zookeeper.properties&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;自带的zookeeper默认三条配置如下,如果要修改端口或者数据文件夹，可以修改：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# the directory where the snapshot is stored.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;dataDir=/tmp/zookeeper&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# the port at which the clients will connect&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;clientPort=2181&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# disable the per-ip limit on the number of connections since this is a non-production config&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;maxClientCnxns=0&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后修改kafka server配置文件：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;vim config/server.properties&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;对于单机运行而言，指定一个broker即可，host name可以修改下，其他基本不用修改（如果你修改了zookeeper端口，那么相应的zookeeper配置也要修改）：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;############################# Server Basics #############################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# The id of the broker. This must be set to a unique integer for each broker.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;broker.id=0                   &lt;span class=&quot;comment&quot;&gt;#kafka集群中服务器的编号&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;############################# Socket Server Settings #############################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# The port the socket server listens on&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;port=9092                     &lt;span class=&quot;comment&quot;&gt;#主机端口&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Hostname the broker will bind to. If not set, the server will bind to all interfaces&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;host.name=localhost           &lt;span class=&quot;comment&quot;&gt;#主机名，在分布式kafka中一定要配置&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# A comma seperated list of directories under which to store log files&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log.dirs=/tmp/kafka-logs       &lt;span class=&quot;comment&quot;&gt;#消息log文件存储目录&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;############################# Zookeeper #############################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Zookeeper connection string (see zookeeper docs for details).&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# This is a comma separated host:port pairs, each corresponding to a zk&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# server. e.g. &quot;127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002&quot;.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# You can also append an optional chroot string to the urls to specify the&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# root directory for all kafka znodes.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;zookeeper.connect=localhost:2181       &lt;span class=&quot;comment&quot;&gt;#此处我改为了我的主机名&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# Timeout in ms for connecting to zookeeper&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;zookeeper.connection.timeout.ms=6000&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;4）启动&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#先启动自带的zookeeper&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;bin/zookeeper-server-start.sh config/zookeeper.properties &amp;amp;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#再启动kafka&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;bin/kafka-server-start.sh  config/server.properties  &amp;amp;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;5)先创建topic分区，用于测试&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#其中指定zookeeper地址， --replication-factor指定冗余分区数目，--partition指定topic的分区数目，--topic指定分区名称&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic kafkatest&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;查看topic是否成功创建&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;bin/kafka-topics.sh --describe --zookeeper localhost:2181&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;6）消息发送&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;bin/kafka-console-producer.sh --broker-list localhost:9092 --topic kafkatest&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;执行命令后，输出一个WARN后，可以开始输入消息，&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[2015-07-26 08:58:42,027] WARN Property topic is not valid (kafka.utils.VerifiableProperties)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssdfff&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sdf[2015-07-26 08:58:55,305] INFO Closing socket connection to /127.0.0.1. (kafka.network.Processor)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;fsdfsff&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;dfsff&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sdfdffdfd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sdffff&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt; 按ctrl-c结束输入&lt;br&gt;7）接收消息测试&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;bin/kafka-console-consumer.sh --zookeeper localhost:2181 --topic kafkatest --from-beginning&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;刚才发送的消息接收&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;[2015-07-26 09:03:20,138] INFO Closing socket connection to /127.0.0.1. (kafka.network.Processor)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ssdfff&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sdffsdfsff&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;dfsff&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sdfdffdfd&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sdffff&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;kafka-集群模式的配置&quot;&gt;&lt;a href=&quot;#kafka-集群模式的配置&quot; class=&quot;headerlink&quot; title=&quot;kafka 集群模式的配置&quot;&gt;&lt;/a&gt;&lt;strong&gt;kafka 集群模式的配置&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;三台服务器的ip分别为: 192.168.61.150(主机名cluster1), 192.168.61.151(主机名cluster2), 192.168.61.152(主机名cluster3)&lt;br&gt;1) 分别在三台服务器上配置zookeeper,可以参考这篇文章&lt;a href=&quot;http://shiyanjun.cn/archives/469.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ZooKeeper-3.3.4集群安装配置&lt;/a&gt;&lt;br&gt;2) 配置kafka server配置文件：&lt;br&gt;对于192.168.61.150机器，配置文件如下：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#为了削减篇幅，删除了无用的注释行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;############################# Server Basics &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;broker.id=0          &lt;span class=&quot;comment&quot;&gt;# 服务器的编号&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;port=9092&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;host.name=cluster1   &lt;span class=&quot;comment&quot;&gt;#此处主机名要改&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#这些默认配置不用改&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;num.network.threads=3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;num.io.threads=8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;socket.send.buffer.bytes=102400&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;socket.receive.buffer.bytes=102400&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;socket.request.max.bytes=104857600&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log.dirs=/tmp/kafka-logs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;num.partitions=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;num.recovery.threads.per.data.dir=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#log.flush.interval.messages=10000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#log.flush.interval.ms=1000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log.retention.hours=168&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#log.retention.bytes=1073741824&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log.segment.bytes=1073741824&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log.retention.check.interval.ms=300000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;############################# Zookeeper #############################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;zookeeper.connect=cluster1:2181,cluster2:2181,cluster3:2181  &lt;span class=&quot;comment&quot;&gt;#此次重要，需要改&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;zookeeper.connection.timeout.ms=6000&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;对于192.168.61.151机器，配置文件如下：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#为了削减篇幅，删除了无用的注释行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;############################# Server Basics &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;broker.id=1          &lt;span class=&quot;comment&quot;&gt;# 服务器的编号&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;port=9092&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;host.name=cluster1   &lt;span class=&quot;comment&quot;&gt;#此处主机名要改&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#这些默认配置不用改&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;num.network.threads=3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;num.io.threads=8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;socket.send.buffer.bytes=102400&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;socket.receive.buffer.bytes=102400&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;socket.request.max.bytes=104857600&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log.dirs=/tmp/kafka-logs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;num.partitions=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;num.recovery.threads.per.data.dir=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#log.flush.interval.messages=10000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#log.flush.interval.ms=1000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log.retention.hours=168&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#log.retention.bytes=1073741824&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log.segment.bytes=1073741824&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log.retention.check.interval.ms=300000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;############################# Zookeeper #############################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;zookeeper.connect=cluster1:2181,cluster2:2181,cluster3:2181  &lt;span class=&quot;comment&quot;&gt;#此次重要，需要改&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;zookeeper.connection.timeout.ms=6000&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;对于192.168.61.152机器，配置文件如下：&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#为了削减篇幅，删除了无用的注释行&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;############################# Server Basics &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;broker.id=2          &lt;span class=&quot;comment&quot;&gt;# 服务器的编号&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;port=9092&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;host.name=cluster1   &lt;span class=&quot;comment&quot;&gt;#此处主机名要改&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#这些默认配置不用改&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;num.network.threads=3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;num.io.threads=8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;socket.send.buffer.bytes=102400&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;socket.receive.buffer.bytes=102400&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;socket.request.max.bytes=104857600&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log.dirs=/tmp/kafka-logs&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;num.partitions=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;num.recovery.threads.per.data.dir=1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#log.flush.interval.messages=10000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#log.flush.interval.ms=1000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log.retention.hours=168&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#log.retention.bytes=1073741824&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log.segment.bytes=1073741824&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;log.retention.check.interval.ms=300000&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;############################# Zookeeper #############################&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;zookeeper.connect=cluster1:2181,cluster2:2181,cluster3:2181  &lt;span class=&quot;comment&quot;&gt;#此次重要，需要改&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;zookeeper.connection.timeout.ms=6000&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;3） 分别在每台机器上启动kafka即可&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;bin/kafka-server-start.sh  config/server.properties  &amp;amp;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;kafka可配置选项&quot;&gt;&lt;a href=&quot;#kafka可配置选项&quot; class=&quot;headerlink&quot; title=&quot;kafka可配置选项&quot;&gt;&lt;/a&gt;&lt;strong&gt;kafka可配置选项&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;请参考 &lt;a href=&quot;http://liyonghui160com.iteye.com/blog/2163899&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Kafka 配置说明 含0.8.1版server.properties&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;kafka-java-API&quot;&gt;&lt;a href=&quot;#kafka-java-API&quot; class=&quot;headerlink&quot; title=&quot;kafka java API&quot;&gt;&lt;/a&gt;&lt;strong&gt;kafka java API&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;kafka java api使用相当简单，首先是在pom文件中引入kafka jar包。&lt;/p&gt;
&lt;h3 id=&quot;pom-xml文件&quot;&gt;&lt;a href=&quot;#pom-xml文件&quot; class=&quot;headerlink&quot; title=&quot;pom.xml文件&quot;&gt;&lt;/a&gt;pom.xml文件&lt;/h3&gt;&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;project&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;xmlns&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;http://maven.apache.org/POM/4.0.0&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;span class=&quot;attr&quot;&gt;xmlns:xsi&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;         &lt;span class=&quot;attr&quot;&gt;xsi:schemaLocation&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;modelVersion&lt;/span&gt;&amp;gt;&lt;/span&gt;4.0.0&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;modelVersion&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;ProducerExample&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;SimpleCounter&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;1.0-SNAPSHOT&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;dependencies&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;org.apache.kafka&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;kafka_2.10&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;0.8.2.1&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;org.apache.zookeeper&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;zookeeper&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;3.4.6&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;dependencies&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;build&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;plugins&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;plugin&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;org.apache.maven.plugins&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;maven-shade-plugin&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;executions&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;execution&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;phase&lt;/span&gt;&amp;gt;&lt;/span&gt;package&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;phase&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;goals&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                            &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;goal&lt;/span&gt;&amp;gt;&lt;/span&gt;shade&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;goal&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                        &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;goals&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;execution&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;executions&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;configuration&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;finalName&lt;/span&gt;&amp;gt;&lt;/span&gt;test-$&amp;#123;artifactId&amp;#125;-$&amp;#123;version&amp;#125;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;finalName&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;configuration&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;plugin&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;plugins&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;build&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;project&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;producer-API&quot;&gt;&lt;a href=&quot;#producer-API&quot; class=&quot;headerlink&quot; title=&quot;producer API&quot;&gt;&lt;/a&gt;producer API&lt;/h3&gt;&lt;p&gt;producer 的代码我主要是参考github上的一个example &lt;a href=&quot;https://github.com/gwenshap/kafka-examples&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;gwenshap/kafka-examples&lt;/a&gt;&lt;br&gt;DemoProducer的定义代码如下：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; com.test.groups;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; org.apache.kafka.clients.producer.*;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.Properties;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.concurrent.ExecutionException;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;DemoProducer&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    String topic;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    String sync;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; Properties kafkaProps = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Properties();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; Producer&amp;lt;String, String&amp;gt; producer;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;DemoProducer&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String topic)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.topic = topic;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;configure&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String brokerList, String sync)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.sync = sync;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        kafkaProps.put(&lt;span class=&quot;string&quot;&gt;&quot;bootstrap.servers&quot;&lt;/span&gt;, brokerList);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// This is mandatory, even though we don&#39;t send keys&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        kafkaProps.put(&lt;span class=&quot;string&quot;&gt;&quot;key.serializer&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;org.apache.kafka.common.serialization.StringSerializer&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        kafkaProps.put(&lt;span class=&quot;string&quot;&gt;&quot;value.serializer&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;org.apache.kafka.common.serialization.StringSerializer&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        kafkaProps.put(&lt;span class=&quot;string&quot;&gt;&quot;acks&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;1&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// how many times to retry when produce request fails?&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        kafkaProps.put(&lt;span class=&quot;string&quot;&gt;&quot;retries&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;3&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        kafkaProps.put(&lt;span class=&quot;string&quot;&gt;&quot;linger.ms&quot;&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        producer = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; KafkaProducer&amp;lt;String, String&amp;gt;(kafkaProps);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;produce&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String value)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; ExecutionException, InterruptedException &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (sync.equals(&lt;span class=&quot;string&quot;&gt;&quot;sync&quot;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            produceSync(value);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (sync.equals(&lt;span class=&quot;string&quot;&gt;&quot;async&quot;&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            produceAsync(value);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;string&quot;&gt;&quot;Expected sync or async, got &quot;&lt;/span&gt; + sync);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        producer.close();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/* Produce a record and wait for server to reply. Throw an exception if something goes wrong */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;produceSync&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String value)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; ExecutionException, InterruptedException &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ProducerRecord&amp;lt;String, String&amp;gt; record = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ProducerRecord&amp;lt;String, String&amp;gt;(topic, value);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        producer.send(record).get();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/* Produce a record without waiting for server. This includes a callback that will print an error if something goes wrong */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;produceAsync&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String value)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ProducerRecord&amp;lt;String, String&amp;gt; record = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ProducerRecord&amp;lt;String, String&amp;gt;(topic, value);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        producer.send(record, &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; DemoProducerCallback());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;DemoProducerCallback&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Callback&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;onCompletion&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(RecordMetadata recordMetadata, Exception e)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (e != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                System.out.println(&lt;span class=&quot;string&quot;&gt;&quot;Error producing to topic &quot;&lt;/span&gt; + recordMetadata.topic());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                e.printStackTrace();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;DemoProducer的测试代码如下：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; com.test.groups;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.concurrent.ExecutionException;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;SimpleCounter&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; DemoProducer producer;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String[] args)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; InterruptedException, ExecutionException &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (args.length == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            System.out.println(&lt;span class=&quot;string&quot;&gt;&quot;SimpleCounterOldProducer &amp;#123;broker-list&amp;#125; &amp;#123;topic&amp;#125; &amp;#123;type old/new&amp;#125; &amp;#123;type sync/async&amp;#125; &amp;#123;delay (ms)&amp;#125; &amp;#123;count&amp;#125;&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;/* get arguments */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        String brokerList = args[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        String topic = args[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        String sync = args[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; delay = Integer.parseInt(args[&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; count = Integer.parseInt(args[&lt;span class=&quot;number&quot;&gt;4&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;/* start a producer */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        producer.configure(brokerList, sync);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        producer.start();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; startTime = System.currentTimeMillis();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        System.out.println(&lt;span class=&quot;string&quot;&gt;&quot;Starting...&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        producer.produce(&lt;span class=&quot;string&quot;&gt;&quot;Starting...&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;/* produce the numbers */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i=&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; count; i++ ) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            producer.produce(Integer.toString(i));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            Thread.sleep(delay);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;long&lt;/span&gt; endTime = System.currentTimeMillis();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        System.out.println(&lt;span class=&quot;string&quot;&gt;&quot;... and we are done. This took &quot;&lt;/span&gt; + (endTime - startTime) + &lt;span class=&quot;string&quot;&gt;&quot; ms.&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        producer.produce(&lt;span class=&quot;string&quot;&gt;&quot;... and we are done. This took &quot;&lt;/span&gt; + (endTime - startTime) + &lt;span class=&quot;string&quot;&gt;&quot; ms.&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;/* close shop and leave */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        producer.close();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        System.exit(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后在eclipse中运行时加上参数：localhost:9092 kafkatest  async 50 10&lt;br&gt;其中参数【1】为kafka地址，参数【2】为topic name， 参数【3】为同步produce还是异步produce，【4】为发送间隔，【5】为发送消息数目。&lt;/p&gt;
&lt;h3 id=&quot;consumer-API&quot;&gt;&lt;a href=&quot;#consumer-API&quot; class=&quot;headerlink&quot; title=&quot;consumer API&quot;&gt;&lt;/a&gt;consumer API&lt;/h3&gt;&lt;p&gt;consumer test java代码如下：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;89&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; com.test.groups;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; kafka.consumer.ConsumerConfig;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; kafka.consumer.KafkaStream;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; kafka.javaapi.consumer.ConsumerConnector;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.HashMap;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.List;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.Map;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.Properties;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.concurrent.ExecutorService;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; java.util.concurrent.Executors;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;ConsumerGroupExample&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; ConsumerConnector consumer;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; String topic;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt;  ExecutorService executor;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;ConsumerGroupExample&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String a_zookeeper, String a_groupId, String a_topic)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 创建consumer对象， a_zookeeper是zookeeper地址，&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// a_groupId是消费者读取时的group id，可以随便设&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// a_topic是读取的topic名称&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        consumer = kafka.consumer.Consumer.createJavaConsumerConnector(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                createConsumerConfig(a_zookeeper, a_groupId));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.topic = a_topic;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 关闭consumer接口&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;shutdown&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (consumer != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) consumer.shutdown();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (executor != &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;) executor.shutdown();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!executor.awaitTermination(&lt;span class=&quot;number&quot;&gt;5000&lt;/span&gt;, TimeUnit.MILLISECONDS)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                System.out.println(&lt;span class=&quot;string&quot;&gt;&quot;Timed out waiting for consumer threads to shut down, exiting uncleanly&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            System.out.println(&lt;span class=&quot;string&quot;&gt;&quot;Interrupted during shutdown, exiting uncleanly&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 启动消费者， a_numThreads指定读取线程数，因为topic可以有多个分区，可以多线程读取&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; a_numThreads)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        Map&amp;lt;String, Integer&amp;gt; topicCountMap = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;String, Integer&amp;gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        topicCountMap.put(topic, &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Integer(a_numThreads));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        Map&amp;lt;String, List&amp;lt;KafkaStream&amp;lt;&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;[], &lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;[]&amp;gt;&amp;gt;&amp;gt; consumerMap = consumer.createMessageStreams(topicCountMap);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        List&amp;lt;KafkaStream&amp;lt;&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;[], &lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;[]&amp;gt;&amp;gt; streams = consumerMap.get(topic);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// now launch all the threads&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        executor = Executors.newFixedThreadPool(a_numThreads);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// now create an object to consume the messages&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; threadNumber = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; KafkaStream stream : streams) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// ConsumerThread真正读取消息是在 ConsumerThread中&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            executor.submit(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ConsumerThread(stream, threadNumber));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            threadNumber++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 初始化consumer 的相关属性&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; ConsumerConfig &lt;span class=&quot;title&quot;&gt;createConsumerConfig&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String a_zookeeper, String a_groupId)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        Properties props = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Properties();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        props.put(&lt;span class=&quot;string&quot;&gt;&quot;zookeeper.connect&quot;&lt;/span&gt;, a_zookeeper);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        props.put(&lt;span class=&quot;string&quot;&gt;&quot;group.id&quot;&lt;/span&gt;, a_groupId);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        props.put(&lt;span class=&quot;string&quot;&gt;&quot;zookeeper.session.timeout.ms&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;400&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        props.put(&lt;span class=&quot;string&quot;&gt;&quot;zookeeper.sync.time.ms&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;200&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        props.put(&lt;span class=&quot;string&quot;&gt;&quot;auto.commit.interval.ms&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;1000&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ConsumerConfig(props);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(String[] args)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        String zooKeeper = args[&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        String groupId = args[&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        String topic = args[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; threads = Integer.parseInt(args[&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ConsumerGroupExample example = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ConsumerGroupExample(zooKeeper, groupId, topic);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        example.run(threads);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// sleep时间用于consumer将offset信息更新到zookeeper中，因为offset信息不是同步更新的&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            Thread.sleep(&lt;span class=&quot;number&quot;&gt;10000&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (InterruptedException ie) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// example.shutdown();&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;ConsumerThread代码如下：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;package&lt;/span&gt; com.test.groups;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; kafka.consumer.ConsumerIterator;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; kafka.consumer.KafkaStream;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;ConsumerThread&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Runnable&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; KafkaStream m_stream;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; m_threadNumber;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;ConsumerTest&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(KafkaStream a_stream, &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; a_threadNumber)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        m_threadNumber = a_threadNumber;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        m_stream = a_stream;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ConsumerIterator&amp;lt;&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;[], &lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;[]&amp;gt; it = m_stream.iterator();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//此处循环会不断从topic中读取消息，阻塞函数，除非手动shutdown；&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (it.hasNext())&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            System.out.println(&lt;span class=&quot;string&quot;&gt;&quot;Thread &quot;&lt;/span&gt; + m_threadNumber + &lt;span class=&quot;string&quot;&gt;&quot;: &quot;&lt;/span&gt; + &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; String(it.next().message()));&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        System.out.println(&lt;span class=&quot;string&quot;&gt;&quot;Shutting down Thread: &quot;&lt;/span&gt; + m_threadNumber);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h2 id=&quot;kafka与storm的集成kafka-spout&quot;&gt;&lt;a href=&quot;#kafka与storm的集成kafka-spout&quot; class=&quot;headerlink&quot; title=&quot;kafka与storm的集成kafka-spout&quot;&gt;&lt;/a&gt;&lt;strong&gt;kafka与storm的集成kafka-spout&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;kafka集群与storm集群的集成很简单，也很自然，让storm从kafka集群中获取数据，一方面实现了数据采集和计算的解耦合，一方面kafka可作为数据缓冲，对此，storm官方已经给予了支持，在apache storm项目中有专门的jar包，只需要在maven文件中添加如下：&lt;br&gt;&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;org.apache.storm&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;storm-core&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;0.9.2-incubating&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;scope&lt;/span&gt;&amp;gt;&lt;/span&gt;provided&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;scope&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;org.apache.storm&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;storm-kafka&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;0.9.2-incubating&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;org.apache.kafka&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;kafka_2.9.2&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;0.8.1.1&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;version&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;exclusions&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;exclusion&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;               &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;org.apache.zookeeper&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;               &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;zookeeper&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;exclusion&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;exclusion&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;               &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;log4j&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;groupId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;               &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;log4j&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;artifactId&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;          &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;exclusion&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;     &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;exclusions&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;dependency&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;然后在Topology定义代码中设置kafka spout即可：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;TopologyBuilder builder = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; TopologyBuilder();&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;BrokerHosts hosts = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; ZkHosts(&lt;span class=&quot;string&quot;&gt;&quot;192.168.61.150:2181,192.168.61.151:2181,192.168.61.152:2181&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;String topic_name = &lt;span class=&quot;string&quot;&gt;&quot;kafkatest&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;String zkRoot = &lt;span class=&quot;string&quot;&gt;&quot;/&quot;&lt;/span&gt; + topic_name; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;SpoutConfig spoutConfig = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; SpoutConfig(hosts, topic_name, zkRoot, UUID.randomUUID().toString());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;spoutConfig.scheme = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; SchemeAsMultiScheme(&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; StringScheme());&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;KafkaSpout kafkaSpout = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; KafkaSpout(spoutConfig);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// set Spout.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;builder.setSpout(&lt;span class=&quot;string&quot;&gt;&quot;spout&quot;&lt;/span&gt;, kafkaSpout, &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;1） 上面需要注意的是，如果你的kafka 消息类型不是String， 是自定义的消息类型，那么需要自定义spoutConfig.scheme. spoutConfig.scheme 用于实现kafka-spout如何将接收到的kafka message转换为storm的tuple。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;TestMessageScheme&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Scheme&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;final&lt;/span&gt; Logger LOGGER = LoggerFactory.getLogger(TestMessageScheme.class);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; List&amp;lt;Object&amp;gt; &lt;span class=&quot;title&quot;&gt;deserialize&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;byte&lt;/span&gt;[] bytes)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			String msg = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; String(bytes, &lt;span class=&quot;string&quot;&gt;&quot;UTF-8&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Values(msg);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125; &lt;span class=&quot;keyword&quot;&gt;catch&lt;/span&gt; (InvalidProtocolBufferException e) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;			LOGGER.error(&lt;span class=&quot;string&quot;&gt;&quot;Cannot parse the provided message!&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;comment&quot;&gt;//&lt;span class=&quot;doctag&quot;&gt;TODO:&lt;/span&gt; what happend if returns null?&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;meta&quot;&gt;@Override&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; Fields &lt;span class=&quot;title&quot;&gt;getOutputFields&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Fields(&lt;span class=&quot;string&quot;&gt;&quot;msg&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;2）上面的代码是实时的，即启动storm后只能收到之后发送的kafka message；&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;配置过程中遇到的问题&lt;/strong&gt;&lt;br&gt;我做的主要是用kafka来做图片消息传输，在测试过程中遇到的问题主要是图片太大，在发送和接收的时候都出现问题。&lt;br&gt;1） 发送的时候图片太大，导致消息的size大不能传输，解决办法为：&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt; 2） 修改完发送端口，发送图片没有问题，可以接收图片的时候总是会卡住，接收几条消息之后consumer就卡住不动了，目前只能切分为小图片发送；&lt;/p&gt;
&lt;h2 id=&quot;参考资料&quot;&gt;&lt;a href=&quot;#参考资料&quot; class=&quot;headerlink&quot; title=&quot;参考资料&quot;&gt;&lt;/a&gt;&lt;strong&gt;参考资料&lt;/strong&gt;&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.biaodianfu.com/kafka.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;标点符 » 分布式消息系统：Kafka&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://tech.meituan.com/kafka-fs-design-theory.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Kafka文件存储机制那些事–美团技术团队&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/gwenshap/kafka-examples&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;gwenshap/kafka-examples&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://blog.csdn.net/lizhitao/article/details/41778193&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Kafka集群partition replication自动分配分析&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://liyonghui160com.iteye.com/blog/2163899&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Kafka 配置说明 含0.8.1版server.properties&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://shiyanjun.cn/archives/469.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ZooKeeper-3.3.4集群安装配置&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;br&gt; &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com&lt;/strong&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;kafka介绍&quot;&gt;&lt;a href=&quot;#kafka介绍&quot; class=&quot;headerlink&quot; title=&quot;kafka介绍&quot;&gt;&lt;/a&gt;&lt;strong&gt;kafka介绍&lt;/strong&gt;&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;Kafka是分布式发布-订阅消息系统。它最初由Li
    
    </summary>
    
      <category term="集群技术" scheme="http://yanjiankang.cn/categories/%E9%9B%86%E7%BE%A4%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="kafka" scheme="http://yanjiankang.cn/tags/kafka/"/>
    
      <category term="storm" scheme="http://yanjiankang.cn/tags/storm/"/>
    
      <category term="zookeeper" scheme="http://yanjiankang.cn/tags/zookeeper/"/>
    
      <category term="producer" scheme="http://yanjiankang.cn/tags/producer/"/>
    
      <category term="consumer" scheme="http://yanjiankang.cn/tags/consumer/"/>
    
      <category term="java" scheme="http://yanjiankang.cn/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>2015-github博客-新的征程</title>
    <link href="http://yanjiankang.cn/first/"/>
    <id>http://yanjiankang.cn/first/</id>
    <published>2016-04-07T08:12:59.851Z</published>
    <updated>2015-05-11T10:38:56.000Z</updated>
    
    <content type="html">&lt;p&gt;欢迎来到 &lt;a href=&quot;http://yanjiankang.cn/&quot;&gt;严健康的个人博客&lt;/a&gt;!&lt;/p&gt;
&lt;p&gt;这是我的新开始，为了未来而奋斗。 &lt;/p&gt;
&lt;h2 id=&quot;2015年目标&quot;&gt;&lt;a href=&quot;#2015年目标&quot; class=&quot;headerlink&quot; title=&quot;2015年目标&quot;&gt;&lt;/a&gt;2015年目标&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;刷题-算法导论&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;锻炼java编程能力&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;storm计算平台&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/dengshan.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;每个人都有潜在的能量，只是很容易：被习惯所掩盖，被时间所迷离，被惰性所消磨。&lt;/p&gt;
&lt;/blockquote&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;欢迎来到 &lt;a href=&quot;http://yanjiankang.cn/&quot;&gt;严健康的个人博客&lt;/a&gt;!&lt;/p&gt;
&lt;p&gt;这是我的新开始，为了未来而奋斗。 &lt;/p&gt;
&lt;h2 id=&quot;2015年目标&quot;&gt;&lt;a href=&quot;#2015年目标&quot; class=&quot;headerlink&quot; t
    
    </summary>
    
      <category term="生活杂记" scheme="http://yanjiankang.cn/categories/%E7%94%9F%E6%B4%BB%E6%9D%82%E8%AE%B0/"/>
    
    
      <category term="2015" scheme="http://yanjiankang.cn/tags/2015/"/>
    
      <category term="生活" scheme="http://yanjiankang.cn/tags/%E7%94%9F%E6%B4%BB/"/>
    
      <category term="目标" scheme="http://yanjiankang.cn/tags/%E7%9B%AE%E6%A0%87/"/>
    
  </entry>
  
  <entry>
    <title>LeetCode刷题--统计质数的方法</title>
    <link href="http://yanjiankang.cn/count_prime/"/>
    <id>http://yanjiankang.cn/count_prime/</id>
    <published>2016-04-07T08:12:59.849Z</published>
    <updated>2015-06-08T03:06:10.000Z</updated>
    
    <content type="html">&lt;p&gt;最近在刷LeetCode，对遇到的一些问题进行记录。&lt;/p&gt;
&lt;h2 id=&quot;统计小于n的所有质数问题&quot;&gt;&lt;a href=&quot;#统计小于n的所有质数问题&quot; class=&quot;headerlink&quot; title=&quot;统计小于n的所有质数问题&quot;&gt;&lt;/a&gt;&lt;strong&gt;统计小于n的所有质数问题&lt;/strong&gt;&lt;/h2&gt;&lt;h3 id=&quot;题目描述&quot;&gt;&lt;a href=&quot;#题目描述&quot; class=&quot;headerlink&quot; title=&quot;题目描述&quot;&gt;&lt;/a&gt;题目描述&lt;/h3&gt;&lt;p&gt;Description:&lt;br&gt;Count the number of prime numbers less than a non-negative number, n.&lt;br&gt;题目即为统计小于n的所有质数的数目；&lt;/p&gt;
&lt;h3 id=&quot;解法一&quot;&gt;&lt;a href=&quot;#解法一&quot; class=&quot;headerlink&quot; title=&quot;解法一&quot;&gt;&lt;/a&gt;解法一&lt;/h3&gt;&lt;p&gt;目前最简单易懂的解法描述为：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;质数不能被1和它本身之外的正整数整除，所以，如果要判断一个数x是不是质数只要看它是否能被2~sqrt(x)间的数整除即可。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;解法的代码如下：&lt;br&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;countPrimes&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; n)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i, count = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (i = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;; i &amp;lt; n; i += &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;) &amp;#123;  &lt;span class=&quot;comment&quot;&gt;// 只考虑奇数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; ((i%&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;==&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) || (i%&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;==&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) || (i%&lt;span class=&quot;number&quot;&gt;5&lt;/span&gt;==&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) || (i%&lt;span class=&quot;number&quot;&gt;7&lt;/span&gt;==&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;))&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (isPrime(n) == &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) count++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    return count;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 该函数判断是否是质数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;isPrime&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; num)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; limit, i;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (num &amp;lt;= &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;) return &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (num == &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; || num == &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;) return &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    limit = &lt;span class=&quot;built_in&quot;&gt;sqrt&lt;/span&gt;(n) + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (i = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;; i &amp;lt; limit; ++i) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (num % i == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) return &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    return &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;显然这种解法的复杂度为O（n^2），因此在提交的时候会直接Time Limit Exceeded。 &lt;/p&gt;
&lt;h3 id=&quot;解法二&quot;&gt;&lt;a href=&quot;#解法二&quot; class=&quot;headerlink&quot; title=&quot;解法二&quot;&gt;&lt;/a&gt;解法二&lt;/h3&gt;&lt;p&gt;仔细研究上面的算法可以发现如下优化:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;合数可以分解成若干个质数，因此只要2~sqrt(n)间的质数不能整除n即可, 因此在下面的算法中我们会将找到的质数全部保存下来。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;先看c代码：&lt;br&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;countPrimes&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; n)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; count = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i,j;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; end = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 首先动态申请数组空间用于保存质数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt;* primes = (int*)&lt;span class=&quot;built_in&quot;&gt;malloc&lt;/span&gt;(n*sizeof(int)); &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; limit;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (n &amp;lt;= &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;) return &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    primes[count++] = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;;  &lt;span class=&quot;comment&quot;&gt;// 第一个质数明显是2，不用再判断&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (i = &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;; i &amp;lt; n; i++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        limit = &lt;span class=&quot;built_in&quot;&gt;sqrt&lt;/span&gt;(i);  &lt;span class=&quot;comment&quot;&gt;//计算判断的终止点&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 要判断i是不是质数，只需要判断2-sqrt(i)中的所有质数，&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 因此下面的while语句即为找到prime数组中小于sqrt(i)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 的最大质数的下标&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;while&lt;/span&gt; (primes[end] &amp;lt;= limit &amp;amp;&amp;amp; end &amp;lt; count) end++;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 然后依次判断所有质数，如果整除说明不是质数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 否则将该数加入质数数组中；&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (j = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; j &amp;lt; end; j++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (i % primes[j] == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (j == end) primes[count++] = i;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;built_in&quot;&gt;free&lt;/span&gt;(primes);  &lt;span class=&quot;comment&quot;&gt;// 记得释放动态空间&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    return count;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;上面的代码再次提交后会发现提交通过，运行时间为260ms，仍然还是较慢；&lt;/p&gt;
&lt;p&gt;解法三&lt;/p&gt;
&lt;p&gt;下面再次考虑新的解法。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;质数就是只能位1和本身整除的数。因此如果我们将小于n的数中2,3,4，…n-1的倍数去除，那么剩下的自然就是质数。这就是筛选法。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;更进一步的：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;我们主要考虑2-（n/2+1）即可，显然大于等于(n/2+1)不可能被n整除；&lt;/li&gt;
&lt;li&gt;主要考虑2-（n/2+1）的所有质数即可；&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;c代码如下：&lt;br&gt;&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;countPrimes&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; n)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; count = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i,j,limit;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 0-n 即为n+1,该数组用于存储是否是质数标志，&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 因此pflags[i]代表i是否是质数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt;* pflags = (char*)&lt;span class=&quot;built_in&quot;&gt;malloc&lt;/span&gt;(n+&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;); &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (n &amp;lt;= &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;) return &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    pflags[&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;] = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;  &lt;span class=&quot;comment&quot;&gt;// 2显然是质数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (i = &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;; i &amp;lt; n; ++i) &amp;#123; &lt;span class=&quot;comment&quot;&gt;//初始化数组&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        pflags[i++] = &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;;  &lt;span class=&quot;comment&quot;&gt;// 所有的奇数初始为1，偶数为0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        pflags[i] = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    limit = n / &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt; + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;; &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 下面的循环用于依次去掉3-limit的每个数的倍数，对于i， &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 如果i是合数，那么跳过3，因此只用考虑质数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 如果i是质数，那么从2×i开始，依次将小于n的i的倍数标为0&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 此处使用加法代替乘法&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (i = &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;; i &amp;lt; limit; ++i) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt; == pflags[i]) &lt;span class=&quot;keyword&quot;&gt;continue&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (j = i+i; j &amp;lt; n; j += i) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            pflags[j] = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (i = &lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;; i &amp;lt; n; ++i) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; == pflags[i]) count++;  &lt;span class=&quot;comment&quot;&gt;// 遍历数组，统计质数数目&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    return count;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;该方法提交成功，运行时间为96ms， 比解法2大大提升。&lt;/p&gt;
&lt;h3 id=&quot;解法四&quot;&gt;&lt;a href=&quot;#解法四&quot; class=&quot;headerlink&quot; title=&quot;解法四&quot;&gt;&lt;/a&gt;解法四&lt;/h3&gt;&lt;p&gt;在discuss中，发现一个使用c写的运行28ms的代码如下：&lt;br&gt;也是使用筛选法，代码如下。&lt;/p&gt;
&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;define&lt;/span&gt; N 2000000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;#&lt;span class=&quot;meta-keyword&quot;&gt;define&lt;/span&gt; M 200000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; Solution &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;bool&lt;/span&gt; visit[N] = &amp;#123;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; p[M] = &amp;#123;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;countPrimes&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; n)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; res = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;; i &amp;lt; n; i+=&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(!visit[i]) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                p[res++] = i;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; j = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; j &amp;lt; res &amp;amp;&amp;amp; i*p[j] &amp;lt; n; j++) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                visit[i*p[j]] = &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt;(i % p[j] == &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                    &lt;span class=&quot;keyword&quot;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        return res+(n&amp;gt;&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;?&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com&lt;/strong&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;p&gt;最近在刷LeetCode，对遇到的一些问题进行记录。&lt;/p&gt;
&lt;h2 id=&quot;统计小于n的所有质数问题&quot;&gt;&lt;a href=&quot;#统计小于n的所有质数问题&quot; class=&quot;headerlink&quot; title=&quot;统计小于n的所有质数问题&quot;&gt;&lt;/a&gt;&lt;strong&gt;统计小于n的所有
    
    </summary>
    
      <category term="算法" scheme="http://yanjiankang.cn/categories/%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="LeetCode" scheme="http://yanjiankang.cn/tags/LeetCode/"/>
    
      <category term="算法" scheme="http://yanjiankang.cn/tags/%E7%AE%97%E6%B3%95/"/>
    
      <category term="质数" scheme="http://yanjiankang.cn/tags/%E8%B4%A8%E6%95%B0/"/>
    
  </entry>
  
  <entry>
    <title>Actor 模型调研</title>
    <link href="http://yanjiankang.cn/actor-model-research/"/>
    <id>http://yanjiankang.cn/actor-model-research/</id>
    <published>2016-04-07T08:12:59.848Z</published>
    <updated>2015-07-26T07:09:04.000Z</updated>
    
    <content type="html">&lt;h2 id=&quot;Actor-模型的历史&quot;&gt;&lt;a href=&quot;#Actor-模型的历史&quot; class=&quot;headerlink&quot; title=&quot;Actor 模型的历史&quot;&gt;&lt;/a&gt;&lt;strong&gt;Actor 模型的历史&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Actor 模型最早由 Hewitt 于 1977 年提出,经过许多人的扩展,后来 Agha 总结定义了一个由少数表达能力强的原语组成的Actor模型。由于其提供的封装和消息传递等机制与面向对象方法非常相似,而且Actor模型又具有灵活的控制结构和强大的并发描述能力,因此成为并发面向对象语言的重要的基础模型之一。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Actor 模型提出之后,一系列基于 Actor 模型的并发语言开始发展,包括 ABCL,ACT++,ConcurrentSmalltalk。其中比较著名的两种编程语言是 Erlang 和 Scala。Erlang是一种通用的并行程序设计语言,它由乔·阿姆斯特朗(Joe Armstrong)在瑞典电信设备制造商爱立信所辖的计算机科学研究室开发,目的是创造一种可以应付大规模开发活动的程序设计语言和执行环境。Scala 是一种针对JVM将函数和面向对象技术组合在一起的编程语言。这两种语言的并发特性的实现都是基于 Actor 模型来实现的,而这两种语言&lt;br&gt;是目前比较受欢迎的并发编程语言,因此它们的发展对Actor的推广起了重要的作用。 到现在为止,Actor模型的使用无处不在,即使有些地方并没有明确说采用的 Actor 模型: &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Google 提出的 Map/Reduce 分布式运算平台  &lt;/li&gt;
&lt;li&gt;C#,Java 等语言中的 lock 互斥实现  &lt;/li&gt;
&lt;li&gt;传统 Email&lt;/li&gt;
&lt;li&gt;信箱的实现&lt;/li&gt;
&lt;li&gt;……&lt;h2 id=&quot;Actor-模型设计思想&quot;&gt;&lt;a href=&quot;#Actor-模型设计思想&quot; class=&quot;headerlink&quot; title=&quot;Actor 模型设计思想&quot;&gt;&lt;/a&gt;&lt;strong&gt;Actor 模型设计思想&lt;/strong&gt;&lt;/h2&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Actor 设计思想中最重要的一点就是:Actor模型希望能以一种更自然的方式模拟人类社会分工协作解决一类复杂系统问题的工作模式,因此在 Actor 的设计哲学中,认为万物都是Actor,这与面向对象编程的“一切皆是对象”类似。两者的根本区别在于面向对象编程通常是顺序执行的,而Actor模型是并发执行的。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Actor 模型通过消息来进行Actor之间的交互,发送消息是异步非阻塞的消息传递,也就说发送完消息并不需要等待响应;而面向对象对象之间是通过方法调用的,是同步阻塞的。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 因为 Actor 之间只能发送消息,而不会共享任何数据或者内存空间,因此不存在锁的问题。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; Actor 模型通过隔离控制和计算实体,实现封装和模块化;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 我们可以这么认为:&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;strong&gt;Actor=数据+行为+消息&lt;/strong&gt; ,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 即一个Actor实体是数据、行为和消息的合集,Actor 之间只能通过消息来传递信息。&lt;/p&gt;
&lt;h2 id=&quot;Actor-模型机制介绍&quot;&gt;&lt;a href=&quot;#Actor-模型机制介绍&quot; class=&quot;headerlink&quot; title=&quot;Actor 模型机制介绍&quot;&gt;&lt;/a&gt;&lt;strong&gt;Actor 模型机制介绍&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;下面简单介绍一些 Actor 的设计原理和机制。 &lt;/p&gt;
&lt;h3 id=&quot;Actor-基本元素&quot;&gt;&lt;a href=&quot;#Actor-基本元素&quot; class=&quot;headerlink&quot; title=&quot;Actor 基本元素&quot;&gt;&lt;/a&gt;&lt;strong&gt;Actor 基本元素&lt;/strong&gt;&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Actor 模型中的基本元素有:actor 实体,邮箱,信息,行为,状态。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;一个actor实体是对客观世界功能实体的抽象和模拟,它是一个活动的对象,其职能是处理各类消息。比如,现实世界中的学生和老师都是一个 actor。&lt;br&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/actor-example.jpg&quot; alt=&quot;Actor模型示例&quot;&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;每个  actor  实体内部都有一个信箱,用于存放接受的消息,信箱有一个唯一的地址,且在 Actor的整个生命周期中地址是不会改变的,一般actor名字可以作为地址。就比如每个学生和老师都有一个实名信箱一样。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;actor 之间只能通过互发消息来影响对方的行为,也就是邮件,存储在邮箱中的消息按先到先服务的顺序被响应。每个 actor 实体只能向认识的 actor 实体发消息,也就是发送消息必须知道对方的地址。学生通过发邮件向老师传递消息,老师可以回复学生的信息,也可以单独向学生发消息,当然前提是学生或者老师知道对方的邮箱地址。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;actor 的行为说明 actor如何响应一个请求消息,一般行为描述的代码体包含一组可以响应的方法定义。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;每个 actor 总是处在一个状态之下,每个状态会对应一组行为定义,行为导致状态变化,行为执行依靠线程。比如一个缓冲池的Actor,在状态为空的时候只有 put 方法,在状态为满的时候只有get方法,不空也不满的时候既可以执行 get 操作,也可以执行 put 操作。 &lt;/p&gt;
&lt;h3 id=&quot;Actor-消息处理&quot;&gt;&lt;a href=&quot;#Actor-消息处理&quot; class=&quot;headerlink&quot; title=&quot;Actor 消息处理&quot;&gt;&lt;/a&gt;&lt;strong&gt;Actor 消息处理&lt;/strong&gt;&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/actor-message-process.jpg&quot; alt=&quot;Actor模型消息处理&quot;&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;在处理1个消息时, 1个actor可以做3种操作: &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;生成新actor、发消息给认识的actor和指定一个替代行为，可以使用三个原语来表示。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;new 原语用来生成新的actor,返回值所生成的actor的邮箱地址. 这使得actor可以在计算中按需要动态生成；&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;send原语用来进行消息传递,一个消息包含目的actor的邮箱地址、要调用的方法名和引用该方法所需参数；&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;become原语用来指明一个替代行为，替代行为是指actor 在处理完本消息后所处的行为，也就是actor用指出的替代行为来处理下一个消息，这样在become语句完成之后如果有下一条消息到达，可以继续执行，实现流水线并发。Become操作也可以改变actor所处的状态。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;以上三个操作在一个信息的处理过程中是可以并发执行的，因为他们均为原语操作，不会被打断。&lt;/p&gt;
&lt;h3 id=&quot;Actor-并发实现&quot;&gt;&lt;a href=&quot;#Actor-并发实现&quot; class=&quot;headerlink&quot; title=&quot;Actor 并发实现&quot;&gt;&lt;/a&gt;&lt;strong&gt;Actor 并发实现&lt;/strong&gt;&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/actor-cocurrent.jpg&quot; alt=&quot;Actor模型并发示意图&quot;&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Actor模型为并行而生，根据维基百科中的描述，它原本是为大量独立的微型处理器所构建的高性能网络而设计的模型。而目前，单台机器也有了多个独立的计算单元，这就是为什么在并行程序愈演愈烈的今天，Actor模型又重新回到了人们的视线之中了。Actor模型的执行方式有两个特点：&lt;br&gt;1) 每个Actor，单线程地依次执行发送给它的消息，在内部可以通过become原语来实现流水线并发；&lt;br&gt;2) 不同的Actor可以同时执行它们的消息；&lt;br&gt;如上图所示，我们学生可以单线程串行的处理自己的信息，但是由于多个学生和多个老师都可以并行的处理自己的消息，因此整个系统的并发效率是大大提高了。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;我们知道，系统中执行任务的最小单元是线程，数量一定程度上是有限的，而过多的线程会占用大量资源，也无法带来最好的运行效率。但是Actor并不是线程实体，虽然Actor的底层实现还是线程，但是后面我们会谈到，由于线程的复用，因此Actor的并发效率是比较高，目前实现百万级别的Actor模型已经存在了。&lt;/p&gt;
&lt;h3 id=&quot;Actor任务调度策略&quot;&gt;&lt;a href=&quot;#Actor任务调度策略&quot; class=&quot;headerlink&quot; title=&quot;Actor任务调度策略&quot;&gt;&lt;/a&gt;&lt;strong&gt;Actor任务调度策略&lt;/strong&gt;&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Actor模型的任务调度一般有两个策略，一个是基于线程调度，一个是基于事件调度。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;基于线程的调度为每个 actor 实体分配一个线程，在接受一个消息时，如果当前 actor的消息队列为空，则会阻塞当前线程直到接收到该消息为止。基于线程的调度实现起来较为简单，但是线程的开销是比较大的，线程数量是受到操作系统的限制，因此基于线程的调度会影响actor的并发性能；&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;基于事件的调度，在有消息到达，有任务需要执行时才会为 actor 的任务分配线程并执行。这样就可以使用少量的线程来执行许多个 actor 实体提交的任务，从而保证了运算资源的动态调度，也使系统有很好的伸缩性。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Scala语言就是基于事件的调度策略，所有actor共享一个固定大小的线程池，当一个Actor启动之后，系统会分配一个线程给它使用，如果当前邮箱中没有需要处理的消息，就会把actor设置为等待状态并且释放这个线程；如果当前消息队列里面有消息需要处理，则从线程池里选择一个新的线程来处理。处理完后会立即返回，或者是立即抛出异常，结束该线程的执行，这样该线程就可以被其它actor使用。这种通过线程复用的方式可以提高Actor模型的并发性能。&lt;/p&gt;
&lt;h3 id=&quot;Actor实现例子&quot;&gt;&lt;a href=&quot;#Actor实现例子&quot; class=&quot;headerlink&quot; title=&quot;Actor实现例子&quot;&gt;&lt;/a&gt;&lt;strong&gt;Actor实现例子&lt;/strong&gt;&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;http://7xj1d3.com1.z0.glb.clouddn.com/actor-java-example.jpg&quot; alt=&quot;Actor模型java代码示例&quot;&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;这是一个基于java 的Actor模型的例子，因为java有一个Actor模型的实现库。可以看到，当hello actor收到greet的消息之后，他会发送一个打印消息到系统内置的标准输出stdout actor，stdout actor收到消息后会把信息打印到屏幕上，同时hello actor会创建一个world类型的actor，名称为other，并向这个actor发送audience消息。Other actor收到audience消息后会调用audience方法，所以也会向stdout actor发送打印World的消息。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;注意，由于消息是异步的，因此hello和world的打印顺序是不确定的。&lt;/p&gt;
&lt;h2 id=&quot;Actor模型的应用&quot;&gt;&lt;a href=&quot;#Actor模型的应用&quot; class=&quot;headerlink&quot; title=&quot;Actor模型的应用&quot;&gt;&lt;/a&gt;&lt;strong&gt;Actor模型的应用&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;讲完了actor的机制，那么我们需要考虑为什么需要actor模型，actor模型适合在什么情况下用？我们可以看到，如果我们的编程模型变成了这种只能进行消息传递，没有共享变量，也没有方法调用，这完全不符合我们的编程习惯，因此在一开始肯定会束手无策。但是Actor模型的存在肯定有其存在的意义，而且Actor模型更符合自然社会的运作模式，所以我觉得基于Actor模型的编程语言是需要我们转变编程的思维习惯，改变长期以来对面向过程和面向对象的程序设计的固定思维模式，就像人们从面向过程到面向对象的思维模式的改变。经过一些了解，发现Actor的主要运用有两种场景。&lt;/p&gt;
&lt;h3 id=&quot;两种编程模式&quot;&gt;&lt;a href=&quot;#两种编程模式&quot; class=&quot;headerlink&quot; title=&quot;两种编程模式&quot;&gt;&lt;/a&gt;&lt;strong&gt;两种编程模式&lt;/strong&gt;&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;为了了解Actor的应用，在这里先讲一下两种编程模式：&lt;strong&gt;线程驱动和事件驱动&lt;/strong&gt;。&lt;br&gt;基于线程的编程如下：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;result = query(&lt;span class=&quot;string&quot;&gt;&#39;SELECT * FROM posts WHERE id = 1&#39;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;do_something_with(result);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;线程驱动一般是顺序执行的，比如我们要访问数据库，需要先查询数据库，再拿查询的结果去做事情，如上所示；&lt;br&gt;基于事件的编程如下：&lt;br&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;query_finished = function(result) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        do_something_with(result);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;query(&lt;span class=&quot;string&quot;&gt;&#39;SELECT * FROM posts WHERE id = 1&#39;&lt;/span&gt;, query_finished);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;而事件的驱动则改变了思维模式，发射事件后即忘记，做别的事情了，无需立即等待刚才发射的响应结果了。在基于线程编程中，我们为什么要等待，是因为希望基于响应结果来进行一些逻辑，这是线程驱动的思维，而事件驱动的思维就是将这些逻辑放到消费者那里去处理（事件的发射方为生产者，事件结果的使用方为消费者）。比如这个例子中，我们将基于数据库查询结果的响应操作作为事件响应，当数据库查询返回后会回调这个函数。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;因此事件驱动是一种异步编程，需要完全改变思路，将“请求响应”的思路转变到“事件驱动”思路上，事件驱动编程分为事件的检测和响应两部分。&lt;/p&gt;
&lt;h3 id=&quot;两种编程模式在并发时存在的问题&quot;&gt;&lt;a href=&quot;#两种编程模式在并发时存在的问题&quot; class=&quot;headerlink&quot; title=&quot;两种编程模式在并发时存在的问题&quot;&gt;&lt;/a&gt;&lt;strong&gt;两种编程模式在并发时存在的问题&lt;/strong&gt;&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;基于线程驱动的编程模式是同步共享机制，因此在多线程编程时，存在以下问题：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;需要显式协调共享数据锁；&lt;/li&gt;
&lt;li&gt;依赖锁导致死锁；&lt;/li&gt;
&lt;li&gt;难以调试；&lt;/li&gt;
&lt;li&gt;多线程在多核上的性能并不会比每个单核一个线程性能更好；&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;基于事件驱动的编程模式是异步非阻塞机制，天生具有并发性，但是仍然存在以下问题：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使得业务流程晦涩难懂；&lt;/li&gt;
&lt;li&gt;需要转变软件编程思维；&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;而Actor模型的出现综合这两者的优点，Actor模型将事件统一为消息传递，通过隔离控制和计算实体来实现封装，大大降低了事件驱动编程的难度。&lt;/p&gt;
&lt;h3 id=&quot;Actor模型应用-事件编程&quot;&gt;&lt;a href=&quot;#Actor模型应用-事件编程&quot; class=&quot;headerlink&quot; title=&quot;Actor模型应用-事件编程&quot;&gt;&lt;/a&gt;&lt;strong&gt;Actor模型应用-事件编程&lt;/strong&gt;&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;基于事件编程存在以下特点：&lt;br&gt;1) 事件发生不可控，事件响应处理必须及时。&lt;br&gt;2) 事件处理不能采取传统同步模式，容易锁，堵塞，性能差，设计耦合，不能切分。&lt;br&gt;3) 事件处理必须采取异步，性能高，设计松耦合。&lt;br&gt;4) 事件处理最好并发，与事件触发机制一致。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;而Actor模型的优点就在于：核心是异步消息机制；无共享状态，无锁，无堵塞；异步，高并发；因此Actor模型是事件驱动编程目前最合适模型。&lt;/p&gt;
&lt;h3 id=&quot;Actor模型应用-保证数据一致性&quot;&gt;&lt;a href=&quot;#Actor模型应用-保证数据一致性&quot; class=&quot;headerlink&quot; title=&quot;Actor模型应用-保证数据一致性&quot;&gt;&lt;/a&gt;&lt;strong&gt;Actor模型应用-保证数据一致性&lt;/strong&gt;&lt;/h3&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Actor模型的另外一种使用场景就是保护数据的一致性。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;线程1：&lt;br&gt;开始事务 –&amp;gt; 访问表A  –&amp;gt; 访问表B –&amp;gt; 提交事务&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;线程2：&lt;br&gt;开始事务 –&amp;gt; 访问表B –&amp;gt; 访问表A –&amp;gt; 提交事务&lt;/p&gt;
&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;比如说有两个线程，第一个线程开始事务之后先访问表 A 再访问表B，第二个线程先访问表B，再访问表A，这种情况是很容易出现死锁的。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;这里线程是代表控制行为，表AB是代表数据，因此传统的模型中数据是被动的给行为，这样的话就很难保证数据的一致性，必须要给数据上锁。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;而Actor模型如何避免锁呢？&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Actor模型的一个关键思想就是：要让数据自己有行为能力保护实现自己的一致性。因此在Actor模型中，数据的一致性是靠行为职责来保证的，没有行为守护的数据是一盘散沙，这样的数据必须靠锁来维护一致性。如果数据自身要求有严格的一致性，也就是事务机制，数据就不能被动被加工，要让数据自己有行为能力保护实现自己的一致性，就像孩子小的时候可以任由爸妈怎么照顾关心都可以，但是如果孩子长大有自己的思想和要求，他就可能不喜欢被爸妈照顾，他要求自己通过行动实现自己的要求。只有我们改变思路，让数据自己有行为维护自己的一致性，才能真正安全实现真正的事务。&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Actor模型在一个较高的层面上通过数据的行为实现了无锁的并发模型。&lt;/p&gt;
&lt;h2 id=&quot;参考资料&quot;&gt;&lt;a href=&quot;#参考资料&quot; class=&quot;headerlink&quot; title=&quot;参考资料&quot;&gt;&lt;/a&gt;&lt;strong&gt;参考资料&lt;/strong&gt;&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;Gul Agha. Actors: A Model of Concurrent Computation in Distributed Systems. Doctoral Dissertation. MIT Press. 1986.&lt;/li&gt;
&lt;li&gt;Philipp Haller and Martin Odersky (January 2007). Actors that Unify Threads and Events. Technical report LAMP. 2007.&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.jdon.com/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;解道jdon&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Dennis Kafura, Manibrata Mukherji, Greg Lavender. Act++ 2.0 : A Class Library for Concurrent Programming in C++ Using Actors.&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://rerun.me/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;AKKA NOTES&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;董哲,刘琳,田籁声. 基于ACTOR模型的并发面向对象语言AC++[J]. 软件学报,1997,03:38-44.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;br&gt; &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com&lt;/strong&gt;&lt;/p&gt;
</content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Actor-模型的历史&quot;&gt;&lt;a href=&quot;#Actor-模型的历史&quot; class=&quot;headerlink&quot; title=&quot;Actor 模型的历史&quot;&gt;&lt;/a&gt;&lt;strong&gt;Actor 模型的历史&lt;/strong&gt;&lt;/h2&gt;&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp
    
    </summary>
    
      <category term="软件工程" scheme="http://yanjiankang.cn/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/"/>
    
    
      <category term="java" scheme="http://yanjiankang.cn/tags/java/"/>
    
      <category term="actor模型" scheme="http://yanjiankang.cn/tags/actor%E6%A8%A1%E5%9E%8B/"/>
    
      <category term="并发" scheme="http://yanjiankang.cn/tags/%E5%B9%B6%E5%8F%91/"/>
    
      <category term="Scala" scheme="http://yanjiankang.cn/tags/Scala/"/>
    
      <category term="线程驱动" scheme="http://yanjiankang.cn/tags/%E7%BA%BF%E7%A8%8B%E9%A9%B1%E5%8A%A8/"/>
    
      <category term="事件驱动" scheme="http://yanjiankang.cn/tags/%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8/"/>
    
  </entry>
  
</feed>
