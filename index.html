
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Yan Jiankang&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Jiankang Yan">
    

    
    <meta name="description" content="个人学习总结  知识管理  技术总结">
<meta property="og:type" content="website">
<meta property="og:title" content="Yan Jiankang's Blog">
<meta property="og:url" content="http://yanjiankang.cn/index.html">
<meta property="og:site_name" content="Yan Jiankang's Blog">
<meta property="og:description" content="个人学习总结  知识管理  技术总结">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Yan Jiankang's Blog">
<meta name="twitter:description" content="个人学习总结  知识管理  技术总结">

    
    <link rel="alternative" href="/atom.xml" title="Yan Jiankang&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Yan Jiankang&#39;s Blog" title="Yan Jiankang&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Yan Jiankang&#39;s Blog">Yan Jiankang&#39;s Blog</a></h1>
				<h2 class="blog-motto">博学之,审问之,慎思之,明辨之,笃行之</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:yanjiankang.cn">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/07/Storm-sourcecode-uicode-1/" title="Storm 源码分析——UI界面显示代码分析（上）" itemprop="url">Storm 源码分析——UI界面显示代码分析（上）</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Jiankang Yan" target="_blank" itemprop="author">Jiankang Yan</a>
		
  <p class="article-time">
    <time datetime="2016-04-07T08:12:59.865Z" itemprop="datePublished"> 发表于 2016-04-07</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>#Storm源码分析——UI界面显示代码分析</p>
<p>storm开发环境的配置请参考：<a href="http://yanjiankang.cn/2016/02/02/Storm-sourcecode-analize-tools/">storm源码分析——工具篇</a></p>
<p>storm的UI界面的参数解释可以参考<a href="http://lbxc.iteye.com/blog/1522318" target="_blank" rel="external">http://lbxc.iteye.com/blog/1522318</a></p>
<p>storm提供了ui界面的Restful API，主要API如下，详细的API的参数和返回值请参考<a href="https://www.zybuluo.com/yanhealth/note/142919：" target="_blank" rel="external">https://www.zybuluo.com/yanhealth/note/142919：</a><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/api/v1/cluster/configuration (GET) </span><br><span class="line">/api/v1/cluster/summary (GET)</span><br><span class="line">/api/v1/supervisor/summary (GET)</span><br><span class="line">/api/v1/topology/summary (GET)</span><br><span class="line">/api/v1/topology/:id (GET)</span><br><span class="line">/api/v1/topology/:id/component/:component (GET)</span><br><span class="line">/api/v1/topology/:id/activate (POST)</span><br><span class="line">/api/v1/topology/:id/deactivate (POST)</span><br><span class="line">/api/v1/topology/:id/rebalance/:wait-time (POST)</span><br><span class="line">/api/v1/topology/:id/kill/:wait-time (POST)</span><br></pre></td></tr></table></figure></p>
<p>这些接口函数的定义主要是在ui/core.clj文件中。下面主要分析UI进程的启动过程和以上接口数据的产生。 </p>
<h2 id="UI进程的启动"><a href="#UI进程的启动" class="headerlink" title="UI进程的启动"></a>UI进程的启动</h2><p>我们知道，UI进程是通过以下命令启动的：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/storm ui</span><br></pre></td></tr></table></figure></p>
<p>其中storm实际上是一个bash的脚本文件，storm 会通过以下命令调用bin/storm.py的python文件来执行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span> <span class="string">"<span class="variable">$PYTHON</span>"</span> <span class="string">"<span class="variable">$&#123;STORM_BIN_DIR&#125;</span>/storm.py"</span> <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure></p>
<p>storm.py中，接收到ui参数后，执行的函数代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ui</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span><br><span class="line">    Syntax: [storm ui]</span><br><span class="line">    Launches the UI daemon. </span><br><span class="line">    """</span></span><br><span class="line">    cppaths = [CLUSTER_CONF_DIR]</span><br><span class="line">    jvmopts = parse_args(confvalue(<span class="string">"ui.childopts"</span>, cppaths)) + [ </span><br><span class="line">        <span class="string">"-Dlogfile.name=ui.log"</span>,</span><br><span class="line">        <span class="string">"-Dlog4j.configurationFile="</span> + os.path.join(get_log4j_conf_dir(), <span class="string">"cluster.xml"</span>)</span><br><span class="line">    ]   </span><br><span class="line">    exec_storm_class(</span><br><span class="line">        <span class="string">"backtype.storm.ui.core"</span>,</span><br><span class="line">        jvmtype=<span class="string">"-server"</span>,</span><br><span class="line">        daemonName=<span class="string">"ui"</span>,</span><br><span class="line">        jvmopts=jvmopts,</span><br><span class="line">        extrajars=[STORM_DIR, CLUSTER_CONF_DIR])</span><br></pre></td></tr></table></figure></p>
<p>其中首先会调用confvalue函数来获取UI进程执行的参数项，confvalue代码如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">def confvalue(name, extrapaths, daemon=True):</span><br><span class="line">    global CONFFILE</span><br><span class="line">    <span class="built_in">command</span> = [</span><br><span class="line">        JAVA_CMD, <span class="string">"-client"</span>, get_config_opts(), <span class="string">"-Dstorm.conf.file="</span> + CONFFILE,</span><br><span class="line">        <span class="string">"-cp"</span>, get_classpath(extrapaths, daemon), <span class="string">"backtype.storm.command.config_value"</span>, name</span><br><span class="line">    ]</span><br><span class="line">    p = sub.Popen(<span class="built_in">command</span>, stdout=sub.PIPE)</span><br><span class="line">    output, errors = p.communicate()</span><br><span class="line">    <span class="comment"># python 3</span></span><br><span class="line">    <span class="keyword">if</span> not isinstance(output, str):</span><br><span class="line">        output = output.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">    lines = output.split(os.linesep)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        tokens = line.split(<span class="string">" "</span>)</span><br><span class="line">        <span class="keyword">if</span> tokens[0] == <span class="string">"VALUE:"</span>:</span><br><span class="line">            <span class="built_in">return</span> <span class="string">" "</span>.join(tokens[1:])</span><br><span class="line">    <span class="built_in">return</span> <span class="string">""</span></span><br></pre></td></tr></table></figure></p>
<p>其中sub.Popen是启动一个子进程，执行command命令，而command数组实际上是执行backtype.storm.command.config_value这个类，并将传入的ui.childopts作为参数。<br>config_value类的路径为：src/clj/backtype/storm/command/config_value.clj<br>config_value.clj的代码如下：<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> -main [<span class="comment">^String</span> name]</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> [conf (<span class="name">read-storm-config</span>)]</span><br><span class="line">    (<span class="name">println</span> <span class="string">"VALUE:"</span> (<span class="name">conf</span> name))</span><br><span class="line">    ))</span><br></pre></td></tr></table></figure></p>
<p>因此，实际上就是读取storm的配置文件storm.conf，并得到ui.childopts参数。默认的ui.childopts参数是”-Xmx768m”，设置虚拟机内存堆的最大可用大小为768M.</p>
<p>因此<strong>UI进程启动的顺序</strong>为：</p>
<ol>
<li>先调用<strong>backtype.storm.command.config_value</strong>获取读取到的配置文件中的ui启动项；</li>
<li>然后执行java命令行参数后调用<strong>backtype.storm.ui.core</strong>启动UI进程。</li>
</ol>
<p>其中配置文件中可以配置的UI参数如下（定义在src/jvm/backtype/storm/Config.java）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Childopts for Storm UI Java process.</span></span><br><span class="line"><span class="keyword">static</span> String	UI_CHILDOPTS</span><br><span class="line"></span><br><span class="line"><span class="comment">//A class implementing javax.servlet.Filter for authenticating/filtering UI requests</span></span><br><span class="line"><span class="keyword">static</span> String	UI_FILTER</span><br><span class="line"></span><br><span class="line"><span class="comment">//Initialization parameters for the javax.servlet.Filter</span></span><br><span class="line"><span class="keyword">static</span> String	UI_FILTER_PARAMS</span><br><span class="line"></span><br><span class="line"><span class="comment">//The size of the header buffer for the UI in bytes</span></span><br><span class="line"><span class="keyword">static</span> String	UI_HEADER_BUFFER_BYTES</span><br><span class="line"></span><br><span class="line"><span class="comment">//Storm UI binds to this host/interface.</span></span><br><span class="line"><span class="keyword">static</span> String	UI_HOST</span><br><span class="line"></span><br><span class="line"><span class="comment">//Class name of the HTTP credentials plugin for the UI.</span></span><br><span class="line"><span class="keyword">static</span> String	UI_HTTP_CREDS_PLUGIN</span><br><span class="line"></span><br><span class="line"><span class="comment">//Storm UI binds to this port.</span></span><br><span class="line"><span class="keyword">static</span> String	UI_PORT</span><br></pre></td></tr></table></figure></p>
<h2 id="backtype-storm-ui-core"><a href="#backtype-storm-ui-core" class="headerlink" title="backtype.storm.ui.core"></a><strong>backtype.storm.ui.core</strong></h2><p>这一节看一下src/backtype/storm/ui/core.clj这个文件的主要功能（其中部分关于jetty服务器配置的函数定义在ui/helper.clj文件中）：</p>
<p><strong>backtype.storm.ui.core的主要功能是定义并启动一个jetty服务器，用于实现所有API的响应并返回json数据。</strong></p>
<p>首先看main函数， 就是调用start-server! 函数（clojure中！表示函数是突变函数，表示方法或宏不能在STM中安全使用）：<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> -main [] (<span class="name">start-server!</span>))</span><br></pre></td></tr></table></figure></p>
<p>start-server！函数定义如下：<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> start-server!</span><br><span class="line">  []</span><br><span class="line">  (<span class="name"><span class="builtin-name">try</span></span></span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> [conf *STORM-CONF*</span><br><span class="line">          header-buffer-size (<span class="name"><span class="builtin-name">int</span></span> (<span class="name">.get</span> conf UI-HEADER-BUFFER-BYTES))</span><br><span class="line">          filters-confs [&#123;<span class="symbol">:filter-class</span> (<span class="name">conf</span> UI-FILTER)</span><br><span class="line">                          <span class="symbol">:filter-params</span> (<span class="name">conf</span> UI-FILTER-PARAMS)&#125;]</span><br><span class="line">          https-port (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">not-nil?</span> (<span class="name">conf</span> UI-HTTPS-PORT)) (<span class="name">conf</span> UI-HTTPS-PORT) <span class="number">0</span>)</span><br><span class="line">          https-ks-path (<span class="name">conf</span> UI-HTTPS-KEYSTORE-PATH)</span><br><span class="line">          https-ks-password (<span class="name">conf</span> UI-HTTPS-KEYSTORE-PASSWORD)</span><br><span class="line">          https-ks-type (<span class="name">conf</span> UI-HTTPS-KEYSTORE-TYPE)</span><br><span class="line">          https-key-password (<span class="name">conf</span> UI-HTTPS-KEY-PASSWORD)</span><br><span class="line">          https-ts-path (<span class="name">conf</span> UI-HTTPS-TRUSTSTORE-PATH)</span><br><span class="line">          https-ts-password (<span class="name">conf</span> UI-HTTPS-TRUSTSTORE-PASSWORD)</span><br><span class="line">          https-ts-type (<span class="name">conf</span> UI-HTTPS-TRUSTSTORE-TYPE)</span><br><span class="line">          https-want-client-auth (<span class="name">conf</span> UI-HTTPS-WANT-CLIENT-AUTH)</span><br><span class="line">          https-need-client-auth (<span class="name">conf</span> UI-HTTPS-NEED-CLIENT-AUTH)]</span><br><span class="line">      (<span class="name">storm-run-jetty</span> &#123;<span class="symbol">:port</span> (<span class="name">conf</span> UI-PORT)</span><br><span class="line">                        <span class="symbol">:host</span> (<span class="name">conf</span> UI-HOST)</span><br><span class="line">                        <span class="symbol">:https-port</span> https-port</span><br><span class="line">                        <span class="symbol">:configurator</span> (<span class="name"><span class="builtin-name">fn</span></span> [server]</span><br><span class="line">                                        (<span class="name">config-ssl</span> server</span><br><span class="line">                                                    https-port</span><br><span class="line">                                                    https-ks-path</span><br><span class="line">                                                    https-ks-password</span><br><span class="line">                                                    https-ks-type</span><br><span class="line">                                                    https-key-password</span><br><span class="line">                                                    https-ts-path</span><br><span class="line">                                                    https-ts-password</span><br><span class="line">                                                    https-ts-type</span><br><span class="line">                                                    https-need-client-auth</span><br><span class="line">                                                    https-want-client-auth)</span><br><span class="line">                                        (<span class="name"><span class="builtin-name">doseq</span></span> [connector (<span class="name">.getConnectors</span> server)]</span><br><span class="line">                                          (<span class="name">.setRequestHeaderSize</span> connector header-buffer-size))</span><br><span class="line">                                        (<span class="name">config-filter</span> server app filters-confs))&#125;))</span><br><span class="line">   (<span class="name">catch</span> Exception ex</span><br><span class="line">     (<span class="name">log-error</span> ex))))</span><br></pre></td></tr></table></figure></p>
<p>首先从conf配置项中取出http的相应参数，然后将这些配置项封装为map作为参数去调用<strong>storm-run-jetty</strong>函数(helper.clj)，参数有:port，:host，:https-port，:configurator。storm-run-jetty函数定义如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">;; Modified from ring.adapter.jetty 1.3.0</span><br><span class="line">(defn- jetty-create-server</span><br><span class="line">  "Construct a Jetty Server instance."</span><br><span class="line">  [options]</span><br><span class="line">  (let [connector (doto (SelectChannelConnector.)</span><br><span class="line">                    (.setPort (options :port 80))</span><br><span class="line">                    (.setHost (options :host))</span><br><span class="line">                    (.setMaxIdleTime (options :max-idle-time 200000)))</span><br><span class="line">        server    (doto (Server.)</span><br><span class="line">                    (.addConnector connector)</span><br><span class="line">                    (.setSendDateHeader true))</span><br><span class="line">        https-port (options :https-port)]</span><br><span class="line">    (if (and (not-nil? https-port) (&gt; https-port 0)) (remove-non-ssl-connectors server))</span><br><span class="line">    server))</span><br><span class="line"></span><br><span class="line">(defn storm-run-jetty</span><br><span class="line">  "Modified version of run-jetty</span><br><span class="line">  Assumes configurator sets handler."</span><br><span class="line">  [config]</span><br><span class="line">  &#123;:pre [(:configurator config)]&#125;</span><br><span class="line">  (let [#^Server s (jetty-create-server (dissoc config :configurator))</span><br><span class="line">        configurator (:configurator config)]</span><br><span class="line">    (configurator s)</span><br><span class="line">    (.start s)))</span><br></pre></td></tr></table></figure>
<p><strong>storm-run-jetty的运行流程</strong>：</p>
<ol>
<li><p>传入参数为：:port，:host，:https-port，:configurator。 其中:configurator是在start-server!中定义的参数，返回的是如下的函数，该函数首先利用https的传入参数初始化一个ssl connector，并将其添加到server中。然后对server中的每一个connector，设置HTTP请求头的buffer size，设置server的过滤器，再设置server的handle为app，主要通过config-filter函数(helper.clj)实现。。</p>
 <figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">fn</span></span> [server]</span><br><span class="line">           (<span class="name">config-ssl</span> server</span><br><span class="line">                       https-port</span><br><span class="line">                       https-ks-path</span><br><span class="line">                       https-ks-password</span><br><span class="line">                       https-ks-type</span><br><span class="line">                       https-key-password</span><br><span class="line">                       https-ts-path</span><br><span class="line">                       https-ts-password</span><br><span class="line">                       https-ts-type</span><br><span class="line">                       https-need-client-auth</span><br><span class="line">                       https-want-client-auth)</span><br><span class="line">           (<span class="name"><span class="builtin-name">doseq</span></span> [connector (<span class="name">.getConnectors</span> server)]</span><br><span class="line">             (<span class="name">.setRequestHeaderSize</span> connector header-buffer-size))</span><br><span class="line">           (<span class="name">config-filter</span> server app filters-confs))</span><br></pre></td></tr></table></figure>
</li>
<li><p>在storm-run-jetty函数中首先调用jetty-create-server函数来创建一个jetty服务器对象：</p>
<ul>
<li>传入的参数为:port，:host，:https-port 。</li>
<li>首先初始化一个SelectChannelConnector，设置端口（默认为80），设置host， 设置最大空闲时间（默认为200000ms），然后初始化一个Server， 添加连接器Connector，设置Http Header中发送日期。然后判断参数中是否存在https端口，如果存在的话，将Server中的所有不是SslSocketConnector实例的连接器删除。</li>
<li>返回server</li>
</ul>
</li>
<li>然后从storm-run-jetty函数参数中取出configurator函数，配置server对象，添加https连接器和过滤器，设置handle；</li>
<li>最后启动服务器server.start()。 </li>
</ol>
<p>storm中的jetty服务器的<strong>handle的实现</strong>是借助于Clojure中的web开发框架ring及其routing库Compojure来实现的，主要通过以下app代码来实现。即首先对<strong>main-routes路由函数</strong>（后面介绍）添加中间件：包括request参数json化，parse multipart， 在发送request前重载namespace；捕捉错误并json化，然后作为参数调用handler/site函数；</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">def</span></span> app</span><br><span class="line">  (<span class="name">handler/site</span> (<span class="name"><span class="builtin-name">-&gt;</span></span> main-routes</span><br><span class="line">                    (<span class="name">wrap-json-params</span>)</span><br><span class="line">                    (<span class="name">wrap-multipart-params</span>)</span><br><span class="line">                    (<span class="name">wrap-reload</span> '[backtype.storm.ui.core])</span><br><span class="line">                    catch-errors)))</span><br></pre></td></tr></table></figure>
<p><strong>compojure.handler.site函数</strong>的功能为：传入route函数，添加中间件，返回handle。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Create a handler suitable <span class="keyword">for</span> a standard website. This adds the</span><br><span class="line">following middleware to your routes:</span><br><span class="line">  - wrap-session</span><br><span class="line">  - wrap-flash</span><br><span class="line">  - wrap-cookies</span><br><span class="line">  - wrap-multipart-params</span><br><span class="line">  - wrap-params</span><br><span class="line">  - wrap-nested-params</span><br><span class="line">  - wrap-keyword-params</span><br></pre></td></tr></table></figure>
<p>因此最后得到的app是一个handle。将app作为config-filter的参数执行以下代码：<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> config-filter [server handler filters-confs]</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> filters-confs</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> [servlet-holder (<span class="name">ServletHolder.</span></span><br><span class="line">                           (<span class="name">ring.util.servlet/servlet</span> handler))</span><br><span class="line">          context (<span class="name"><span class="builtin-name">doto</span></span> (<span class="name">org.eclipse.jetty.servlet.ServletContextHandler.</span> server <span class="string">"/"</span>)</span><br><span class="line">                    (<span class="name">.addServlet</span> servlet-holder <span class="string">"/"</span>))]</span><br><span class="line">      (<span class="name">.addFilter</span> context (<span class="name">cors-filter-handler</span>) <span class="string">"/*"</span> (<span class="name">EnumSet/allOf</span> DispatcherType))</span><br><span class="line">      (<span class="name"><span class="builtin-name">doseq</span></span> [&#123;<span class="symbol">:keys</span> [filter-name filter-class filter-params]&#125; filters-confs]</span><br><span class="line">        (<span class="name"><span class="builtin-name">if</span></span> filter-class</span><br><span class="line">          (<span class="name"><span class="builtin-name">let</span></span> [filter-holder (<span class="name"><span class="builtin-name">doto</span></span> (<span class="name">org.eclipse.jetty.servlet.FilterHolder.</span>)</span><br><span class="line">                                (<span class="name">.setClassName</span> filter-class)</span><br><span class="line">                                (<span class="name">.setName</span> (<span class="name"><span class="builtin-name">or</span></span> filter-name filter-class))</span><br><span class="line">                                (<span class="name">.setInitParameters</span> (<span class="name"><span class="builtin-name">or</span></span> filter-params &#123;&#125;)))]</span><br><span class="line">            (<span class="name">.addFilter</span> context filter-holder <span class="string">"/*"</span> FilterMapping/ALL))))</span><br><span class="line">      (<span class="name">.setHandler</span> server context))))</span><br></pre></td></tr></table></figure></p>
<p>这段代码的前面主要是添加filter。关键的最后一句server.setHandler(context) 函数会将前面得到的app作为jetty服务器的handle。这里注意：虽然默认的filters-confs参数是 <strong>{:filter-class  nil, :filter-params nil}</strong>，但其并不是nil，所以<strong>if filters-confs</strong>为true。</p>
<p>最后再来看一下main-routes函数，其定义如下。这是ring框架提供的macro定义，主要定义了<strong>不同API路径的请求处理和响应返回</strong>。</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">defroutes</span> main-routes</span><br><span class="line">  (<span class="name">GET</span> <span class="string">"/api/v1/cluster/configuration"</span> [&amp; m]</span><br><span class="line">    (<span class="name">json-response</span> (<span class="name">cluster-configuration</span>)</span><br><span class="line">                   (<span class="symbol">:callback</span> m) <span class="symbol">:serialize-fn</span> identity))</span><br><span class="line">  (<span class="name">GET</span> <span class="string">"/api/v1/cluster/summary"</span> [<span class="symbol">:as</span> &#123;<span class="symbol">:keys</span> [cookies servlet-request]&#125; &amp; m]</span><br><span class="line">    (<span class="name">populate-context!</span> servlet-request)</span><br><span class="line">    (<span class="name">assert-authorized-user</span> <span class="string">"getClusterInfo"</span>)</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> [user (<span class="name">get-user-name</span> servlet-request)]</span><br><span class="line">      (<span class="name">json-response</span> (<span class="name">cluster-summary</span> user) (<span class="symbol">:callback</span> m))))</span><br><span class="line">  (<span class="name">GET</span> <span class="string">"/api/v1/supervisor/summary"</span> [<span class="symbol">:as</span> &#123;<span class="symbol">:keys</span> [cookies servlet-request]&#125; &amp; m]</span><br><span class="line">    (<span class="name">populate-context!</span> servlet-request)</span><br><span class="line">    (<span class="name">assert-authorized-user</span> <span class="string">"getClusterInfo"</span>)</span><br><span class="line">    (<span class="name">json-response</span> (<span class="name">supervisor-summary</span>) (<span class="symbol">:callback</span> m)))</span><br><span class="line">  (<span class="name">GET</span> <span class="string">"/api/v1/topology/summary"</span> [<span class="symbol">:as</span> &#123;<span class="symbol">:keys</span> [cookies servlet-request]&#125; &amp; m]</span><br><span class="line">    (<span class="name">populate-context!</span> servlet-request)</span><br><span class="line">    (<span class="name">assert-authorized-user</span> <span class="string">"getClusterInfo"</span>)</span><br><span class="line">    (<span class="name">json-response</span> (<span class="name">all-topologies-summary</span>) (<span class="symbol">:callback</span> m)))</span><br><span class="line">  (<span class="name">GET</span>  <span class="string">"/api/v1/topology/:id"</span> [<span class="symbol">:as</span> &#123;<span class="symbol">:keys</span> [cookies servlet-request scheme params]&#125; id &amp; m]</span><br><span class="line">    (<span class="name">populate-context!</span> servlet-request)</span><br><span class="line">    (<span class="name">assert-authorized-user</span> <span class="string">"getTopology"</span> (<span class="name">topology-config</span> id))</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> [user (<span class="name">.getUserName</span> http-creds-handler servlet-request)]</span><br><span class="line">      (<span class="name">json-response</span> (<span class="name">topology-page</span> id (<span class="symbol">:window</span> m) (<span class="name">check-include-sys?</span> (<span class="symbol">:sys</span> m)) user (<span class="name"><span class="builtin-name">=</span></span> scheme <span class="symbol">:https</span>)) (<span class="symbol">:callback</span> m))))</span><br><span class="line">  (<span class="name">GET</span> <span class="string">"/api/v1/topology/:id/visualization"</span> [<span class="symbol">:as</span> &#123;<span class="symbol">:keys</span> [cookies servlet-request]&#125; id &amp; m]</span><br><span class="line">    (<span class="name">populate-context!</span> servlet-request)</span><br><span class="line">    (<span class="name">assert-authorized-user</span> <span class="string">"getTopology"</span> (<span class="name">topology-config</span> id))</span><br><span class="line">    (<span class="name">json-response</span> (<span class="name">mk-visualization-data</span> id (<span class="symbol">:window</span> m) (<span class="name">check-include-sys?</span> (<span class="symbol">:sys</span> m))) (<span class="symbol">:callback</span> m)))</span><br><span class="line">  (<span class="name">GET</span> <span class="string">"/api/v1/topology/:id/component/:component"</span> [<span class="symbol">:as</span> &#123;<span class="symbol">:keys</span> [cookies servlet-request scheme]&#125; id component &amp; m]</span><br><span class="line">    (<span class="name">populate-context!</span> servlet-request)</span><br><span class="line">    (<span class="name">assert-authorized-user</span> <span class="string">"getTopology"</span> (<span class="name">topology-config</span> id))</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> [user (<span class="name">.getUserName</span> http-creds-handler servlet-request)]</span><br><span class="line">      (<span class="name">json-response</span> (<span class="name">component-page</span> id component (<span class="symbol">:window</span> m) (<span class="name">check-include-sys?</span> (<span class="symbol">:sys</span> m)) user (<span class="name"><span class="builtin-name">=</span></span> scheme <span class="symbol">:https</span>)) (<span class="symbol">:callback</span> m))))</span><br><span class="line">  (<span class="name">POST</span> <span class="string">"/api/v1/topology/:id/activate"</span> [<span class="symbol">:as</span> &#123;<span class="symbol">:keys</span> [cookies servlet-request]&#125; id &amp; m]</span><br><span class="line">    (<span class="name">populate-context!</span> servlet-request)</span><br><span class="line">    (<span class="name">assert-authorized-user</span> <span class="string">"activate"</span> (<span class="name">topology-config</span> id))</span><br><span class="line">    (<span class="name">with-nimbus</span> nimbus</span><br><span class="line">       (<span class="name"><span class="builtin-name">let</span></span> [tplg (<span class="name"><span class="builtin-name">-&gt;&gt;</span></span> (<span class="name"><span class="builtin-name">doto</span></span></span><br><span class="line">                        (<span class="name">GetInfoOptions.</span>)</span><br><span class="line">                        (<span class="name">.set_num_err_choice</span> NumErrorsChoice/NONE))</span><br><span class="line">                      (<span class="name">.getTopologyInfoWithOpts</span> <span class="comment">^Nimbus</span>$Client nimbus id))</span><br><span class="line">            name (<span class="name">.get_name</span> tplg)]</span><br><span class="line">        (<span class="name">.activate</span> nimbus name)</span><br><span class="line">        (<span class="name">log-message</span> <span class="string">"Activating topology '"</span> name <span class="string">"'"</span>)))</span><br><span class="line">    (<span class="name">json-response</span> (<span class="name">topology-op-response</span> id <span class="string">"activate"</span>) (<span class="name">m</span> <span class="string">"callback"</span>)))</span><br><span class="line">  (<span class="name">POST</span> <span class="string">"/api/v1/topology/:id/deactivate"</span> [<span class="symbol">:as</span> &#123;<span class="symbol">:keys</span> [cookies servlet-request]&#125; id &amp; m]</span><br><span class="line">    (<span class="name">populate-context!</span> servlet-request)</span><br><span class="line">    (<span class="name">assert-authorized-user</span> <span class="string">"deactivate"</span> (<span class="name">topology-config</span> id))</span><br><span class="line">    (<span class="name">with-nimbus</span> nimbus</span><br><span class="line">        (<span class="name"><span class="builtin-name">let</span></span> [tplg (<span class="name"><span class="builtin-name">-&gt;&gt;</span></span> (<span class="name"><span class="builtin-name">doto</span></span></span><br><span class="line">                        (<span class="name">GetInfoOptions.</span>)</span><br><span class="line">                        (<span class="name">.set_num_err_choice</span> NumErrorsChoice/NONE))</span><br><span class="line">                      (<span class="name">.getTopologyInfoWithOpts</span> <span class="comment">^Nimbus</span>$Client nimbus id))</span><br><span class="line">            name (<span class="name">.get_name</span> tplg)]</span><br><span class="line">        (<span class="name">.deactivate</span> nimbus name)</span><br><span class="line">        (<span class="name">log-message</span> <span class="string">"Deactivating topology '"</span> name <span class="string">"'"</span>)))</span><br><span class="line">    (<span class="name">json-response</span> (<span class="name">topology-op-response</span> id <span class="string">"deactivate"</span>) (<span class="name">m</span> <span class="string">"callback"</span>)))</span><br><span class="line">  (<span class="name">POST</span> <span class="string">"/api/v1/topology/:id/rebalance/:wait-time"</span> [<span class="symbol">:as</span> &#123;<span class="symbol">:keys</span> [cookies servlet-request]&#125; id wait-time &amp; m]</span><br><span class="line">    (<span class="name">populate-context!</span> servlet-request)</span><br><span class="line">    (<span class="name">assert-authorized-user</span> <span class="string">"rebalance"</span> (<span class="name">topology-config</span> id))</span><br><span class="line">    (<span class="name">with-nimbus</span> nimbus</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> [tplg (<span class="name"><span class="builtin-name">-&gt;&gt;</span></span> (<span class="name"><span class="builtin-name">doto</span></span></span><br><span class="line">                        (<span class="name">GetInfoOptions.</span>)</span><br><span class="line">                        (<span class="name">.set_num_err_choice</span> NumErrorsChoice/NONE))</span><br><span class="line">                      (<span class="name">.getTopologyInfoWithOpts</span> <span class="comment">^Nimbus</span>$Client nimbus id))</span><br><span class="line">            name (<span class="name">.get_name</span> tplg)</span><br><span class="line">            rebalance-options (<span class="name">m</span> <span class="string">"rebalanceOptions"</span>)</span><br><span class="line">            options (<span class="name">RebalanceOptions.</span>)]</span><br><span class="line">        (<span class="name">.set_wait_secs</span> options (<span class="name">Integer/parseInt</span> wait-time))</span><br><span class="line">        (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">and</span></span> (<span class="name">not-nil?</span> rebalance-options) (<span class="name"><span class="builtin-name">contains?</span></span> rebalance-options <span class="string">"numWorkers"</span>))</span><br><span class="line">          (<span class="name">.set_num_workers</span> options (<span class="name">Integer/parseInt</span> (<span class="name">.toString</span> (<span class="name">rebalance-options</span> <span class="string">"numWorkers"</span>)))))</span><br><span class="line">        (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">and</span></span> (<span class="name">not-nil?</span> rebalance-options) (<span class="name"><span class="builtin-name">contains?</span></span> rebalance-options <span class="string">"executors"</span>))</span><br><span class="line">          (<span class="name"><span class="builtin-name">doseq</span></span> [keyval (<span class="name">rebalance-options</span> <span class="string">"executors"</span>)]</span><br><span class="line">            (<span class="name">.put_to_num_executors</span> options (<span class="name"><span class="builtin-name">key</span></span> keyval) (<span class="name">Integer/parseInt</span> (<span class="name">.toString</span> (<span class="name"><span class="builtin-name">val</span></span> keyval))))))</span><br><span class="line">        (<span class="name">.rebalance</span> nimbus name options)</span><br><span class="line">        (<span class="name">log-message</span> <span class="string">"Rebalancing topology '"</span> name <span class="string">"' with wait time: "</span> wait-time <span class="string">" secs"</span>)))</span><br><span class="line">    (<span class="name">json-response</span> (<span class="name">topology-op-response</span> id <span class="string">"rebalance"</span>) (<span class="name">m</span> <span class="string">"callback"</span>)))</span><br><span class="line">  (<span class="name">POST</span> <span class="string">"/api/v1/topology/:id/kill/:wait-time"</span> [<span class="symbol">:as</span> &#123;<span class="symbol">:keys</span> [cookies servlet-request]&#125; id wait-time &amp; m]</span><br><span class="line">    (<span class="name">populate-context!</span> servlet-request)</span><br><span class="line">    (<span class="name">assert-authorized-user</span> <span class="string">"killTopology"</span> (<span class="name">topology-config</span> id))</span><br><span class="line">    (<span class="name">with-nimbus</span> nimbus</span><br><span class="line">      (<span class="name"><span class="builtin-name">let</span></span> [tplg (<span class="name"><span class="builtin-name">-&gt;&gt;</span></span> (<span class="name"><span class="builtin-name">doto</span></span></span><br><span class="line">                        (<span class="name">GetInfoOptions.</span>)</span><br><span class="line">                        (<span class="name">.set_num_err_choice</span> NumErrorsChoice/NONE))</span><br><span class="line">                      (<span class="name">.getTopologyInfoWithOpts</span> <span class="comment">^Nimbus</span>$Client nimbus id))</span><br><span class="line">            name (<span class="name">.get_name</span> tplg)</span><br><span class="line">            options (<span class="name">KillOptions.</span>)]</span><br><span class="line">        (<span class="name">.set_wait_secs</span> options (<span class="name">Integer/parseInt</span> wait-time))</span><br><span class="line">        (<span class="name">.killTopologyWithOpts</span> nimbus name options)</span><br><span class="line">        (<span class="name">log-message</span> <span class="string">"Killing topology '"</span> name <span class="string">"' with wait time: "</span> wait-time <span class="string">" secs"</span>)))</span><br><span class="line">    (<span class="name">json-response</span> (<span class="name">topology-op-response</span> id <span class="string">"kill"</span>) (<span class="name">m</span> <span class="string">"callback"</span>)))</span><br><span class="line">  (<span class="name">GET</span> <span class="string">"/"</span> [<span class="symbol">:as</span> &#123;cookies <span class="symbol">:cookies</span>&#125;]</span><br><span class="line">    (<span class="name">resp/redirect</span> <span class="string">"/index.html"</span>))</span><br><span class="line">  (<span class="name">route/resources</span> <span class="string">"/"</span>)</span><br><span class="line">  (<span class="name">route/not-found</span> <span class="string">"Page not found"</span>))</span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li>json-response函数用于将得到的response转换为json格式；</li>
<li>populate-context!函数用于将servlet-request对象转换为storm的RequestContext对象，即backtype.storm.security.auth.ReqContext （src/jvm/backtype/storm/security/auth/ReqContext.java），主要是用于添加用户认证的插件，插件只需要实现IHttpCredentialsPlugin接口即可。没有做详细了解。</li>
<li>assert-authorized-user也是验证用户操作权限的；</li>
<li><p>with-nimbus是一个宏，用于建立一个与thrift server的客户端连接，代码如下, 首先初始化一个ReqContext上下文对象，获取用户名，然后与storm thirift server建立连接，执行body所代表的操作。<strong>其中nimbus-sym是一个符号参数，其会在with-nimbus-connection-as-user中被赋值为NimbusClient对象，用于在执行body代码是作为参数；</strong></p>
  <figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; src/clj/backtype/storm/ui/core.clj</span></span><br><span class="line">(<span class="name"><span class="builtin-name">defmacro</span></span> with-nimbus</span><br><span class="line">  [nimbus-sym &amp; body]</span><br><span class="line">  `(<span class="name"><span class="builtin-name">let</span></span> [context# (<span class="name">ReqContext/context</span>)</span><br><span class="line">         user# (<span class="name"><span class="builtin-name">if</span></span> (<span class="name">.principal</span> context#) (<span class="name">.getName</span> (<span class="name">.principal</span> context#)))]</span><br><span class="line">    (<span class="name">thrift/with-nimbus-connection-as-user</span></span><br><span class="line">       [~nimbus-sym (<span class="name">*STORM-CONF*</span> NIMBUS-HOST) (<span class="name">*STORM-CONF*</span> NIMBUS-THRIFT-PORT) user#]</span><br><span class="line">       ~@body)))</span><br><span class="line"></span><br><span class="line"><span class="comment">;; src/clj/backtype/storm/thrift.clj</span></span><br><span class="line">(<span class="name"><span class="builtin-name">defmacro</span></span> with-nimbus-connection-as-user</span><br><span class="line">  [[client-sym host port as-user] &amp; body]</span><br><span class="line">  `(<span class="name"><span class="builtin-name">let</span></span> [[<span class="comment">^Nimbus</span>$Client ~client-sym <span class="comment">^TTransport</span> conn#] (<span class="name">nimbus-client-and-conn</span> ~host ~port ~as-user)]</span><br><span class="line">     (<span class="name"><span class="builtin-name">try</span></span></span><br><span class="line">       ~@body</span><br><span class="line">       (<span class="name">finally</span> (<span class="name">.close</span> conn#)))))</span><br></pre></td></tr></table></figure>
<p>  比如<strong>active API</strong>的代码如下：在建立与服务器的连接后得到了<strong>NimbusCilent对象nimbus</strong>，调用其.getTopologyInfoWithOpts函数，得到TopologyInfo 对象，进而得到topology name，然后调用active方法激活topology；</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">with-nimbus</span> nimbus</span><br><span class="line">       (<span class="name"><span class="builtin-name">let</span></span> [tplg (<span class="name"><span class="builtin-name">-&gt;&gt;</span></span> (<span class="name"><span class="builtin-name">doto</span></span></span><br><span class="line">                        (<span class="name">GetInfoOptions.</span>)</span><br><span class="line">                        (<span class="name">.set_num_err_choice</span> NumErrorsChoice/NONE))</span><br><span class="line">                      (<span class="name">.getTopologyInfoWithOpts</span> <span class="comment">^Nimbus</span>$Client nimbus id))</span><br><span class="line">            name (<span class="name">.get_name</span> tplg)]</span><br><span class="line">        (<span class="name">.activate</span> nimbus name)</span><br><span class="line">        (<span class="name">log-message</span> <span class="string">"Activating topology '"</span> name <span class="string">"'"</span>)))</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>note：jetty服务器API是org.eclipse.jetty.server这个包提供的。</p>
<p>至此整个UI进程的启动和运行过程已经解析完毕。下一步是解析UI界面上的数据来源。 请参考下一篇博客。</p>
<p><br> <br><br><br></p>
<hr>
<p><strong>转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com</strong></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/集群技术/">集群技术</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/storm/">storm</a><a href="/tags/UI/">UI</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/07/Storm-sourcecode-uicode-1/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/07/Storm-sourcecode-uicode-1/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/07/Storm-sourcecode-analize-tools/" title="Storm 源码分析——工具篇" itemprop="url">Storm 源码分析——工具篇</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Jiankang Yan" target="_blank" itemprop="author">Jiankang Yan</a>
		
  <p class="article-time">
    <time datetime="2016-04-07T08:12:59.864Z" itemprop="datePublished"> 发表于 2016-04-07</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><strong>工欲善其事，必先利其器。</strong></p>
<p>在开始分析storm源码之前，一个好的阅读代码的环境是非常有帮助的。<br>storm的代码包括：核心功能的Clojure代码，对外接口的java 代码，RPC通信的thrift代码，bin中客户端命令的python代码等。</p>
<p>虽然可以在命令行使用vim直接阅读，但是对于对storm还不熟悉的像我这样的小白，我的建议是使用IDE效率会更高。</p>
<h2 id="Intellij-idea-Cursive"><a href="#Intellij-idea-Cursive" class="headerlink" title="Intellij idea + Cursive"></a>Intellij idea + Cursive</h2><p>我的推荐是：<strong>Intellij idea + Cursive</strong> （一开始我是用的是Eclipse，但是对于Clojure的支持并不是很好，直到我发现了Cursive）</p>
<p>Intellij idea的安装可以直接从其官网下载：<a href="https://www.jetbrains.com/idea/download/" target="_blank" rel="external">https://www.jetbrains.com/idea/download/</a><br>免费的Community版本功能就足够使用；</p>
<p>我是CentOS系统，下载的linux版本，下载后解压运行即可：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Unpack the idea idea-15.0.3.tar.gz file using the following command: </span></span><br><span class="line">tar xfz idea-15.0.3.tar.gz</span><br><span class="line"><span class="comment">#Run idea.sh from the bin subdirectory.</span></span><br></pre></td></tr></table></figure></p>
<p>然后<strong>安装Cursive 插件</strong>：</p>
<p><img src="http://7xj1d3.com1.z0.glb.clouddn.com/idea-install-cursive-1.png" alt=""></p>
<p>运行idea，点击configure，再点击setting。</p>
<p>然后点击plugins：</p>
<p><img src="http://7xj1d3.com1.z0.glb.clouddn.com/idea-install-cursive-2.png" alt=""></p>
<p>再点击底下的Browse repositories， </p>
<p>然后搜索cursive，点击Install ，我这边因为已经安装过了，所以没有install的按钮：</p>
<p><img src="http://7xj1d3.com1.z0.glb.clouddn.com/idea-install-cursive-3.png" alt=""></p>
<p>安装后重启idea，进入Cursive会提示需要license， 去他的官网<a href="https://cursive-ide.com/申请一个免费的即可：" target="_blank" rel="external">https://cursive-ide.com/申请一个免费的即可：</a></p>
<p>点击首页的Get a License按钮，如下填写后：</p>
<p><img src="http://7xj1d3.com1.z0.glb.clouddn.com/idea-install-cursive-4.png" alt="enter image description here"></p>
<p>会将License发送到你的邮箱。</p>
<p>至此安装完成。</p>
<h2 id="安装storm编译依赖"><a href="#安装storm编译依赖" class="headerlink" title="安装storm编译依赖"></a>安装storm编译依赖</h2><p>按照storm的开发文档<a href="https://www.zybuluo.com/yanhealth/note/281972的说明，storm的编译依赖python" target="_blank" rel="external">https://www.zybuluo.com/yanhealth/note/281972的说明，storm的编译依赖python</a>, ruby 和nodejs，需要预先安装：</p>
<p>The ruby package manager rvm and nodejs package manager nvm are for convenience and are used in the tests which run on travis. (ruby的包管理器rvm和nodejs的包管理器nvm是用于在 travis (<a href="https://en.wikipedia.org/wiki/Travis_CI" target="_blank" rel="external">https://en.wikipedia.org/wiki/Travis_CI</a>) 上的测试的) 。可以用如下命令安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://get.rvm.io | bash <span class="_">-s</span> stable --autolibs=enabled &amp;&amp; <span class="built_in">source</span> ~/.profile</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -qO- https://raw.githubusercontent.com/creationix/nvm/v0.26.1/install.sh | bash &amp;&amp; <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>
<p>安装好以后运行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rvm use 2.1.5 --install</span><br><span class="line">nvm install 0.12.2</span><br><span class="line">nvm use 0.12.2</span><br></pre></td></tr></table></figure>
<h2 id="导入Storm-core项目"><a href="#导入Storm-core项目" class="headerlink" title="导入Storm-core项目"></a>导入Storm-core项目</h2><p>在官网下载storm的源代码并解压后，在idea点击import，然后选择storm源码目录下的storm-core：</p>
<p><img src="http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-1.png" alt=""></p>
<p>然后下一步，选择Maven：</p>
<p><img src="http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-2.png" alt=""></p>
<p>next，默认就可以：</p>
<p><img src="http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-3.png" alt=""></p>
<p><img src="http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-4.png" alt="enter image description here"></p>
<p>然后选择安装的jdk的位置，我选的版本1.7，没有安装需要先安装jdk；</p>
<p><img src="http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-5.png" alt=""></p>
<p>导入后会开始解决依赖问题：</p>
<p><img src="http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-6.png" alt="enter image description here"></p>
<p>然后添加一个maven的打包操作：</p>
<p><img src="http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-7.png" alt="enter image description here"></p>
<p><img src="http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-8.png" alt=""></p>
<p>此处-DskipTests=true ，是指跳过打包时的测试阶段，因为我的版本中测试会失败。同时也可以节省时间。</p>
<p>最后运行打包命令，会在storm-core项目根目录下的target中生成jar包文件：</p>
<p><img src="http://7xj1d3.com1.z0.glb.clouddn.com/idea-import-storm-9.png" alt=""></p>
<h2 id="如何编译storm生成可以发布的binary版本"><a href="#如何编译storm生成可以发布的binary版本" class="headerlink" title="如何编译storm生成可以发布的binary版本"></a>如何编译storm生成可以发布的binary版本</h2><p>以下命令可以将storm编译后安装到本地的.m2库中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install  <span class="comment"># 可加上-DskipTests=true 跳过测试</span></span><br></pre></td></tr></table></figure></p>
<p>如果你需要对storm源代码进行改动，并且希望生成binary版本的话，可以按照storm的Develper教程<a href="https://www.zybuluo.com/yanhealth/note/281972来操作：" target="_blank" rel="external">https://www.zybuluo.com/yanhealth/note/281972来操作：</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># First, build the code. 首先在storm根目录下install</span></span><br><span class="line">$ mvn clean install <span class="comment"># you may skip tests with `-DskipTests=true` to save time</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the binary distribution. </span></span><br><span class="line">$ <span class="built_in">cd</span> storm-dist/binary &amp;&amp; mvn package</span><br></pre></td></tr></table></figure>
<p>至此，基本上storm的整个环境配置完成。可以开始storm源代码的阅读和二次开发。</p>
<h2 id="storm的代码结构"><a href="#storm的代码结构" class="headerlink" title="storm的代码结构"></a>storm的代码结构</h2><h3 id="Java-storm-core-src-jvm"><a href="#Java-storm-core-src-jvm" class="headerlink" title="Java   (storm-core/src/jvm/)"></a>Java   (storm-core/src/jvm/)</h3><p><strong>backtype.storm.coordination</strong>: 实现了DRPC和事务性topology里用到的基于Storm的批处理功能。这个包里最重要得类是CoordinatedBolt<br><strong>backtype.storm.drpc</strong>: DRPC的更高层次抽象的具体实现<br><strong>backtype.storm.generated</strong>: 自动生成的Thrift代码（利用这里folk出来的Thrift版本生成的，主要是把org.apache.thrift包重命名成org.apache.thrift7来避免与其他Thrift版本的冲突）<br><strong>backtype.storm.grouping</strong>: 包含了用户实现自定义stream分组类时需要用到的接口<br><strong>backtype.storm.hooks</strong>: 定义了处理storm各种事件的钩子接口，例如当task发射tuple时、当tuple被ack时。关于钩子的手册详见这里<br><strong>backtype.storm.serialization</strong>: storm序列化/反序列化tuple的实现。在Kryo之上构建。<br><strong>backtype.storm.spout</strong>: spout及相关接口的定义（例如”SpoutOutputCollector”）。也包括了”ShellSpout”来实现非JVM语言定义spout的协议。<br><strong>backtype.storm.task:</strong> bolt及相关接口的定义（例如”OutputCollector”）。也包括了”ShellBolt”来实现非JVM语言定义bolt的协议。最后，”TopologyContext”也是在这里定义的，用来在运行时供spout和bolt使用以获取topology的执行信息。<br><strong>backtype.storm.testing</strong>: 包括了storm单元测试中用到的各种测试bolt及工具。<br><strong>backtype.storm.topology</strong>: 在Thrift结构之上的Java层，用以提供一个纯Java API来使用Storm（用户不需要了解Thrift的细节）。”TopologyBuilder”及不同spout和bolt的基类们也在这里定义。稍高一层次的接口”IBasicBolt”也在这里定义，它会使得创建某些特定类型的bolt会更加简洁。<br><strong>backtype.storm.transactional</strong>: 包括了事务性topology的实现。<br><strong>backtype.storm.tuple</strong>: 包括Storm中tuple数据模型的实现。<br><strong>backtype.storm.utils</strong>: 包含了Storm源码中用到的数据结构及各种工具类。</p>
<h3 id="Clojure-storm-core-src-clj"><a href="#Clojure-storm-core-src-clj" class="headerlink" title="Clojure  (storm-core/src/clj/)"></a>Clojure  (storm-core/src/clj/)</h3><p><strong>backtype.storm.bootstrap</strong>: 包括了1个有用的宏来引入源码中用到的所有类及命名空间。<br><strong>backtype.storm.clojure</strong>: 包括了利用Clojure为Storm定义的特定领域语言(DSL)。<br><strong>backtype.storm.cluster</strong>: Storm守护进程中用到的Zookeeper逻辑都封装在这个文件中。这部分代码提供了API来将整个集群的运行状态映射到Zookeeper的”文件系统”上（例如哪里运行着怎样的task，每个task运行的是哪个spout/bolt）。<br><strong>backtype.storm.command</strong>.<em>: 这些命名空间包括了各种”storm xxx”开头的客户端命令行的命令实现。这些实现都很简短。<br><strong>backtype.storm.config</strong>: Clojure中config的读取/解析实现。同时也包括了工具函数来告诉nimbus、supervisor等守护进程在各种情况下应该使用哪些本地目录。例如：”master-inbox”函数会返回本地目录告诉Nimbus应该将上传给它的jar包保存到哪里。<br><strong>backtype.storm.daemon.acker</strong>: “acker” bolt的实现。这是Storm确保数据被完全处理的关键组成部分。<br><strong>backtype.storm.daemon.common</strong>: Storm守护进程用到的公共函数，例如根据topology的名字获取其id，将1个用户定义的topology映射到真正运行的topology（真正运行的topology是在用户定义的topology基础上添加了ack stream及acker bolt，参见system-topology!函数），同时包括了各种心跳及Storm中其他数据结构的定义。<br><strong>backtype.storm.daemon.drpc</strong>: 包括了DRPC服务器的实现，用来与DRPC topology一起使用。<br><strong>backtype.storm.daemon.nimbus</strong>: 包括了Nimbus的实现。<br><strong>backtype.storm.daemon.supervisor</strong>: 包括了Supervisor的实现。<br><strong>backtype.storm.daemon.task</strong>: 包括了spout或bolt的task实例实现。包括了处理消息路由、序列化、为UI提供的统计集合及spout、bolt执行动作的实现。<br><strong>backtype.storm.daemon.worker</strong>: 包括了worker进程（1个worker包含很多的task）的实现。包括了消息传输和task启动的实现。<br><strong>backtype.storm.event</strong>: 包括了1个简单的异步函数的执行器。Nimbus和Supervisor很多场合都用到了异步函数执行器来避免资源竞争。<br><strong>backtype.storm.log</strong>: 定义了用来输出log信息给log4j的函数。<br><strong>backtype.storm.messaging</strong>.</em>: 定义了1个高一层次的接口来实现点对点的消息通讯。工作在本地模式时Storm会使用内存中的Java队列来模拟消息传递。工作在集群模式时，消息传递使用的是ZeroMQ。通用的接口在protocol.clj中定义。<br><strong>backtype.storm.stats</strong>: 实现了向Zookeeper中写入UI使用的统计信息时如何进行汇总。实现了不同粒度的聚合。<br><strong>backtype.storm.testing</strong>: 包括了测试Storm topology的工具。包括时间仿真，运行一组固定数量的tuple然后获得输出快照的”complete-topology”，”tracker topology”可以在集群”空闲”时做更细粒度的控制操作，以及其他工具。<br><strong>backtype.storm.thrift</strong>: 包括了自动生成的Thrift API的Clojure封装以使得使用Thrift结构更加便利。<br><strong>backtype.storm.timer</strong>: 实现了1个后台定时器来延迟执行函数或者定时轮询执行。Storm不能使用Java里的Timer类，因为为了单测Nimbus和Supervisor，必须要与时间仿真集成起来使用。<br><strong>backtype.storm.ui.*</strong>: Storm UI的实现。完全独立于其他的代码，通过Nimbus的Thrift API来获取需要的数据。<br><strong>backtype.storm.util</strong>: 包括了Storm代码中用到的通用工具函数。<br><strong>backtype.storm.zookeeper</strong>: 包括了Clojure对Zookeeper API的封装，同时也提供了一些高一层次的操作例如：”mkdirs”、”delete-recursive”</p>
<h3 id="Thrift-（storm-core-src-storm-thrift）"><a href="#Thrift-（storm-core-src-storm-thrift）" class="headerlink" title="Thrift （storm-core/src/storm.thrift）"></a>Thrift （storm-core/src/storm.thrift）</h3><p><strong>storm.thrift</strong>: RPC服务的通信接口定义<br><strong>genthrift.sh</strong>: 将storm.thrift文件中定义的结构编译转换为java代码(backtype.storm.generated)的脚本文件</p>
<h3 id="Web-UI-storm-core-src-ui"><a href="#Web-UI-storm-core-src-ui" class="headerlink" title="Web UI (storm-core/src/ui)"></a>Web UI (storm-core/src/ui)</h3><p><strong>src/ui</strong> : 定义storm UI界面的网页文件资源</p>
<p><br> <br><br><br></p>
<hr>
<p><strong>转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com</strong></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[1] <a href="https://github.com/apache/storm" target="_blank" rel="external">https://github.com/apache/storm</a><br>[2]  <a href="http://blog.csdn.net/pelick/article/details/17682477" target="_blank" rel="external">Storm源码结构 (来源Storm Github Wiki)</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/集群技术/">集群技术</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/storm/">storm</a><a href="/tags/idea/">idea</a><a href="/tags/Clojure/">Clojure</a><a href="/tags/cursive/">cursive</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/07/Storm-sourcecode-analize-tools/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/07/Storm-sourcecode-analize-tools/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/07/storm-source-study-note-01/" title="Storm源码阅读学习笔记之一(待整理)" itemprop="url">Storm源码阅读学习笔记之一(待整理)</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Jiankang Yan" target="_blank" itemprop="author">Jiankang Yan</a>
		
  <p class="article-time">
    <time datetime="2016-04-07T08:12:59.862Z" itemprop="datePublished"> 发表于 2016-04-07</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ol>
<li><p>宏 for 和 doseq 可以用来做 list comprehension. 它们支持遍历多个集合 ( 最右边的最快 ) ,同时还可以做一些过滤用 :when 和 :while 。 宏 for 只接受一个表达式 ,它返回一个懒惰集合作为结果 . 宏 doseq 接受任意数量的表达式 , 以有副作用的方式执行它们 , 并且返回 nil;</p>
</li>
<li><p>$符号用于取代java包之间的点;</p>
</li>
<li><p>定义zookeeper的连接状态</p>
 <figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">def</span></span> zk-keeper-states</span><br><span class="line">&#123;Watcher$Event$KeeperState/Disconnected <span class="symbol">:disconnected</span></span><br><span class="line">Watcher$Event$KeeperState/SyncConnected <span class="symbol">:connected</span></span><br><span class="line">Watcher$Event$KeeperState/AuthFailed <span class="symbol">:auth-failed</span></span><br><span class="line">Watcher$Event$KeeperState/Expired <span class="symbol">:expired</span>&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义zookeeper监听事件类型</p>
 <figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">def</span></span> zk-event-types</span><br><span class="line">&#123;Watcher$Event$EventType/None <span class="symbol">:none</span></span><br><span class="line">Watcher$Event$EventType/NodeCreated <span class="symbol">:node-created</span></span><br><span class="line">Watcher$Event$EventType/NodeDeleted <span class="symbol">:node-deleted</span></span><br><span class="line">Watcher$Event$EventType/NodeDataChanged <span class="symbol">:node-data-changed</span></span><br><span class="line">Watcher$Event$EventType/NodeChildrenChanged <span class="symbol">:node-children-changed</span>&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>defn-定义私有函数</p>
</li>
<li><p>storm中广泛使用defnk: 和普通defn的不同是, 可以在参数里面使用k,v, 并且可以在函数体中直接使用k来得到value, 也可以在指定参数时给定k的默认值, 其实它的实现就是增加一个hashmap来存放这些k,v</p>
</li>
<li><p>storm中zookeeper.clj中采用Curator作为zookeeper的客户端连接, Curator是Netflix公司开源的一个Zookeeper客户端，与Zookeeper提供的原生客户端相比，Curator的抽象层次更高，简化了Zookeeper客户端的开发量。<br>backtype.storm.utils 中用java代码定义了newCurator的构造方法; </p>
</li>
<li><p>今天的工作主要是导入storm到eclipse中去,遇到很多问题;<br>When building a WAR with “lein ring uberwar” and if ring-servlet is only in the lib/dev directory but not in the lib directory, ring-servlet is not added to the WAR.When deploying the WAR, for instance on Jetty, one get the following error:<br>“Could not locate ring/util/servlet__init.class or ring/util/servlet.clj on classpath”.<br>A temporary work around is to explicitly adds [ring/ring-servlet “1.0.1”] to the list of dependencies in the project.clj.  我添加了ring-servlet到pom中,错误消失; </p>
</li>
<li><p>reify 用来 实现java的接口, 如下例所示:</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">myJButton.addActionListener(<span class="keyword">new</span> ActionListener() &#123;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line">         <span class="comment">// do something here</span></span><br><span class="line">&#125; &#125;);</span><br></pre></td></tr></table></figure>
 <figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">.addActionListener</span> my-jbutton</span><br><span class="line">     (<span class="name"><span class="builtin-name">proxy</span></span> [ActionListener] []</span><br><span class="line">         (<span class="name">actionPerformed</span> [evt]</span><br><span class="line">             <span class="comment">;; (do something here)</span></span><br><span class="line">          ))) </span><br><span class="line"></span><br><span class="line">(<span class="name">.addActionListener</span> my-jbutton</span><br><span class="line">     (<span class="name"><span class="builtin-name">reify</span></span> ActionListener</span><br><span class="line">         (<span class="name">actionPerformed</span> [this evt]</span><br><span class="line">                 <span class="comment">;; (do something here)</span></span><br><span class="line">         )))</span><br></pre></td></tr></table></figure>
</li>
<li><p>“..” 是同时调用两个函数的简写: 即 方法调用可以用 .. 宏串起来; </p>
</li>
<li><p>Curator 框架事件类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Enum CuratorEventType : </span><br><span class="line">CHILDREN</span><br><span class="line">Corresponds to CuratorFramework.getChildren()</span><br><span class="line">CLOSING</span><br><span class="line">Event sent when client is being closed</span><br><span class="line">CREATE</span><br><span class="line">Corresponds to CuratorFramework.create()</span><br><span class="line">DELETE</span><br><span class="line">Corresponds to CuratorFramework.delete()</span><br><span class="line">EXISTS</span><br><span class="line">Corresponds to CuratorFramework.checkExists()</span><br><span class="line">GET_ACL</span><br><span class="line">Corresponds to CuratorFramework.getACL()</span><br><span class="line">GET_DATA</span><br><span class="line">Corresponds to CuratorFramework.getData()</span><br><span class="line">SET_ACL</span><br><span class="line">Corresponds to CuratorFramework.setACL()</span><br><span class="line">SET_DATA</span><br><span class="line">Corresponds to CuratorFramework.setData()</span><br><span class="line">SYNC</span><br><span class="line">Corresponds to CuratorFramework.sync(String, Object)</span><br><span class="line">WATCHED</span><br><span class="line">Corresponds to Watchable.usingWatcher(Watcher) or Watchable.watched()</span><br></pre></td></tr></table></figure>
</li>
<li><p>Clojure 函数参数中可以使用^符号+参数类型来限定参数类型; </p>
</li>
<li><p>Clojure方法调用可以用 .. 宏串起来 并不是有几个串联调用的方法就需要几个点, 而是都是两个点； </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(.getLocation (.getCodeSource (.getProtectionDomain (.getClass '(1 2)))))</span><br><span class="line">可以缩写为</span><br><span class="line">(.. '(1 2) getClass getProtectionDomain getCodeSource getLocation)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Tips: Eclipse 中可以使用ctrl+H 进行整个项目的搜索,非常实用的功能；</p>
</li>
<li><p>Twitter Storm源代码分析之TimeCacheMap – 见另一篇笔记；</p>
</li>
<li><p>inimbus是一个接口, 主要实现方法为:查询调用可用slot, 分配slots, 获取supervisor的节点id, 获取调度器；</p>
</li>
<li><p>clojure cond宏: 接受一系列 test/expression 对， 它每次对一个 test 进行求值， 如果某个 test 返回 true ， 那么 cond 求值并返回与这个 test 相对应的expression ， 并且不再对其他 test 进行求值。如:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    (defn type-of-number [n]</span><br><span class="line">               (cond (&gt; n 0) "positive number"</span><br><span class="line">                     (&lt; n 0) "negative number"</span><br><span class="line">                     :else "zero"))</span><br><span class="line">    ``` </span><br><span class="line">18. storm中使用到的语法符号-&gt;: </span><br><span class="line">-&gt;, (-&gt; x form &amp; more)</span><br><span class="line">线性化嵌套, 使其更具有可读性,  Inserts x as the second item in the first form ； 从下面的例子可以看出, 就是把第一个参数(x)作为最初的输入, 调用第二个参数(代表的fn), 然后拿返回值调用后续函数；和..用处差不多, 但..只能用于java调用；</span><br><span class="line">    ```clojure</span><br><span class="line">    (first (.split (.replace (.toUpperCase "a b c d") "A" "X") " "))</span><br><span class="line">    可以改写为:</span><br><span class="line">    (-&gt; "a b c d" </span><br><span class="line">    .toUpperCase </span><br><span class="line">    (.replace "A" "X") </span><br><span class="line">    (.split " ") </span><br><span class="line">    first)</span><br></pre></td></tr></table></figure>
</li>
<li><p>nimbus data 数据结构: 见nimbus.clj文件, 主要包括</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">    (defn nimbus-data [conf inimbus]</span><br><span class="line">        (let [forced-scheduler (.getForcedScheduler inimbus)]</span><br><span class="line">        &#123;:conf conf </span><br><span class="line">         :nimbus-host-port-info (NimbusInfo/fromConf conf)</span><br><span class="line">         :inimbus inimbus</span><br><span class="line">         :authorization-handler (mk-authorization-handler (conf NIMBUS-AUTHORIZER) conf)</span><br><span class="line">         :impersonation-authorization-handler (mk-authorization-handler (conf NIMBUS-IMPERSONATION-AUTHORIZER) conf)</span><br><span class="line">         :submitted-count (atom 0)</span><br><span class="line">         :storm-cluster-state (cluster/mk-storm-cluster-state conf :acls (when (Utils/isZkAuthenticationConfiguredStormServer conf) NIMBUS-ZK-ACLS))</span><br><span class="line">         :submit-lock (Object.)</span><br><span class="line">         :cred-update-lock (Object.)</span><br><span class="line">         :log-update-lock (Object.)</span><br><span class="line">         :heartbeats-cache (atom &#123;&#125;)</span><br><span class="line">         :downloaders (file-cache-map conf)</span><br><span class="line">         :uploaders (file-cache-map conf)</span><br><span class="line">         :uptime (uptime-computer)</span><br><span class="line">         :validator (new-instance (conf NIMBUS-TOPOLOGY-VALIDATOR))</span><br><span class="line">         :timer (mk-timer :kill-fn (fn [t]</span><br><span class="line">                                     (log-error t "Error when processing event")</span><br><span class="line">                                     (exit-process! 20 "Error when processing an event")</span><br><span class="line">                                     ))</span><br><span class="line">         :scheduler (mk-scheduler conf inimbus)</span><br><span class="line">         :leader-elector (zk-leader-elector conf)</span><br><span class="line">         :code-distributor (mk-code-distributor conf)</span><br><span class="line">         :id-&gt;sched-status (atom &#123;&#125;)</span><br><span class="line">         :cred-renewers (AuthUtils/GetCredentialRenewers conf)</span><br><span class="line">         :nimbus-autocred-plugins (AuthUtils/getNimbusAutoCredPlugins conf)</span><br><span class="line">         &#125;))</span><br><span class="line">    ``` </span><br><span class="line">20. **org.apache.commons.io.FileUtils** : forceMkdir方法: </span><br><span class="line">    public static void forceMkdir(File directory)</span><br><span class="line">                           throws IOException</span><br><span class="line">Makes a directory, including any necessary but nonexistent parent directories. If a file already exists with specified name but it is not a directory then an IOException is thrown. If the directory cannot be created (or does not already exist) then an IOException is thrown.</span><br><span class="line"></span><br><span class="line">21. **doseq** :  Repeatedly executes body (presumably for side-effects) with bindings and filtering as provided by "for". Does not retain the head of the sequence. Returns nil.</span><br><span class="line"></span><br><span class="line">22. clojure 中**symbol** :  Returns a Symbol with the given namespace and name. </span><br><span class="line"></span><br><span class="line">23. 宏 **defmulti** 和 **defmethod** 经常被用在一起来定义 multimethod. 宏 defmulti 的参数包括一个方法名以及一个 dispatch 函数,这个 dispatch 函数的返回值会被用来到底调用哪个重载的函数。宏 defmethod 的参数则包括方法名, dispatch 的值, 参数列表以及方法体。一个特殊的 dispatch 值 :default 是用来表示默认情况的 — 即如果其它的 dispatch 值都不匹配的话,那么就调用这个方法。 defmethod 多定义的名字一样的方法,它们的参数个数必须一样。传给multimethod 的参数会传给 dipatch 函数的。</span><br><span class="line"></span><br><span class="line">24. **-&gt;&gt; , (-&gt;&gt; x form &amp; more)**</span><br><span class="line">Inserts x as the last item in the first form 和-&gt;的差别在于x插入的位置不同, -&gt;是插入在第二个item, 即紧跟在函数名后面, 而-&gt;&gt;是插在最后一个item; </span><br><span class="line">    ```clojure</span><br><span class="line">    user=&gt; (-&gt;&gt; (range)</span><br><span class="line">                (map #(* % %))</span><br><span class="line">                (filter even?)</span><br><span class="line">                (take 10)</span><br><span class="line">                (reduce +))</span><br><span class="line">    等价于:</span><br><span class="line">    user=&gt; (reduce +</span><br><span class="line">           (take 10</span><br><span class="line">           (filter even?</span><br><span class="line">           (map #(* % %)</span><br><span class="line">           (range)))))</span><br></pre></td></tr></table></figure>
</li>
<li><p>backtype.storm.<strong>config</strong>.clj 文件中主要实现功能:  对conf参数内容进行提取,  backtype.storm.Config.java文件中定义了所有的storm可配置参数,同时定义serilization register；</p>
</li>
<li><p>Clojure 语法 : <strong>with-meta</strong>  (with-meta obj m)    Returns an object of the same type and value as obj, with  map m as its metadata.</p>
</li>
<li><p><strong>into, (into to from)</strong><br>把from join到to, 可以看到底下对于list, vector, set, 加完的顺序是不同的, 刚开始有些疑惑, 其实Into, 只是依次从from中把item读出, 并append到to里面, 最终的顺序不同因为数据结构对append的处理不同；</p>
</li>
<li><p><strong>‘() 是List, 类似于java里面的LinkedList, [] 是vector, #{} 可以定义set, {} 里面可以定义set；</strong></p>
</li>
<li><p><strong>merge</strong>, (merge &amp; maps) : 把多个map merge在一起, 如果有一样的key则latter优先原则, 后出现的优先;</p>
</li>
<li><p><strong>LocalState</strong> 定义了一个轻量级, 可持久化的KV 数据库, 它的效率不高,每次读写都要进行磁盘操作, 所以他一般只能用于读写次数不多的场景;</p>
</li>
<li><p>fn 定义匿名函数;</p>
</li>
<li><p>cluster.clj 文件中 <strong>ClusterState</strong>协议 定义了一系列用于对Zookeeper进行操作的方法; </p>
</li>
<li><p><strong>defprotocol</strong>: protocol是clojure中的接口; 需要注意的是，protocol里所有方法的第一个参数都是self/this参数（类似python），从第二个开始才是调用时传入的参数。</p>
</li>
<li><p>cluster.clj 文件中 <strong>mk-distributed-cluster-state</strong> 函数返回一个实现了ClusterState协议的对象, 该对象的基本方法都是使用zookeeper.clj文件中定义的方法实现的; </p>
</li>
<li><p>cluster.clj 文件中 <strong>StormClusterState</strong>协议, 主要定义了与storm相关的zookeeper操作, 包括读取topology中的任务分配, 向zookeeper中发送心跳信息等;</p>
</li>
<li><p>cluster.clj 文件中 <strong>mk-storm-cluster-state</strong> 函数返回一个实现了StormClusterState协议的对象;</p>
</li>
<li><p><strong>cluster.clj</strong>文件中主要定义了两个协议,并定义两个函数分别返回实现了该协议的对象;</p>
</li>
<li><p><strong>register</strong> : </p>
</li>
<li><p><strong>defrecord</strong> : </p>
</li>
<li><p><strong>SupervisorInfo</strong> 在common.clj文件中定义； converter.clj 文件中定义了SupevisorInfo的使用, 即在Thrift中的传输;</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defrecord</span></span> SupervisorInfo [time-secs hostname assignment-id used-ports meta scheduler-meta uptime-secs version])</span><br></pre></td></tr></table></figure>
</li>
<li><p>common.clj文件中定义了StormBase, 其中定义了Topology的基本信息; </p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defrecord</span></span> StormBase [storm-name launch-time-secs status num-workers component-&gt;executors owner topology-action-options prev-status])</span><br><span class="line"><span class="comment">;;component-&gt;executors 保存了&lt;component-id , parallelism&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>common.clj文件中定义了Assignment, 其中定义当前topology的任务分配情况; </p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defrecord</span></span> Assignment [master-code-dir node-&gt;host executor-&gt;node+port executor-&gt;start-time-secs])</span><br><span class="line"><span class="comment">;; master-code-dir 为nimbus在本地保存该topology信息的路径, 包括stormjar  stormcode   stormconf</span></span><br><span class="line"><span class="comment">;; node-&gt;host 定义了该Topology被分配到的&lt;supervisor-id, hostname&gt;</span></span><br><span class="line"><span class="comment">;; executor-&gt;node+port 定义了该topology中executor的分配情况, node对应于supervisor-id, port是supervisor的一个端口;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Clojure的函数后面加个<strong>感叹号</strong>的意思: 跟下划线一样是普通的组词字符，定义的时候想加就加, 在coding风格上提倡用这个形式来表示函数有明显<strong>副作用</strong>， 但是这只是风格上的提倡，在语义层面没有强制; 参考: <a href="http://dev.clojure.org/display/community/Library+Coding+Standards" target="_blank" rel="external">http://dev.clojure.org/display/community/Library+Coding+Standards</a></p>
</li>
<li><p>storm.<strong>thrift</strong> 是按照Thrift语法编写的RPC  接口文件, 其中定义了service Nimbus的所有注册服务; 由于storm运行在jvm上, 前面定义的结构需要使用thrift转换为对应的java代码； 即 backtype.storm.generated.Nimbus.<strong>Iface</strong>接口;</p>
</li>
<li><p>nimbus中定义的数据结构主要有两大类: <strong>java</strong>定义的数据结构和<strong>Clojure</strong>定义的数据结构; java定义的数据结构主要用于<strong>任务分配</strong>, 而Clojure定义的数据结构主要来充当一些<strong>Storm的元数据</strong>; java定义的数据结构主要封装在backtype.storm.<strong>scheduler</strong>包中；</p>
</li>
<li><p>nimbus文件中定义mk-assignments函数, 主要功能为负责对当前集群中的所有topology进行新一轮的任务调度, 一方面会检查已运行的topology所占用的资源, 是否需要重新分配; 另一方面会根据当前系统中的可用资源, 为新提交的topology分配任务;</p>
</li>
<li><p>log.clj 文件中定义了所有级别的log message 宏; </p>
</li>
<li><p>Clojure apply:  Applies fn f to the argument list formed by prepending intervening arguments to args. </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(apply f args)</span><br><span class="line">(apply f x args)</span><br><span class="line">(apply f x y args)</span><br><span class="line">(apply f x y z args)</span><br><span class="line">(apply f a b c d &amp; args) </span><br><span class="line">示例 : (apply str ["str1" "str2" "str3"]) ;;=&gt; "str1str2str3</span><br></pre></td></tr></table></figure>
</li>
<li><p>do-cleanup函数功能</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; cleanup-storm-ids 函数判断出哪些topology需要清理, </span></span><br><span class="line"><span class="comment">;; 然后对需要清理的topology进行相应的操作;</span></span><br><span class="line"><span class="comment">;; 操作包括: 删除zookeeper中心跳和错误信息, </span></span><br><span class="line"><span class="comment">;; 然后尝试清除nimbus本地目录中的相关文件</span></span><br><span class="line"><span class="comment">;; 并从nimbus心跳缓存中移除对应的信息</span></span><br><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> do-cleanup [nimbus]</span><br><span class="line">(<span class="name"><span class="builtin-name">let</span></span> [storm-cluster-state (<span class="symbol">:storm-cluster-state</span> nimbus)</span><br><span class="line">conf (<span class="symbol">:conf</span> nimbus)</span><br><span class="line">submit-lock (<span class="symbol">:submit-lock</span> nimbus)]</span><br><span class="line">(<span class="name"><span class="builtin-name">let</span></span> [to-cleanup-ids (<span class="name"><span class="builtin-name">locking</span></span> submit-lock</span><br><span class="line">(<span class="name">cleanup-storm-ids</span> conf storm-cluster-state))]</span><br><span class="line">(<span class="name"><span class="builtin-name">when-not</span></span> (<span class="name"><span class="builtin-name">empty?</span></span> to-cleanup-ids)</span><br><span class="line">(<span class="name"><span class="builtin-name">doseq</span></span> [id to-cleanup-ids]</span><br><span class="line">(<span class="name">log-message</span> <span class="string">"Cleaning up "</span> id)</span><br><span class="line">(<span class="name">.teardown-heartbeats!</span> storm-cluster-state id)</span><br><span class="line">(<span class="name">.teardown-topology-errors!</span> storm-cluster-state id)</span><br><span class="line">(<span class="name">rmr</span> (<span class="name">master-stormdist-root</span> conf id))</span><br><span class="line">(<span class="name"><span class="builtin-name">swap!</span></span> (<span class="symbol">:heartbeats-cache</span> nimbus) dissoc id))</span><br><span class="line">))))</span><br></pre></td></tr></table></figure>
</li>
<li><p>clean-inbox函数功能</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; 该方法负责清理nimbus的inbox文件夹</span></span><br><span class="line"><span class="comment">;; 清理的条件是文件夹中的jar包从最后一次被修改到当前时间间隔超过了seconds</span></span><br><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> clean-inbox [dir-location seconds]</span><br><span class="line"><span class="string">"Deletes jar files in dir older than seconds."</span></span><br><span class="line">(<span class="name"><span class="builtin-name">let</span></span> [now (<span class="name">current-time-secs</span>)</span><br><span class="line">pred #(<span class="name"><span class="builtin-name">and</span></span> (<span class="name">.isFile</span> %) (<span class="name">file-older-than?</span> now seconds %))</span><br><span class="line">files (<span class="name"><span class="builtin-name">filter</span></span> pred (<span class="name">file-seq</span> (<span class="name">File.</span> dir-location)))]</span><br><span class="line">(<span class="name"><span class="builtin-name">doseq</span></span> [f files]</span><br><span class="line">(<span class="name"><span class="builtin-name">if</span></span> (<span class="name">.delete</span> f)</span><br><span class="line">(<span class="name">log-message</span> <span class="string">"Cleaning inbox ... deleted: "</span> (<span class="name">.getName</span> f))</span><br><span class="line"><span class="comment">;; This should never happen</span></span><br><span class="line">(<span class="name">log-error</span> <span class="string">"Cleaning inbox ... error deleting: "</span> (<span class="name">.getName</span> f))</span><br><span class="line">))))</span><br></pre></td></tr></table></figure>
</li>
<li><p>nimbus.clj文件中 <strong>transition-name!</strong>函数</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; 该方法根据topology-name对应的转移事件,完成topology的状态转换,</span></span><br><span class="line"><span class="comment">;; 将基于storm-name的状态转换为基于storm-id的状态</span></span><br><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> transition-name! [nimbus storm-name event &amp; args]</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> [storm-id (<span class="name">get-storm-id</span> (<span class="symbol">:storm-cluster-state</span> nimbus) storm-name)]</span><br><span class="line">    (<span class="name"><span class="builtin-name">when-not</span></span> storm-id</span><br><span class="line">      (<span class="name"><span class="builtin-name">throw</span></span> (<span class="name">NotAliveException.</span> storm-name)))</span><br><span class="line">    (<span class="name"><span class="builtin-name">apply</span></span> transition! nimbus storm-id event args)))</span><br></pre></td></tr></table></figure>
</li>
<li><p>nimbus.clj文件中<strong>transition!</strong> 方法</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; transition! 方法会根据传入的转移事件, </span></span><br><span class="line"><span class="comment">;; 获取与当前的Topology状态对应的状态转移函数,并执行该函数获取转换后的新状态</span></span><br><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> transition!</span><br><span class="line">  ([nimbus storm-id event]</span><br><span class="line">     (<span class="name">transition!</span> nimbus storm-id event <span class="literal">false</span>))</span><br><span class="line">  ([nimbus storm-id event error-on-no-transition?]</span><br><span class="line">     (<span class="name"><span class="builtin-name">locking</span></span> (<span class="symbol">:submit-lock</span> nimbus)</span><br><span class="line">       (<span class="name"><span class="builtin-name">let</span></span> [system-events #&#123;<span class="symbol">:startup</span>&#125;</span><br><span class="line">             [event &amp; event-args] (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">keyword?</span></span> event) [event] event)</span><br><span class="line">             storm-base (<span class="name"><span class="builtin-name">-&gt;</span></span> nimbus <span class="symbol">:storm-cluster-state</span>  (<span class="name">.storm-base</span> storm-id <span class="literal">nil</span>))</span><br><span class="line">             status (<span class="symbol">:status</span> storm-base)]</span><br><span class="line">         <span class="comment">;; handles the case where event was scheduled but topology has been removed</span></span><br><span class="line">         (<span class="name"><span class="builtin-name">if-not</span></span> status</span><br><span class="line">           (<span class="name">log-message</span> <span class="string">"Cannot apply event "</span> event <span class="string">" to "</span> storm-id <span class="string">" because topology no longer exists"</span>)</span><br><span class="line">           (<span class="name"><span class="builtin-name">let</span></span> [get-event (<span class="name"><span class="builtin-name">fn</span></span> [m e]</span><br><span class="line">                             (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">contains?</span></span> m e)</span><br><span class="line">                               (<span class="name">m</span> e)</span><br><span class="line">                               (<span class="name"><span class="builtin-name">let</span></span> [msg (<span class="name"><span class="builtin-name">str</span></span> <span class="string">"No transition for event: "</span> event</span><br><span class="line">                                              <span class="string">", status: "</span> status,</span><br><span class="line">                                              <span class="string">" storm-id: "</span> storm-id)]</span><br><span class="line">                                 (<span class="name"><span class="builtin-name">if</span></span> error-on-no-transition?</span><br><span class="line">                                   (<span class="name">throw-runtime</span> msg)</span><br><span class="line">                                   (<span class="name"><span class="builtin-name">do</span></span> (<span class="name"><span class="builtin-name">when-not</span></span> (<span class="name"><span class="builtin-name">contains?</span></span> system-events event)</span><br><span class="line">                                         (<span class="name">log-message</span> msg))</span><br><span class="line">                                       <span class="literal">nil</span>))</span><br><span class="line">                                 )))</span><br><span class="line">                 transition (<span class="name"><span class="builtin-name">-&gt;</span></span> (<span class="name">state-transitions</span> nimbus storm-id status storm-base)</span><br><span class="line">                                (<span class="name"><span class="builtin-name">get</span></span> (<span class="symbol">:type</span> status))</span><br><span class="line">                                (<span class="name">get-event</span> event))</span><br><span class="line">                 transition (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">or</span></span> (<span class="name"><span class="builtin-name">nil?</span></span> transition)</span><br><span class="line">                                    (<span class="name"><span class="builtin-name">keyword?</span></span> transition))</span><br><span class="line">                              (<span class="name"><span class="builtin-name">fn</span></span> [] transition)</span><br><span class="line">                              transition)</span><br><span class="line">                 storm-base-updates (<span class="name"><span class="builtin-name">apply</span></span> transition event-args)</span><br><span class="line">                 storm-base-updates (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">keyword?</span></span> storm-base-updates) <span class="comment">;if it's just a symbol, that just indicates new status.</span></span><br><span class="line">                                      &#123;<span class="symbol">:status</span> &#123;<span class="symbol">:type</span> storm-base-updates&#125;&#125;</span><br><span class="line">                                      storm-base-updates)]</span><br><span class="line"></span><br><span class="line">             (<span class="name"><span class="builtin-name">when</span></span> storm-base-updates</span><br><span class="line">               (<span class="name">.update-storm!</span> (<span class="symbol">:storm-cluster-state</span> nimbus) storm-id storm-base-updates)))))</span><br><span class="line">       )))</span><br></pre></td></tr></table></figure>
</li>
<li><p>nimbus.clj文件中<strong>kill-transition</strong> 方法</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; 函数功能: delay kill-time后 kill 掉topology</span></span><br><span class="line"><span class="comment">;; 在kill状态下执行remove转移事件</span></span><br><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> kill-transition [nimbus storm-id]</span><br><span class="line">  (<span class="name"><span class="builtin-name">fn</span></span> [kill-time]</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> [delay (<span class="name"><span class="builtin-name">if</span></span> kill-time</span><br><span class="line">                  kill-time</span><br><span class="line">                  (<span class="name"><span class="builtin-name">get</span></span> (<span class="name">read-storm-conf</span> (<span class="symbol">:conf</span> nimbus) storm-id)</span><br><span class="line">                       TOPOLOGY-MESSAGE-TIMEOUT-SECS))]</span><br><span class="line">      (<span class="name">delay-event</span> nimbus</span><br><span class="line">                   storm-id</span><br><span class="line">                   delay</span><br><span class="line">                   <span class="symbol">:remove</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="symbol">:status</span> &#123;<span class="symbol">:type</span> <span class="symbol">:killed</span>&#125;</span><br><span class="line">        <span class="symbol">:topology-action-options</span> &#123;<span class="symbol">:delay-secs</span> delay <span class="symbol">:action</span> <span class="symbol">:kill</span>&#125;&#125;)</span><br><span class="line">    ))</span><br></pre></td></tr></table></figure>
</li>
<li><p>nimbus.clj文件中<strong>rebalance-transition</strong> 方法</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; 函数功能: delay time后 rebalance topology</span></span><br><span class="line"><span class="comment">;; 返回的执行结果中topology状态被更新为rebalancing</span></span><br><span class="line"><span class="comment">;; 等到计时器线程中do-rebalance转移事件执行完毕, 真正的rebalance才完成</span></span><br><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> rebalance-transition [nimbus storm-id status]</span><br><span class="line">  (<span class="name"><span class="builtin-name">fn</span></span> [time num-workers executor-overrides]</span><br><span class="line">    (<span class="name"><span class="builtin-name">let</span></span> [delay (<span class="name"><span class="builtin-name">if</span></span> time</span><br><span class="line">                  time</span><br><span class="line">                  (<span class="name"><span class="builtin-name">get</span></span> (<span class="name">read-storm-conf</span> (<span class="symbol">:conf</span> nimbus) storm-id)</span><br><span class="line">                       TOPOLOGY-MESSAGE-TIMEOUT-SECS))]</span><br><span class="line">      (<span class="name">delay-event</span> nimbus</span><br><span class="line">                   storm-id</span><br><span class="line">                   delay</span><br><span class="line">                   <span class="symbol">:do-rebalance</span>)</span><br><span class="line">      &#123;<span class="symbol">:status</span> &#123;<span class="symbol">:type</span> <span class="symbol">:rebalancing</span>&#125; </span><br><span class="line">       <span class="symbol">:prev-status</span> status</span><br><span class="line">       <span class="symbol">:topology-action-options</span> (<span class="name"><span class="builtin-name">-&gt;</span></span> &#123;<span class="symbol">:delay-secs</span> delay <span class="symbol">:action</span> <span class="symbol">:rebalance</span>&#125;</span><br><span class="line">                                  (<span class="name">assoc-non-nil</span> <span class="symbol">:num-workers</span> num-workers)</span><br><span class="line">                                  (<span class="name">assoc-non-nil</span> <span class="symbol">:component-&gt;executors</span> executor-overrides))</span><br><span class="line">       &#125;)))</span><br></pre></td></tr></table></figure>
</li>
<li><p>nimbus.clj文件中<strong>state-transitions</strong> 方法</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; 该函数定义了一个状态转移矩阵, key的集合包括active, inactive, killed, rebalancing</span></span><br><span class="line"><span class="comment">;; 对应的value表示了处于由key指定的状态时, </span></span><br><span class="line"><span class="comment">;; 其状态变化需要遵循的从转移事件到对应状态的转移函数的集合</span></span><br><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> state-transitions [nimbus storm-id status storm-base]</span><br><span class="line">  &#123;<span class="symbol">:active</span> &#123;<span class="symbol">:inactivate</span> <span class="symbol">:inactive</span></span><br><span class="line">            <span class="symbol">:activate</span> <span class="literal">nil</span></span><br><span class="line">            <span class="symbol">:rebalance</span> (<span class="name">rebalance-transition</span> nimbus storm-id status)</span><br><span class="line">            <span class="symbol">:kill</span> (<span class="name">kill-transition</span> nimbus storm-id)</span><br><span class="line">            &#125;</span><br><span class="line">   <span class="symbol">:inactive</span> &#123;<span class="symbol">:activate</span> <span class="symbol">:active</span></span><br><span class="line">              <span class="symbol">:inactivate</span> <span class="literal">nil</span></span><br><span class="line">              <span class="symbol">:rebalance</span> (<span class="name">rebalance-transition</span> nimbus storm-id status)</span><br><span class="line">              <span class="symbol">:kill</span> (<span class="name">kill-transition</span> nimbus storm-id)</span><br><span class="line">              &#125;</span><br><span class="line">   <span class="symbol">:killed</span> &#123;<span class="symbol">:startup</span> (<span class="name"><span class="builtin-name">fn</span></span> [] (<span class="name">delay-event</span> nimbus</span><br><span class="line">                                         storm-id</span><br><span class="line">                                         (<span class="name"><span class="builtin-name">-&gt;</span></span> storm-base</span><br><span class="line">                                             <span class="symbol">:topology-action-options</span></span><br><span class="line">                                             <span class="symbol">:delay-secs</span>)</span><br><span class="line">                                         <span class="symbol">:remove</span>)</span><br><span class="line">                             <span class="literal">nil</span>)</span><br><span class="line">            <span class="symbol">:kill</span> (<span class="name">kill-transition</span> nimbus storm-id)</span><br><span class="line">            <span class="symbol">:remove</span> (<span class="name"><span class="builtin-name">fn</span></span> []</span><br><span class="line">                      (<span class="name">log-message</span> <span class="string">"Killing topology: "</span> storm-id)</span><br><span class="line">                      (<span class="name">.remove-storm!</span> (<span class="symbol">:storm-cluster-state</span> nimbus)</span><br><span class="line">                                      storm-id)</span><br><span class="line">                      <span class="literal">nil</span>)</span><br><span class="line">            &#125;</span><br><span class="line">   <span class="symbol">:rebalancing</span> &#123;<span class="symbol">:startup</span> (<span class="name"><span class="builtin-name">fn</span></span> [] (<span class="name">delay-event</span> nimbus</span><br><span class="line">                                              storm-id</span><br><span class="line">                                              (<span class="name"><span class="builtin-name">-&gt;</span></span> storm-base</span><br><span class="line">                                                  <span class="symbol">:topology-action-options</span></span><br><span class="line">                                                  <span class="symbol">:delay-secs</span>)</span><br><span class="line">                                              <span class="symbol">:do-rebalance</span>)</span><br><span class="line">                                 <span class="literal">nil</span>)</span><br><span class="line">                 <span class="symbol">:kill</span> (<span class="name">kill-transition</span> nimbus storm-id)</span><br><span class="line">                 <span class="symbol">:do-rebalance</span> (<span class="name"><span class="builtin-name">fn</span></span> []</span><br><span class="line">                                 (<span class="name">do-rebalance</span> nimbus storm-id status storm-base)</span><br><span class="line">                                 (<span class="symbol">:type</span> (<span class="symbol">:prev-status</span> storm-base)))</span><br><span class="line">                 &#125;&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>nimbus.clj文件中<strong>compute-new-topology-&gt;executor-&gt;node+port</strong>方法</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; public so it can be mocked out</span></span><br><span class="line"><span class="comment">;; 该方法根据当前已经存在的分配情况, 结合系统当前的运行情况找出需要进行任务分配的Topology 集合</span></span><br><span class="line"><span class="comment">;; 并为他们分配任务, 计算出这一轮分配完之后的每个Topology对应的任务分配情况</span></span><br><span class="line"><span class="comment">;;  scratch-topology-id 是需要重新进行分配操作的topology id</span></span><br><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> compute-new-topology-&gt;executor-&gt;node+port [nimbus existing-assignments topologies scratch-topology-id]</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> [conf (<span class="symbol">:conf</span> nimbus)</span><br><span class="line">        storm-cluster-state (<span class="symbol">:storm-cluster-state</span> nimbus)</span><br><span class="line">        topology-&gt;executors (<span class="name">compute-topology-&gt;executors</span> nimbus (<span class="name"><span class="builtin-name">keys</span></span> existing-assignments))</span><br><span class="line">        <span class="comment">;; update the executors heartbeats first.</span></span><br><span class="line">        _ (<span class="name">update-all-heartbeats!</span> nimbus existing-assignments topology-&gt;executors)</span><br><span class="line">        topology-&gt;alive-executors (<span class="name">compute-topology-&gt;alive-executors</span> nimbus</span><br><span class="line">                                                                     existing-assignments</span><br><span class="line">                                                                     topologies</span><br><span class="line">                                                                     topology-&gt;executors</span><br><span class="line">                                                                     scratch-topology-id)</span><br><span class="line">        supervisor-&gt;dead-ports (<span class="name">compute-supervisor-&gt;dead-ports</span> nimbus</span><br><span class="line">                                                               existing-assignments</span><br><span class="line">                                                               topology-&gt;executors</span><br><span class="line">                                                               topology-&gt;alive-executors)</span><br><span class="line">        topology-&gt;scheduler-assignment (<span class="name">compute-topology-&gt;scheduler-assignment</span> nimbus</span><br><span class="line">                                                                               existing-assignments</span><br><span class="line">                                                                               topology-&gt;alive-executors)</span><br><span class="line"></span><br><span class="line">        <span class="comment">;; 过滤条件: 该Topology的所有Executor为空, 或者该Topology的所有Executors不等于该Topolgy</span></span><br><span class="line">       <span class="comment">;; 的alive executors, 或者该Topology的num-used-worker 数目小雨指定的num workers</span></span><br><span class="line">        missing-assignment-topologies (<span class="name"><span class="builtin-name">-&gt;&gt;</span></span> topologies</span><br><span class="line">                                           .getTopologies    <span class="comment">;; Collection&lt;TopologyDetails&gt;</span></span><br><span class="line">                                           (<span class="name"><span class="builtin-name">map</span></span> (<span class="name"><span class="builtin-name">memfn</span></span> getId))</span><br><span class="line">                                           (<span class="name"><span class="builtin-name">filter</span></span> (<span class="name"><span class="builtin-name">fn</span></span> [t]</span><br><span class="line">                                                      (<span class="name"><span class="builtin-name">let</span></span> [alle (<span class="name"><span class="builtin-name">get</span></span> topology-&gt;executors t)</span><br><span class="line">                                                            alivee (<span class="name"><span class="builtin-name">get</span></span> topology-&gt;alive-executors t)]</span><br><span class="line">                                                            (<span class="name"><span class="builtin-name">or</span></span> (<span class="name"><span class="builtin-name">empty?</span></span> alle)</span><br><span class="line">                                                                (<span class="name"><span class="builtin-name">not=</span></span> alle alivee)</span><br><span class="line">                                                                (<span class="name"><span class="builtin-name">&lt;</span></span> (<span class="name"><span class="builtin-name">-&gt;</span></span> topology-&gt;scheduler-assignment</span><br><span class="line">                                                                       (<span class="name"><span class="builtin-name">get</span></span> t)</span><br><span class="line">                                                                       num-used-workers )</span><br><span class="line">                                                                   (<span class="name"><span class="builtin-name">-&gt;</span></span> topologies (<span class="name">.getById</span> t) .getNumWorkers)</span><br><span class="line">                                                                   ))</span><br><span class="line">                                                            ))))</span><br><span class="line">        all-scheduling-slots (<span class="name"><span class="builtin-name">-&gt;&gt;</span></span> (<span class="name">all-scheduling-slots</span> nimbus topologies missing-assignment-topologies)</span><br><span class="line">                                  (<span class="name"><span class="builtin-name">map</span></span> (<span class="name"><span class="builtin-name">fn</span></span> [[node-id port]] &#123;node-id #&#123;port&#125;&#125;))</span><br><span class="line">                                  (<span class="name"><span class="builtin-name">apply</span></span> merge-with set/union))</span><br><span class="line"></span><br><span class="line">        supervisors (<span class="name">read-all-supervisor-details</span> nimbus all-scheduling-slots supervisor-&gt;dead-ports)</span><br><span class="line">        cluster (<span class="name">Cluster.</span> (<span class="symbol">:inimbus</span> nimbus) supervisors topology-&gt;scheduler-assignment)</span><br><span class="line"></span><br><span class="line">        <span class="comment">;; call scheduler.schedule to schedule all the topologies</span></span><br><span class="line">        <span class="comment">;; the new assignments for all the topologies are in the cluster object.</span></span><br><span class="line">        _ (<span class="name">.schedule</span> (<span class="symbol">:scheduler</span> nimbus) topologies cluster)</span><br><span class="line">        new-scheduler-assignments (<span class="name">.getAssignments</span> cluster)</span><br><span class="line">        <span class="comment">;; add more information to convert SchedulerAssignment to Assignment</span></span><br><span class="line">        new-topology-&gt;executor-&gt;node+port (<span class="name">compute-topology-&gt;executor-&gt;node+port</span> new-scheduler-assignments)]</span><br><span class="line">    (<span class="name"><span class="builtin-name">reset!</span></span> (<span class="symbol">:id-&gt;sched-status</span> nimbus) (<span class="name">.getStatusMap</span> cluster))</span><br><span class="line">    <span class="comment">;; print some useful information.</span></span><br><span class="line">    (<span class="name"><span class="builtin-name">doseq</span></span> [[topology-id executor-&gt;node+port] new-topology-&gt;executor-&gt;node+port</span><br><span class="line">            <span class="symbol">:let</span> [old-executor-&gt;node+port (<span class="name"><span class="builtin-name">-&gt;</span></span> topology-id</span><br><span class="line">                                          existing-assignments</span><br><span class="line">                                          <span class="symbol">:executor-&gt;node+port</span>)</span><br><span class="line">                  reassignment (<span class="name"><span class="builtin-name">filter</span></span> (<span class="name"><span class="builtin-name">fn</span></span> [[executor node+port]]</span><br><span class="line">                                         (<span class="name"><span class="builtin-name">and</span></span> (<span class="name"><span class="builtin-name">contains?</span></span> old-executor-&gt;node+port executor)</span><br><span class="line">                                              (<span class="name"><span class="builtin-name">not</span></span> (<span class="name"><span class="builtin-name">=</span></span> node+port (<span class="name">old-executor-&gt;node+port</span> executor)))))</span><br><span class="line">                                       executor-&gt;node+port)]]</span><br><span class="line">      (<span class="name"><span class="builtin-name">when-not</span></span> (<span class="name"><span class="builtin-name">empty?</span></span> reassignment)</span><br><span class="line">        (<span class="name"><span class="builtin-name">let</span></span> [new-slots-cnt (<span class="name"><span class="builtin-name">count</span></span> (<span class="name">set</span> (<span class="name"><span class="builtin-name">vals</span></span> executor-&gt;node+port)))</span><br><span class="line">              reassign-executors (<span class="name"><span class="builtin-name">keys</span></span> reassignment)]</span><br><span class="line">          (<span class="name">log-message</span> <span class="string">"Reassigning "</span> topology-id <span class="string">" to "</span> new-slots-cnt <span class="string">" slots"</span>)</span><br><span class="line">          (<span class="name">log-message</span> <span class="string">"Reassign executors: "</span> (<span class="name"><span class="builtin-name">vec</span></span> reassign-executors)))))</span><br><span class="line"></span><br><span class="line">    new-topology-&gt;executor-&gt;node+port))</span><br></pre></td></tr></table></figure>
</li>
<li><p>Clojure 中 <strong>mapcat</strong>方法:  Returns the result of applying concat to the result of applying map to f and colls.  Thus function f should return a collection. Returns a transducer when no collections are provided. </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">user=&gt; (mapcat (fn [[k v]] </span><br><span class="line">                 (for [[k2 v2] v] </span><br><span class="line">                   (concat [k k2] v2)))</span><br><span class="line">         '&#123;:a &#123;:x (1 2) :y (3 4)&#125;</span><br><span class="line">           :b &#123;:x (1 2) :z (5 6)&#125;&#125;)</span><br><span class="line"></span><br><span class="line">((:a :x 1 2) (:a :y 3 4) (:b :x 1 2) (:b :z 5 6))</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>if-let</strong> :  对let添加if判断, 如下面的例子, 如果nums非false或nil, 则执行累加, 否则表示list中没有偶数打印”No even numbers found.” 适用于对于不同的let结果的不同处理. </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">user=&gt; (defn sum-even-numbers [nums]</span><br><span class="line">         (if-let [nums (seq (filter even? nums))]</span><br><span class="line">           (reduce + nums)</span><br><span class="line">           "No even numbers found."))</span><br><span class="line">user=&gt; (sum-even-numbers [1 3 5 7 9])</span><br><span class="line">"No even numbers found."</span><br><span class="line">user=&gt; (sum-even-numbers [1 3 5 7 9 10 12])</span><br><span class="line">22</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>when-let</strong> :  when-let, 一样的理论, 当let赋值非false或nil时, 执行相应逻辑, 否则返回nil </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(defn drop-one</span><br><span class="line">  [coll]</span><br><span class="line">  (when-let [s (seq coll)]</span><br><span class="line">    (rest s)))</span><br><span class="line">user=&gt; (drop-one [1 2 3])</span><br><span class="line">(2 3)</span><br><span class="line">user=&gt; (drop-one [])</span><br><span class="line">nil</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>nimbus 本地工作目录结构</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- workdir</span><br><span class="line">	- nimbus</span><br><span class="line">		- inbox</span><br><span class="line">		- stormdist</span><br><span class="line">			- topology id命名的文件夹</span><br><span class="line">				- **stormcode.ser** ( backtype.storm.generated包中StormTopology对象序列化)</span><br><span class="line">				- **stormconf.ser**  (topology conf 代码序列化)</span><br><span class="line">				- **stormjar.jar**     (用户提交的jar包)</span><br><span class="line">	- supervisor</span><br><span class="line">		- isupervisor</span><br><span class="line">		- localstate</span><br><span class="line">		- tmp</span><br></pre></td></tr></table></figure>
</li>
<li><p>TopologyDetails 对象中的数据结构</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopologyDetails</span> </span>&#123;</span><br><span class="line">    String topologyId;</span><br><span class="line">    Map topologyConf;</span><br><span class="line">    StormTopology topology;</span><br><span class="line">    Map&lt;ExecutorDetails, String&gt; executorToComponent;</span><br><span class="line">    <span class="keyword">int</span> numWorkers;</span><br><span class="line"> ......</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ExcutorDetails</strong> 对象记录了每个Executor所对应的startTask和endTask, 这样定义是为了保证Storm在计算Executor时, 每个Executor都是一个连续的任务集合；</p>
</li>
<li><p>Clojure 中 <strong>swap!</strong> 宏的作用:<br><strong>(swap! atom f)    (swap! atom f x)    (swap! atom f x y)     (swap! atom f x y &amp; args)</strong><br>Atomically swaps the value of atom to be:<br>(apply f current-value-of-atom args). Note that f may be called<br>multiple times, and thus should be free of side effects.  Returns<br>the value that was swapped in.<br>swap! 将函数f作用于当前状态值和额外的参数args之上，形成新的状态值</p>
</li>
<li><p><strong>SchedulerAssignment</strong> 是一个接口, <strong>SchedulerAssignmentImpl</strong>是对这个接口的实现；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SchedulerAssignment</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Does this slot occupied by this assignment?</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSlotOccupied</span><span class="params">(WorkerSlot slot)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//is the executor assigned?</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExecutorAssigned</span><span class="params">(ExecutorDetails executor)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// get the topology-id this assignment is for.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTopologyId</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//get the executor -&gt; slot map.</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Map&lt;ExecutorDetails, WorkerSlot&gt; <span class="title">getExecutorToSlot</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return the executors covered by this assignments</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;ExecutorDetails&gt; <span class="title">getExecutors</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;WorkerSlot&gt; <span class="title">getSlots</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> backtype.storm.scheduler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">//<span class="doctag">TODO:</span> improve this by maintaining slot -&gt; executors as well for more efficient operations</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SchedulerAssignmentImpl</span> <span class="keyword">implements</span> <span class="title">SchedulerAssignment</span> </span>&#123;</span><br><span class="line">    <span class="comment">//topology-id this assignment is for.</span></span><br><span class="line">    String topologyId;</span><br><span class="line">    <span class="comment">// assignment detail, a mapping from executor to WorkerSlot</span></span><br><span class="line">    Map&lt;ExecutorDetails, WorkerSlot&gt; executorToSlot;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SchedulerAssignmentImpl</span><span class="params">(String topologyId, Map&lt;ExecutorDetails, WorkerSlot&gt; executorToSlots)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.topologyId = topologyId;</span><br><span class="line">        <span class="keyword">this</span>.executorToSlot = <span class="keyword">new</span> HashMap&lt;ExecutorDetails, WorkerSlot&gt;(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (executorToSlots != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.executorToSlot.putAll(executorToSlots);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;WorkerSlot&gt; <span class="title">getSlots</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HashSet(executorToSlot.values());</span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Assign the slot to executors.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">assign</span><span class="params">(WorkerSlot slot, Collection&lt;ExecutorDetails&gt; executors)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (ExecutorDetails executor : executors) &#123;</span><br><span class="line">            <span class="keyword">this</span>.executorToSlot.put(executor, slot);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Release the slot occupied by this assignment.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unassignBySlot</span><span class="params">(WorkerSlot slot)</span> </span>&#123;</span><br><span class="line">        List&lt;ExecutorDetails&gt; executors = <span class="keyword">new</span> ArrayList&lt;ExecutorDetails&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ExecutorDetails executor : <span class="keyword">this</span>.executorToSlot.keySet()) &#123;</span><br><span class="line">            WorkerSlot ws = <span class="keyword">this</span>.executorToSlot.get(executor);</span><br><span class="line">            <span class="keyword">if</span> (ws.equals(slot)) &#123;</span><br><span class="line">                executors.add(executor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// remove</span></span><br><span class="line">        <span class="keyword">for</span> (ExecutorDetails executor : executors) &#123;</span><br><span class="line">            <span class="keyword">this</span>.executorToSlot.remove(executor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Does this slot occupied by this assignment?</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSlotOccupied</span><span class="params">(WorkerSlot slot)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.executorToSlot.containsValue(slot);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExecutorAssigned</span><span class="params">(ExecutorDetails executor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.executorToSlot.containsKey(executor);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTopologyId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.topologyId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;ExecutorDetails, WorkerSlot&gt; <span class="title">getExecutorToSlot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.executorToSlot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return the executors covered by this assignments</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;ExecutorDetails&gt; <span class="title">getExecutors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.executorToSlot.keySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>nimbus.clj</strong>文件中<strong>mk-assignments</strong>方法</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">;; get existing assignment (just the executor-&gt;node+port map) -&gt; default to &#123;&#125;</span></span><br><span class="line"><span class="comment">;; filter out ones which have a executor timeout</span></span><br><span class="line"><span class="comment">;; figure out available slots on cluster. add to that the used valid slots to get total slots. figure out how many executors should be in each slot (e.g., 4, 4, 4, 5)</span></span><br><span class="line"><span class="comment">;; only keep existing slots that satisfy one of those slots. for rest, reassign them across remaining slots</span></span><br><span class="line"><span class="comment">;; edge case for slots with no executor timeout but with supervisor timeout... just treat these as valid slots that can be reassigned to. worst comes to worse the executor will timeout and won't assign here next time around</span></span><br><span class="line"><span class="comment">;; mk-assignments主要负责对当前集群中的所有Topology进行新一轮的任务调度, 它一方面会检查已运行的Topology</span></span><br><span class="line"><span class="comment">;; 所占用的资源,判断他们是否有问题, 是否需要重新分配, 另一方面也会根据当前的可用资源, 为新提交的Topology分配任务</span></span><br><span class="line"><span class="comment">;; 然后会将所有的分配信息保存或者更新到Zookeeper中,</span></span><br><span class="line">(<span class="name">defnk</span> mk-assignments [nimbus <span class="symbol">:scratch-topology-id</span> <span class="literal">nil</span>]</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> [conf (<span class="symbol">:conf</span> nimbus)</span><br><span class="line">        storm-cluster-state (<span class="symbol">:storm-cluster-state</span> nimbus)</span><br><span class="line">        <span class="comment">^INimbus</span> inimbus (<span class="symbol">:inimbus</span> nimbus)</span><br><span class="line">        <span class="comment">;; read all the topologies</span></span><br><span class="line">        topology-ids (<span class="name">.active-storms</span> storm-cluster-state)</span><br><span class="line">        topologies (<span class="name"><span class="builtin-name">into</span></span> &#123;&#125; (<span class="name"><span class="builtin-name">for</span></span> [tid topology-ids]</span><br><span class="line">                              &#123;tid (<span class="name">read-topology-details</span> nimbus tid)&#125;))</span><br><span class="line">        topologies (<span class="name">Topologies.</span> topologies)</span><br><span class="line">        <span class="comment">;; read all the assignments</span></span><br><span class="line">        assigned-topology-ids (<span class="name">.assignments</span> storm-cluster-state <span class="literal">nil</span>)</span><br><span class="line">        existing-assignments (<span class="name"><span class="builtin-name">into</span></span> &#123;&#125; (<span class="name"><span class="builtin-name">for</span></span> [tid assigned-topology-ids]</span><br><span class="line">                                        <span class="comment">;; for the topology which wants rebalance (specified by the scratch-topology-id)</span></span><br><span class="line">                                        <span class="comment">;; we exclude its assignment, meaning that all the slots occupied by its assignment</span></span><br><span class="line">                                        <span class="comment">;; will be treated as free slot in the scheduler code.</span></span><br><span class="line">                                        (<span class="name"><span class="builtin-name">when</span></span> (<span class="name"><span class="builtin-name">or</span></span> (<span class="name"><span class="builtin-name">nil?</span></span> scratch-topology-id) (<span class="name"><span class="builtin-name">not=</span></span> tid scratch-topology-id))</span><br><span class="line">                                          &#123;tid (<span class="name">.assignment-info</span> storm-cluster-state tid <span class="literal">nil</span>)&#125;)))</span><br><span class="line">        <span class="comment">;; make the new assignments for topologies</span></span><br><span class="line">        topology-&gt;executor-&gt;node+port (<span class="name">compute-new-topology-&gt;executor-&gt;node+port</span></span><br><span class="line">                                       nimbus</span><br><span class="line">                                       existing-assignments</span><br><span class="line">                                       topologies</span><br><span class="line">                                       scratch-topology-id)</span><br><span class="line"></span><br><span class="line">        topology-&gt;executor-&gt;node+port (<span class="name"><span class="builtin-name">merge</span></span> (<span class="name"><span class="builtin-name">into</span></span> &#123;&#125; (<span class="name"><span class="builtin-name">for</span></span> [id assigned-topology-ids] &#123;id <span class="literal">nil</span>&#125;)) topology-&gt;executor-&gt;node+port)</span><br><span class="line"></span><br><span class="line">        now-secs (<span class="name">current-time-secs</span>)</span><br><span class="line"></span><br><span class="line">        basic-supervisor-details-map (<span class="name">basic-supervisor-details-map</span> storm-cluster-state)</span><br><span class="line"></span><br><span class="line">        <span class="comment">;; construct the final Assignments by adding start-times etc into it</span></span><br><span class="line">        new-assignments (<span class="name"><span class="builtin-name">into</span></span> &#123;&#125; (<span class="name"><span class="builtin-name">for</span></span> [[topology-id executor-&gt;node+port] topology-&gt;executor-&gt;node+port</span><br><span class="line">                                        <span class="symbol">:let</span> [existing-assignment (<span class="name"><span class="builtin-name">get</span></span> existing-assignments topology-id)</span><br><span class="line">                                              all-nodes (<span class="name"><span class="builtin-name">-&gt;&gt;</span></span> executor-&gt;node+port vals (<span class="name"><span class="builtin-name">map</span></span> first) set)</span><br><span class="line">                                              node-&gt;host (<span class="name"><span class="builtin-name">-&gt;&gt;</span></span> all-nodes</span><br><span class="line">                                                              (<span class="name"><span class="builtin-name">mapcat</span></span> (<span class="name"><span class="builtin-name">fn</span></span> [node]</span><br><span class="line">                                                                        (<span class="name"><span class="builtin-name">if-let</span></span> [host (<span class="name">.getHostName</span> inimbus basic-supervisor-details-map node)]</span><br><span class="line">                                                                          [[node host]]</span><br><span class="line">                                                                          )))</span><br><span class="line">                                                              (<span class="name"><span class="builtin-name">into</span></span> &#123;&#125;))</span><br><span class="line">                                              all-node-&gt;host (<span class="name"><span class="builtin-name">merge</span></span> (<span class="symbol">:node-&gt;host</span> existing-assignment) node-&gt;host)</span><br><span class="line">                                              reassign-executors (<span class="name">changed-executors</span> (<span class="symbol">:executor-&gt;node+port</span> existing-assignment) executor-&gt;node+port)</span><br><span class="line">                                              start-times (<span class="name"><span class="builtin-name">merge</span></span> (<span class="symbol">:executor-&gt;start-time-secs</span> existing-assignment)</span><br><span class="line">                                                                (<span class="name"><span class="builtin-name">into</span></span> &#123;&#125;</span><br><span class="line">                                                                      (<span class="name"><span class="builtin-name">for</span></span> [id reassign-executors]</span><br><span class="line">                                                                        [id now-secs]</span><br><span class="line">                                                                        )))]]</span><br><span class="line">                                   &#123;topology-id (<span class="name">Assignment.</span></span><br><span class="line">                                                 (<span class="name">master-stormdist-root</span> conf topology-id)</span><br><span class="line">                                                 (<span class="name"><span class="builtin-name">select-keys</span></span> all-node-&gt;host all-nodes)</span><br><span class="line">                                                 executor-&gt;node+port</span><br><span class="line">                                                 start-times)&#125;))]</span><br><span class="line"></span><br><span class="line">    <span class="comment">;; tasks figure out what tasks to talk to by looking at topology at runtime</span></span><br><span class="line">    <span class="comment">;; only log/set when there's been a change to the assignment</span></span><br><span class="line">    (<span class="name"><span class="builtin-name">doseq</span></span> [[topology-id assignment] new-assignments</span><br><span class="line">            <span class="symbol">:let</span> [existing-assignment (<span class="name"><span class="builtin-name">get</span></span> existing-assignments topology-id)</span><br><span class="line">                  topology-details (<span class="name">.getById</span> topologies topology-id)]]</span><br><span class="line">      (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> existing-assignment assignment)</span><br><span class="line">        (<span class="name">log-debug</span> <span class="string">"Assignment for "</span> topology-id <span class="string">" hasn't changed"</span>)</span><br><span class="line">        (<span class="name"><span class="builtin-name">do</span></span></span><br><span class="line">          (<span class="name">log-message</span> <span class="string">"Setting new assignment for topology id "</span> topology-id <span class="string">": "</span> (<span class="name">pr-str</span> assignment))</span><br><span class="line">          (<span class="name">.set-assignment!</span> storm-cluster-state topology-id assignment)</span><br><span class="line">          )))</span><br><span class="line">    (<span class="name"><span class="builtin-name">-&gt;&gt;</span></span> new-assignments</span><br><span class="line">          (<span class="name"><span class="builtin-name">map</span></span> (<span class="name"><span class="builtin-name">fn</span></span> [[topology-id assignment]]</span><br><span class="line">            (<span class="name"><span class="builtin-name">let</span></span> [existing-assignment (<span class="name"><span class="builtin-name">get</span></span> existing-assignments topology-id)]</span><br><span class="line">              [topology-id (<span class="name"><span class="builtin-name">map</span></span> to-worker-slot (<span class="name">newly-added-slots</span> existing-assignment assignment))]</span><br><span class="line">              )))</span><br><span class="line">          (<span class="name"><span class="builtin-name">into</span></span> &#123;&#125;)</span><br><span class="line">          (<span class="name">.assignSlots</span> inimbus topologies))</span><br><span class="line">    ))</span><br></pre></td></tr></table></figure>
</li>
<li><p>WorkerTopologyContext 上下文对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerTopologyContext</span> <span class="keyword">extends</span> <span class="title">GeneralTopologyContext</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SHARED_EXECUTOR = <span class="string">"executor"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer _workerPort;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; _workerTasks;</span><br><span class="line">    <span class="keyword">private</span> String _codeDir;</span><br><span class="line">    <span class="keyword">private</span> String _pidDir;</span><br><span class="line">    Map&lt;String, Object&gt; _userResources;</span><br><span class="line">    Map&lt;String, Object&gt; _defaultResources;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WorkerTopologyContext</span><span class="params">(</span><br><span class="line">            StormTopology topology,</span><br><span class="line">            Map stormConf,</span><br><span class="line">            Map&lt;Integer, String&gt; taskToComponent,</span><br><span class="line">            Map&lt;String, List&lt;Integer&gt;&gt; componentToSortedTasks,</span><br><span class="line">            Map&lt;String, Map&lt;String, Fields&gt;&gt; componentToStreamToFields,</span><br><span class="line">            String stormId,</span><br><span class="line">            String codeDir,</span><br><span class="line">            String pidDir,</span><br><span class="line">            Integer workerPort,</span><br><span class="line">            List&lt;Integer&gt; workerTasks,</span><br><span class="line">            Map&lt;String, Object&gt; defaultResources,</span><br><span class="line">            Map&lt;String, Object&gt; userResources</span><br><span class="line">            )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(topology, stormConf, taskToComponent, componentToSortedTasks, componentToStreamToFields, stormId);</span><br><span class="line">        _codeDir = codeDir;</span><br><span class="line">        _defaultResources = defaultResources;</span><br><span class="line">        _userResources = userResources;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(pidDir!=<span class="keyword">null</span>) &#123;</span><br><span class="line">                _pidDir = <span class="keyword">new</span> File(pidDir).getCanonicalPath();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                _pidDir = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Could not get canonical path for "</span> + _pidDir, e);</span><br><span class="line">        &#125;</span><br><span class="line">        _workerPort = workerPort;</span><br><span class="line">        _workerTasks = workerTasks;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>common.clj</strong> 文件定义了对Topology的检验函数, 为Topoloy添加acker, metric, system bolt的方法;</p>
</li>
<li><p>Clojure中<strong>-functionname</strong> 表示该函数是public的，调用该函数时，不需要加-， 直接functionname即可；</p>
</li>
<li><p>nimbus读取storm的配置文件函数<strong>read-storm-config</strong> 是在config.clj中定义的； 而nimbus中定义的read-storm-conf是读取指定Topology的配置信息；</p>
</li>
<li><p>read-storm-config 函数中真正读取<strong>storm.yaml</strong>函数是由java代码来实现的， <strong>readStormConfig</strong>定义在Utils.java中，该文件中解析yaml文件， 其中的Yaml类是由<strong>org.yaml.snakeyaml.Yaml</strong> 提供的；</p>
</li>
<li><p>Apache thrift的使用步骤： </p>
<ol>
<li>编写后缀名为thrift的文件，使用工具生成对应语言的源代码，thrift支持的语言很多，包括C/C++/java/python等；</li>
<li>实现thrift client；</li>
<li>实现thrift server；thfirt server需要实现thrift文件中定义的service接口；</li>
</ol>
</li>
<li><p>supervisor 启动时先设置了线程的未捕捉异常的Handler.  <strong>Thread.UncaughtExceptionHandler</strong>解释:<br>一个处理接口，当一个线程因为没有捕捉的异常导致的突然终止时，该接口被唤醒。 当一个线程因为不能捕捉的异常将要终止的时候，JVM会调用getUncaughtExceptionHandler方法查找扎个线程对应的指定UncaughtExceptionHandler对象，并且回调这个对象的uncaughtException方法。如果这个线程没有指定的UncaughtExceptionHandler对象，那么将ThreadGroup对象作为UncaughtExceptionHandler对象，因为ThreadGroup类实现了Thread.UncaughtExceptionHandler接口；会调用顶层ThreadGroup的那个默认的UncaughtExceptionHandler对象的uncaughtException方法.</p>
</li>
<li><p><strong>standalone-supervisor</strong> 方法实例化一个实现了ISupervisor 接口的对象;</p>
</li>
<li><p><strong>storm事件管理器</strong>定义在event.clj中，主要功能就是通过独立线程执行”事件处理函数”。我们可以将”事件处理函数”添加到EventManager的阻塞队列中，EventManager的事件处理线程不断地从阻塞队列中获取”事件处理函数”并执行。<br><strong>EventManager协议:</strong>   协议就是一组函数定义的集合，协议中函数的第一个参数必须为实现该协议的实例本身，类似于java中实例方法的第一个参数为this；协议类似于java中的接口。</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defprotocol</span></span> EventManager</span><br><span class="line">  (<span class="name">add</span> [this event-fn])</span><br><span class="line">  (<span class="name">waiting?</span> [this])</span><br><span class="line">  (<span class="name">shutdown</span> [this]))</span><br></pre></td></tr></table></figure>
<p><strong>event-manager</strong>函数定义如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">(defn event-manager</span><br><span class="line">  &quot;Creates a thread to respond to events. Any error will cause process to halt&quot;</span><br><span class="line">  ;; daemon?表示是否将事件处理线程设置成守护线程</span><br><span class="line">  [daemon?]</span><br><span class="line">  ;; added表示已添加的&quot;事件处理函数&quot;的个数</span><br><span class="line">  (let [added (atom 0)</span><br><span class="line">    ;; processed表示已处理的&quot;事件处理函数&quot;的个数</span><br><span class="line">        processed (atom 0)</span><br><span class="line">    ;; queue绑定事件管理器的阻塞队列LinkedBlockingQueue</span><br><span class="line">        ^LinkedBlockingQueue queue (LinkedBlockingQueue.)</span><br><span class="line">    ;; 设置事件管理器的状态为&quot;running&quot;</span><br><span class="line">        running (atom true)</span><br><span class="line">    ;; 创建事件处理线程。Clojure函数实现了Runnable和Callable接口，所以可以将Clojure函数作为参数传递给java.lang.Thread类的构造函数</span><br><span class="line">        runner (Thread.</span><br><span class="line">             ;; 事件处理线程循环检查事件处理器的状态是否是&quot;running&quot;，如果是，就从阻塞队列中获取&quot;事件处理函数&quot;，并执行；然后将processed加1</span><br><span class="line">                 (fn []</span><br><span class="line">                   (try-cause</span><br><span class="line">                     (while @running</span><br><span class="line">                       (let [r (.take queue)]</span><br><span class="line">                         (r)</span><br><span class="line">                         (swap! processed inc)))</span><br><span class="line">                     (catch InterruptedException t</span><br><span class="line">                       (log-message &quot;Event manager interrupted&quot;))</span><br><span class="line">                     (catch Throwable t</span><br><span class="line">                       (log-error t &quot;Error when processing event&quot;)</span><br><span class="line">                       (exit-process! 20 &quot;Error when processing an event&quot;)))))]:</span><br><span class="line">    (.setDaemon runner daemon?)</span><br><span class="line">    ;; 启动事件处理线程</span><br><span class="line">    (.start runner)</span><br><span class="line">    ;; 返回一个实现了EventManager协议的实例</span><br><span class="line">    (reify</span><br><span class="line">      EventManager</span><br><span class="line">      ;; add函数将&quot;事件处理函数&quot;添加到事件处理器的阻塞队列中</span><br><span class="line">      (add</span><br><span class="line">        [this event-fn]</span><br><span class="line">        ;; should keep track of total added and processed to know if this is finished yet</span><br><span class="line">        (when-not @running</span><br><span class="line">          (throw (RuntimeException. &quot;Cannot add events to a shutdown event manager&quot;)))</span><br><span class="line">        (swap! added inc)</span><br><span class="line">        (.put queue event-fn))</span><br><span class="line">      ;; waiting?判断事件处理线程是否处于等待状态</span><br><span class="line">      (waiting?</span><br><span class="line">        [this]</span><br><span class="line">        (or (Time/isThreadWaiting runner)</span><br><span class="line">            (= @processed @added)))</span><br><span class="line">      ;; 关闭事件管理器</span><br><span class="line">      (shutdown</span><br><span class="line">        [this]</span><br><span class="line">        (reset! running false)</span><br><span class="line">        (.interrupt runner)</span><br><span class="line">        (.join runner)))))</span><br></pre></td></tr></table></figure>
</li>
<li><p>UI界面上的信息获取是在ui.core.clj 文件中实现的,里面实现了所有的UI  API 函数, 可以获取UI 界面信息;</p>
</li>
<li><p>storm 0.11.0 版本中使用的thrift 是0.9.2 版本的,我用0.9.3 版本编辑结果后用以下命令比较:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `ls ./` ; <span class="keyword">do</span> diff <span class="variable">$i</span> <span class="string">"/home/yjk/storm-master-copy/storm-core/src/jvm/backtype/storm/generated/<span class="variable">$i</span>"</span>; <span class="keyword">done</span>;</span><br></pre></td></tr></table></figure>
<p>结果基本上是相等的, 但有细微差别. 存在许多以下转换</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;       return get_num_tasks();</span><br><span class="line">---</span><br><span class="line">&gt;       return Integer.valueOf(get_num_tasks());</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>未完待续. </p>
<p><br> <br><br><br></p>
<hr>
<p><strong>转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com</strong></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/集群技术/">集群技术</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/storm/">storm</a><a href="/tags/zookeeper/">zookeeper</a><a href="/tags/clojure/">clojure</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/07/storm-source-study-note-01/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/07/storm-source-study-note-01/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/07/Storm-introduce-parallism/" title="Storm并行度详解" itemprop="url">Storm并行度详解</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Jiankang Yan" target="_blank" itemprop="author">Jiankang Yan</a>
		
  <p class="article-time">
    <time datetime="2016-04-07T08:12:59.861Z" itemprop="datePublished"> 发表于 2016-04-07</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>##基本概念##<br>Spout是数据源；<br>Bolt封装了数据处理逻辑；<br>Worker是工作进程，一个工作进程中可以含有一个或者多个Executor线程；<br>Executor是运行Spout或者Bolt处理逻辑的线程；<br>Task是Storm中的最小处理单元，一个Executor中可以包含一个或者多个Task，消息的分发都是从一个task到另一个task进行的；<br>Stream Grouping定义了消息分发策略，定义了Bolt节点以何种方式接收数据；<br>Topology就是由消息分组方式连接起来的Spout和Bolt节点网络；</p>
<p>##关系##<br>Worker由Supervisor负责启动，一个Worker中可以含有一个或者多个Executor线程，每个Executor线程都会启动一个消息循环线程，用于接收、处理和发送消息，当Executor收到其下某一task的消息后，就会调用该Task对应的处理逻辑对消息进行处理。</p>
<p>每个executor只会运行1个topology的1个component(spout或bolt)的task（注：task可以是1个或多个，storm默认是1个component只生成1个task，executor线程里会在每次循环里<strong>顺序调用</strong>所有task实例）。</p>
<p>supervisor和node是一一对应的关系，而worker就是process（进程），executor就是thread（线程），task就是在spout或bolt中定义的函数。</p>
<p>##storm的并行度解释##<br>下图为上述概念的关系图<br><img src="http://7xj1d3.com1.z0.glb.clouddn.com/Storm_worker-processes_executors_tasks.png" alt="storm并行度示意图1"></p>
<p>下面是storm并发度的一个计算方式。<br><img src="http://7xj1d3.com1.z0.glb.clouddn.com/example-of-a-running-topology.png" alt="storm并发度计算方式"><br>其中是一个包含有两个 worker 进程的拓扑。其中，蓝色的 BlueSpout 有两个 executor，每个 executor 中有一个 task，并行度为 2；绿色的 GreenBolt 有两个 executor，每个 executor 有两个 task，并行度也为2；而黄色的 YellowBolt 有 6 个 executor，每个 executor 中有一个 task，并行度为 6，因此，这个拓扑的总并行度就是 2 + 2 + 6 = 10。具体分配到每个 worker 就有 10 / 2 = 5 个 executor。</p>
<p><strong>并行度是基于线程数量来确定的，线程数被平均分配到Worker进程中。</strong></p>
<p><strong>提高storm并行度的方法</strong>：增加work进程，增加executor线程，增加task实例</p>
<p>##storm的并行度设置##</p>
<p>###配置worker数量###<br>增加额外的worker 是增加topology 计算能力的简单方法。为此Storm 提供了API 和修改配置项两种修改方法。无论采取哪种方法，spout 和bolt 组件都不需要做变更，可以直接复用。<br><strong>1 配置文件storm.yaml</strong><br>storm.yaml中，如下指定了worker进程的端口，以及当前机器下能运行的work数量,每个端口用于对应进程对外通讯的。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">supervisor.slots.ports:    // 指定storm通讯端口    </span><br><span class="line">      - 6701  </span><br><span class="line">      - 6702  </span><br><span class="line">      - 6703  </span><br><span class="line">      - 6704</span><br></pre></td></tr></table></figure></p>
<p>默认的worker是4个，同时需要注意一个Slot的概念，Slots的数目默认是跟worker的允许端口数相同，但是如果机器是超线程的，那么Slots数目也会翻倍；</p>
<p>2 代码中配置<br>worker进程数量也可以通过代码设置。(优先级更高)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Config stormConf = <span class="keyword">new</span> Config();</span><br><span class="line">config.setNumWorkers(workers);</span><br></pre></td></tr></table></figure></p>
<p>###配置executor数量###<br>如何每个组件需要的执行线程数？</p>
<p><strong>代码中设置</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">builder.setSpout(id, spout, parallelism_hint)  <span class="comment">// parallelism_hint设置spout的线程数量</span></span><br><span class="line">builder.setBolt(id, bolt, parallelism_hint)   <span class="comment">// parallelism_hint设置bolt的线程数量</span></span><br></pre></td></tr></table></figure></p>
<p>注意，不设置的话，storm中默认是每个组件(spout或bolt)一个executor；<br>例如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</span><br><span class="line">builder.setSpout(<span class="string">"spout"</span>, </span><br><span class="line">                <span class="keyword">new</span> RandomSentenceSpout(), <span class="number">2</span>);</span><br><span class="line">builder.setBolt(<span class="string">"split"</span>, </span><br><span class="line">                <span class="keyword">new</span> SplitSentence(),<span class="number">2</span>)</span><br><span class="line">                .shuffleGrouping(<span class="string">"spout"</span>);</span><br><span class="line">builder.setBolt(<span class="string">"count"</span>, </span><br><span class="line">                <span class="keyword">new</span> WordCount(),<span class="number">4</span>)</span><br><span class="line">                .shuffleGrouping(<span class="string">"split"</span>);</span><br><span class="line">builder.setBolt(<span class="string">"report"</span>, </span><br><span class="line">                <span class="keyword">new</span> ReportBolt())</span><br><span class="line">                .globalGrouping(<span class="string">"count"</span>);</span><br></pre></td></tr></table></figure></p>
<p>其中spout为2，split为2， count为4，report为1</p>
<p>###配置task数量###<br>task是通过 spout/bolt的声明中setNumTasks(num)设置对应spout/bolt的task个数。<br><strong>代码中设置</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</span><br><span class="line">builder.setSpout(<span class="string">"spout"</span>, </span><br><span class="line">                <span class="keyword">new</span> RandomSentenceSpout()</span><br><span class="line">                .setNumTasks(<span class="number">2</span>), <span class="number">2</span>);</span><br><span class="line">builder.setBolt(<span class="string">"split"</span>, </span><br><span class="line">                <span class="keyword">new</span> SplitSentence()</span><br><span class="line">                .setNumTasks(<span class="number">4</span>),<span class="number">2</span>)</span><br><span class="line">                .shuffleGrouping(<span class="string">"spout"</span>);</span><br><span class="line">builder.setBolt(<span class="string">"count"</span>, </span><br><span class="line">                <span class="keyword">new</span> WordCount()</span><br><span class="line">                .setNumTasks(<span class="number">4</span>),<span class="number">4</span>)</span><br><span class="line">                .shuffleGrouping(<span class="string">"split"</span>);</span><br><span class="line">builder.setBolt(<span class="string">"report"</span>, </span><br><span class="line">                <span class="keyword">new</span> ReportBolt())</span><br><span class="line">                .globalGrouping(<span class="string">"count"</span>);</span><br></pre></td></tr></table></figure></p>
<p>如果你在设置 bolt 的时候不指定 task 的数量，那么每个 executor 的 task 数会默认设置为 1。</p>
<p>##其他知识##</p>
<p>###worker调优###<br> Config类对象可设置如下参数，来调整worker进入数据，处理数据的容量大小：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">conf.put(Config.TOPOLOGY_RECEIVER_BUFFER_SIZE, <span class="number">8</span>);</span><br><span class="line">conf.put(Config.TOPOLOGY_TRANSFER_BUFFER_SIZE, <span class="number">32</span>);</span><br><span class="line">conf.put(Config.TOPOLOGY_EXECUTOR_RECEIVE_BUFFER_SIZE, <span class="number">16384</span>);</span><br><span class="line">conf.put(Config.TOPOLOGY_EXECUTOR_SEND_BUFFER_SIZE, <span class="number">16384</span>);</span><br></pre></td></tr></table></figure>
<p>###rebalance调整topology并行度<br>Storm 的一个很有意思的特点是你可以随时增加或者减少 worker 或者 executor 的数量，而不需要重启集群或者拓扑。这个方法就叫做再平衡（rebalance）。</p>
<p>有两种方法可以对一个拓扑执行再平衡操作：</p>
<ol>
<li>使用 Storm UI</li>
<li>使用命令行如下<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 重新配置拓扑 "mytopology"，使得该拓扑拥有 5 个 worker processes</span></span><br><span class="line"><span class="comment">##另外，配置名为 "blue-spout" 的 spout 使用 3 个 executor，配置名为 "yellow-bolt" 的 bolt 使用 10 个 executor。</span></span><br><span class="line"></span><br><span class="line">$ storm rebalance mytopology -n 5 <span class="_">-e</span> blue-spout=3 <span class="_">-e</span> yellow-bolt=10</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>##参考##</p>
<ol>
<li><a href="http://chengjianxiaoxue.iteye.com/blog/2188864" target="_blank" rel="external">http://chengjianxiaoxue.iteye.com/blog/2188864</a></li>
<li><a href="http://www.superwu.cn/2015/05/22/2316/" target="_blank" rel="external">http://www.superwu.cn/2015/05/22/2316/</a></li>
<li><a href="http://weyo.me/pages/techs/storm-translations-understanding-the-parallelism-of-a-storm-topology/" target="_blank" rel="external">http://weyo.me/pages/techs/storm-translations-understanding-the-parallelism-of-a-storm-topology/</a></li>
</ol>
<p><br> <br><br><br></p>
<hr>
<p><strong>转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com</strong></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/集群技术/">集群技术</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/storm/">storm</a><a href="/tags/并行度/">并行度</a><a href="/tags/worker/">worker</a><a href="/tags/executor/">executor</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/07/Storm-introduce-parallism/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/07/Storm-introduce-parallism/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/07/rtsp_camera_to_web_browser/" title="采集rtsp流摄像头到浏览器实时播放方案" itemprop="url">采集rtsp流摄像头到浏览器实时播放方案</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Jiankang Yan" target="_blank" itemprop="author">Jiankang Yan</a>
		
  <p class="article-time">
    <time datetime="2016-04-07T08:12:59.859Z" itemprop="datePublished"> 发表于 2016-04-07</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>最近在做一个流媒体的项目，项目中需要采集摄像头的视频流到网页界面实时播放，一般ip摄像头的流格式都是rtsp的，虽然可以通过vlc实时播放，但是不如浏览器观看给用户的体验简单。</p>
<p>根据查找的资料和实际的实践，目前发现的切实可行的方案有以下几种（因为项目是采用java开发，因此下面的代码也主要使用java实现）：</p>
<ol>
<li><p>使用xuggle库直接解码rtsp流，将解码的一帧帧图片发送给浏览器，使用html5的video播放mjpeg格式，即图片的不断刷新；</p>
</li>
<li><p>使用xuggle库直接解码rtsp流，解码结果直接发送给rtmp服务器，然后浏览器使用flash直接播放rtmp的视频流；</p>
</li>
<li><p>ffmpeg直接解码rtsp流，将解码结果使用http发送到nodejs服务器，nodejs服务器使用websocket发送给客户端，客户端使用canvas实时绘制图像；</p>
</li>
</ol>
<p>下面详细介绍这几种方案。</p>
<h2 id="FFmpeg和Xuggle的简介"><a href="#FFmpeg和Xuggle的简介" class="headerlink" title="FFmpeg和Xuggle的简介"></a>FFmpeg和Xuggle的简介</h2><p>FFmpeg是一个自由软件，可以运行音频和视频多种格式的录影、转换、流功能，包含了libavcodec——这是一个用于多个项目中音频和视频的解码器库，以及libavformat——一个音频与视频格式转换库。<br>FFmpeg的安装请参考：<a href="http://www.linuxidc.com/Linux/2014-05/101322.htm" target="_blank" rel="external">ubuntu上安装ffmpeg</a></p>
<p><a href="http://www.xuggle.com/" target="_blank" rel="external">xuggle官网</a>是一个开源的资源库，能够让开发者更好的去对视频和音频文件进行解码、编码、以及录制等功能。xuggle是对ffmepg的封装，是一套基于ffmpeg的开发库。 使用非常方便。 在java中使用时，请在eclipse中导入其jar包。 <a href="http://pan.baidu.com/s/1pJj0GVD" target="_blank" rel="external">xuggle-5.4-jar包下载</a></p>
<h2 id="方案一的具体实现"><a href="#方案一的具体实现" class="headerlink" title="方案一的具体实现"></a>方案一的具体实现</h2><p>xuggle读取rtsp摄像头的代码如下：<br>import包如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.xuggle.mediatool.IMediaReader;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.mediatool.MediaListenerAdapter;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.mediatool.ToolFactory;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.mediatool.event.IVideoPictureEvent;</span><br></pre></td></tr></table></figure></p>
<p>其中：streamLocation是需要读取的rtsp地址<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mediaReader = ToolFactory.makeReader(streamLocation);</span><br><span class="line">mediaReader.setBufferedImageTypeToGenerate(BufferedImage.TYPE_3BYTE_BGR）;</span><br><span class="line">mediaReader.addListener(<span class="keyword">this</span>);</span><br><span class="line"><span class="keyword">while</span> (mediaReader.readPacket() == <span class="keyword">null</span> &amp;&amp; running ) ;</span><br><span class="line">mediaReader.close();</span><br></pre></td></tr></table></figure></p>
<p>上面这段代码实现了rtsp的持续读取，那么读取到的数据怎么获取，很简单，实现以下的帧回调函数onVideoPicture即可。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Gets called when FFMPEG transcoded a frame</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onVideoPicture</span><span class="params">(IVideoPictureEvent event)</span> </span>&#123;</span><br><span class="line">	BufferedImage frame = event.getImage();</span><br><span class="line">	<span class="comment">//stream是用户自定义的rtsp视频流的id，例如;streamId = this.hashcode()即可</span></span><br><span class="line">	images.put(streamId ,frame);</span><br><span class="line">	frameNr++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上的images是使用guava库的Cache建立的代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.cache.Cache;</span><br><span class="line"><span class="keyword">import</span> com.google.common.cache.CacheBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Cache&lt;String, BufferedImage&gt; images = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure></p>
<p>使用html5 video标签+javax.ws.rs实现的网页显示代码如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br></pre></td><td class="code"><pre><span class="line">import java.awt.image.BufferedImage;</span><br><span class="line">import java.io.ByteArrayOutputStream;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.OutputStream;</span><br><span class="line">import java.util.HashSet;</span><br><span class="line">import java.util.Set;</span><br><span class="line"></span><br><span class="line">import javax.imageio.ImageIO;</span><br><span class="line">import javax.ws.rs.DefaultValue;</span><br><span class="line">import javax.ws.rs.GET;</span><br><span class="line">import javax.ws.rs.Path;</span><br><span class="line">import javax.ws.rs.PathParam;</span><br><span class="line">import javax.ws.rs.Produces;</span><br><span class="line">import javax.ws.rs.QueryParam;</span><br><span class="line">import javax.ws.rs.WebApplicationException;</span><br><span class="line">import javax.ws.rs.core.Application;</span><br><span class="line">import javax.ws.rs.core.Response;</span><br><span class="line">import javax.ws.rs.core.StreamingOutput;</span><br><span class="line"></span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line">import com.google.common.cache.Cache;</span><br><span class="line">import com.sun.jersey.api.container.httpserver.HttpServerFactory;</span><br><span class="line">import com.sun.jersey.api.core.ApplicationAdapter;</span><br><span class="line">import com.sun.net.httpserver.HttpServer;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * A simple webservice used to view results MJPEG streams. </span><br><span class="line"> * The webservice supports a number of calls different calls:</span><br><span class="line"> * &lt;ol&gt;</span><br><span class="line"> * &lt;li&gt;http://IP:PORT/streaming/streams : lists the available JPG and MJPEG urls</span><br><span class="line"> * &lt;/li&gt;</span><br><span class="line"> * &lt;li&gt;http://IP:PORT/streaming/picture/&#123;streamid&#125;.jpg : url to grab jpg</span><br><span class="line"> * pictures&lt;/li&gt;</span><br><span class="line"> * &lt;li&gt;http://IP:PORT/streaming/tiles : provides a visual overview of all the</span><br><span class="line"> * streams available at this service. Clicking an image will open the mjpeg</span><br><span class="line"> * stream&lt;/li&gt;</span><br><span class="line"> * &lt;li&gt;http://IP:PORT/streaming/mjpeg/&#123;streamid&#125;.mjpeg : provides a possibly</span><br><span class="line"> * never ending mjpeg formatted stream&lt;/li&gt;</span><br><span class="line"> * &lt;/ol&gt;</span><br><span class="line"> * </span><br><span class="line"> * The service runs on port 8558 by default but this can be changed by using the</span><br><span class="line"> * port(int) method.</span><br><span class="line"> * </span><br><span class="line"> * @author Corne Versloot</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">@Path("/streaming")</span><br><span class="line">public class MjpegStreamingOp extends Application &#123;</span><br><span class="line"></span><br><span class="line">	private static Cache&lt;String, BufferedImage&gt; images = null;</span><br><span class="line">	private Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">	private HttpServer server;</span><br><span class="line">	private int port = 8558;</span><br><span class="line">	private int frameRate = 20;  // this parameter decide the sleep time</span><br><span class="line"></span><br><span class="line">	public MjpegStreamingOp port(int nr) &#123;</span><br><span class="line">		this.port = nr;</span><br><span class="line">		return this;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public MjpegStreamingOp framerate(int nr) &#123;</span><br><span class="line">		this.frameRate = nr;</span><br><span class="line">		return this;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void prepare() throws IllegalArgumentException, IOException &#123;</span><br><span class="line">	    //此处需要修改为从rtsp读进来的images存放的类</span><br><span class="line">		images = TCPClient.getImages();</span><br><span class="line">		ApplicationAdapter connector = new ApplicationAdapter(</span><br><span class="line">				new MjpegStreamingOp());</span><br><span class="line">		server = HttpServerFactory.create("http://localhost:" + port + "/",</span><br><span class="line">				connector);</span><br><span class="line">		server.start();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * Sets the classes to be used as resources for this application</span><br><span class="line">	 */</span><br><span class="line">	public Set&lt;Class&lt;?&gt;&gt; getClasses() &#123;</span><br><span class="line">		Set&lt;Class&lt;?&gt;&gt; s = new HashSet&lt;Class&lt;?&gt;&gt;();</span><br><span class="line">		s.add(MjpegStreamingOp.class);</span><br><span class="line">		return s;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void deactivate() &#123;</span><br><span class="line">		server.stop(0);</span><br><span class="line">		images.invalidateAll();</span><br><span class="line">		images.cleanUp();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@GET</span><br><span class="line">	@Path("/streams")</span><br><span class="line">	@Produces("text/plain")</span><br><span class="line">	public String getStreamIds() throws IOException &#123;</span><br><span class="line">		String result = new String();</span><br><span class="line">		for (String id : images.asMap().keySet()) &#123;</span><br><span class="line">			result += "/streaming/picture/" + id + ".jpeg\r\n";</span><br><span class="line">		&#125;</span><br><span class="line">		System.out.println("\r\n");</span><br><span class="line">		for (String id : images.asMap().keySet()) &#123;</span><br><span class="line">			result += "/streaming/mjpeg/" + id + ".mjpeg\r\n";</span><br><span class="line">		&#125;</span><br><span class="line">		return result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@GET</span><br><span class="line">	@Path("/picture/&#123;streamid&#125;.jpeg")</span><br><span class="line">	@Produces("image/jpg")</span><br><span class="line">	public Response jpeg(@PathParam("streamid") final String streamId) &#123;</span><br><span class="line">		BufferedImage image = null;</span><br><span class="line">		if ((image = images.getIfPresent(streamId)) != null) &#123;</span><br><span class="line">			ByteArrayOutputStream baos = new ByteArrayOutputStream();</span><br><span class="line">			try &#123;</span><br><span class="line">				ImageIO.write(image, "jpg", baos);</span><br><span class="line">				byte[] imageData = baos.toByteArray();</span><br><span class="line">				return Response.ok(imageData).build(); // non streaming</span><br><span class="line">				// return Response.ok(new</span><br><span class="line">				// ByteArrayInputStream(imageDAta)).build(); // streaming</span><br><span class="line">			&#125; catch (IOException ioe) &#123;</span><br><span class="line">				logger.warn("Unable to write image to output", ioe);</span><br><span class="line">				return Response.serverError().build();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			return Response.noContent().build();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@GET</span><br><span class="line">	@Path("/playmultiple")</span><br><span class="line">	@Produces("text/html")</span><br><span class="line">	public String showPlayers(@DefaultValue("3") @QueryParam("cols") int cols,</span><br><span class="line">			@DefaultValue("0") @QueryParam("offset") int offset,</span><br><span class="line">			@DefaultValue("6") @QueryParam("number") int number)</span><br><span class="line">			throws IOException &#123;</span><br><span class="line">		// number = Math.min(6, number);</span><br><span class="line">		String result = "&lt;html&gt;&lt;head&gt;&lt;title&gt;Mjpeg stream players</span><br><span class="line">		                &lt;/title&gt;&lt;/head&gt;&lt;body bgcolor=\"#3C3C3C\"&gt;";</span><br><span class="line">		result += "&lt;font style=\"color:#CCC;\"&gt;Streams: " + images.size()</span><br><span class="line">				+ " (showing " + offset + " - "</span><br><span class="line">				+ Math.min(images.size(), offset + number) + ")&lt;/font&gt;&lt;br/&gt;";</span><br><span class="line">		result += "&lt;table style=\"border-spacing:0; </span><br><span class="line">		           border-collapse: collapse;\"&gt;&lt;tr&gt;";</span><br><span class="line">		int videoNr = 0;</span><br><span class="line">		for (String id : images.asMap().keySet()) &#123;</span><br><span class="line">			if (videoNr &lt; offset) &#123;</span><br><span class="line">				videoNr++;</span><br><span class="line">				continue;</span><br><span class="line">			&#125;</span><br><span class="line">			if (videoNr - offset &gt; 0 &amp;&amp; (videoNr - offset) % cols == 0) &#123;</span><br><span class="line">				result += "&lt;/tr&gt;&lt;tr&gt;";</span><br><span class="line">			&#125;</span><br><span class="line">			result += "&lt;td&gt;&lt;video poster=\"mjpeg/"</span><br><span class="line">					+ id</span><br><span class="line">					+ ".mjpeg\"&gt;"</span><br><span class="line">					+ "Your browser does not support the video tag.&lt;/video&gt;&lt;/td&gt;";</span><br><span class="line">			// result +=</span><br><span class="line">			// "&lt;td&gt;&lt;img src=\"http://"+InetAddress.getLocalHost().getHostAddress()</span><br><span class="line">			                 +":"+port+"/streaming/mjpeg/"+id+".mjpeg\"&gt;&lt;/td&gt;";</span><br><span class="line">			if (videoNr &gt; offset + number)</span><br><span class="line">				break;</span><br><span class="line">			videoNr++;</span><br><span class="line">		&#125;</span><br><span class="line">		result += "&lt;/tr&gt;&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;";</span><br><span class="line">		return result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@GET</span><br><span class="line">	@Path("/play")</span><br><span class="line">	@Produces("text/html")</span><br><span class="line">	public String showPlayers(@QueryParam("streamid") String streamId)</span><br><span class="line">			throws IOException &#123;</span><br><span class="line">		String result = "&lt;html&gt;&lt;head&gt;&lt;title&gt;Mjpeg stream: " + streamId</span><br><span class="line">				+ "&lt;/title&gt;&lt;/head&gt;&lt;body bgcolor=\"#3C3C3C\"&gt;";</span><br><span class="line">		result += "&lt;font style=\"color:#CCC;\"&gt;&lt;a href=\"tiles\"&gt;Back&lt;/a&gt;&lt;/font&gt;&lt;br/&gt;";</span><br><span class="line">		result += "&lt;table style=\"border-spacing:0; border-collapse: collapse;\"&gt;&lt;tr&gt;";</span><br><span class="line">		result += "&lt;video poster=\"mjpeg/" + streamId + ".mjpeg\"&gt;"</span><br><span class="line">				+ "Your browser does not support the video tag.&lt;/video&gt;";</span><br><span class="line">		return result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@GET</span><br><span class="line">	@Path("/tiles")</span><br><span class="line">	@Produces("text/html")</span><br><span class="line">	public String showTiles(@DefaultValue("3") @QueryParam("cols") int cols,</span><br><span class="line">			@DefaultValue("-1") @QueryParam("width") float width)</span><br><span class="line">			throws IOException &#123;</span><br><span class="line">		String result = "&lt;html&gt;&lt;head&gt;&lt;title&gt;Mjpeg stream players&lt;/title&gt;";</span><br><span class="line">		result += "&lt;/head&gt;&lt;body bgcolor=\"#3C3C3C\"&gt;";</span><br><span class="line"></span><br><span class="line">		result += "&lt;table style=\"border-spacing:0; border-collapse: collapse;\"&gt;&lt;tr&gt;";</span><br><span class="line">		int videoNr = 0;</span><br><span class="line">		for (String id : images.asMap().keySet()) &#123;</span><br><span class="line">			if (videoNr &gt; 0 &amp;&amp; videoNr % cols == 0) &#123;</span><br><span class="line">				result += "&lt;/tr&gt;&lt;tr&gt;";</span><br><span class="line">			&#125;</span><br><span class="line">			result += "&lt;td&gt;&lt;a href=\"play?streamid=" + id</span><br><span class="line">					+ "\"&gt;&lt;img src=\"picture/" + id + ".jpeg\" "</span><br><span class="line">					+ (width &gt; 0 ? "width=\"" + width + "\"" : "") + "/&gt;&lt;/a&gt;";</span><br><span class="line">			videoNr++;</span><br><span class="line">		&#125;</span><br><span class="line">		result += "&lt;/tr&gt;&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;";</span><br><span class="line">		return result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@GET</span><br><span class="line">	@Path("/mjpeg/&#123;streamid&#125;.mjpeg")</span><br><span class="line">	@Produces("multipart/x-mixed-replace; boundary=--BoundaryString\r\n")</span><br><span class="line">	public Response mjpeg(@PathParam("streamid") final String streamId) &#123;</span><br><span class="line">		StreamingOutput output = new StreamingOutput() &#123;</span><br><span class="line">			private BufferedImage prevImage = null;</span><br><span class="line">			private int sleep = 1000 / frameRate;</span><br><span class="line"></span><br><span class="line">			@Override</span><br><span class="line">			public void write(OutputStream outputStream) throws IOException,</span><br><span class="line">					WebApplicationException &#123;</span><br><span class="line">				BufferedImage image = null;</span><br><span class="line">				try &#123;</span><br><span class="line">					while ((image = images.getIfPresent(streamId)) != null) </span><br><span class="line">						if (prevImage == null || !image.equals(prevImage)) &#123;</span><br><span class="line">							ByteArrayOutputStream baos = new ByteArrayOutputStream();</span><br><span class="line">							ImageIO.write(image, "jpg", baos);</span><br><span class="line">							byte[] imageData = baos.toByteArray();</span><br><span class="line">							outputStream</span><br><span class="line">									.write(("--BoundaryString\r\n"</span><br><span class="line">											+ "Content-type: image/jpeg\r\n"</span><br><span class="line">											+ "Content-Length: "</span><br><span class="line">											+ imageData.length + "\r\n\r\n")</span><br><span class="line">											.getBytes());</span><br><span class="line">							outputStream.write(imageData);</span><br><span class="line">							outputStream.write("\r\n\r\n".getBytes());</span><br><span class="line">							outputStream.flush();</span><br><span class="line">						&#125;</span><br><span class="line">						Thread.sleep(sleep);</span><br><span class="line">					&#125;</span><br><span class="line">					outputStream.flush();</span><br><span class="line">					outputStream.close();</span><br><span class="line">				&#125; catch (IOException ioe) &#123;</span><br><span class="line">					logger.info("Steam for [" + streamId</span><br><span class="line">							+ "] closed by client!");</span><br><span class="line">				&#125; catch (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		return Response.ok(output).header("Connection", "close")</span><br><span class="line">				.header("Max-Age", "0").header("Expires", "0")</span><br><span class="line">				.header("Cache-Control", "no-cache, private")</span><br><span class="line">				.header("Pragma", "no-cache").build();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上代码参考自github上stormcv项目，项目地址为：<a href="https://github.com/sensorstorm/StormCV" target="_blank" rel="external">https://github.com/sensorstorm/StormCV</a>, 感谢原作者。</p>
<p>至此，打开网页 <a href="http://localhost:8558/streaming/tiles" target="_blank" rel="external">http://localhost:8558/streaming/tiles</a> 即可查看到实时视频。</p>
<h2 id="方案二的具体实现"><a href="#方案二的具体实现" class="headerlink" title="方案二的具体实现"></a>方案二的具体实现</h2><h3 id="xuggle库转rtsp为rtmp"><a href="#xuggle库转rtsp为rtmp" class="headerlink" title="xuggle库转rtsp为rtmp"></a>xuggle库转rtsp为rtmp</h3><p>rtsp的reader：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.mediatool.IMediaReader;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.mediatool.MediaListenerAdapter;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.mediatool.ToolFactory;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.mediatool.event.IVideoPictureEvent;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.xuggler.ICodec;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.xuggler.IContainer;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.xuggler.IVideoPicture;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * This class reads a video stream or file, decodes frames and transcode to rtmp stream</span><br><span class="line"> * <span class="doctag">@author</span> jkyan</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RTSPReader</span> <span class="keyword">extends</span> <span class="title">MediaListenerAdapter</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(RTSPReader.class);</span><br><span class="line">	<span class="keyword">private</span> IMediaReader mediaReader;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> frameSkip;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> groupSize;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> frameNr; <span class="comment">// number of the frame read so far</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> running = <span class="keyword">false</span>; </span><br><span class="line">	<span class="comment">// used to determine if the EOF was reached if Xuggler does not detect it</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">long</span> lastRead = -<span class="number">1</span>; </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> sleepTime = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String streamName; </span><br><span class="line">	<span class="keyword">private</span> String streamLocation = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">private</span> RTMPWriter rtmpWriter = <span class="keyword">null</span>;</span><br><span class="line">	Double frameRate = <span class="number">0.0</span>;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// frameskip和groupsize决定了需要读取的帧的数目，即采样率，</span></span><br><span class="line">    <span class="comment">// 例如，1,1时代表每一帧都需要读取，10,5时代表只需要[0 1 2 3 4] [10 11 12 13 14] ...</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">RTSPReader</span><span class="params">(String streamName, String streamLocation, </span><br><span class="line">	    <span class="keyword">int</span> frameSkip, <span class="keyword">int</span> groupSize, <span class="keyword">int</span> sleepTime)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.streamLocation = streamLocation;</span><br><span class="line">		<span class="keyword">this</span>.frameSkip = Math.max(<span class="number">1</span>, frameSkip);</span><br><span class="line">		<span class="keyword">this</span>.groupSize = Math.max(<span class="number">1</span>, groupSize);</span><br><span class="line">		<span class="keyword">this</span>.sleepTime = sleepTime;</span><br><span class="line">		<span class="keyword">this</span>.streamName = streamName;</span><br><span class="line">		lastRead = System.currentTimeMillis() + <span class="number">10000</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Start reading the provided URL</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		running = <span class="keyword">true</span>;</span><br><span class="line">		<span class="keyword">while</span> (running) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="comment">// if a url was provided read it</span></span><br><span class="line">				<span class="keyword">if</span> (streamLocation != <span class="keyword">null</span>) &#123;</span><br><span class="line">					logger.info(<span class="string">"Start reading stream: "</span> + streamLocation);</span><br><span class="line">					mediaReader = ToolFactory.makeReader(streamLocation);</span><br><span class="line">					lastRead = System.currentTimeMillis() + <span class="number">10000</span>;</span><br><span class="line">					frameNr = <span class="number">0</span>;</span><br><span class="line">					rtmpWriter = <span class="keyword">new</span> RTMPWriter(<span class="number">576</span>,<span class="number">704</span>,<span class="number">30.0</span>,streamName);</span><br><span class="line">					mediaReader.addListener(<span class="keyword">this</span>);</span><br><span class="line">					<span class="keyword">while</span> (mediaReader.readPacket() == <span class="keyword">null</span> &amp;&amp; running);</span><br><span class="line">					<span class="comment">// reset internal state</span></span><br><span class="line">					rtmpWriter.setFinish();</span><br><span class="line">					mediaReader.close();</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					logger.error(<span class="string">"No stream provided, nothing to read"</span>);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				logger.warn(<span class="string">"Stream closed unexpectatly: "</span> + e.getMessage(), e);</span><br><span class="line">				<span class="comment">// sleep a minute and try to read the stream again</span></span><br><span class="line">				sleep(<span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		running = <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">(<span class="keyword">int</span> ms)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(ms);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Gets called when FFMPEG transcoded a frame</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onVideoPicture</span><span class="params">(IVideoPictureEvent event)</span> </span>&#123;</span><br><span class="line">		lastRead = System.currentTimeMillis();</span><br><span class="line">		<span class="keyword">if</span> (frameNr % frameSkip &lt; groupSize) &#123;</span><br><span class="line">			IVideoPicture picture = event.getPicture();</span><br><span class="line">			rtmpWriter.write(frameNr, picture);</span><br><span class="line">			<span class="comment">// enforced throttling</span></span><br><span class="line">			<span class="keyword">if</span> (sleepTime &gt; <span class="number">0</span>)</span><br><span class="line">				sleep(sleepTime);</span><br><span class="line">		&#125;</span><br><span class="line">		frameNr++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Tells the StreamReader to stop reading frames</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		running = <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Returns whether the StreamReader is still active or not</span><br><span class="line">	 * <span class="doctag">@return</span></span><br><span class="line">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isRunning</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// kill this thread if the last frame read is to long ago</span></span><br><span class="line">		<span class="comment">// (means Xuggler missed the EoF) and clear resources</span></span><br><span class="line">		<span class="keyword">if</span> (lastRead &gt; <span class="number">0</span> &amp;&amp; System.currentTimeMillis() - lastRead &gt; <span class="number">3000</span>) &#123;</span><br><span class="line">			running = <span class="keyword">false</span>;</span><br><span class="line">			<span class="keyword">if</span> (mediaReader != <span class="keyword">null</span> &amp;&amp; mediaReader.getContainer() != <span class="keyword">null</span>)</span><br><span class="line">				mediaReader.getContainer().close();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.running;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><a href="http://itony.me/619.html" target="_blank" rel="external">rtmp服务器的搭建方法</a>请参考这里。</p>
<p>rtmp的writer：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.xuggle.xuggler.ICodec;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.xuggler.IContainer;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.xuggler.IContainerFormat;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.xuggler.IPacket;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.xuggler.IPixelFormat;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.xuggler.IRational;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.xuggler.IStream;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.xuggler.IStreamCoder;</span><br><span class="line"><span class="keyword">import</span> com.xuggle.xuggler.IVideoPicture;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> javax.management.RuntimeErrorException;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RTMPWriter</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(RTMPWriter.class);</span><br><span class="line">	<span class="comment">// private static String url = "";</span></span><br><span class="line">	<span class="keyword">private</span> String url = <span class="string">"rtmp://localhost:1935/live1/"</span>;</span><br><span class="line">	<span class="keyword">private</span> String appName = <span class="string">""</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> height = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> width = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">private</span> IStreamCoder coder = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">private</span> IContainer container = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">private</span> Boolean isfinish = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//rtmp writer中需要获取rtsp流图像的宽和高，帧频作为编码参数</span></span><br><span class="line">    <span class="comment">//rtmp服务器的地址格式一般为：ip+端口+地址+应用名称</span></span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">RTMPWriter</span><span class="params">(<span class="keyword">int</span> height, <span class="keyword">int</span> width, <span class="keyword">double</span> frameRate, String appName)</span> </span>&#123;</span><br><span class="line">		container = IContainer.make();</span><br><span class="line">		IContainerFormat containerFormat = IContainerFormat.make();</span><br><span class="line">		containerFormat.setOutputFormat(<span class="string">"flv"</span>, url + appName, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">// set the buffer length xuggle will suggest to ffmpeg for reading inputs</span></span><br><span class="line">		container.setInputBufferLength(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">int</span> retVal = container.open(url + appName, IContainer.Type.WRITE,</span><br><span class="line">				containerFormat);</span><br><span class="line">		<span class="keyword">if</span> (retVal &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			logger.error(<span class="string">"Could not open output container for live stream"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			logger.info(<span class="string">"hava opened server "</span> + url + appName + <span class="string">" for write!"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		IStream stream = container.addNewStream(<span class="number">0</span>);</span><br><span class="line">		coder = stream.getStreamCoder();</span><br><span class="line">		ICodec codec = ICodec.findEncodingCodec(ICodec.ID.CODEC_ID_H264);</span><br><span class="line">		<span class="keyword">if</span> (codec == <span class="keyword">null</span>) &#123;</span><br><span class="line">			logger.warn(<span class="string">"cannot find h264 encoding codec!"</span>);</span><br><span class="line">			Collection&lt;ICodec&gt; icodec_collections = ICodec.getInstalledCodecs();</span><br><span class="line">			Iterator&lt;ICodec&gt; iterator = icodec_collections.iterator();</span><br><span class="line">			<span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">				ICodec icodec = iterator.next();</span><br><span class="line">				logger.info(<span class="string">"Your system supports codec:"</span> + icodec.getName());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			coder.setCodec(codec);</span><br><span class="line">		&#125;</span><br><span class="line">		coder.setNumPicturesInGroupOfPictures(<span class="number">5</span>);</span><br><span class="line">		coder.setBitRate(<span class="number">256000</span>);</span><br><span class="line">		coder.setPixelType(IPixelFormat.Type.YUV420P);</span><br><span class="line">		<span class="keyword">if</span> (width == <span class="number">0</span> || height == <span class="number">0</span>) &#123;</span><br><span class="line">			logger.error(<span class="string">"cannot get the real size of the stream needed to read"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		coder.setHeight(height);</span><br><span class="line">		coder.setWidth(width);</span><br><span class="line">		coder.setFlag(IStreamCoder.Flags.FLAG_QSCALE, <span class="keyword">true</span>);</span><br><span class="line">		coder.setGlobalQuality(<span class="number">0</span>);</span><br><span class="line">		IRational rationalFrameRate = IRational.make(frameRate);</span><br><span class="line">		coder.setFrameRate(rationalFrameRate);</span><br><span class="line">		coder.setTimeBase(IRational.make(rationalFrameRate.getDenominator(),</span><br><span class="line">				rationalFrameRate.getNumerator()));</span><br><span class="line">		coder.open();</span><br><span class="line">		logger.info(<span class="string">"[ENCODER] address: "</span> + url + appName + </span><br><span class="line">				<span class="string">"\n video size is "</span> + width + <span class="string">"x"</span> + height </span><br><span class="line">				+ <span class="string">" and framerate is "</span> + frameRate);</span><br><span class="line">		<span class="keyword">if</span> (container.writeHeader() &lt; <span class="number">0</span>) </span><br><span class="line">		  <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"cannot write header"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFinish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.isfinish = <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">long</span> frameNr, IVideoPicture picture)</span> </span>&#123;</span><br><span class="line">		IPacket packet = IPacket.make();</span><br><span class="line">		<span class="keyword">if</span> (frameNr == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">// make first frame keyframe</span></span><br><span class="line">			picture.setKeyFrame(<span class="keyword">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		picture.setQuality(<span class="number">0</span>);</span><br><span class="line">		coder.encodeVideo(packet, picture, <span class="number">0</span>);</span><br><span class="line">		picture.delete();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (packet.isComplete()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (container.writePacket(packet) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"cannot write packet"</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				logger.info(<span class="string">"[ENCODER] writing packet of size "</span> + packet.getSize());</span><br><span class="line">			&#125;  </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (isfinish) &#123;</span><br><span class="line">			<span class="keyword">if</span> (container.writeTrailer() &lt; <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"cannot write Trailer"</span>);</span><br><span class="line">			coder.close();</span><br><span class="line">			container.close();</span><br><span class="line">		&#125; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到这里已经实现了rtsp流推送到rtsp的服务器。下一步即为rtmp流的显示。使用的是<a href="https://flowplayer.org/" target="_blank" rel="external">flowplayer</a>。</p>
<p>FlowPlayer 是一个用Flash开发的在Web上的视频播放器，可以很容易将它集成在任何的网页上。支持HTTP以及流媒体传输。</p>
<p>FlowPlayer的示例程序可以<a href="http://pan.baidu.com/s/1sjJU1zR" target="_blank" rel="external">点击此处</a>下载。(FlowPlayer是商业软件，此处仅作测试，请支持正版)</p>
<p>下载flowplay并实现以下的html，即可。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"flowplayer-3.2.13.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>RTSP Camera to RTMP Player<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>	</span><br><span class="line">	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>RTSP Camera to RTMP Player<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="comment">&lt;!-- this A tag is where your Flowplayer will be placed. it can be anywhere --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span>  </span><br><span class="line">		 <span class="attr">href</span>=<span class="string">"#"</span></span><br><span class="line">		 <span class="attr">style</span>=<span class="string">"display:block;width:520px;height:330px"</span>  </span><br><span class="line">		 <span class="attr">id</span>=<span class="string">"player"</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">	</span><br><span class="line">	<span class="comment">&lt;!-- this will install flowplayer inside previous A- tag. --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 修改url为rtmp的应用名称，netConnectionUrl为rtmp服务器的地址 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span><br><span class="line">	flowplayer("player", "flowplayer-3.2.18.swf",&#123; </span><br><span class="line">		clip: &#123; </span><br><span class="line">		  url: 'app',</span><br><span class="line">		  provider: 'rtmp',</span><br><span class="line">		  live: true, </span><br><span class="line">		&#125;,  </span><br><span class="line">		plugins: &#123;  </span><br><span class="line">		   rtmp: &#123;  </span><br><span class="line">			 url: 'flowplayer.rtmp-3.2.13.swf',  </span><br><span class="line">			 netConnectionUrl: 'rtmp://localhost:1935/live1'</span><br><span class="line">		   &#125; </span><br><span class="line">	   &#125; </span><br><span class="line">	&#125;);</span><br><span class="line">	</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">p</span>&gt;</span>		</span><br><span class="line">		Sample RTMP URL (Live) is "rtmp://live.hkstv.hk.lxdns.com/live/hks"</span><br><span class="line">	<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">	</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>启动rtmp服务器，实例化上面的RTSPReader类并传入相应的rtsp摄像头地址，再打开这个网页即可看到摄像头直播。可以使用VLC打开rtsp流对比观看。<br>rtsp示例地址:  rtsp://streaming3.webcam.nl:1935/n224/n224.stream</p>
<p>另外推荐一个世界各地的摄像头直播网站，很有趣: <a href="http://geocam.tv/" target="_blank" rel="external">世界各地的摄像头</a></p>
<h3 id="ffmpeg-命令直接-转rtsp为rtmp"><a href="#ffmpeg-命令直接-转rtsp为rtmp" class="headerlink" title="ffmpeg 命令直接 转rtsp为rtmp"></a>ffmpeg 命令直接 转rtsp为rtmp</h3><p> 上面是使用java库转rtsp为rtmp。<br> ffmpeg直接就可以通过命令将rtsp转rtmp<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i rtsp://地址  <span class="_">-f</span> flv  rtmp://localhost:1935/live1/app</span><br></pre></td></tr></table></figure></p>
<h2 id="方案三的具体实现"><a href="#方案三的具体实现" class="headerlink" title="方案三的具体实现"></a>方案三的具体实现</h2><p>这套方案参考地址为：<a href="http://segmentfault.com/a/1190000000392586" target="_blank" rel="external">使用 WebSockets 进行 HTML5 视频直播 - SegmentFault</a></p>
<p>具体实现如下：<br>来自rtsp摄像头的视频被 ffmpeg 编码，然后通过 HTTP 传递给一个 Node.js 写的小脚本；脚本会将这条 MPEG 视频流通过 WebSockets 分发给所有链接的浏览器；浏览器使用 JavaScript 解码 MPEG 视频流并将解码后的画面渲染到 Canvas 元素上。</p>
<ol>
<li><p>安装nodejs</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install nodejs</span><br><span class="line">sudo apt-get install npm</span><br><span class="line">sudo apt-get install node-legacy</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载 <a href="https://github.com/phoboslab/jsmpeg" target="_blank" rel="external">phoboslab/jsmpeg 项目</a>的 <a href="https://github.com/phoboslab/jsmpeg/blob/master/stream-server.js" target="_blank" rel="external">stream-server.js</a> 脚本。安装 WebSocket包ws并启动服务器： </p>
<pre><code class="bash">npm install ws
node stream-server.js 你的密码
</code></pre>
<p>这里的密码是用来确视频流不被劫持用的。如果服务器运行正常，你应该会看到这样的输出： </p>
<pre><code class="bash">Listening <span class="keyword">for</span> MPEG Stream on http://127.0.0.1:8082/&lt;secret&gt;/&lt;width&gt;/&lt;height&gt;
Awaiting WebSocket connections on ws://127.0.0.1:8084/
</code></pre>
</li>
<li><p>服务器启动后，你就可以启动 ffmpeg 并将它指向到正在运行的这个域名和端口了： </p>
<pre><code class="bash">ffmpeg -i rtsp://admin:12345@10.124.142.15:554/h264/ch1/main/av_stream  <span class="_">-f</span> mpeg1video  -r 25  <span class="_">-s</span> 640x480  http://localhost:8082/123456/640/480/
</code></pre>
<p>这条命令会开始从rtsp流捕捉 640x480 的视频，并编码成 25fps 码率的 MPEG 视频。编码后的视频会通过 HTTP 被发送到所指定的服务器和端口。确保密码正确，URL 中的长和宽也需要正确指定，否则服务器无法正确判断当前的分辨率。</p>
</li>
<li><p>要观看直播，需要从前文提到的 <a href="https://github.com/phoboslab/jsmpeg" target="_blank" rel="external">jsmpeg 项目</a>中下载 stream-example.html 和 jsmpg.js 文件，更改 stream-example.html 中的 WebSocket URL 为你的服务器地址，并使用你喜欢的浏览器打开。 </p>
</li>
</ol>
<p>如果一切正常，你就能看到摄像头画面。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上三种方案得到的结果都会有延时，具体的分析未完待续。</p>
<p><br> <br><br><br></p>
<hr>
<p><strong>转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com</strong></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/流媒体技术/">流媒体技术</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/rtsp/">rtsp</a><a href="/tags/web/">web</a><a href="/tags/摄像头/">摄像头</a><a href="/tags/rtmp/">rtmp</a><a href="/tags/html5/">html5</a><a href="/tags/nodejs/">nodejs</a><a href="/tags/xuggle/">xuggle</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/07/rtsp_camera_to_web_browser/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/07/rtsp_camera_to_web_browser/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/07/python_list_delete_element/" title="python中列表删除满足条件元素的方法" itemprop="url">python中列表删除满足条件元素的方法</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Jiankang Yan" target="_blank" itemprop="author">Jiankang Yan</a>
		
  <p class="article-time">
    <time datetime="2016-04-07T08:12:59.858Z" itemprop="datePublished"> 发表于 2016-04-07</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="问题的产生"><a href="#问题的产生" class="headerlink" title="问题的产生"></a>问题的产生</h2><p>最近的开发中遇到的问题为：需要删除python中list中满足条件的元素，例如，删除【1,2,3,4,5】中不是4的元素：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line">l = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> l :</span><br><span class="line">    <span class="keyword">if</span> i != <span class="number">4</span> :</span><br><span class="line">        l.remove(i)</span><br><span class="line"><span class="keyword">print</span> l</span><br></pre></td></tr></table></figure></p>
<p>然后运行的结果是【2,4】，明显出错了，我们详细分析一下为什么：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line">l = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> l :</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"i:%d"</span> % i</span><br><span class="line">    <span class="keyword">if</span> i != <span class="number">4</span> :</span><br><span class="line">        l.remove(i)</span><br><span class="line">        <span class="keyword">print</span> l</span><br></pre></td></tr></table></figure></p>
<p>运行结果为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">i:<span class="number">1</span></span><br><span class="line">[<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">i:<span class="number">3</span></span><br><span class="line">[<span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">i:<span class="number">5</span></span><br><span class="line">[<span class="number">2</span>, <span class="number">4</span>]</span><br></pre></td></tr></table></figure></p>
<p>遍历完1后直接到3，然后到5，2和4被跳过了；<br><strong>推导原因如下</strong>：<br>list.remove(i)方法用于删除列表中等于i的第一个元素，这个方法不返回任何值，第一次删除后l变成[2,3,4,5],此时for循环的index增加为1；<br>第二次遍历时，直接遍历到3，删除3后，index变为2，l变为[3,4,5],然后删除3，依此类推；</p>
<p>##正确的方法##<br><strong>1 使用Lambada表达式</strong>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">l = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line">l = filter(<span class="keyword">lambda</span> x:x !=<span class="number">4</span>,l)</span><br></pre></td></tr></table></figure></p>
<p>其中filter要求两个参数，第一个是规则函数，第二个参数要求输入序列，而lambda这个函数的作用就是产生一个函数，是一种紧凑小函数的写法</p>
<p><strong>2 使用列表解析</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">l = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line">l = [ i <span class="keyword">for</span> i <span class="keyword">in</span> l <span class="keyword">if</span> i !=<span class="number">4</span>]</span><br></pre></td></tr></table></figure></p>
<p><strong>3 建立新的list存放要删除的元素</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">l = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line">dellist = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> l:</span><br><span class="line">    <span class="keyword">if</span> i != <span class="number">4</span>:</span><br><span class="line">        dellist.append(i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> dellist:</span><br><span class="line">    l.remove(i)</span><br></pre></td></tr></table></figure></p>
<p>##参考##<br><a href="http://gmingzhe.blog.51cto.com/810664/165905" target="_blank" rel="external">http://gmingzhe.blog.51cto.com/810664/165905</a></p>
<p><br> <br><br><br></p>
<hr>
<p><strong>转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com</strong></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/python/">python</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/python/">python</a><a href="/tags/list/">list</a><a href="/tags/delete/">delete</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/07/python_list_delete_element/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/07/python_list_delete_element/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/07/OpenCV -Java-API- Read-RTSP-Camera/" title="OpenCV  Java API 读取 RTSP 摄像头" itemprop="url">OpenCV  Java API 读取 RTSP 摄像头</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Jiankang Yan" target="_blank" itemprop="author">Jiankang Yan</a>
		
  <p class="article-time">
    <time datetime="2016-04-07T08:12:59.856Z" itemprop="datePublished"> 发表于 2016-04-07</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我的配置：Centos 6.4 + opencv 2.4.8 + ffmpeg  2.8.5</p>
<p>最近在用opencv的VideoCapture读取rtsp摄像头，首先找到以下代码，想测试一下：</p>
<h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a><strong>测试代码</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.opencv.core.Mat;</span><br><span class="line"><span class="keyword">import</span> org.opencv.highgui.Highgui;</span><br><span class="line"><span class="keyword">import</span> org.opencv.highgui.VideoCapture;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Created by jkyan on 1/26/16.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenCVRTSPReader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">         System.load(<span class="string">"/lib/linux64_opencv_java248.so"</span>);</span><br><span class="line">         VideoCapture capture = <span class="keyword">new</span> VideoCapture(<span class="string">"rtsp://218.204.223.237:554/live/1/66251FC11353191F/e7ooqwcfbqjoo80j.sdp"</span>);</span><br><span class="line"></span><br><span class="line">         Mat image=<span class="keyword">new</span> Mat();</span><br><span class="line">         <span class="keyword">double</span> propid=<span class="number">0</span>;</span><br><span class="line">         capture.open(<span class="string">"rtsp://218.204.223.237:554/live/1/66251FC11353191F/e7ooqwcfbqjoo80j.sdp"</span>);</span><br><span class="line">         <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">         <span class="keyword">if</span> (capture.isOpened()) &#123;</span><br><span class="line">             System.out.println(<span class="string">"Video is captured"</span>);</span><br><span class="line">             <span class="keyword">int</span> x=<span class="number">0</span>;</span><br><span class="line">             <span class="keyword">while</span> (x&lt;<span class="number">18</span>) &#123;</span><br><span class="line">                 x=x+<span class="number">1</span>;</span><br><span class="line">                 propid=capture.get(x);</span><br><span class="line">                 System.out.println(<span class="string">"Property Id is "</span> + x + <span class="string">" value ="</span>+ propid);</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">// grab 10 frames as a test</span></span><br><span class="line">             <span class="keyword">while</span> (i &lt; <span class="number">10</span>) &#123;</span><br><span class="line">                 <span class="keyword">try</span> &#123;</span><br><span class="line">                     <span class="comment">//capture.retrieve(image); //same results as .read()</span></span><br><span class="line">                     capture.read(image);</span><br><span class="line">                     <span class="comment">//Highgui.imwrite("camera"+i+".jpg", image);</span></span><br><span class="line">                     System.out.println(<span class="string">"read a frame at "</span>+ i);</span><br><span class="line">                 &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                     e.printStackTrace();</span><br><span class="line">                 &#125;</span><br><span class="line">                 i=i+<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">             &#125;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             System.out.println(<span class="string">"Camera can not be opened!"</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         capture.release();</span><br><span class="line">         System.out.println(<span class="string">"VideoCapture is released"</span>);</span><br><span class="line">         System.exit(<span class="number">0</span>);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="报错及解决办法"><a href="#报错及解决办法" class="headerlink" title="报错及解决办法"></a><strong>报错及解决办法</strong></h2><p>但是运行时直接报错（在已经安装了OpenCV的情况下，Opencv的安装教程参考，同时安装了ffmpeg, ffmpeg的安装教程参考）, Your GStreamer installation is missing a plug-in, 报错内容如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GStreamer Plugin: Embedded video playback halted; module decodebin20 reported: Your GStreamer installation is missing a plug-in.</span><br></pre></td></tr></table></figure></p>
<p>说是缺少插件，找到的解决办法基本上都是安装以下包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gstreamer-&#123;ffmpeg,plugins-&#123;bad,good,ugly&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>但是<strong>直接使用yum安装会提示这些包找不到</strong>，因为他们并不在官方源中，因此<strong>需要添加第三方源</strong>。</p>
<h2 id="添加第三方源"><a href="#添加第三方源" class="headerlink" title="添加第三方源"></a><strong>添加第三方源</strong></h2><p>我找到的解决办法是添加rpmfusion源，参考教程为：<a href="http://rpmfusion.org/Configuration" target="_blank" rel="external">http://rpmfusion.org/Configuration</a><br>直接直接以下命令即可安装：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -c <span class="string">'yum localinstall --nogpgcheck http://download1.rpmfusion.org/free/el/updates/6/i386/rpmfusion-free-release-6-1.noarch.rpm http://download1.rpmfusion.org/nonfree/el/updates/6/i386/rpmfusion-nonfree-release-6-1.noarch.rpm'</span></span><br></pre></td></tr></table></figure></p>
<p>然后更新yum：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure></p>
<p>但是我添加了之后，<strong>gstreamer-ffmpeg仍然装不上，会报缺少liborc.so.0.4这个库</strong>。<br>最后找到这个网站：<a href="http://pkgs.org/centos-6/linuxtech/liborc-devel-0.4.14-1.el6.x86_64.rpm.html" target="_blank" rel="external">http://pkgs.org/centos-6/linuxtech/liborc-devel-0.4.14-1.el6.x86_64.rpm.html</a><br>里面有liborc的包，因此按照其教程，<strong>在/etc/yum.repos.d/目录中新建linuxtech.repo</strong>，文件内容如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[linuxtech]</span><br><span class="line">name=LinuxTECH</span><br><span class="line">baseurl=http://pkgrepo.linuxtech.net/el6/release/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://pkgrepo.linuxtech.net/el6/release/RPM-GPG-KEY-LinuxTECH.NET</span><br></pre></td></tr></table></figure></p>
<p>同样更新一下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache</span><br></pre></td></tr></table></figure></p>
<p>然后安装liborc：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install liborc-devel</span><br></pre></td></tr></table></figure></p>
<p>再接着安装gstreamer-ffmpeg和其他的gstreamer-plugins-{bad,good,ugly} 可顺利装上：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gstreamer-&#123;ffmpeg,plugins-&#123;bad,good,ugly&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后再去运行上述代码，可以完美运行。<br>结束。</p>
<p><br> <br><br><br></p>
<hr>
<p><strong>转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com</strong></p>
<p>参考：<br>[1] <a href="http://ubuntuforums.org/archive/index.php/t-1730395.html" target="_blank" rel="external">http://ubuntuforums.org/archive/index.php/t-1730395.html</a><br>[2] <a href="http://answers.opencv.org/question/44767/rtsp-link-can-not-open-camera-java-h264-stream/" target="_blank" rel="external">http://answers.opencv.org/question/44767/rtsp-link-can-not-open-camera-java-h264-stream/</a><br>[3] <a href="http://pkgs.org/centos-6/linuxtech/liborc-devel-0.4.14-1.el6.x86_64.rpm.html" target="_blank" rel="external">http://pkgs.org/centos-6/linuxtech/liborc-devel-0.4.14-1.el6.x86_64.rpm.html</a><br>[4] <a href="http://www.cnblogs.com/foohack/p/4153173.html" target="_blank" rel="external">http://www.cnblogs.com/foohack/p/4153173.html</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux配置/">Linux配置</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/opencv/">opencv</a><a href="/tags/rtsp/">rtsp</a><a href="/tags/centos/">centos</a><a href="/tags/ffmpeg/">ffmpeg</a><a href="/tags/gstream/">gstream</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/07/OpenCV -Java-API- Read-RTSP-Camera/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/07/OpenCV -Java-API- Read-RTSP-Camera/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/07/Linux-install-OpenCV-on-Ubuntu-or-Redhat/" title="Linux 编译安装 OpenCV (Ubuntu, Redhat)" itemprop="url">Linux 编译安装 OpenCV (Ubuntu, Redhat)</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Jiankang Yan" target="_blank" itemprop="author">Jiankang Yan</a>
		
  <p class="article-time">
    <time datetime="2016-04-07T08:12:59.854Z" itemprop="datePublished"> 发表于 2016-04-07</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>今天在编译安装opencv时遇到的一些问题，记录下来。</p>
<h2 id="我的系统配置和安装版本"><a href="#我的系统配置和安装版本" class="headerlink" title="我的系统配置和安装版本"></a><strong>我的系统配置和安装版本</strong></h2><p>ubuntu server 12.04 和 redhat 6.4 两台机器<br>安装opencv 2.4.8</p>
<h2 id="编译环境准备"><a href="#编译环境准备" class="headerlink" title="编译环境准备"></a><strong>编译环境准备</strong></h2><p>对于ubuntu的机器，首先安装以下软件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装基本编程环境</span></span><br><span class="line">sudo apt-get install build-essential  </span><br><span class="line"><span class="comment"># 安装编解码支持库</span></span><br><span class="line">sudo apt-get install  libgtk2.0-dev libavcodec-dev libavformat-dev  libtiff4-dev  libswscale-dev libjasper-dev  </span><br><span class="line"><span class="comment"># 安装cmake</span></span><br><span class="line">sudo apt-get install cmake </span><br><span class="line"><span class="comment"># 安装pkg-config</span></span><br><span class="line">sudo apt-get install pkg-config</span><br></pre></td></tr></table></figure></p>
<p>对于redhat的机器，使用yum安装以下包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install cmake gcc gcc-c++ gtk+-devel gimp-devel gimp-devel-tools gimp-help-browser zlib-devel libtiff-devel libjpeg-devel libpng-devel gstreamer-devel libavc1394-devel libraw1394-devel libdc1394-devel jasper-devel jasper-utils swig python libtool nasm</span><br></pre></td></tr></table></figure></p>
<h2 id="下载OpenCV安装包"><a href="#下载OpenCV安装包" class="headerlink" title="下载OpenCV安装包"></a><strong>下载OpenCV安装包</strong></h2><p>到<a href="http://opencv.org/downloads.html" target="_blank" rel="external">官网</a>下载OpenCV的安装包，我下载的是2.4.8的版本，但这个版本我安装的时候有bug，后面会介绍。（建议下载2.4.11及以上版本，安装步骤基本类似）</p>
<p>下载后解压，进入目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unzip -v opencv-2.4.8.zip</span><br><span class="line"><span class="comment">#进入解压后的目录</span></span><br><span class="line"><span class="built_in">cd</span> opencv-2.4.8</span><br></pre></td></tr></table></figure></p>
<h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a><strong>编译安装</strong></h2><p>直接在当前目录下编译即可，并不一定要建立子目录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -D CMAKE_BUILD_TYPE=RELEASE -D CMAKE_INSTALL_PREFIX=/usr/<span class="built_in">local</span> .</span><br></pre></td></tr></table></figure></p>
<p>make<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j8    <span class="comment">#（-j8表示使用8个线程编译，可以大大加快编译速度）</span></span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure></p>
<p>我主要在此处遇到了问题，因为我的电脑<strong>安装了GPU卡</strong>，因此OpenCV会自动编译CUDA相关的代码，可以直接关掉( 在cmake时加上-D WITH_CUDA=OFF )，但我需要编译。因此默认是打开的，因此在make时遇到以下错误：a storage class is not allowed in an explicit specialization<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(51): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(52): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(53): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(54): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(55): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(56): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(57): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(58): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(61): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(62): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(63): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(64): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(65): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(66): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(67): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(68): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(119): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(120): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(121): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(122): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(123): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(124): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(125): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(126): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(127): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(128): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(129): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(130): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(131): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(132): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">/root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp(133): error: a storage class is not allowed <span class="keyword">in</span> an explicit specialization</span><br><span class="line">31 errors detected <span class="keyword">in</span> the compilation of <span class="string">"/tmp/tmpxft_00006af4_00000000-9_NCVPyramid.compute_35.cpp1.ii"</span>.</span><br><span class="line">CMake Error at cuda_compile_generated_NCVPyramid.cu.o.cmake:266 (message):</span><br><span class="line">  Error generating file</span><br><span class="line">  /root/opencv-2.4.8/modules/gpu/CMakeFiles/cuda_compile.dir/src/nvidia/core/./cuda_compile_generated_NCVPyramid.cu.o</span><br><span class="line"></span><br><span class="line">make[2]: *** [modules/gpu/CMakeFiles/cuda_compile.dir/src/nvidia/core/./cuda_compile_generated_NCVPyramid.cu.o] Error 1</span><br><span class="line">make[2]: *** Waiting <span class="keyword">for</span> unfinished jobs....</span><br><span class="line">make[1]: *** [modules/gpu/CMakeFiles/opencv_gpu.dir/all] Error 2</span><br><span class="line">make: *** [all] Error 2</span><br></pre></td></tr></table></figure></p>
<p>我安装的CUDA是6.5版本，计算能力是3.5，针对以上错误，我找到的说在cmake时加上以上参数的方法都是没用：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-D CUDA_GENERATION=Auto</span><br><span class="line">或</span><br><span class="line">-D CUDA_GENERATION=<span class="string">""</span> -D CUDA_ARCH_BIN=2.0（或3.5，5.0）</span><br></pre></td></tr></table></figure></p>
<p>最后找的解决办法是：<br>打开错误的文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意修改为你的编译路径</span></span><br><span class="line">vim /root/opencv-2.4.8/modules/gpu/src/nvidia/core/NCVPixelOperations.hpp</span><br></pre></td></tr></table></figure></p>
<p>将其中template声明中的所有static全部删除。可以使用vim的全局替换，或者其他编辑工具全局替换即可(template&lt;&gt; static inline 替换为template&lt;&gt; inline )：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:%s/template&lt;&gt; static inline/template&lt;&gt; inline/g</span><br></pre></td></tr></table></figure></p>
<p>这个问题的原因是OpenCV 2.4.8 与CUDA 6.5不兼容的一个bug（好像2.4系列都有问题），已在后续版本中修复，参考<a href="http://code.opencv.org/issues/3814" target="_blank" rel="external">http://code.opencv.org/issues/3814</a></p>
<p>修改过后重新执行以下，切记有多核的一定使用多线程，编译CUDA慢的要哭：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cmake -D CMAKE_BUILD_TYPE=RELEASE -D CMAKE_INSTALL_PREFIX=/usr/<span class="built_in">local</span> .</span><br><span class="line">make -j8    <span class="comment">#（-j8表示使用8个线程编译，可以大大加快编译速度）</span></span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure></p>
<h2 id="环境变量修改"><a href="#环境变量修改" class="headerlink" title="环境变量修改"></a><strong>环境变量修改</strong></h2><p>在/etc/ld.so.conf 文件中添加 /usr/local/lib  ， 然后执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ldconfig -v</span><br></pre></td></tr></table></figure></p>
<p>为程序指定openvc的头文件位置, 使用pkg-config命令来完成。首先在 /etc/profile 中添加<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span>  PKG_CONFIG_PATH=<span class="variable">$PKG_CONFIG_PATH</span>:/usr/<span class="built_in">local</span>/lib/pkgconfig</span><br></pre></td></tr></table></figure></p>
<p>然后source生效<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure></p>
<p>再执行以下命令可以打印opencv的配置信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkg-config --libs opencv</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~<span class="comment"># pkg-config  --libs opencv</span></span><br><span class="line">/usr/<span class="built_in">local</span>/lib/libopencv_calib3d.so /usr/<span class="built_in">local</span>/lib/libopencv_contrib.so /usr/<span class="built_in">local</span>/lib/libopencv_core.so /usr/<span class="built_in">local</span>/lib/libopencv_features2d.so /usr/<span class="built_in">local</span>/lib/libopencv_flann.so /usr/<span class="built_in">local</span>/lib/libopencv_gpu.so /usr/<span class="built_in">local</span>/lib/libopencv_highgui.so /usr/<span class="built_in">local</span>/lib/libopencv_imgproc.so /usr/<span class="built_in">local</span>/lib/libopencv_legacy.so /usr/<span class="built_in">local</span>/lib/libopencv_ml.so /usr/<span class="built_in">local</span>/lib/libopencv_nonfree.so /usr/<span class="built_in">local</span>/lib/libopencv_objdetect.so /usr/<span class="built_in">local</span>/lib/libopencv_ocl.so /usr/<span class="built_in">local</span>/lib/libopencv_photo.so /usr/<span class="built_in">local</span>/lib/libopencv_stitching.so /usr/<span class="built_in">local</span>/lib/libopencv_superres.so /usr/<span class="built_in">local</span>/lib/libopencv_ts.a /usr/<span class="built_in">local</span>/lib/libopencv_video.so /usr/<span class="built_in">local</span>/lib/libopencv_videostab.so /usr/<span class="built_in">local</span>/cuda/lib64/libcufft.so /usr/<span class="built_in">local</span>/cuda/lib64/libnpps.so /usr/<span class="built_in">local</span>/cuda/lib64/libnppi.so /usr/<span class="built_in">local</span>/cuda/lib64/libnppc.so /usr/<span class="built_in">local</span>/cuda/lib64/libcudart.so -lrt -lpthread -lm -ldl</span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a><strong>测试</strong></h2><p>在解压的opencv目录下找到 samples/c/build_all.sh，运行该文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root/opencv-2.4.8/samples/c/</span><br><span class="line">chmod a+x build_all.sh</span><br><span class="line">./build_all.sh</span><br></pre></td></tr></table></figure></p>
<p>选取生成的可执行文件进行测试，比如find_obg：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/opencv-2.4.8/samples/c<span class="comment"># ls</span></span><br><span class="line">adaptiveskindetector      delaunay               mser_sample</span><br><span class="line">adaptiveskindetector.cpp  delaunay.c             mser_sample.cpp</span><br><span class="line">agaricus-lepiota.data     example_cmake          mushroom</span><br><span class="line">airplane.jpg              facedetect             mushroom.cpp</span><br><span class="line">baboon200.jpg             facedetect.cmd         one_way_sample</span><br><span class="line">baboon200_rotated.jpg     facedetect.cpp         one_way_sample.cpp</span><br><span class="line">baboon.jpg                fback_c                one_way_train_0000.jpg</span><br><span class="line">bgfg_codebook             fback_c.c              one_way_train_0001.jpg</span><br><span class="line">bgfg_codebook.cpp         find_obj               one_way_train_images.txt</span><br><span class="line">blobtrack_sample          find_obj_calonder      polar_transforms</span><br><span class="line">blobtrack_sample.cpp      find_obj_calonder.cpp  polar_transforms.c</span><br><span class="line">box_<span class="keyword">in</span>_scene.png          find_obj.cpp           puzzle.png</span><br><span class="line">box.png                   find_obj_ferns         pyramid_segmentation</span><br><span class="line">build_all.sh              find_obj_ferns.cpp     pyramid_segmentation.c</span><br><span class="line">calonder_params.xml       fruits.jpg             scene_l.bmp</span><br><span class="line">cat.jpg                   intrinsics.yml         scene_r.bmp</span><br><span class="line">cat.xml                   JCB.png                smiledetect</span><br><span class="line">CMakeLists.txt            latentsvmdetect        smiledetect.cpp</span><br><span class="line">contours                  latentsvmdetect.cpp    stuff.jpg</span><br><span class="line">contours.c                lena.jpg               tree.avi</span><br><span class="line">convert_cascade           morphology             tree_engine</span><br><span class="line">convert_cascade.c         morphology.c           tree_engine.cpp</span><br><span class="line">cvsample.dsp              motempl                waveform.data</span><br><span class="line">cvsample.vs2005.vcproj    motempl.c</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./find_obj</span><br></pre></td></tr></table></figure>
<p>安装结束。</p>
<p><br> <br><br><br></p>
<hr>
<p><strong>转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com</strong></p>
<p>参考资料：<br>[1] <a href="http://docs.opencv.org/2.4/doc/tutorials/introduction/linux_install/linux_install.html#linux-installation" target="_blank" rel="external">http://docs.opencv.org/2.4/doc/tutorials/introduction/linux_install/linux_install.html#linux-installation</a><br>[2] <a href="http://blog.csdn.net/surgewong/article/details/39078251" target="_blank" rel="external">http://blog.csdn.net/surgewong/article/details/39078251</a><br>[3] <a href="http://blog.csdn.net/xuejiren/article/details/24347555" target="_blank" rel="external">http://blog.csdn.net/xuejiren/article/details/24347555</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Linux配置/">Linux配置</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/opencv/">opencv</a><a href="/tags/Linux/">Linux</a><a href="/tags/ubuntu/">ubuntu</a><a href="/tags/redhat/">redhat</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/07/Linux-install-OpenCV-on-Ubuntu-or-Redhat/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/07/Linux-install-OpenCV-on-Ubuntu-or-Redhat/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/07/Kafka-install-config-storm-spout/" title="Kafka集群配置以及与Storm的spout集成" itemprop="url">Kafka集群配置以及与Storm的spout集成</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Jiankang Yan" target="_blank" itemprop="author">Jiankang Yan</a>
		
  <p class="article-time">
    <time datetime="2016-04-07T08:12:59.852Z" itemprop="datePublished"> 发表于 2016-04-07</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="kafka介绍"><a href="#kafka介绍" class="headerlink" title="kafka介绍"></a><strong>kafka介绍</strong></h2><pre><code>Kafka是分布式发布-订阅消息系统。它最初由LinkedIn公司开发，之后成为Apache项目的一部分。Kafka是一个分布式的，可划分的，冗余备份的持久性的日志服务。它主要用于处理活跃的流式数据。
</code></pre><h3 id="Kafka主要特点："><a href="#Kafka主要特点：" class="headerlink" title="Kafka主要特点："></a><strong>Kafka主要特点</strong>：</h3><ul>
<li>同时为发布和订阅提供高吞吐量。据了解，Kafka每秒可以生产约25万消息（50 MB），每秒处理55万消息（110 MB）。</li>
<li>可进行持久化操作。将消息持久化到磁盘，因此可用于批量消费，例如ETL，以及实时应用程序。通过将数据持久化到硬盘以及replication防止数据丢失。</li>
<li>分布式系统，易于向外扩展。所有的producer、broker和consumer都会有多个，均为分布式的。无需停机即可扩展机器。</li>
<li>消息被处理的状态是在consumer端维护，而不是由server端维护。当失败时能自动平衡。</li>
<li>支持online和offline的场景。</li>
</ul>
<h3 id="kafka架构："><a href="#kafka架构：" class="headerlink" title="kafka架构："></a><strong>kafka架构</strong>：</h3><p>  <img src="http://7xj1d3.com1.z0.glb.clouddn.com/kafka.png" alt="kafka架构图"></p>
<ul>
<li><strong>Topic：</strong>特指Kafka处理的消息源（feeds of messages）的不同分类。</li>
<li><strong>Partition：</strong>Topic物理上的分组，一个topic可以分为多个partition，每个partition是一个有序的队列。partition中的每条消息都会被分配一个有序的id（offset）。</li>
<li><strong>Message：</strong>消息，是通信的基本单位，每个producer可以向一个topic（主题）发布一些消息。</li>
<li><strong>Producers：</strong>消息和数据生产者，向Kafka的一个topic发布消息的过程叫做producers。</li>
<li><strong>Consumers：</strong>消息和数据消费者，订阅topics并处理其发布的消息的过程叫做consumers。</li>
<li><strong>Broker：</strong>缓存代理，Kafa集群中的一台或多台服务器统称为broker。</li>
<li>kafka以topic来进行消息管理，每个topic包含多个partition，每个partition对应一个逻辑log，有多个segment组成。</li>
<li>每个segment中存储多条消息，消息id由其逻辑位置决定，即从消息id可直接定位到消息的存储位置，避免id到位置的额外映射。</li>
<li>每个partition在内存中对应一个index，记录每个segment中的第一条消息偏移。</li>
<li>发布者发到某个topic的消息会被均匀的分布到多个partition上（随机或根据用户指定的回调函数进行分布），broker收到发布消息往对应partition的最后一个segment上添加该消息，当某个segment上的消息条数达到配置值或消息发布时间超过阈值时，segment上的消息会被flush到磁盘，只有flush到磁盘上的消息订阅者才能订阅到，segment达到一定的大小后将不会再往该segment写数据，broker会创建新的segment；</li>
<li>在Kafka文件存储中，同一个topic下有多个不同partition，在单机模式上每个partition为一个目录，partiton命名规则为topic名称+有序序号，第一个partiton序号从0开始，序号最大值为partitions数量减1；</li>
<li><p>在<strong>多机的分布式kafka</strong>中，<strong>kafka的partition分配规则</strong>如下图所示：<br>一个Kafka集群中4个Broker举例，创建1个topic包含4个Partition，2 Replication， brokers上分区分配如下图：<br><img src="http://7xj1d3.com1.z0.glb.clouddn.com/kafka-partition1.png" alt="kafka分布式partition分配规则1"><br>当当集群中新增2节点，Partition增加到6个时分布情况如下：<br><img src="http://7xj1d3.com1.z0.glb.clouddn.com/kafka-partition2.png" alt="kafka分布式partition分配规则2"><br>具体可以参考<a href="http://blog.csdn.net/lizhitao/article/details/41778193" target="_blank" rel="external">Kafka集群partition replication自动分配分析</a></p>
</li>
<li><p>partion中segment file组成和物理结构：segment file由2大部分组成，分别为index file和data file，此2个文件一一对应，成对出现，后缀”.index”和“.log”分别表示为segment索引文件、数据文件；segment文件命名规则–partion全局的第一个segment从0开始，后续每个segment文件名为上一个segment文件最后一条消息的offset值。数值最大为64位long大小，19位数字字符长度，没有数字用0填充。</p>
<p>kafka的运行流程美团团队分析的比较好，可以参考：<a href="http://tech.meituan.com/kafka-fs-design-theory.html" target="_blank" rel="external">Kafka文件存储机制那些事–美团技术团队</a></p>
</li>
</ul>
<h2 id="kafka-单机模式的配置"><a href="#kafka-单机模式的配置" class="headerlink" title="kafka 单机模式的配置"></a><strong>kafka 单机模式的配置</strong></h2><p>1) 去kafka官网下载kafka,记得下载bin包，就不用再自己编译：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://www.webhostingjams.com/mirror/apache/kafka/0.8.2.1/kafka_2.9.1-0.8.2.1.tgz</span><br></pre></td></tr></table></figure></p>
<p>2) 解压<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf kafka_2.9.1-0.8.2.1.tgz</span><br></pre></td></tr></table></figure></p>
<p>3) 配置zookeeper配置文件和kafka配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> kafka_2.9.1-0.8.2.1</span><br><span class="line">vim config/zookeeper.properties</span><br></pre></td></tr></table></figure></p>
<p>自带的zookeeper默认三条配置如下,如果要修改端口或者数据文件夹，可以修改：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># the directory where the snapshot is stored.</span></span><br><span class="line">dataDir=/tmp/zookeeper</span><br><span class="line"><span class="comment"># the port at which the clients will connect</span></span><br><span class="line">clientPort=2181</span><br><span class="line"><span class="comment"># disable the per-ip limit on the number of connections since this is a non-production config</span></span><br><span class="line">maxClientCnxns=0</span><br></pre></td></tr></table></figure></p>
<p>然后修改kafka server配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim config/server.properties</span><br></pre></td></tr></table></figure></p>
<p>对于单机运行而言，指定一个broker即可，host name可以修改下，其他基本不用修改（如果你修改了zookeeper端口，那么相应的zookeeper配置也要修改）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">############################# Server Basics #############################</span></span><br><span class="line"><span class="comment"># The id of the broker. This must be set to a unique integer for each broker.</span></span><br><span class="line">broker.id=0                   <span class="comment">#kafka集群中服务器的编号</span></span><br><span class="line"><span class="comment">############################# Socket Server Settings #############################</span></span><br><span class="line"><span class="comment"># The port the socket server listens on</span></span><br><span class="line">port=9092                     <span class="comment">#主机端口</span></span><br><span class="line"><span class="comment"># Hostname the broker will bind to. If not set, the server will bind to all interfaces</span></span><br><span class="line">host.name=localhost           <span class="comment">#主机名，在分布式kafka中一定要配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A comma seperated list of directories under which to store log files</span></span><br><span class="line">log.dirs=/tmp/kafka-logs       <span class="comment">#消息log文件存储目录</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">############################# Zookeeper #############################</span></span><br><span class="line"><span class="comment"># Zookeeper connection string (see zookeeper docs for details).</span></span><br><span class="line"><span class="comment"># This is a comma separated host:port pairs, each corresponding to a zk</span></span><br><span class="line"><span class="comment"># server. e.g. "127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002".</span></span><br><span class="line"><span class="comment"># You can also append an optional chroot string to the urls to specify the</span></span><br><span class="line"><span class="comment"># root directory for all kafka znodes.</span></span><br><span class="line">zookeeper.connect=localhost:2181       <span class="comment">#此处我改为了我的主机名</span></span><br><span class="line"><span class="comment"># Timeout in ms for connecting to zookeeper</span></span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br></pre></td></tr></table></figure>
<p>4）启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先启动自带的zookeeper</span></span><br><span class="line">bin/zookeeper-server-start.sh config/zookeeper.properties &amp;  </span><br><span class="line"><span class="comment">#再启动kafka</span></span><br><span class="line">bin/kafka-server-start.sh  config/server.properties  &amp;</span><br></pre></td></tr></table></figure></p>
<p>5)先创建topic分区，用于测试<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#其中指定zookeeper地址， --replication-factor指定冗余分区数目，--partition指定topic的分区数目，--topic指定分区名称</span></span><br><span class="line">bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic kafkatest</span><br></pre></td></tr></table></figure></p>
<p>查看topic是否成功创建<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh --describe --zookeeper localhost:2181</span><br></pre></td></tr></table></figure></p>
<p>6）消息发送<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-console-producer.sh --broker-list localhost:9092 --topic kafkatest</span><br></pre></td></tr></table></figure></p>
<p>执行命令后，输出一个WARN后，可以开始输入消息，<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[2015-07-26 08:58:42,027] WARN Property topic is not valid (kafka.utils.VerifiableProperties)</span><br><span class="line">ssdfff</span><br><span class="line">sdf[2015-07-26 08:58:55,305] INFO Closing socket connection to /127.0.0.1. (kafka.network.Processor)</span><br><span class="line">fsdfsff</span><br><span class="line">dfsff</span><br><span class="line">sdfdffdfd</span><br><span class="line">sdffff</span><br></pre></td></tr></table></figure></p>
<p> 按ctrl-c结束输入<br>7）接收消息测试<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-console-consumer.sh --zookeeper localhost:2181 --topic kafkatest --from-beginning</span><br></pre></td></tr></table></figure></p>
<p>刚才发送的消息接收<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[2015-07-26 09:03:20,138] INFO Closing socket connection to /127.0.0.1. (kafka.network.Processor)</span><br><span class="line">ssdfff</span><br><span class="line">sdffsdfsff</span><br><span class="line">dfsff</span><br><span class="line">sdfdffdfd</span><br><span class="line">sdffff</span><br></pre></td></tr></table></figure></p>
<h2 id="kafka-集群模式的配置"><a href="#kafka-集群模式的配置" class="headerlink" title="kafka 集群模式的配置"></a><strong>kafka 集群模式的配置</strong></h2><p>三台服务器的ip分别为: 192.168.61.150(主机名cluster1), 192.168.61.151(主机名cluster2), 192.168.61.152(主机名cluster3)<br>1) 分别在三台服务器上配置zookeeper,可以参考这篇文章<a href="http://shiyanjun.cn/archives/469.html" target="_blank" rel="external">ZooKeeper-3.3.4集群安装配置</a><br>2) 配置kafka server配置文件：<br>对于192.168.61.150机器，配置文件如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#为了削减篇幅，删除了无用的注释行</span></span><br><span class="line"><span class="comment">############################# Server Basics </span></span><br><span class="line">broker.id=0          <span class="comment"># 服务器的编号</span></span><br><span class="line">port=9092</span><br><span class="line">host.name=cluster1   <span class="comment">#此处主机名要改</span></span><br><span class="line"><span class="comment">#这些默认配置不用改</span></span><br><span class="line">num.network.threads=3</span><br><span class="line">num.io.threads=8</span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line">log.dirs=/tmp/kafka-logs</span><br><span class="line">num.partitions=1</span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line"><span class="comment">#log.flush.interval.messages=10000</span></span><br><span class="line"><span class="comment">#log.flush.interval.ms=1000</span></span><br><span class="line">log.retention.hours=168</span><br><span class="line"><span class="comment">#log.retention.bytes=1073741824</span></span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"><span class="comment">############################# Zookeeper #############################</span></span><br><span class="line">zookeeper.connect=cluster1:2181,cluster2:2181,cluster3:2181  <span class="comment">#此次重要，需要改</span></span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br></pre></td></tr></table></figure></p>
<p>对于192.168.61.151机器，配置文件如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#为了削减篇幅，删除了无用的注释行</span></span><br><span class="line"><span class="comment">############################# Server Basics </span></span><br><span class="line">broker.id=1          <span class="comment"># 服务器的编号</span></span><br><span class="line">port=9092</span><br><span class="line">host.name=cluster1   <span class="comment">#此处主机名要改</span></span><br><span class="line"><span class="comment">#这些默认配置不用改</span></span><br><span class="line">num.network.threads=3</span><br><span class="line">num.io.threads=8</span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line">log.dirs=/tmp/kafka-logs</span><br><span class="line">num.partitions=1</span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line"><span class="comment">#log.flush.interval.messages=10000</span></span><br><span class="line"><span class="comment">#log.flush.interval.ms=1000</span></span><br><span class="line">log.retention.hours=168</span><br><span class="line"><span class="comment">#log.retention.bytes=1073741824</span></span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"><span class="comment">############################# Zookeeper #############################</span></span><br><span class="line">zookeeper.connect=cluster1:2181,cluster2:2181,cluster3:2181  <span class="comment">#此次重要，需要改</span></span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br></pre></td></tr></table></figure></p>
<p>对于192.168.61.152机器，配置文件如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#为了削减篇幅，删除了无用的注释行</span></span><br><span class="line"><span class="comment">############################# Server Basics </span></span><br><span class="line">broker.id=2          <span class="comment"># 服务器的编号</span></span><br><span class="line">port=9092</span><br><span class="line">host.name=cluster1   <span class="comment">#此处主机名要改</span></span><br><span class="line"><span class="comment">#这些默认配置不用改</span></span><br><span class="line">num.network.threads=3</span><br><span class="line">num.io.threads=8</span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line">log.dirs=/tmp/kafka-logs</span><br><span class="line">num.partitions=1</span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line"><span class="comment">#log.flush.interval.messages=10000</span></span><br><span class="line"><span class="comment">#log.flush.interval.ms=1000</span></span><br><span class="line">log.retention.hours=168</span><br><span class="line"><span class="comment">#log.retention.bytes=1073741824</span></span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"><span class="comment">############################# Zookeeper #############################</span></span><br><span class="line">zookeeper.connect=cluster1:2181,cluster2:2181,cluster3:2181  <span class="comment">#此次重要，需要改</span></span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br></pre></td></tr></table></figure></p>
<p>3） 分别在每台机器上启动kafka即可<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-server-start.sh  config/server.properties  &amp;</span><br></pre></td></tr></table></figure></p>
<h2 id="kafka可配置选项"><a href="#kafka可配置选项" class="headerlink" title="kafka可配置选项"></a><strong>kafka可配置选项</strong></h2><p>请参考 <a href="http://liyonghui160com.iteye.com/blog/2163899" target="_blank" rel="external">Kafka 配置说明 含0.8.1版server.properties</a></p>
<h2 id="kafka-java-API"><a href="#kafka-java-API" class="headerlink" title="kafka java API"></a><strong>kafka java API</strong></h2><p>kafka java api使用相当简单，首先是在pom文件中引入kafka jar包。</p>
<h3 id="pom-xml文件"><a href="#pom-xml文件" class="headerlink" title="pom.xml文件"></a>pom.xml文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span><br><span class="line">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ProducerExample<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SimpleCounter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafka_2.10<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.8.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>test-$&#123;artifactId&#125;-$&#123;version&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="producer-API"><a href="#producer-API" class="headerlink" title="producer API"></a>producer API</h3><p>producer 的代码我主要是参考github上的一个example <a href="https://github.com/gwenshap/kafka-examples" target="_blank" rel="external">gwenshap/kafka-examples</a><br>DemoProducer的定义代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test.groups;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoProducer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String topic;</span><br><span class="line">    String sync;</span><br><span class="line">    <span class="keyword">private</span> Properties kafkaProps = <span class="keyword">new</span> Properties();</span><br><span class="line">    <span class="keyword">private</span> Producer&lt;String, String&gt; producer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DemoProducer</span><span class="params">(String topic)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.topic = topic;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(String brokerList, String sync)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sync = sync;</span><br><span class="line">        kafkaProps.put(<span class="string">"bootstrap.servers"</span>, brokerList);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This is mandatory, even though we don't send keys</span></span><br><span class="line">        kafkaProps.put(<span class="string">"key.serializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line">        kafkaProps.put(<span class="string">"value.serializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringSerializer"</span>);</span><br><span class="line">        kafkaProps.put(<span class="string">"acks"</span>, <span class="string">"1"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// how many times to retry when produce request fails?</span></span><br><span class="line">        kafkaProps.put(<span class="string">"retries"</span>, <span class="string">"3"</span>);</span><br><span class="line">        kafkaProps.put(<span class="string">"linger.ms"</span>, <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        producer = <span class="keyword">new</span> KafkaProducer&lt;String, String&gt;(kafkaProps);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">(String value)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sync.equals(<span class="string">"sync"</span>))</span><br><span class="line">            produceSync(value);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (sync.equals(<span class="string">"async"</span>))</span><br><span class="line">            produceAsync(value);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Expected sync or async, got "</span> + sync);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        producer.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Produce a record and wait for server to reply. Throw an exception if something goes wrong */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">produceSync</span><span class="params">(String value)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        ProducerRecord&lt;String, String&gt; record = <span class="keyword">new</span> ProducerRecord&lt;String, String&gt;(topic, value);</span><br><span class="line">        producer.send(record).get();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Produce a record without waiting for server. This includes a callback that will print an error if something goes wrong */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">produceAsync</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">        ProducerRecord&lt;String, String&gt; record = <span class="keyword">new</span> ProducerRecord&lt;String, String&gt;(topic, value);</span><br><span class="line">        producer.send(record, <span class="keyword">new</span> DemoProducerCallback());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoProducerCallback</span> <span class="keyword">implements</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(RecordMetadata recordMetadata, Exception e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">"Error producing to topic "</span> + recordMetadata.topic());</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>DemoProducer的测试代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test.groups;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleCounter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> DemoProducer producer;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (args.length == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"SimpleCounterOldProducer &#123;broker-list&#125; &#123;topic&#125; &#123;type old/new&#125; &#123;type sync/async&#125; &#123;delay (ms)&#125; &#123;count&#125;"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* get arguments */</span></span><br><span class="line">        String brokerList = args[<span class="number">0</span>];</span><br><span class="line">        String topic = args[<span class="number">1</span>];</span><br><span class="line">        String sync = args[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">int</span> delay = Integer.parseInt(args[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">int</span> count = Integer.parseInt(args[<span class="number">4</span>]);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* start a producer */</span></span><br><span class="line">        producer.configure(brokerList, sync);</span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"Starting..."</span>);</span><br><span class="line">        producer.produce(<span class="string">"Starting..."</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* produce the numbers */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; count; i++ ) &#123;</span><br><span class="line">            producer.produce(Integer.toString(i));</span><br><span class="line">            Thread.sleep(delay);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> endTime = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"... and we are done. This took "</span> + (endTime - startTime) + <span class="string">" ms."</span>);</span><br><span class="line">        producer.produce(<span class="string">"... and we are done. This took "</span> + (endTime - startTime) + <span class="string">" ms."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* close shop and leave */</span></span><br><span class="line">        producer.close();</span><br><span class="line">        System.exit(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后在eclipse中运行时加上参数：localhost:9092 kafkatest  async 50 10<br>其中参数【1】为kafka地址，参数【2】为topic name， 参数【3】为同步produce还是异步produce，【4】为发送间隔，【5】为发送消息数目。</p>
<h3 id="consumer-API"><a href="#consumer-API" class="headerlink" title="consumer API"></a>consumer API</h3><p>consumer test java代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test.groups;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> kafka.consumer.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> kafka.consumer.KafkaStream;</span><br><span class="line"><span class="keyword">import</span> kafka.javaapi.consumer.ConsumerConnector;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerGroupExample</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConsumerConnector consumer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String topic;</span><br><span class="line">    <span class="keyword">private</span>  ExecutorService executor;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConsumerGroupExample</span><span class="params">(String a_zookeeper, String a_groupId, String a_topic)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建consumer对象， a_zookeeper是zookeeper地址，</span></span><br><span class="line">        <span class="comment">// a_groupId是消费者读取时的group id，可以随便设</span></span><br><span class="line">        <span class="comment">// a_topic是读取的topic名称</span></span><br><span class="line">        consumer = kafka.consumer.Consumer.createJavaConsumerConnector(</span><br><span class="line">                createConsumerConfig(a_zookeeper, a_groupId));</span><br><span class="line">        <span class="keyword">this</span>.topic = a_topic;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 关闭consumer接口</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (consumer != <span class="keyword">null</span>) consumer.shutdown();</span><br><span class="line">        <span class="keyword">if</span> (executor != <span class="keyword">null</span>) executor.shutdown();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!executor.awaitTermination(<span class="number">5000</span>, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">                System.out.println(<span class="string">"Timed out waiting for consumer threads to shut down, exiting uncleanly"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Interrupted during shutdown, exiting uncleanly"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 启动消费者， a_numThreads指定读取线程数，因为topic可以有多个分区，可以多线程读取</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">int</span> a_numThreads)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Integer&gt; topicCountMap = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;();</span><br><span class="line">        topicCountMap.put(topic, <span class="keyword">new</span> Integer(a_numThreads));</span><br><span class="line">        Map&lt;String, List&lt;KafkaStream&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt;&gt;&gt; consumerMap = consumer.createMessageStreams(topicCountMap);</span><br><span class="line">        List&lt;KafkaStream&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt;&gt; streams = consumerMap.get(topic);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// now launch all the threads</span></span><br><span class="line">        executor = Executors.newFixedThreadPool(a_numThreads);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// now create an object to consume the messages</span></span><br><span class="line">        <span class="keyword">int</span> threadNumber = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> KafkaStream stream : streams) &#123;</span><br><span class="line">        <span class="comment">// ConsumerThread真正读取消息是在 ConsumerThread中</span></span><br><span class="line">            executor.submit(<span class="keyword">new</span> ConsumerThread(stream, threadNumber));</span><br><span class="line">            threadNumber++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 初始化consumer 的相关属性</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ConsumerConfig <span class="title">createConsumerConfig</span><span class="params">(String a_zookeeper, String a_groupId)</span> </span>&#123;</span><br><span class="line">        Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">        props.put(<span class="string">"zookeeper.connect"</span>, a_zookeeper);</span><br><span class="line">        props.put(<span class="string">"group.id"</span>, a_groupId);</span><br><span class="line">        props.put(<span class="string">"zookeeper.session.timeout.ms"</span>, <span class="string">"400"</span>);</span><br><span class="line">        props.put(<span class="string">"zookeeper.sync.time.ms"</span>, <span class="string">"200"</span>);</span><br><span class="line">        props.put(<span class="string">"auto.commit.interval.ms"</span>, <span class="string">"1000"</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConsumerConfig(props);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String zooKeeper = args[<span class="number">0</span>];</span><br><span class="line">        String groupId = args[<span class="number">1</span>];</span><br><span class="line">        String topic = args[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">int</span> threads = Integer.parseInt(args[<span class="number">3</span>]);</span><br><span class="line"> </span><br><span class="line">        ConsumerGroupExample example = <span class="keyword">new</span> ConsumerGroupExample(zooKeeper, groupId, topic);</span><br><span class="line">        example.run(threads);</span><br><span class="line">        </span><br><span class="line"><span class="comment">// sleep时间用于consumer将offset信息更新到zookeeper中，因为offset信息不是同步更新的</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// example.shutdown();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ConsumerThread代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test.groups;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> kafka.consumer.ConsumerIterator;</span><br><span class="line"><span class="keyword">import</span> kafka.consumer.KafkaStream;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> KafkaStream m_stream;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> m_threadNumber;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConsumerTest</span><span class="params">(KafkaStream a_stream, <span class="keyword">int</span> a_threadNumber)</span> </span>&#123;</span><br><span class="line">        m_threadNumber = a_threadNumber;</span><br><span class="line">        m_stream = a_stream;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConsumerIterator&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt; it = m_stream.iterator();</span><br><span class="line"><span class="comment">//此处循环会不断从topic中读取消息，阻塞函数，除非手动shutdown；</span></span><br><span class="line">        <span class="keyword">while</span> (it.hasNext())</span><br><span class="line">            System.out.println(<span class="string">"Thread "</span> + m_threadNumber + <span class="string">": "</span> + <span class="keyword">new</span> String(it.next().message()));</span><br><span class="line">        System.out.println(<span class="string">"Shutting down Thread: "</span> + m_threadNumber);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="kafka与storm的集成kafka-spout"><a href="#kafka与storm的集成kafka-spout" class="headerlink" title="kafka与storm的集成kafka-spout"></a><strong>kafka与storm的集成kafka-spout</strong></h2><p>kafka集群与storm集群的集成很简单，也很自然，让storm从kafka集群中获取数据，一方面实现了数据采集和计算的解耦合，一方面kafka可作为数据缓冲，对此，storm官方已经给予了支持，在apache storm项目中有专门的jar包，只需要在maven文件中添加如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.storm<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>storm-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.2-incubating<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.storm<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>storm-kafka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.2-incubating<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafka_2.9.2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.8.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>然后在Topology定义代码中设置kafka spout即可：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</span><br><span class="line">BrokerHosts hosts = <span class="keyword">new</span> ZkHosts(<span class="string">"192.168.61.150:2181,192.168.61.151:2181,192.168.61.152:2181"</span>);</span><br><span class="line">String topic_name = <span class="string">"kafkatest"</span>;</span><br><span class="line">String zkRoot = <span class="string">"/"</span> + topic_name; </span><br><span class="line">SpoutConfig spoutConfig = <span class="keyword">new</span> SpoutConfig(hosts, topic_name, zkRoot, UUID.randomUUID().toString());</span><br><span class="line">spoutConfig.scheme = <span class="keyword">new</span> SchemeAsMultiScheme(<span class="keyword">new</span> StringScheme());</span><br><span class="line">KafkaSpout kafkaSpout = <span class="keyword">new</span> KafkaSpout(spoutConfig);</span><br><span class="line"><span class="comment">// set Spout.</span></span><br><span class="line">builder.setSpout(<span class="string">"spout"</span>, kafkaSpout, <span class="number">3</span>);</span><br></pre></td></tr></table></figure></p>
<p>1） 上面需要注意的是，如果你的kafka 消息类型不是String， 是自定义的消息类型，那么需要自定义spoutConfig.scheme. spoutConfig.scheme 用于实现kafka-spout如何将接收到的kafka message转换为storm的tuple。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMessageScheme</span> <span class="keyword">implements</span> <span class="title">Scheme</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(TestMessageScheme.class);</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			String msg = <span class="keyword">new</span> String(bytes, <span class="string">"UTF-8"</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> Values(msg);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InvalidProtocolBufferException e) &#123;</span><br><span class="line">			LOGGER.error(<span class="string">"Cannot parse the provided message!"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//<span class="doctag">TODO:</span> what happend if returns null?</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Fields <span class="title">getOutputFields</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Fields(<span class="string">"msg"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2）上面的代码是实时的，即启动storm后只能收到之后发送的kafka message；</p>
<ul>
<li><strong>配置过程中遇到的问题</strong><br>我做的主要是用kafka来做图片消息传输，在测试过程中遇到的问题主要是图片太大，在发送和接收的时候都出现问题。<br>1） 发送的时候图片太大，导致消息的size大不能传输，解决办法为：</li>
</ul>
<p> 2） 修改完发送端口，发送图片没有问题，可以接收图片的时候总是会卡住，接收几条消息之后consumer就卡住不动了，目前只能切分为小图片发送；</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a><strong>参考资料</strong></h2><ul>
<li><a href="http://www.biaodianfu.com/kafka.html" target="_blank" rel="external">标点符 » 分布式消息系统：Kafka</a></li>
<li><a href="http://tech.meituan.com/kafka-fs-design-theory.html" target="_blank" rel="external">Kafka文件存储机制那些事–美团技术团队</a></li>
<li><a href="https://github.com/gwenshap/kafka-examples" target="_blank" rel="external">gwenshap/kafka-examples</a></li>
<li><a href="http://blog.csdn.net/lizhitao/article/details/41778193" target="_blank" rel="external">Kafka集群partition replication自动分配分析</a></li>
<li><a href="http://liyonghui160com.iteye.com/blog/2163899" target="_blank" rel="external">Kafka 配置说明 含0.8.1版server.properties</a></li>
<li><a href="http://shiyanjun.cn/archives/469.html" target="_blank" rel="external">ZooKeeper-3.3.4集群安装配置</a></li>
</ul>
<p><br> <br><br><br></p>
<hr>
<p><strong>转载请标明文章出处。本文内容为实践后的原创整理，如果侵犯了您的版权，请联系我进行删除，邮件：yanhealth@163.com</strong></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/集群技术/">集群技术</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/kafka/">kafka</a><a href="/tags/storm/">storm</a><a href="/tags/zookeeper/">zookeeper</a><a href="/tags/producer/">producer</a><a href="/tags/consumer/">consumer</a><a href="/tags/java/">java</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/07/Kafka-install-config-storm-spout/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/07/Kafka-install-config-storm-spout/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/07/first/" title="2015-github博客-新的征程" itemprop="url">2015-github博客-新的征程</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Jiankang Yan" target="_blank" itemprop="author">Jiankang Yan</a>
		
  <p class="article-time">
    <time datetime="2016-04-07T08:12:59.851Z" itemprop="datePublished"> 发表于 2016-04-07</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>欢迎来到 <a href="http://yanjiankang.cn/">严健康的个人博客</a>!</p>
<p>这是我的新开始，为了未来而奋斗。 </p>
<h2 id="2015年目标"><a href="#2015年目标" class="headerlink" title="2015年目标"></a>2015年目标</h2><ul>
<li><p>刷题-算法导论</p>
</li>
<li><p>锻炼java编程能力</p>
</li>
<li><p>storm计算平台</p>
</li>
</ul>
<p><img src="http://7xj1d3.com1.z0.glb.clouddn.com/dengshan.jpg" alt=""></p>
<blockquote>
<p>每个人都有潜在的能量，只是很容易：被习惯所掩盖，被时间所迷离，被惰性所消磨。</p>
</blockquote>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/生活杂记/">生活杂记</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/2015/">2015</a><a href="/tags/生活/">生活</a><a href="/tags/目标/">目标</a>
  </div>

</div>




<div class="comments-count">
	
	  	<span></span>
		<a href="/2016/04/07/first/#comments" class="ds-thread-count comments-count-link" data-thread-key="2016/04/07/first/" data-count-type="comments">&nbsp;</a>
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="healthyjk" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Linux配置/" title="Linux配置">Linux配置<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/python/" title="python">python<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/流媒体技术/" title="流媒体技术">流媒体技术<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/生活杂记/" title="生活杂记">生活杂记<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/算法/" title="算法">算法<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/软件工程/" title="软件工程">软件工程<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/集群技术/" title="集群技术">集群技术<sup>5</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/storm/" title="storm">storm<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/opencv/" title="opencv">opencv<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/zookeeper/" title="zookeeper">zookeeper<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/java/" title="java">java<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/rtsp/" title="rtsp">rtsp<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/kafka/" title="kafka">kafka<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/clojure/" title="clojure">clojure<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/centos/" title="centos">centos<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/producer/" title="producer">producer<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/consumer/" title="consumer">consumer<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ffmpeg/" title="ffmpeg">ffmpeg<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ubuntu/" title="ubuntu">ubuntu<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/redhat/" title="redhat">redhat<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/并行度/" title="并行度">并行度<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/worker/" title="worker">worker<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/executor/" title="executor">executor<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/idea/" title="idea">idea<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Clojure/" title="Clojure">Clojure<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/cursive/" title="cursive">cursive<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Jiankang Yan in Fudan. <br/>
			This is my github blog, Welcome.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/yanhealth" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/healthyjk" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="Jiankang Yan">Jiankang Yan</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
